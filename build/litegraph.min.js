<<<<<<< HEAD
var $jscomp = $jscomp || {};
$jscomp.scope = {};
$jscomp.ASSUME_ES5 = !1;
$jscomp.ASSUME_NO_NATIVE_MAP = !1;
$jscomp.ASSUME_NO_NATIVE_SET = !1;
$jscomp.defineProperty = $jscomp.ASSUME_ES5 || "function" == typeof Object.defineProperties ? Object.defineProperty : function(u, f, k) {
  u != Array.prototype && u != Object.prototype && (u[f] = k.value);
};
$jscomp.getGlobal = function(u) {
  return "undefined" != typeof window && window === u ? u : "undefined" != typeof global && null != global ? global : u;
};
$jscomp.global = $jscomp.getGlobal(this);
$jscomp.polyfill = function(u, f, k, c) {
  if (f) {
    k = $jscomp.global;
    u = u.split(".");
    for (c = 0; c < u.length - 1; c++) {
      var p = u[c];
      p in k || (k[p] = {});
      k = k[p];
    }
    u = u[u.length - 1];
    c = k[u];
    f = f(c);
    f != c && null != f && $jscomp.defineProperty(k, u, {configurable:!0, writable:!0, value:f});
  }
};
$jscomp.polyfill("Array.prototype.fill", function(u) {
  return u ? u : function(f, k, c) {
    var p = this.length || 0;
    0 > k && (k = Math.max(0, p + k));
    if (null == c || c > p) {
      c = p;
    }
    c = Number(c);
    0 > c && (c = Math.max(0, p + c));
    for (k = Number(k || 0); k < c; k++) {
      this[k] = f;
    }
    return this;
  };
}, "es6", "es3");
$jscomp.SYMBOL_PREFIX = "jscomp_symbol_";
$jscomp.initSymbol = function() {
  $jscomp.initSymbol = function() {
  };
  $jscomp.global.Symbol || ($jscomp.global.Symbol = $jscomp.Symbol);
};
$jscomp.Symbol = function() {
  var u = 0;
  return function(f) {
    return $jscomp.SYMBOL_PREFIX + (f || "") + u++;
  };
}();
$jscomp.initSymbolIterator = function() {
  $jscomp.initSymbol();
  var u = $jscomp.global.Symbol.iterator;
  u || (u = $jscomp.global.Symbol.iterator = $jscomp.global.Symbol("iterator"));
  "function" != typeof Array.prototype[u] && $jscomp.defineProperty(Array.prototype, u, {configurable:!0, writable:!0, value:function() {
    return $jscomp.arrayIterator(this);
  }});
  $jscomp.initSymbolIterator = function() {
  };
};
$jscomp.arrayIterator = function(u) {
  var f = 0;
  return $jscomp.iteratorPrototype(function() {
    return f < u.length ? {done:!1, value:u[f++]} : {done:!0};
  });
};
$jscomp.iteratorPrototype = function(u) {
  $jscomp.initSymbolIterator();
  u = {next:u};
  u[$jscomp.global.Symbol.iterator] = function() {
    return this;
  };
  return u;
};
$jscomp.iteratorFromArray = function(u, f) {
  $jscomp.initSymbolIterator();
  u instanceof String && (u += "");
  var k = 0, c = {next:function() {
    if (k < u.length) {
      var p = k++;
      return {value:f(p, u[p]), done:!1};
    }
    c.next = function() {
      return {done:!0, value:void 0};
    };
    return c.next();
  }};
  c[Symbol.iterator] = function() {
    return c;
  };
  return c;
};
$jscomp.polyfill("Array.prototype.values", function(u) {
  return u ? u : function() {
    return $jscomp.iteratorFromArray(this, function(f, k) {
      return k;
    });
  };
}, "es8", "es3");
(function(u) {
  function f() {
    e.debug && console.log("Graph created");
    this.list_of_graphcanvas = null;
    this.clear();
  }
  function k(a) {
    this._ctor();
  }
  function c(a, b, d) {
    d = d || {};
    this.background_image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=";
    a && a.constructor === String && (a = document.querySelector(a));
    this.max_zoom = 10;
    this.min_zoom = 0.1;
    this.title_text_font = "bold 14px Arial";
    this.inner_text_font = "normal 12px Arial";
    this.default_link_color = "#AAC";
    this.highquality_render = !0;
    this.editor_alpha = 1;
    this.pause_rendering = !1;
    this.render_only_selected = this.clear_background = this.render_shadows = !0;
    this.live_mode = !1;
    this.allow_interaction = this.allow_dragnodes = this.allow_dragcanvas = this.show_info = !0;
    this.drag_mode = !1;
    this.dragging_rectangle = null;
    this.render_connections_shadows = this.always_render_background = !1;
    this.render_connection_arrows = this.render_curved_connections = this.render_connections_border = !0;
    this.connections_width = 3;
    b && b.attachCanvas(this);
    this.setCanvas(a);
    this.clear();
    d.skip_render || this.startRendering();
    this.autoresize = d.autoresize;
  }
  function p(a, b) {
    return Math.sqrt((b[0] - a[0]) * (b[0] - a[0]) + (b[1] - a[1]) * (b[1] - a[1]));
  }
  function t(a, b, d, g, h, e) {
    return d < a && d + h > a && g < b && g + e > b ? !0 : !1;
  }
  function v(a, b) {
    var d = a[0] + a[2], g = a[1] + a[3], h = b[1] + b[3];
    return a[0] > b[0] + b[2] || a[1] > h || d < b[0] || g < b[1] ? !1 : !0;
  }
  function w(a, b) {
    this.options = b = b || {};
    var d = this;
    b.parentMenu && (b.parentMenu.constructor !== this.constructor ? (console.error("parentMenu must be of class ContextMenu, ignoring it"), b.parentMenu = null) : (this.parentMenu = b.parentMenu, this.parentMenu.lock = !0, this.parentMenu.current_submenu = this));
    b.event && b.event.constructor !== MouseEvent && b.event.constructor !== CustomEvent && (console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it."), b.event = null);
    var g = document.createElement("div");
    g.className = "litegraph litecontextmenu litemenubar-panel";
    g.style.minWidth = 100;
    g.style.minHeight = 100;
    g.style.pointerEvents = "none";
    setTimeout(function() {
      g.style.pointerEvents = "auto";
    }, 100);
    g.addEventListener("mouseup", function(a) {
      a.preventDefault();
      return !0;
    }, !0);
    g.addEventListener("contextmenu", function(a) {
      if (2 != a.button) {
        return !1;
      }
      a.preventDefault();
      return !1;
    }, !0);
    g.addEventListener("mousedown", function(a) {
      if (2 == a.button) {
        return d.close(), a.preventDefault(), !0;
      }
    }, !0);
    this.root = g;
    if (b.title) {
      var h = document.createElement("div");
      h.className = "litemenu-title";
      h.innerHTML = b.title;
      g.appendChild(h);
    }
    h = 0;
    for (var e in a) {
      var n = a.constructor == Array ? a[e] : e;
      null != n && n.constructor !== String && (n = void 0 === n.content ? String(n) : n.content);
      this.addItem(n, a[e], b);
      h++;
    }
    g.addEventListener("mouseleave", function(a) {
      d.lock || d.close(a);
    });
    a = document;
    b.event && (a = b.event.target.ownerDocument);
    a || (a = document);
    a.body.appendChild(g);
    e = b.left || 0;
    a = b.top || 0;
    b.event && (e = b.event.pageX - 10, a = b.event.pageY - 10, b.title && (a -= 20), b.parentMenu && (b = b.parentMenu.root.getBoundingClientRect(), e = b.left + b.width), b = document.body.getBoundingClientRect(), h = g.getBoundingClientRect(), e > b.width - h.width - 10 && (e = b.width - h.width - 10), a > b.height - h.height - 10 && (a = b.height - h.height - 10));
    g.style.left = e + "px";
    g.style.top = a + "px";
  }
  var e = u.LiteGraph = {NODE_TITLE_HEIGHT:16, NODE_SLOT_HEIGHT:15, NODE_WIDTH:140, NODE_MIN_WIDTH:50, NODE_COLLAPSED_RADIUS:10, NODE_COLLAPSED_WIDTH:80, CANVAS_GRID_SIZE:10, NODE_TITLE_COLOR:"#222", NODE_DEFAULT_COLOR:"#999", NODE_DEFAULT_BGCOLOR:"#444", NODE_DEFAULT_BOXCOLOR:"#AEF", NODE_DEFAULT_SHAPE:"box", MAX_NUMBER_OF_NODES:1000, DEFAULT_POSITION:[100, 100], node_images_path:"", VALID_SHAPES:["box", "round"], BOX_SHAPE:1, ROUND_SHAPE:2, CIRCLE_SHAPE:3, INPUT:1, OUTPUT:2, EVENT:-1, ACTION:-1, 
  ALWAYS:0, ON_EVENT:1, NEVER:2, ON_TRIGGER:3, proxy:null, debug:!1, throw_errors:!0, allow_scripts:!0, registered_node_types:{}, node_types_by_file_extension:{}, Nodes:{}, registerNodeType:function(a, b) {
    if (!b.prototype) {
      throw "Cannot register a simple object, it must be a class with a prototype";
    }
    b.type = a;
    e.debug && console.log("Node registered: " + a);
    a.split("/");
    var d = b.constructor.name, g = a.lastIndexOf("/");
    b.category = a.substr(0, g);
    b.title || (b.title = d);
    if (b.prototype) {
      for (var h in k.prototype) {
        b.prototype[h] || (b.prototype[h] = k.prototype[h]);
      }
    }
    Object.defineProperty(b.prototype, "shape", {set:function(a) {
      switch(a) {
        case "box":
          this._shape = e.BOX_SHAPE;
          break;
        case "round":
          this._shape = e.ROUND_SHAPE;
          break;
        case "circle":
          this._shape = e.CIRCLE_SHAPE;
          break;
        default:
          this._shape = a;
      }
    }, get:function(a) {
      return this._shape;
    }, enumerable:!0});
    this.registered_node_types[a] = b;
    b.constructor.name && (this.Nodes[d] = b);
    b.prototype.onPropertyChange && console.warn("LiteGraph node class " + a + " has onPropertyChange method, it must be called onPropertyChanged with d at the end");
    if (b.supported_extensions) {
      for (h in b.supported_extensions) {
        this.node_types_by_file_extension[b.supported_extensions[h].toLowerCase()] = b;
      }
    }
  }, wrapFunctionAsNode:function(a, b, d, g) {
    for (var h = Array(b.length), c = "", n = e.getParameterNames(b), l = 0; l < n.length; ++l) {
      c += "this.addInput('" + n[l] + "'," + (d && d[l] ? "'" + d[l] + "'" : "0") + ");\n";
    }
    d = Function(c + ("this.addOutput('out'," + (g ? "'" + g + "'" : 0) + ");\n"));
    d.title = a.split("/").pop();
    d.desc = "Generated from " + b.name;
    d.prototype.onExecute = function() {
      for (var a = 0; a < h.length; ++a) {
        h[a] = this.getInputData(a);
      }
      a = b.apply(this, h);
      this.setOutputData(0, a);
    };
    this.registerNodeType(a, d);
  }, addNodeMethod:function(a, b) {
    k.prototype[a] = b;
    for (var d in this.registered_node_types) {
      var g = this.registered_node_types[d];
      g.prototype[a] && (g.prototype["_" + a] = g.prototype[a]);
      g.prototype[a] = b;
    }
  }, createNode:function(a, b, d) {
    var g = this.registered_node_types[a];
    if (!g) {
      return e.debug && console.log('GraphNode type "' + a + '" not registered.'), null;
    }
    b = b || g.title || a;
    g = new g(b);
    g.type = a;
    g.title || (g.title = b);
    g.properties || (g.properties = {});
    g.properties_info || (g.properties_info = []);
    g.flags || (g.flags = {});
    g.size || (g.size = g.computeSize());
    g.pos || (g.pos = e.DEFAULT_POSITION.concat());
    g.mode || (g.mode = e.ALWAYS);
    if (d) {
      for (var h in d) {
        g[h] = d[h];
      }
    }
    return g;
  }, getNodeType:function(a) {
    return this.registered_node_types[a];
  }, getNodeTypesInCategory:function(a) {
    var b = [], d;
    for (d in this.registered_node_types) {
      "" == a ? null == this.registered_node_types[d].category && b.push(this.registered_node_types[d]) : this.registered_node_types[d].category == a && b.push(this.registered_node_types[d]);
    }
    return b;
  }, getNodeTypesCategories:function() {
    var a = {"":1}, b;
    for (b in this.registered_node_types) {
      this.registered_node_types[b].category && !this.registered_node_types[b].skip_list && (a[this.registered_node_types[b].category] = 1);
    }
    var d = [];
    for (b in a) {
      d.push(b);
    }
    return d;
  }, reloadNodes:function(a) {
    var b = document.getElementsByTagName("script"), d = [], g;
    for (g in b) {
      d.push(b[g]);
    }
    b = document.getElementsByTagName("head")[0];
    a = document.location.href + a;
    for (g in d) {
      var h = d[g].src;
      if (h && h.substr(0, a.length) == a) {
        try {
          e.debug && console.log("Reloading: " + h);
          var c = document.createElement("script");
          c.type = "text/javascript";
          c.src = h;
          b.appendChild(c);
          b.removeChild(d[g]);
        } catch (n) {
          if (e.throw_errors) {
            throw n;
          }
          e.debug && console.log("Error while reloading " + h);
        }
      }
    }
    e.debug && console.log("Nodes reloaded");
  }, cloneObject:function(a, b) {
    if (null == a) {
      return null;
    }
    a = JSON.parse(JSON.stringify(a));
    if (!b) {
      return a;
    }
    for (var d in a) {
      b[d] = a[d];
    }
    return b;
  }, isValidConnection:function(a, b) {
    if (!a || !b || a == b || a == e.EVENT && b == e.ACTION) {
      return !0;
    }
    a = String(a);
    b = String(b);
    a = a.toLowerCase();
    b = b.toLowerCase();
    if (-1 == a.indexOf(",") && -1 == b.indexOf(",")) {
      return a == b;
    }
    a = a.split(",");
    b = b.split(",");
    for (var d = 0; d < a.length; ++d) {
      for (var g = 0; g < b.length; ++g) {
        if (a[d] == b[g]) {
          return !0;
        }
      }
    }
    return !1;
  }};
  e.getTime = "undefined" != typeof performance ? performance.now.bind(performance) : "undefined" != typeof Date && Date.now ? Date.now.bind(Date) : "undefined" != typeof process ? function() {
    var a = process.hrtime();
    return 0.001 * a[0] + 1e-6 * a[1];
  } : function() {
    return (new Date).getTime();
  };
  u.LGraph = e.LGraph = f;
  f.supported_types = ["number", "string", "boolean"];
  f.prototype.getSupportedTypes = function() {
    return this.supported_types || f.supported_types;
  };
  f.STATUS_STOPPED = 1;
  f.STATUS_RUNNING = 2;
  f.prototype.clear = function() {
    this.stop();
    this.status = f.STATUS_STOPPED;
    this.last_node_id = 0;
    this._nodes = [];
    this._nodes_by_id = {};
    this._nodes_executable = this._nodes_in_order = null;
    this.last_link_id = 0;
    this.links = {};
    this.iteration = 0;
    this.config = {};
    this.fixedtime = this.runningtime = this.globaltime = 0;
    this.elapsed_time = this.fixedtime_lapse = 0.01;
    this.starttime = 0;
    this.catch_errors = !0;
    this.global_inputs = {};
    this.global_outputs = {};
    this.debug = !0;
    this.change();
    this.sendActionToCanvas("clear");
  };
  f.prototype.attachCanvas = function(a) {
    if (a.constructor != c) {
      throw "attachCanvas expects a LGraphCanvas instance";
    }
    a.graph && a.graph != this && a.graph.detachCanvas(a);
    a.graph = this;
    this.list_of_graphcanvas || (this.list_of_graphcanvas = []);
    this.list_of_graphcanvas.push(a);
  };
  f.prototype.detachCanvas = function(a) {
    if (this.list_of_graphcanvas) {
      var b = this.list_of_graphcanvas.indexOf(a);
      -1 != b && (a.graph = null, this.list_of_graphcanvas.splice(b, 1));
    }
  };
  f.prototype.start = function(a) {
    if (this.status != f.STATUS_RUNNING) {
      this.status = f.STATUS_RUNNING;
      if (this.onPlayEvent) {
        this.onPlayEvent();
      }
      this.sendEventToAllNodes("onStart");
      this.starttime = e.getTime();
      var b = this;
      this.execution_timer_id = setInterval(function() {
        b.runStep(1, !this.catch_errors);
      }, a || 1);
    }
  };
  f.prototype.stop = function() {
    if (this.status != f.STATUS_STOPPED) {
      this.status = f.STATUS_STOPPED;
      if (this.onStopEvent) {
        this.onStopEvent();
      }
      null != this.execution_timer_id && clearInterval(this.execution_timer_id);
      this.execution_timer_id = null;
      this.sendEventToAllNodes("onStop");
    }
  };
  f.prototype.runStep = function(a, b) {
    a = a || 1;
    var d = e.getTime();
    this.globaltime = 0.001 * (d - this.starttime);
    var g = this._nodes_executable ? this._nodes_executable : this._nodes;
    if (g) {
      if (b) {
        for (var h = 0; h < a; h++) {
          for (var c = 0, n = g.length; c < n; ++c) {
            var l = g[c];
            if (l.mode == e.ALWAYS && l.onExecute) {
              l.onExecute();
            }
          }
          this.fixedtime += this.fixedtime_lapse;
          if (this.onExecuteStep) {
            this.onExecuteStep();
          }
        }
        if (this.onAfterExecute) {
          this.onAfterExecute();
        }
      } else {
        try {
          for (h = 0; h < a; h++) {
            c = 0;
            for (n = g.length; c < n; ++c) {
              if (l = g[c], l.mode == e.ALWAYS && l.onExecute) {
                l.onExecute();
              }
            }
            this.fixedtime += this.fixedtime_lapse;
            if (this.onExecuteStep) {
              this.onExecuteStep();
            }
          }
          if (this.onAfterExecute) {
            this.onAfterExecute();
          }
          this.errors_in_execution = !1;
        } catch (A) {
          this.errors_in_execution = !0;
          if (e.throw_errors) {
            throw A;
          }
          e.debug && console.log("Error during execution: " + A);
          this.stop();
        }
      }
      a = e.getTime() - d;
      0 == a && (a = 1);
      this.elapsed_time = 0.001 * a;
      this.globaltime += 0.001 * a;
      this.iteration += 1;
    }
  };
  f.prototype.updateExecutionOrder = function() {
    this._nodes_in_order = this.computeExecutionOrder(!1);
    this._nodes_executable = [];
    for (var a = 0; a < this._nodes_in_order.length; ++a) {
      this._nodes_in_order[a].onExecute && this._nodes_executable.push(this._nodes_in_order[a]);
    }
  };
  f.prototype.computeExecutionOrder = function(a, b) {
    for (var d = [], g = [], h = {}, c = {}, n = {}, l = 0, f = this._nodes.length; l < f; ++l) {
      var q = this._nodes[l];
      if (!a || q.onExecute) {
        h[q.id] = q;
        var p = 0;
        if (q.inputs) {
          for (var k = 0, t = q.inputs.length; k < t; k++) {
            q.inputs[k] && null != q.inputs[k].link && (p += 1);
          }
        }
        0 == p ? (g.push(q), b && (q._level = 1)) : (b && (q._level = 0), n[q.id] = p);
      }
    }
    for (; 0 != g.length;) {
      if (q = g.shift(), d.push(q), delete h[q.id], q.outputs) {
        for (l = 0; l < q.outputs.length; l++) {
          if (a = q.outputs[l], null != a && null != a.links && 0 != a.links.length) {
            for (k = 0; k < a.links.length; k++) {
              (f = this.links[a.links[k]]) && !c[f.id] && (p = this.getNodeById(f.target_id), null == p ? c[f.id] = !0 : (b && (!p._level || p._level <= q._level) && (p._level = q._level + 1), c[f.id] = !0, --n[p.id], 0 == n[p.id] && g.push(p)));
            }
          }
        }
      }
    }
    for (l in h) {
      d.push(h[l]);
    }
    d.length != this._nodes.length && e.debug && console.warn("something went wrong, nodes missing");
    for (l = 0; l < d.length; ++l) {
      d[l].order = l;
    }
    return d;
  };
  f.prototype.arrange = function(a) {
    a = a || 40;
    for (var b = this.computeExecutionOrder(!1, !0), d = [], g = 0; g < b.length; ++g) {
      var e = b[g], c = e._level || 1;
      d[c] || (d[c] = []);
      d[c].push(e);
    }
    b = a;
    for (g = 0; g < d.length; ++g) {
      if (c = d[g]) {
        for (var n = 100, l = a, f = 0; f < c.length; ++f) {
          e = c[f], e.pos[0] = b, e.pos[1] = l, e.size[0] > n && (n = e.size[0]), l += e.size[1] + a;
        }
        b += n + a;
      }
    }
    this.setDirtyCanvas(!0, !0);
  };
  f.prototype.getTime = function() {
    return this.globaltime;
  };
  f.prototype.getFixedTime = function() {
    return this.fixedtime;
  };
  f.prototype.getElapsedTime = function() {
    return this.elapsed_time;
  };
  f.prototype.sendEventToAllNodes = function(a, b, d) {
    d = d || e.ALWAYS;
    var g = this._nodes_in_order ? this._nodes_in_order : this._nodes;
    if (g) {
      for (var h = 0, c = g.length; h < c; ++h) {
        var n = g[h];
        if (n[a] && n.mode == d) {
          if (void 0 === b) {
            n[a]();
          } else {
            if (b && b.constructor === Array) {
              n[a].apply(n, b);
            } else {
              n[a](b);
            }
          }
        }
      }
    }
  };
  f.prototype.sendActionToCanvas = function(a, b) {
    if (this.list_of_graphcanvas) {
      for (var d = 0; d < this.list_of_graphcanvas.length; ++d) {
        var g = this.list_of_graphcanvas[d];
        g[a] && g[a].apply(g, b);
      }
    }
  };
  f.prototype.add = function(a, b) {
    if (a) {
      -1 != a.id && null != this._nodes_by_id[a.id] && (console.warn("LiteGraph: there is already a node with this ID, changing it"), a.id = ++this.last_node_id);
      if (this._nodes.length >= e.MAX_NUMBER_OF_NODES) {
        throw "LiteGraph: max number of nodes in a graph reached";
      }
      null == a.id || -1 == a.id ? a.id = ++this.last_node_id : this.last_node_id < a.id && (this.last_node_id = a.id);
      a.graph = this;
      this._nodes.push(a);
      this._nodes_by_id[a.id] = a;
      if (a.onAdded) {
        a.onAdded(this);
      }
      this.config.align_to_grid && a.alignToGrid();
      b || this.updateExecutionOrder();
      if (this.onNodeAdded) {
        this.onNodeAdded(a);
      }
      this.setDirtyCanvas(!0);
      this.change();
      return a;
    }
  };
  f.prototype.remove = function(a) {
    if (null != this._nodes_by_id[a.id] && !a.ignore_remove) {
      if (a.inputs) {
        for (var b = 0; b < a.inputs.length; b++) {
          var d = a.inputs[b];
          null != d.link && a.disconnectInput(b);
        }
      }
      if (a.outputs) {
        for (b = 0; b < a.outputs.length; b++) {
          d = a.outputs[b], null != d.links && d.links.length && a.disconnectOutput(b);
        }
      }
      if (a.onRemoved) {
        a.onRemoved();
      }
      a.graph = null;
      if (this.list_of_graphcanvas) {
        for (b = 0; b < this.list_of_graphcanvas.length; ++b) {
          d = this.list_of_graphcanvas[b], d.selected_nodes[a.id] && delete d.selected_nodes[a.id], d.node_dragged == a && (d.node_dragged = null);
        }
      }
      b = this._nodes.indexOf(a);
      -1 != b && this._nodes.splice(b, 1);
      delete this._nodes_by_id[a.id];
      if (this.onNodeRemoved) {
        this.onNodeRemoved(a);
      }
      this.setDirtyCanvas(!0, !0);
      this.change();
      this.updateExecutionOrder();
    }
  };
  f.prototype.getNodeById = function(a) {
    return null == a ? null : this._nodes_by_id[a];
  };
  f.prototype.findNodesByClass = function(a) {
    for (var b = [], d = 0, g = this._nodes.length; d < g; ++d) {
      this._nodes[d].constructor === a && b.push(this._nodes[d]);
    }
    return b;
  };
  f.prototype.findNodesByType = function(a) {
    a = a.toLowerCase();
    for (var b = [], d = 0, g = this._nodes.length; d < g; ++d) {
      this._nodes[d].type.toLowerCase() == a && b.push(this._nodes[d]);
    }
    return b;
  };
  f.prototype.findNodesByTitle = function(a) {
    for (var b = [], d = 0, g = this._nodes.length; d < g; ++d) {
      this._nodes[d].title == a && b.push(this._nodes[d]);
    }
    return b;
  };
  f.prototype.getNodeOnPos = function(a, b, d) {
    d = d || this._nodes;
    for (var g = d.length - 1; 0 <= g; g--) {
      var e = d[g];
      if (e.isPointInsideNode(a, b, 2)) {
        return e;
      }
    }
    return null;
  };
  f.prototype.addGlobalInput = function(a, b, d) {
    this.global_inputs[a] = {name:a, type:b, value:d};
    if (this.onGlobalInputAdded) {
      this.onGlobalInputAdded(a, b);
    }
    if (this.onGlobalsChange) {
      this.onGlobalsChange();
    }
  };
  f.prototype.setGlobalInputData = function(a, b) {
    if (a = this.global_inputs[a]) {
      a.value = b;
    }
  };
  f.prototype.getGlobalInputData = function(a) {
    return (a = this.global_inputs[a]) ? a.value : null;
  };
  f.prototype.renameGlobalInput = function(a, b) {
    if (b != a) {
      if (!this.global_inputs[a]) {
        return !1;
      }
      if (this.global_inputs[b]) {
        return console.error("there is already one input with that name"), !1;
      }
      this.global_inputs[b] = this.global_inputs[a];
      delete this.global_inputs[a];
      if (this.onGlobalInputRenamed) {
        this.onGlobalInputRenamed(a, b);
      }
      if (this.onGlobalsChange) {
        this.onGlobalsChange();
      }
    }
  };
  f.prototype.changeGlobalInputType = function(a, b) {
    if (!this.global_inputs[a]) {
      return !1;
    }
    if (this.global_inputs[a].type.toLowerCase() != b.toLowerCase() && (this.global_inputs[a].type = b, this.onGlobalInputTypeChanged)) {
      this.onGlobalInputTypeChanged(a, b);
    }
  };
  f.prototype.removeGlobalInput = function(a) {
    if (!this.global_inputs[a]) {
      return !1;
    }
    delete this.global_inputs[a];
    if (this.onGlobalInputRemoved) {
      this.onGlobalInputRemoved(a);
    }
    if (this.onGlobalsChange) {
      this.onGlobalsChange();
    }
    return !0;
  };
  f.prototype.addGlobalOutput = function(a, b, d) {
    this.global_outputs[a] = {name:a, type:b, value:d};
    if (this.onGlobalOutputAdded) {
      this.onGlobalOutputAdded(a, b);
    }
    if (this.onGlobalsChange) {
      this.onGlobalsChange();
    }
  };
  f.prototype.setGlobalOutputData = function(a, b) {
    if (a = this.global_outputs[a]) {
      a.value = b;
    }
  };
  f.prototype.getGlobalOutputData = function(a) {
    return (a = this.global_outputs[a]) ? a.value : null;
  };
  f.prototype.renameGlobalOutput = function(a, b) {
    if (!this.global_outputs[a]) {
      return !1;
    }
    if (this.global_outputs[b]) {
      return console.error("there is already one output with that name"), !1;
    }
    this.global_outputs[b] = this.global_outputs[a];
    delete this.global_outputs[a];
    if (this.onGlobalOutputRenamed) {
      this.onGlobalOutputRenamed(a, b);
    }
    if (this.onGlobalsChange) {
      this.onGlobalsChange();
    }
  };
  f.prototype.changeGlobalOutputType = function(a, b) {
    if (!this.global_outputs[a]) {
      return !1;
    }
    if (this.global_outputs[a].type.toLowerCase() != b.toLowerCase() && (this.global_outputs[a].type = b, this.onGlobalOutputTypeChanged)) {
      this.onGlobalOutputTypeChanged(a, b);
    }
  };
  f.prototype.removeGlobalOutput = function(a) {
    if (!this.global_outputs[a]) {
      return !1;
    }
    delete this.global_outputs[a];
    if (this.onGlobalOutputRemoved) {
      this.onGlobalOutputRemoved(a);
    }
    if (this.onGlobalsChange) {
      this.onGlobalsChange();
    }
    return !0;
  };
  f.prototype.setInputData = function(a, b) {
    a = this.findNodesByName(a);
    for (var d = 0, g = a.length; d < g; ++d) {
      a[d].setValue(b);
    }
  };
  f.prototype.getOutputData = function(a) {
    return this.findNodesByName(a).length ? m[0].getValue() : null;
  };
  f.prototype.triggerInput = function(a, b) {
    a = this.findNodesByName(a);
    for (var d = 0; d < a.length; ++d) {
      a[d].onTrigger(b);
    }
  };
  f.prototype.setCallback = function(a, b) {
    a = this.findNodesByName(a);
    for (var d = 0; d < a.length; ++d) {
      a[d].setTrigger(b);
    }
  };
  f.prototype.connectionChange = function(a) {
    this.updateExecutionOrder();
    if (this.onConnectionChange) {
      this.onConnectionChange(a);
    }
    this.sendActionToCanvas("onConnectionChange");
  };
  f.prototype.isLive = function() {
    if (!this.list_of_graphcanvas) {
      return !1;
    }
    for (var a = 0; a < this.list_of_graphcanvas.length; ++a) {
      if (this.list_of_graphcanvas[a].live_mode) {
        return !0;
      }
    }
    return !1;
  };
  f.prototype.change = function() {
    e.debug && console.log("Graph changed");
    this.sendActionToCanvas("setDirty", [!0, !0]);
    if (this.on_change) {
      this.on_change(this);
    }
  };
  f.prototype.setDirtyCanvas = function(a, b) {
    this.sendActionToCanvas("setDirty", [a, b]);
  };
  f.prototype.serialize = function() {
    for (var a = [], b = 0, d = this._nodes.length; b < d; ++b) {
      a.push(this._nodes[b].serialize());
    }
    d = [];
    for (b in this.links) {
      var g = this.links[b];
      d.push([g.id, g.origin_id, g.origin_slot, g.target_id, g.target_slot, g.type]);
    }
    return {iteration:this.iteration, frame:this.frame, last_node_id:this.last_node_id, last_link_id:this.last_link_id, links:d, config:this.config, nodes:a};
  };
  f.prototype.configure = function(a, b) {
    b || this.clear();
    b = a.nodes;
    if (a.links && a.links.constructor === Array) {
      for (var d = {}, g = 0; g < a.links.length; ++g) {
        var h = a.links[g];
        d[h[0]] = {id:h[0], origin_id:h[1], origin_slot:h[2], target_id:h[3], target_slot:h[4], type:h[5]};
      }
      a.links = d;
    }
    for (g in a) {
      this[g] = a[g];
    }
    a = !1;
    this._nodes = [];
    g = 0;
    for (d = b.length; g < d; ++g) {
      h = b[g];
      var c = e.createNode(h.type, h.title);
      c ? (c.id = h.id, this.add(c, !0)) : (e.debug && console.log("Node not found: " + h.type), a = !0);
    }
    g = 0;
    for (d = b.length; g < d; ++g) {
      h = b[g], (c = this.getNodeById(h.id)) && c.configure(h);
    }
    this.updateExecutionOrder();
    this.setDirtyCanvas(!0, !0);
    return a;
  };
  f.prototype.load = function(a) {
    var b = this, d = new XMLHttpRequest;
    d.open("GET", a, !0);
    d.send(null);
    d.onload = function(a) {
      200 !== d.status ? console.error("Error loading graph:", d.status, d.response) : (a = JSON.parse(d.response), b.configure(a));
    };
    d.onerror = function(a) {
      console.error("Error loading graph:", a);
    };
  };
  f.prototype.onNodeTrace = function(a, b, d) {
  };
  u.LGraphNode = e.LGraphNode = k;
  k.prototype._ctor = function(a) {
    this.title = a || "Unnamed";
    this.size = [e.NODE_WIDTH, 60];
    this.graph = null;
    this._pos = new Float32Array(10, 10);
    Object.defineProperty(this, "pos", {set:function(a) {
      !a || 2 > !a.length || (this._pos[0] = a[0], this._pos[1] = a[1]);
    }, get:function() {
      return this._pos;
    }, enumerable:!0});
    this.id = -1;
    this.type = null;
    this.inputs = [];
    this.outputs = [];
    this.connections = [];
    this.properties = {};
    this.properties_info = [];
    this.data = null;
    this.flags = {};
  };
  k.prototype.configure = function(a) {
    for (var b in a) {
      if ("console" != b) {
        if ("properties" == b) {
          for (var d in a.properties) {
            if (this.properties[d] = a.properties[d], this.onPropertyChanged) {
              this.onPropertyChanged(d, a.properties[d]);
            }
          }
        } else {
          null != a[b] && ("object" == typeof a[b] ? this[b] && this[b].configure ? this[b].configure(a[b]) : this[b] = e.cloneObject(a[b], this[b]) : this[b] = a[b]);
        }
      }
    }
    if (this.onConnectionsChange) {
      if (this.inputs) {
        for (var g = 0; g < this.inputs.length; ++g) {
          d = this.inputs[g];
          var h = this.graph.links[d.link];
          this.onConnectionsChange(e.INPUT, g, !0, h, d);
        }
      }
      if (this.outputs) {
        for (g = 0; g < this.outputs.length; ++g) {
          if (d = this.outputs[g], d.links) {
            for (b = 0; b < d.links.length; ++b) {
              h = this.graph.links[d.links[b]], this.onConnectionsChange(e.OUTPUT, g, !0, h, d);
            }
          }
        }
      }
    }
    for (g in this.inputs) {
      d = this.inputs[g], d.link && d.link.length && (h = d.link, "object" == typeof h && (d.link = h[0], this.graph.links[h[0]] = {id:h[0], origin_id:h[1], origin_slot:h[2], target_id:h[3], target_slot:h[4]}));
    }
    for (g in this.outputs) {
      if (d = this.outputs[g], d.links && 0 != d.links.length) {
        for (b in d.links) {
          h = d.links[b], "object" == typeof h && (d.links[b] = h[0]);
        }
      }
    }
    if (this.onConfigure) {
      this.onConfigure(a);
    }
  };
  k.prototype.serialize = function() {
    if (this.outputs) {
      for (var a = 0; a < this.outputs.length; a++) {
        delete this.outputs[a]._data;
      }
    }
    a = {id:this.id, title:this.title, type:this.type, pos:this.pos, size:this.size, data:this.data, flags:e.cloneObject(this.flags), inputs:this.inputs, outputs:this.outputs, mode:this.mode};
    this.properties && (a.properties = e.cloneObject(this.properties));
    a.type || (a.type = this.constructor.type);
    this.color && (a.color = this.color);
    this.bgcolor && (a.bgcolor = this.bgcolor);
    this.boxcolor && (a.boxcolor = this.boxcolor);
    this.shape && (a.shape = this.shape);
    if (this.onSerialize) {
      this.onSerialize(a);
    }
    return a;
  };
  k.prototype.clone = function() {
    var a = e.createNode(this.type), b = e.cloneObject(this.serialize());
    if (b.inputs) {
      for (var d = 0; d < b.inputs.length; ++d) {
        b.inputs[d].link = null;
      }
    }
    if (b.outputs) {
      for (d = 0; d < b.outputs.length; ++d) {
        b.outputs[d].links && (b.outputs[d].links.length = 0);
      }
    }
    delete b.id;
    a.configure(b);
    return a;
  };
  k.prototype.toString = function() {
    return JSON.stringify(this.serialize());
  };
  k.prototype.getTitle = function() {
    return this.title || this.constructor.title;
  };
  k.prototype.setOutputData = function(a, b) {
    if (this.outputs && !(-1 == a || a >= this.outputs.length)) {
      var d = this.outputs[a];
      if (d && (d._data = b, this.outputs[a].links)) {
        for (d = 0; d < this.outputs[a].links.length; d++) {
          this.graph.links[this.outputs[a].links[d]].data = b;
        }
      }
    }
  };
  k.prototype.getInputData = function(a, b) {
    if (this.inputs && !(a >= this.inputs.length || null == this.inputs[a].link)) {
      a = this.graph.links[this.inputs[a].link];
      if (!a) {
        return null;
      }
      if (!b) {
        return a.data;
      }
      b = this.graph.getNodeById(a.origin_id);
      if (!b) {
        return a.data;
      }
      if (b.updateOutputData) {
        b.updateOutputData(a.origin_slot);
      } else {
        if (b.onExecute) {
          b.onExecute();
        }
      }
      return a.data;
    }
  };
  k.prototype.isInputConnected = function(a) {
    return this.inputs ? a < this.inputs.length && null != this.inputs[a].link : !1;
  };
  k.prototype.getInputInfo = function(a) {
    return this.inputs ? a < this.inputs.length ? this.inputs[a] : null : null;
  };
  k.prototype.getInputNode = function(a) {
    if (!this.inputs || a >= this.inputs.length) {
      return null;
    }
    a = this.inputs[a];
    return a && a.link ? (a = this.graph.links[a.link]) ? this.graph.getNodeById(a.origin_id) : null : null;
  };
  k.prototype.getOutputData = function(a) {
    return !this.outputs || a >= this.outputs.length ? null : this.outputs[a]._data;
  };
  k.prototype.getOutputInfo = function(a) {
    return this.outputs ? a < this.outputs.length ? this.outputs[a] : null : null;
  };
  k.prototype.isOutputConnected = function(a) {
    return this.outputs ? a < this.outputs.length && this.outputs[a].links && this.outputs[a].links.length : null;
  };
  k.prototype.getOutputNodes = function(a) {
    if (!this.outputs || 0 == this.outputs.length || a >= this.outputs.length) {
      return null;
    }
    a = this.outputs[a];
    if (!a.links || 0 == a.links.length) {
      return null;
    }
    for (var b = [], d = 0; d < a.links.length; d++) {
      var g = this.graph.links[a.links[d]];
      g && (g = this.graph.getNodeById(g.target_id)) && b.push(g);
    }
    return b;
  };
  k.prototype.trigger = function(a, b) {
    if (this.outputs && this.outputs.length) {
      this.graph && (this.graph._last_trigger_time = e.getTime());
      for (var d = 0; d < this.outputs.length; ++d) {
        var g = this.outputs[d];
        !g || g.type !== e.EVENT || a && g.name != a || this.triggerSlot(d, b);
      }
    }
  };
  k.prototype.triggerSlot = function(a, b) {
    if (this.outputs && (a = this.outputs[a]) && (a = a.links) && a.length) {
      this.graph && (this.graph._last_trigger_time = e.getTime());
      for (var d = 0; d < a.length; ++d) {
        var g = this.graph.links[a[d]];
        if (g) {
          var h = this.graph.getNodeById(g.target_id);
          if (h) {
            if (g._last_time = e.getTime(), g = h.inputs[g.target_slot], h.onAction) {
              h.onAction(g.name, b);
            } else {
              if (h.mode === e.ON_TRIGGER && h.onExecute) {
                h.onExecute(b);
              }
            }
          }
        }
      }
    }
  };
  k.prototype.addProperty = function(a, b, d, g) {
    d = {name:a, type:d, default_value:b};
    if (g) {
      for (var e in g) {
        d[e] = g[e];
      }
    }
    this.properties_info || (this.properties_info = []);
    this.properties_info.push(d);
    this.properties || (this.properties = {});
    this.properties[a] = b;
    return d;
  };
  k.prototype.addOutput = function(a, b, d) {
    a = {name:a, type:b, links:null};
    if (d) {
      for (var e in d) {
        a[e] = d[e];
      }
    }
    this.outputs || (this.outputs = []);
    this.outputs.push(a);
    if (this.onOutputAdded) {
      this.onOutputAdded(a);
    }
    this.size = this.computeSize();
    return a;
  };
  k.prototype.addOutputs = function(a) {
    for (var b = 0; b < a.length; ++b) {
      var d = a[b], e = {name:d[0], type:d[1], link:null};
      if (a[2]) {
        for (var h in d[2]) {
          e[h] = d[2][h];
        }
      }
      this.outputs || (this.outputs = []);
      this.outputs.push(e);
      if (this.onOutputAdded) {
        this.onOutputAdded(e);
      }
    }
    this.size = this.computeSize();
  };
  k.prototype.removeOutput = function(a) {
    this.disconnectOutput(a);
    this.outputs.splice(a, 1);
    this.size = this.computeSize();
    if (this.onOutputRemoved) {
      this.onOutputRemoved(a);
    }
  };
  k.prototype.addInput = function(a, b, d) {
    a = {name:a, type:b || 0, link:null};
    if (d) {
      for (var e in d) {
        a[e] = d[e];
      }
    }
    this.inputs || (this.inputs = []);
    this.inputs.push(a);
    this.size = this.computeSize();
    if (this.onInputAdded) {
      this.onInputAdded(a);
    }
    return a;
  };
  k.prototype.addInputs = function(a) {
    for (var b = 0; b < a.length; ++b) {
      var d = a[b], e = {name:d[0], type:d[1], link:null};
      if (a[2]) {
        for (var h in d[2]) {
          e[h] = d[2][h];
        }
      }
      this.inputs || (this.inputs = []);
      this.inputs.push(e);
      if (this.onInputAdded) {
        this.onInputAdded(e);
      }
    }
    this.size = this.computeSize();
  };
  k.prototype.removeInput = function(a) {
    this.disconnectInput(a);
    this.inputs.splice(a, 1);
    this.size = this.computeSize();
    if (this.onInputRemoved) {
      this.onInputRemoved(a);
    }
  };
  k.prototype.addConnection = function(a, b, d, e) {
    a = {name:a, type:b, pos:d, direction:e, links:null};
    this.connections.push(a);
    return a;
  };
  k.prototype.computeSize = function(a, b) {
    a = Math.max(this.inputs ? this.inputs.length : 1, this.outputs ? this.outputs.length : 1);
    b = b || new Float32Array([0, 0]);
    a = Math.max(a, 1);
    b[1] = 14 * a + 6;
    a = (a = this.title) ? 8.4 * a.length : 0;
    var d = 0, g = 0;
    if (this.inputs) {
      for (var h = 0, c = this.inputs.length; h < c; ++h) {
        var n = this.inputs[h];
        n = (n = n.label || n.name || "") ? 8.4 * n.length : 0;
        d < n && (d = n);
      }
    }
    if (this.outputs) {
      for (h = 0, c = this.outputs.length; h < c; ++h) {
        n = this.outputs[h], n = (n = n.label || n.name || "") ? 8.4 * n.length : 0, g < n && (g = n);
      }
    }
    b[0] = Math.max(d + g + 10, a);
    b[0] = Math.max(b[0], e.NODE_WIDTH);
    return b;
  };
  k.prototype.getBounding = function(a) {
    a = a || new Float32Array(4);
    a[0] = this.pos[0] - 4;
    a[1] = this.pos[1] - e.NODE_TITLE_HEIGHT;
    a[2] = this.size[0] + 4;
    a[3] = this.size[1] + e.NODE_TITLE_HEIGHT;
    return a;
  };
  k.prototype.isPointInsideNode = function(a, b, d) {
    d = d || 0;
    var g = this.graph && this.graph.isLive() ? 0 : 20;
    if (this.flags.collapsed) {
      if (t(a, b, this.pos[0] - d, this.pos[1] - e.NODE_TITLE_HEIGHT - d, e.NODE_COLLAPSED_WIDTH + 2 * d, e.NODE_TITLE_HEIGHT + 2 * d)) {
        return !0;
      }
    } else {
      if (this.pos[0] - 4 - d < a && this.pos[0] + this.size[0] + 4 + d > a && this.pos[1] - g - d < b && this.pos[1] + this.size[1] + d > b) {
        return !0;
      }
    }
    return !1;
  };
  k.prototype.getSlotInPosition = function(a, b) {
    if (this.inputs) {
      for (var d = 0, e = this.inputs.length; d < e; ++d) {
        var h = this.inputs[d], c = this.getConnectionPos(!0, d);
        if (t(a, b, c[0] - 10, c[1] - 5, 20, 10)) {
          return {input:h, slot:d, link_pos:c, locked:h.locked};
        }
      }
    }
    if (this.outputs) {
      for (d = 0, e = this.outputs.length; d < e; ++d) {
        if (h = this.outputs[d], c = this.getConnectionPos(!1, d), t(a, b, c[0] - 10, c[1] - 5, 20, 10)) {
          return {output:h, slot:d, link_pos:c, locked:h.locked};
        }
      }
    }
    return null;
  };
  k.prototype.findInputSlot = function(a) {
    if (!this.inputs) {
      return -1;
    }
    for (var b = 0, d = this.inputs.length; b < d; ++b) {
      if (a == this.inputs[b].name) {
        return b;
      }
    }
    return -1;
  };
  k.prototype.findOutputSlot = function(a) {
    if (!this.outputs) {
      return -1;
    }
    for (var b = 0, d = this.outputs.length; b < d; ++b) {
      if (a == this.outputs[b].name) {
        return b;
      }
    }
    return -1;
  };
  k.prototype.connect = function(a, b, d) {
    d = d || 0;
    if (a.constructor === String) {
      if (a = this.findOutputSlot(a), -1 == a) {
        return e.debug && console.log("Connect: Error, no slot of name " + a), !1;
      }
    } else {
      if (!this.outputs || a >= this.outputs.length) {
        return e.debug && console.log("Connect: Error, slot number not found"), !1;
      }
    }
    b && b.constructor === Number && (b = this.graph.getNodeById(b));
    if (!b) {
      throw "Node not found";
    }
    if (b == this) {
      return !1;
    }
    if (d.constructor === String) {
      if (d = b.findInputSlot(d), -1 == d) {
        return e.debug && console.log("Connect: Error, no slot of name " + d), !1;
      }
    } else {
      if (d === e.EVENT) {
        return !1;
      }
      if (!b.inputs || d >= b.inputs.length) {
        return e.debug && console.log("Connect: Error, slot number not found"), !1;
      }
    }
    null != b.inputs[d].link && b.disconnectInput(d);
    this.setDirtyCanvas(!1, !0);
    this.graph.connectionChange(this);
    var g = this.outputs[a];
    if (b.onConnectInput && !1 === b.onConnectInput(d, g.type, g)) {
      return !1;
    }
    var h = b.inputs[d];
    if (e.isValidConnection(g.type, h.type)) {
      var c = {id:this.graph.last_link_id++, type:h.type, origin_id:this.id, origin_slot:a, target_id:b.id, target_slot:d};
      this.graph.links[c.id] = c;
      null == g.links && (g.links = []);
      g.links.push(c.id);
      b.inputs[d].link = c.id;
      if (this.onConnectionsChange) {
        this.onConnectionsChange(e.OUTPUT, a, !0, c, g);
      }
      if (b.onConnectionsChange) {
        b.onConnectionsChange(e.INPUT, d, !0, c, h);
      }
    }
    this.setDirtyCanvas(!1, !0);
    this.graph.connectionChange(this);
    return !0;
  };
  k.prototype.disconnectOutput = function(a, b) {
    if (a.constructor === String) {
      if (a = this.findOutputSlot(a), -1 == a) {
        return e.debug && console.log("Connect: Error, no slot of name " + a), !1;
      }
    } else {
      if (!this.outputs || a >= this.outputs.length) {
        return e.debug && console.log("Connect: Error, slot number not found"), !1;
      }
    }
    var d = this.outputs[a];
    if (!d.links || 0 == d.links.length) {
      return !1;
    }
    if (b) {
      b.constructor === Number && (b = this.graph.getNodeById(b));
      if (!b) {
        throw "Target Node not found";
      }
      for (var g = 0, h = d.links.length; g < h; g++) {
        var c = d.links[g], n = this.graph.links[c];
        if (n.target_id == b.id) {
          d.links.splice(g, 1);
          var l = b.inputs[n.target_slot];
          l.link = null;
          delete this.graph.links[c];
          if (b.onConnectionsChange) {
            b.onConnectionsChange(e.INPUT, n.target_slot, !1, n, l);
          }
          if (this.onConnectionsChange) {
            this.onConnectionsChange(e.OUTPUT, a, !1, n, d);
          }
          break;
        }
      }
    } else {
      g = 0;
      for (h = d.links.length; g < h; g++) {
        if (c = d.links[g], n = this.graph.links[c]) {
          if (b = this.graph.getNodeById(n.target_id)) {
            if (l = b.inputs[n.target_slot], l.link = null, b.onConnectionsChange) {
              b.onConnectionsChange(e.INPUT, n.target_slot, !1, n, l);
            }
          }
          delete this.graph.links[c];
          if (this.onConnectionsChange) {
            this.onConnectionsChange(e.OUTPUT, a, !1, n, d);
          }
        }
      }
      d.links = null;
    }
    this.setDirtyCanvas(!1, !0);
    this.graph.connectionChange(this);
    return !0;
  };
  k.prototype.disconnectInput = function(a) {
    if (a.constructor === String) {
      if (a = this.findInputSlot(a), -1 == a) {
        return e.debug && console.log("Connect: Error, no slot of name " + a), !1;
      }
    } else {
      if (!this.inputs || a >= this.inputs.length) {
        return e.debug && console.log("Connect: Error, slot number not found"), !1;
      }
    }
    var b = this.inputs[a];
    if (!b) {
      return !1;
    }
    var d = this.inputs[a].link;
    this.inputs[a].link = null;
    var g = this.graph.links[d];
    if (g) {
      var h = this.graph.getNodeById(g.origin_id);
      if (!h) {
        return !1;
      }
      var c = h.outputs[g.origin_slot];
      if (!c || !c.links || 0 == c.links.length) {
        return !1;
      }
      for (var n = 0, l = c.links.length; n < l; n++) {
        if (c.links[n] == d) {
          c.links.splice(n, 1);
          break;
        }
      }
      delete this.graph.links[d];
      if (this.onConnectionsChange) {
        this.onConnectionsChange(e.INPUT, a, !1, g, b);
      }
      if (h.onConnectionsChange) {
        h.onConnectionsChange(e.OUTPUT, n, !1, g, c);
      }
    }
    this.setDirtyCanvas(!1, !0);
    this.graph.connectionChange(this);
    return !0;
  };
  k.prototype.getConnectionPos = function(a, b) {
    return this.flags.collapsed ? a ? [this.pos[0], this.pos[1] - 0.5 * e.NODE_TITLE_HEIGHT] : [this.pos[0] + e.NODE_COLLAPSED_WIDTH, this.pos[1] - 0.5 * e.NODE_TITLE_HEIGHT] : a && -1 == b ? [this.pos[0] + 10, this.pos[1] + 10] : a && this.inputs.length > b && this.inputs[b].pos ? [this.pos[0] + this.inputs[b].pos[0], this.pos[1] + this.inputs[b].pos[1]] : !a && this.outputs.length > b && this.outputs[b].pos ? [this.pos[0] + this.outputs[b].pos[0], this.pos[1] + this.outputs[b].pos[1]] : a ? [this.pos[0], 
    this.pos[1] + 10 + b * e.NODE_SLOT_HEIGHT] : [this.pos[0] + this.size[0] + 1, this.pos[1] + 10 + b * e.NODE_SLOT_HEIGHT];
  };
  k.prototype.alignToGrid = function() {
    this.pos[0] = e.CANVAS_GRID_SIZE * Math.round(this.pos[0] / e.CANVAS_GRID_SIZE);
    this.pos[1] = e.CANVAS_GRID_SIZE * Math.round(this.pos[1] / e.CANVAS_GRID_SIZE);
  };
  k.prototype.trace = function(a) {
    this.console || (this.console = []);
    this.console.push(a);
    this.console.length > k.MAX_CONSOLE && this.console.shift();
    this.graph.onNodeTrace(this, a);
  };
  k.prototype.setDirtyCanvas = function(a, b) {
    this.graph && this.graph.sendActionToCanvas("setDirty", [a, b]);
  };
  k.prototype.loadImage = function(a) {
    var b = new Image;
    b.src = e.node_images_path + a;
    b.ready = !1;
    var d = this;
    b.onload = function() {
      this.ready = !0;
      d.setDirtyCanvas(!0);
    };
    return b;
  };
  k.prototype.captureInput = function(a) {
    if (this.graph && this.graph.list_of_graphcanvas) {
      for (var b = this.graph.list_of_graphcanvas, d = 0; d < b.length; ++d) {
        var e = b[d];
        if (a || e.node_capturing_input == this) {
          e.node_capturing_input = a ? this : null;
        }
      }
    }
  };
  k.prototype.collapse = function() {
    this.flags.collapsed = this.flags.collapsed ? !1 : !0;
    this.setDirtyCanvas(!0, !0);
  };
  k.prototype.pin = function(a) {
    this.flags.pinned = void 0 === a ? !this.flags.pinned : a;
  };
  k.prototype.localToScreen = function(a, b, d) {
    return [(a + this.pos[0]) * d.scale + d.offset[0], (b + this.pos[1]) * d.scale + d.offset[1]];
  };
  u.LGraphCanvas = e.LGraphCanvas = c;
  c.link_type_colors = {"-1":"#F85", number:"#AAC", node:"#DCA"};
  c.prototype.clear = function() {
    this.fps = this.render_time = this.last_draw_time = this.frame = 0;
    this.scale = 1;
    this.offset = [0, 0];
    this.dragging_rectangle = null;
    this.selected_nodes = {};
    this.visible_nodes = [];
    this.connecting_node = this.node_capturing_input = this.node_over = this.node_dragged = null;
    this.highlighted_links = {};
    this.dirty_bgcanvas = this.dirty_canvas = !0;
    this.node_in_panel = this.dirty_area = null;
    this.last_mouse = [0, 0];
    this.last_mouseclick = 0;
    if (this.onClear) {
      this.onClear();
    }
  };
  c.prototype.setGraph = function(a, b) {
    this.graph != a && (b || this.clear(), !a && this.graph ? this.graph.detachCanvas(this) : (a.attachCanvas(this), this.setDirty(!0, !0)));
  };
  c.prototype.openSubgraph = function(a) {
    if (!a) {
      throw "graph cannot be null";
    }
    if (this.graph == a) {
      throw "graph cannot be the same";
    }
    this.clear();
    this.graph && (this._graph_stack || (this._graph_stack = []), this._graph_stack.push(this.graph));
    a.attachCanvas(this);
    this.setDirty(!0, !0);
  };
  c.prototype.closeSubgraph = function() {
    if (this._graph_stack && 0 != this._graph_stack.length) {
      var a = this._graph_stack.pop();
      this.selected_nodes = {};
      this.highlighted_links = {};
      a.attachCanvas(this);
      this.setDirty(!0, !0);
    }
  };
  c.prototype.setCanvas = function(a, b) {
    if (a && a.constructor === String && (a = document.getElementById(a), !a)) {
      throw "Error creating LiteGraph canvas: Canvas not found";
    }
    if (a !== this.canvas && (!a && this.canvas && (b || this.unbindEvents()), this.canvas = a)) {
      a.className += " lgraphcanvas";
      a.data = this;
      this.bgcanvas = null;
      this.bgcanvas || (this.bgcanvas = document.createElement("canvas"), this.bgcanvas.width = this.canvas.width, this.bgcanvas.height = this.canvas.height);
      if (null == a.getContext) {
        if ("canvas" != a.localName) {
          throw "Element supplied for LGraphCanvas must be a <canvas> element, you passed a " + a.localName;
        }
        throw "This browser doesnt support Canvas";
      }
      null == (this.ctx = a.getContext("2d")) && (console.warn("This canvas seems to be WebGL, enabling WebGL renderer"), this.enableWebGL());
      this._mousemove_callback = this.processMouseMove.bind(this);
      this._mouseup_callback = this.processMouseUp.bind(this);
      b || this.bindEvents();
    }
  };
  c.prototype._doNothing = function(a) {
    a.preventDefault();
    return !1;
  };
  c.prototype._doReturnTrue = function(a) {
    a.preventDefault();
    return !0;
  };
  c.prototype.bindEvents = function() {
    if (this._events_binded) {
      console.warn("LGraphCanvas: events already binded");
    } else {
      var a = this.canvas, b = this.getCanvasWindow().document;
      this._mousedown_callback = this.processMouseDown.bind(this);
      this._mousewheel_callback = this.processMouseWheel.bind(this);
      a.addEventListener("mousedown", this._mousedown_callback, !0);
      a.addEventListener("mousemove", this._mousemove_callback);
      a.addEventListener("mousewheel", this._mousewheel_callback, !1);
      a.addEventListener("contextmenu", this._doNothing);
      a.addEventListener("DOMMouseScroll", this._mousewheel_callback, !1);
      a.addEventListener("touchstart", this.touchHandler, !0);
      a.addEventListener("touchmove", this.touchHandler, !0);
      a.addEventListener("touchend", this.touchHandler, !0);
      a.addEventListener("touchcancel", this.touchHandler, !0);
      this._key_callback = this.processKey.bind(this);
      a.addEventListener("keydown", this._key_callback, !0);
      b.addEventListener("keyup", this._key_callback, !0);
      this._ondrop_callback = this.processDrop.bind(this);
      a.addEventListener("dragover", this._doNothing, !1);
      a.addEventListener("dragend", this._doNothing, !1);
      a.addEventListener("drop", this._ondrop_callback, !1);
      a.addEventListener("dragenter", this._doReturnTrue, !1);
      this._events_binded = !0;
    }
  };
  c.prototype.unbindEvents = function() {
    if (this._events_binded) {
      var a = this.getCanvasWindow().document;
      this.canvas.removeEventListener("mousedown", this._mousedown_callback);
      this.canvas.removeEventListener("mousewheel", this._mousewheel_callback);
      this.canvas.removeEventListener("DOMMouseScroll", this._mousewheel_callback);
      this.canvas.removeEventListener("keydown", this._key_callback);
      a.removeEventListener("keyup", this._key_callback);
      this.canvas.removeEventListener("contextmenu", this._doNothing);
      this.canvas.removeEventListener("drop", this._ondrop_callback);
      this.canvas.removeEventListener("dragenter", this._doReturnTrue);
      this.canvas.removeEventListener("touchstart", this.touchHandler);
      this.canvas.removeEventListener("touchmove", this.touchHandler);
      this.canvas.removeEventListener("touchend", this.touchHandler);
      this.canvas.removeEventListener("touchcancel", this.touchHandler);
      this._ondrop_callback = this._key_callback = this._mousewheel_callback = this._mousedown_callback = null;
      this._events_binded = !1;
    } else {
      console.warn("LGraphCanvas: no events binded");
    }
  };
  c.getFileExtension = function(a) {
    var b = a.indexOf("?");
    -1 != b && (a = a.substr(0, b));
    b = a.lastIndexOf(".");
    return -1 == b ? "" : a.substr(b + 1).toLowerCase();
  };
  c.prototype.enableWebGL = function() {
    this.gl = this.ctx = enableWebGLCanvas(this.canvas);
    this.ctx.webgl = !0;
    this.bgcanvas = this.canvas;
    this.bgctx = this.gl;
  };
  c.prototype.setDirty = function(a, b) {
    a && (this.dirty_canvas = !0);
    b && (this.dirty_bgcanvas = !0);
  };
  c.prototype.getCanvasWindow = function() {
    if (!this.canvas) {
      return window;
    }
    var a = this.canvas.ownerDocument;
    return a.defaultView || a.parentWindow;
  };
  c.prototype.startRendering = function() {
    function a() {
      this.pause_rendering || this.draw();
      var b = this.getCanvasWindow();
      this.is_rendering && b.requestAnimationFrame(a.bind(this));
    }
    this.is_rendering || (this.is_rendering = !0, a.call(this));
  };
  c.prototype.stopRendering = function() {
    this.is_rendering = !1;
  };
  c.prototype.processMouseDown = function(a) {
    if (this.graph) {
      this.adjustMouseEvent(a);
      var b = this.getCanvasWindow();
      c.active_canvas = this;
      this.canvas.removeEventListener("mousemove", this._mousemove_callback);
      b.document.addEventListener("mousemove", this._mousemove_callback, !0);
      b.document.addEventListener("mouseup", this._mouseup_callback, !0);
      var d = this.graph.getNodeOnPos(a.canvasX, a.canvasY, this.visible_nodes), g = !1;
      e.closeAllContextMenus(b);
      if (1 == a.which) {
        a.ctrlKey && (this.dragging_rectangle = new Float32Array(4), this.dragging_rectangle[0] = a.canvasX, this.dragging_rectangle[1] = a.canvasY, this.dragging_rectangle[2] = 1, this.dragging_rectangle[3] = 1, g = !0);
        var h = !1;
        if (d && this.allow_interaction && !g) {
          this.live_mode || d.flags.pinned || this.bringToFront(d);
          if (!this.connecting_node && !d.flags.collapsed && !this.live_mode) {
            if (d.outputs) {
              for (var l = 0, n = d.outputs.length; l < n; ++l) {
                var f = d.outputs[l], q = d.getConnectionPos(!1, l);
                if (t(a.canvasX, a.canvasY, q[0] - 10, q[1] - 5, 20, 10)) {
                  this.connecting_node = d;
                  this.connecting_output = f;
                  this.connecting_pos = d.getConnectionPos(!1, l);
                  this.connecting_slot = l;
                  g = !0;
                  break;
                }
              }
            }
            if (d.inputs) {
              for (l = 0, n = d.inputs.length; l < n; ++l) {
                f = d.inputs[l], q = d.getConnectionPos(!0, l), t(a.canvasX, a.canvasY, q[0] - 10, q[1] - 5, 20, 10) && null !== f.link && (d.disconnectInput(l), g = this.dirty_bgcanvas = !0);
              }
            }
            !g && t(a.canvasX, a.canvasY, d.pos[0] + d.size[0] - 5, d.pos[1] + d.size[1] - 5, 5, 5) && (this.resizing_node = d, this.canvas.style.cursor = "se-resize", g = !0);
          }
          !g && t(a.canvasX, a.canvasY, d.pos[0], d.pos[1] - e.NODE_TITLE_HEIGHT, e.NODE_TITLE_HEIGHT, e.NODE_TITLE_HEIGHT) && (d.collapse(), g = !0);
          if (!g) {
            l = !1;
            if (300 > e.getTime() - this.last_mouseclick && this.selected_nodes[d.id]) {
              if (d.onDblClick) {
                d.onDblClick(a);
              }
              this.processNodeDblClicked(d);
              l = !0;
            }
            d.onMouseDown && d.onMouseDown(a, [a.canvasX - d.pos[0], a.canvasY - d.pos[1]]) ? l = !0 : this.live_mode && (l = h = !0);
            l || (this.allow_dragnodes && (this.node_dragged = d), this.selected_nodes[d.id] || this.processNodeSelected(d, a));
            this.dirty_canvas = !0;
          }
        } else {
          h = !0;
        }
        !g && h && this.allow_dragcanvas && (this.dragging_canvas = !0);
      } else {
        2 != a.which && 3 == a.which && this.processContextMenu(d, a);
      }
      this.last_mouse[0] = a.localX;
      this.last_mouse[1] = a.localY;
      this.last_mouseclick = e.getTime();
      this.canvas_mouse = [a.canvasX, a.canvasY];
      this.graph.change();
      (!b.document.activeElement || "input" != b.document.activeElement.nodeName.toLowerCase() && "textarea" != b.document.activeElement.nodeName.toLowerCase()) && a.preventDefault();
      a.stopPropagation();
      if (this.onMouseDown) {
        this.onMouseDown(a);
      }
      return !1;
    }
  };
  c.prototype.processMouseMove = function(a) {
    this.autoresize && this.resize();
    if (this.graph) {
      c.active_canvas = this;
      this.adjustMouseEvent(a);
      var b = [a.localX, a.localY], d = [b[0] - this.last_mouse[0], b[1] - this.last_mouse[1]];
      this.last_mouse = b;
      this.canvas_mouse = [a.canvasX, a.canvasY];
      if (this.dragging_rectangle) {
        this.dragging_rectangle[2] = a.canvasX - this.dragging_rectangle[0], this.dragging_rectangle[3] = a.canvasY - this.dragging_rectangle[1], this.dirty_canvas = !0;
      } else {
        if (this.dragging_canvas) {
          this.offset[0] += d[0] / this.scale, this.offset[1] += d[1] / this.scale, this.dirty_bgcanvas = this.dirty_canvas = !0;
        } else {
          if (this.allow_interaction) {
            this.connecting_node && (this.dirty_canvas = !0);
            b = this.graph.getNodeOnPos(a.canvasX, a.canvasY, this.visible_nodes);
            for (var g = 0, h = this.graph._nodes.length; g < h; ++g) {
              if (this.graph._nodes[g].mouseOver && b != this.graph._nodes[g]) {
                this.graph._nodes[g].mouseOver = !1;
                if (this.node_over && this.node_over.onMouseLeave) {
                  this.node_over.onMouseLeave(a);
                }
                this.node_over = null;
                this.dirty_canvas = !0;
              }
            }
            if (b) {
              if (!b.mouseOver && (b.mouseOver = !0, this.node_over = b, this.dirty_canvas = !0, b.onMouseEnter)) {
                b.onMouseEnter(a);
              }
              if (b.onMouseMove) {
                b.onMouseMove(a);
              }
              if (this.connecting_node && (h = this._highlight_input || [0, 0], !this.isOverNodeBox(b, a.canvasX, a.canvasY))) {
                var l = this.isOverNodeInput(b, a.canvasX, a.canvasY, h);
                -1 != l && b.inputs[l] ? e.isValidConnection(this.connecting_output.type, b.inputs[l].type) && (this._highlight_input = h) : this._highlight_input = null;
              }
              t(a.canvasX, a.canvasY, b.pos[0] + b.size[0] - 5, b.pos[1] + b.size[1] - 5, 5, 5) ? this.canvas.style.cursor = "se-resize" : this.canvas.style.cursor = null;
            } else {
              this.canvas.style.cursor = null;
            }
            if (this.node_capturing_input && this.node_capturing_input != b && this.node_capturing_input.onMouseMove) {
              this.node_capturing_input.onMouseMove(a);
            }
            if (this.node_dragged && !this.live_mode) {
              for (g in this.selected_nodes) {
                b = this.selected_nodes[g], b.pos[0] += d[0] / this.scale, b.pos[1] += d[1] / this.scale;
              }
              this.dirty_bgcanvas = this.dirty_canvas = !0;
            }
            this.resizing_node && !this.live_mode && (this.resizing_node.size[0] += d[0] / this.scale, this.resizing_node.size[1] += d[1] / this.scale, d = Math.max(this.resizing_node.inputs ? this.resizing_node.inputs.length : 0, this.resizing_node.outputs ? this.resizing_node.outputs.length : 0), this.resizing_node.size[1] < d * e.NODE_SLOT_HEIGHT + 4 && (this.resizing_node.size[1] = d * e.NODE_SLOT_HEIGHT + 4), this.resizing_node.size[0] < e.NODE_MIN_WIDTH && (this.resizing_node.size[0] = e.NODE_MIN_WIDTH), 
            this.canvas.style.cursor = "se-resize", this.dirty_bgcanvas = this.dirty_canvas = !0);
          }
        }
      }
      a.preventDefault();
      return !1;
    }
  };
  c.prototype.processMouseUp = function(a) {
    if (this.graph) {
      var b = this.getCanvasWindow().document;
      c.active_canvas = this;
      b.removeEventListener("mousemove", this._mousemove_callback, !0);
      this.canvas.addEventListener("mousemove", this._mousemove_callback, !0);
      b.removeEventListener("mouseup", this._mouseup_callback, !0);
      this.adjustMouseEvent(a);
      if (1 == a.which) {
        if (this.dragging_rectangle) {
          if (this.graph) {
            var d = this.graph._nodes, g = new Float32Array(4);
            this.deselectAllNodes();
            0 > this.dragging_rectangle[2] && (this.dragging_rectangle[0] += this.dragging_rectangle[2]);
            0 > this.dragging_rectangle[3] && (this.dragging_rectangle[1] += this.dragging_rectangle[3]);
            this.dragging_rectangle[2] = Math.abs(this.dragging_rectangle[2] * this.scale);
            this.dragging_rectangle[3] = Math.abs(this.dragging_rectangle[3] * this.scale);
            for (var h = 0; h < d.length; ++h) {
              b = d[h], b.getBounding(g), v(this.dragging_rectangle, g) && this.selectNode(b, !0);
            }
          }
          this.dragging_rectangle = null;
        } else {
          if (this.connecting_node) {
            this.dirty_bgcanvas = this.dirty_canvas = !0;
            if (b = this.graph.getNodeOnPos(a.canvasX, a.canvasY, this.visible_nodes)) {
              this.connecting_output.type == e.EVENT && this.isOverNodeBox(b, a.canvasX, a.canvasY) ? this.connecting_node.connect(this.connecting_slot, b, e.EVENT) : (d = this.isOverNodeInput(b, a.canvasX, a.canvasY), -1 != d ? this.connecting_node.connect(this.connecting_slot, b, d) : (d = b.getInputInfo(0), this.connecting_output.type == e.EVENT ? this.connecting_node.connect(this.connecting_slot, b, e.EVENT) : d && !d.link && e.isValidConnection(d.type && this.connecting_output.type) && this.connecting_node.connect(this.connecting_slot, 
              b, 0)));
            }
            this.connecting_node = this.connecting_pos = this.connecting_output = null;
            this.connecting_slot = -1;
          } else {
            if (this.resizing_node) {
              this.dirty_bgcanvas = this.dirty_canvas = !0, this.resizing_node = null;
            } else {
              if (this.node_dragged) {
                this.dirty_bgcanvas = this.dirty_canvas = !0, this.node_dragged.pos[0] = Math.round(this.node_dragged.pos[0]), this.node_dragged.pos[1] = Math.round(this.node_dragged.pos[1]), this.graph.config.align_to_grid && this.node_dragged.alignToGrid(), this.node_dragged = null;
              } else {
                b = this.graph.getNodeOnPos(a.canvasX, a.canvasY, this.visible_nodes);
                d = e.getTime();
                !b && 300 > d - this.last_mouseclick && this.deselectAllNodes();
                this.dirty_canvas = !0;
                this.dragging_canvas = !1;
                if (this.node_over && this.node_over.onMouseUp) {
                  this.node_over.onMouseUp(a, [a.canvasX - this.node_over.pos[0], a.canvasY - this.node_over.pos[1]]);
                }
                if (this.node_capturing_input && this.node_capturing_input.onMouseUp) {
                  this.node_capturing_input.onMouseUp(a, [a.canvasX - this.node_capturing_input.pos[0], a.canvasY - this.node_capturing_input.pos[1]]);
                }
              }
            }
          }
        }
      } else {
        2 == a.which ? (this.dirty_canvas = !0, this.dragging_canvas = !1) : 3 == a.which && (this.dirty_canvas = !0, this.dragging_canvas = !1);
      }
      this.graph.change();
      a.stopPropagation();
      a.preventDefault();
      return !1;
    }
  };
  c.prototype.processMouseWheel = function(a) {
    if (this.graph && this.allow_dragcanvas) {
      var b = null != a.wheelDeltaY ? a.wheelDeltaY : -60 * a.detail;
      this.adjustMouseEvent(a);
      var d = this.scale;
      0 < b ? d *= 1.1 : 0 > b && (d *= 1 / 1.1);
      this.setZoom(d, [a.localX, a.localY]);
      this.graph.change();
      a.preventDefault();
      return !1;
    }
  };
  c.prototype.isOverNodeBox = function(a, b, d) {
    var g = e.NODE_TITLE_HEIGHT;
    return t(b, d, a.pos[0] + 2, a.pos[1] + 2 - g, g - 4, g - 4) ? !0 : !1;
  };
  c.prototype.isOverNodeInput = function(a, b, d, e) {
    if (a.inputs) {
      for (var g = 0, c = a.inputs.length; g < c; ++g) {
        var n = a.getConnectionPos(!0, g);
        if (t(b, d, n[0] - 10, n[1] - 5, 20, 10)) {
          return e && (e[0] = n[0], e[1] = n[1]), g;
        }
      }
    }
    return -1;
  };
  c.prototype.processKey = function(a) {
    if (this.graph) {
      var b = !1;
      if ("input" != a.target.localName) {
        if ("keydown" == a.type) {
          32 == a.keyCode && (b = this.dragging_canvas = !0);
          65 == a.keyCode && a.ctrlKey && (this.selectNodes(), b = !0);
          "KeyC" == a.code && (a.metaKey || a.ctrlKey) && !a.shiftKey && this.selected_nodes && (this.copyToClipboard(), b = !0);
          "KeyV" != a.code || !a.metaKey && !a.ctrlKey || a.shiftKey || this.pasteFromClipboard();
          if (46 == a.keyCode || 8 == a.keyCode) {
            this.deleteSelectedNodes(), b = !0;
          }
          if (this.selected_nodes) {
            for (var d in this.selected_nodes) {
              if (this.selected_nodes[d].onKeyDown) {
                this.selected_nodes[d].onKeyDown(a);
              }
            }
          }
        } else {
          if ("keyup" == a.type && (32 == a.keyCode && (this.dragging_canvas = !1), this.selected_nodes)) {
            for (d in this.selected_nodes) {
              if (this.selected_nodes[d].onKeyUp) {
                this.selected_nodes[d].onKeyUp(a);
              }
            }
          }
        }
        this.graph.change();
        if (b) {
          return a.preventDefault(), !1;
        }
      }
    }
  };
  c.prototype.copyToClipboard = function() {
    var a = {nodes:[], links:[]}, b = 0, d = [], e;
    for (e in this.selected_nodes) {
      var h = this.selected_nodes[e];
      h._relative_id = b;
      d.push(h);
      b += 1;
    }
    for (e = 0; e < d.length; ++e) {
      if (h = d[e], a.nodes.push(h.clone().serialize()), h.inputs && h.inputs.length) {
        for (b = 0; b < h.inputs.length; ++b) {
          var c = h.inputs[b];
          if (c && null != c.link && (c = this.graph.links[c.link])) {
            var n = this.graph.getNodeById(c.origin_id);
            n && this.selected_nodes[n.id] && a.links.push([n._relative_id, b, h._relative_id, c.target_slot]);
          }
        }
      }
    }
    localStorage.setItem("litegrapheditor_clipboard", JSON.stringify(a));
  };
  c.prototype.pasteFromClipboard = function() {
    var a = localStorage.getItem("litegrapheditor_clipboard");
    if (a) {
      a = JSON.parse(a);
      for (var b = [], d = 0; d < a.nodes.length; ++d) {
        var g = a.nodes[d], h = e.createNode(g.type);
        h && (h.configure(g), h.pos[0] += 5, h.pos[1] += 5, this.graph.add(h), b.push(h));
      }
      for (d = 0; d < a.links.length; ++d) {
        g = a.links[d], b[g[0]].connect(g[1], b[g[2]], g[3]);
      }
      this.selectNodes(b);
    }
  };
  c.prototype.processDrop = function(a) {
    a.preventDefault();
    this.adjustMouseEvent(a);
    var b = [a.canvasX, a.canvasY], d = this.graph.getNodeOnPos(b[0], b[1]);
    if (d) {
      if ((d.onDropFile || d.onDropData) && (b = a.dataTransfer.files) && b.length) {
        for (var e = 0; e < b.length; e++) {
          var h = a.dataTransfer.files[0], l = h.name;
          c.getFileExtension(l);
          if (d.onDropFile) {
            d.onDropFile(h);
          }
          if (d.onDropData) {
            var n = new FileReader;
            n.onload = function(a) {
              d.onDropData(a.target.result, l, h);
            };
            var f = h.type.split("/")[0];
            "text" == f || "" == f ? n.readAsText(h) : "image" == f ? n.readAsDataURL(h) : n.readAsArrayBuffer(h);
          }
        }
      }
      return d.onDropItem && d.onDropItem(event) ? !0 : this.onDropItem ? this.onDropItem(event) : !1;
    }
    b = null;
    this.onDropItem && (b = this.onDropItem(event));
    b || this.checkDropItem(a);
  };
  c.prototype.checkDropItem = function(a) {
    if (a.dataTransfer.files.length) {
      var b = a.dataTransfer.files[0], d = c.getFileExtension(b.name).toLowerCase();
      if (d = e.node_types_by_file_extension[d]) {
        if (d = e.createNode(d.type), d.pos = [a.canvasX, a.canvasY], this.graph.add(d), d.onDropFile) {
          d.onDropFile(b);
        }
      }
    }
  };
  c.prototype.processNodeDblClicked = function(a) {
    if (this.onShowNodePanel) {
      this.onShowNodePanel(a);
    }
    if (this.onNodeDblClicked) {
      this.onNodeDblClicked(a);
    }
    this.setDirty(!0);
  };
  c.prototype.processNodeSelected = function(a, b) {
    this.selectNode(a, b && b.shiftKey);
    if (this.onNodeSelected) {
      this.onNodeSelected(a);
    }
  };
  c.prototype.processNodeDeselected = function(a) {
    this.deselectNode(a);
    if (this.onNodeDeselected) {
      this.onNodeDeselected(a);
    }
  };
  c.prototype.selectNode = function(a, b) {
    null == a ? this.deselectAllNodes() : this.selectNodes([a], b);
  };
  c.prototype.selectNodes = function(a, b) {
    b || this.deselectAllNodes();
    a = a || this.graph._nodes;
    for (b = 0; b < a.length; ++b) {
      var d = a[b];
      if (!d.selected) {
        if (!d.selected && d.onSelected) {
          d.onSelected();
        }
        d.selected = !0;
        this.selected_nodes[d.id] = d;
        if (d.inputs) {
          for (b = 0; b < d.inputs.length; ++b) {
            this.highlighted_links[d.inputs[b].link] = !0;
          }
        }
        if (d.outputs) {
          for (b = 0; b < d.outputs.length; ++b) {
            var e = d.outputs[b];
            if (e.links) {
              for (var h = 0; h < e.links.length; ++h) {
                this.highlighted_links[e.links[h]] = !0;
              }
            }
          }
        }
      }
    }
    this.setDirty(!0);
  };
  c.prototype.deselectNode = function(a) {
    if (a.selected) {
      if (a.onDeselected) {
        a.onDeselected();
      }
      a.selected = !1;
      if (a.inputs) {
        for (var b = 0; b < a.inputs.length; ++b) {
          delete this.highlighted_links[a.inputs[b].link];
        }
      }
      if (a.outputs) {
        for (b = 0; b < a.outputs.length; ++b) {
          var d = a.outputs[b];
          if (d.links) {
            for (var e = 0; e < d.links.length; ++e) {
              delete this.highlighted_links[d.links[e]];
            }
          }
        }
      }
    }
  };
  c.prototype.deselectAllNodes = function() {
    if (this.graph) {
      for (var a = this.graph._nodes, b = 0, d = a.length; b < d; ++b) {
        var e = a[b];
        if (e.selected) {
          if (e.onDeselected) {
            e.onDeselected();
          }
          e.selected = !1;
        }
      }
      this.selected_nodes = {};
      this.highlighted_links = {};
      this.setDirty(!0);
    }
  };
  c.prototype.deleteSelectedNodes = function() {
    for (var a in this.selected_nodes) {
      this.graph.remove(this.selected_nodes[a]);
    }
    this.selected_nodes = {};
    this.highlighted_links = {};
    this.setDirty(!0);
  };
  c.prototype.centerOnNode = function(a) {
    this.offset[0] = -a.pos[0] - 0.5 * a.size[0] + 0.5 * this.canvas.width / this.scale;
    this.offset[1] = -a.pos[1] - 0.5 * a.size[1] + 0.5 * this.canvas.height / this.scale;
    this.setDirty(!0, !0);
  };
  c.prototype.adjustMouseEvent = function(a) {
    var b = this.canvas.getBoundingClientRect();
    a.localX = a.pageX - b.left;
    a.localY = a.pageY - b.top;
    a.canvasX = a.localX / this.scale - this.offset[0];
    a.canvasY = a.localY / this.scale - this.offset[1];
  };
  c.prototype.setZoom = function(a, b) {
    b || (b = [0.5 * this.canvas.width, 0.5 * this.canvas.height]);
    var d = this.convertOffsetToCanvas(b);
    this.scale = a;
    this.scale > this.max_zoom ? this.scale = this.max_zoom : this.scale < this.min_zoom && (this.scale = this.min_zoom);
    a = this.convertOffsetToCanvas(b);
    d = [a[0] - d[0], a[1] - d[1]];
    this.offset[0] += d[0];
    this.offset[1] += d[1];
    this.dirty_bgcanvas = this.dirty_canvas = !0;
  };
  c.prototype.convertOffsetToCanvas = function(a, b) {
    b = b || [];
    b[0] = a[0] / this.scale - this.offset[0];
    b[1] = a[1] / this.scale - this.offset[1];
    return b;
  };
  c.prototype.convertCanvasToOffset = function(a, b) {
    b = b || [];
    b[0] = (a[0] + this.offset[0]) * this.scale;
    b[1] = (a[1] + this.offset[1]) * this.scale;
    return b;
  };
  c.prototype.convertEventToCanvas = function(a) {
    var b = this.canvas.getBoundingClientRect();
    return this.convertOffsetToCanvas([a.pageX - b.left, a.pageY - b.top]);
  };
  c.prototype.bringToFront = function(a) {
    var b = this.graph._nodes.indexOf(a);
    -1 != b && (this.graph._nodes.splice(b, 1), this.graph._nodes.push(a));
  };
  c.prototype.sendToBack = function(a) {
    var b = this.graph._nodes.indexOf(a);
    -1 != b && (this.graph._nodes.splice(b, 1), this.graph._nodes.unshift(a));
  };
  var q = new Float32Array(4);
  c.prototype.computeVisibleNodes = function(a, b) {
    b = b || [];
    b.length = 0;
    a = a || this.graph._nodes;
    for (var d = 0, e = a.length; d < e; ++d) {
      var h = a[d];
      (!this.live_mode || h.onDrawBackground || h.onDrawForeground) && v(this.visible_area, h.getBounding(q)) && b.push(h);
    }
    return b;
  };
  c.prototype.draw = function(a, b) {
    if (this.canvas) {
      var d = e.getTime();
      this.render_time = 0.001 * (d - this.last_draw_time);
      this.last_draw_time = d;
      if (this.graph) {
        var g = [-this.offset[0], -this.offset[1]], h = [g[0] + this.canvas.width / this.scale, g[1] + this.canvas.height / this.scale];
        this.visible_area = new Float32Array([g[0], g[1], h[0] - g[0], h[1] - g[1]]);
      }
      (this.dirty_bgcanvas || b || this.always_render_background || this.graph && this.graph._last_trigger_time && 1000 > d - this.graph._last_trigger_time) && this.drawBackCanvas();
      (this.dirty_canvas || a) && this.drawFrontCanvas();
      this.fps = this.render_time ? 1.0 / this.render_time : 0;
      this.frame += 1;
    }
  };
  c.prototype.drawFrontCanvas = function() {
    this.ctx || (this.ctx = this.bgcanvas.getContext("2d"));
    var a = this.ctx;
    if (a) {
      a.start2D && a.start2D();
      var b = this.canvas;
      a.restore();
      a.setTransform(1, 0, 0, 1, 0, 0);
      this.dirty_area && (a.save(), a.beginPath(), a.rect(this.dirty_area[0], this.dirty_area[1], this.dirty_area[2], this.dirty_area[3]), a.clip());
      this.clear_background && a.clearRect(0, 0, b.width, b.height);
      this.bgcanvas == this.canvas ? this.drawBackCanvas() : a.drawImage(this.bgcanvas, 0, 0);
      if (this.onRender) {
        this.onRender(b, a);
      }
      this.show_info && this.renderInfo(a);
      if (this.graph) {
        a.save();
        a.scale(this.scale, this.scale);
        a.translate(this.offset[0], this.offset[1]);
        b = this.computeVisibleNodes(null, this.visible_nodes);
        for (var d = 0; d < b.length; ++d) {
          var g = b[d];
          a.save();
          a.translate(g.pos[0], g.pos[1]);
          this.drawNode(g, a);
          a.restore();
        }
        this.graph.config.links_ontop && (this.live_mode || this.drawConnections(a));
        if (null != this.connecting_pos) {
          a.lineWidth = this.connections_width;
          switch(this.connecting_output.type) {
            case e.EVENT:
              b = "#F85";
              break;
            default:
              b = "#AFA";
          }
          this.renderLink(a, this.connecting_pos, [this.canvas_mouse[0], this.canvas_mouse[1]], null, !1, null, b);
          a.beginPath();
          this.connecting_output.type === e.EVENT ? a.rect(this.connecting_pos[0] - 6 + 0.5, this.connecting_pos[1] - 5 + 0.5, 14, 10) : a.arc(this.connecting_pos[0], this.connecting_pos[1], 4, 0, 2 * Math.PI);
          a.fill();
          a.fillStyle = "#ffcc00";
          this._highlight_input && (a.beginPath(), a.arc(this._highlight_input[0], this._highlight_input[1], 6, 0, 2 * Math.PI), a.fill());
        }
        this.dragging_rectangle && (a.strokeStyle = "#FFF", a.strokeRect(this.dragging_rectangle[0], this.dragging_rectangle[1], this.dragging_rectangle[2], this.dragging_rectangle[3]));
        a.restore();
      }
      this.dirty_area && a.restore();
      a.finish2D && a.finish2D();
      this.dirty_canvas = !1;
    }
  };
  c.prototype.renderInfo = function(a, b, d) {
    b = b || 0;
    d = d || 0;
    a.save();
    a.translate(b, d);
    a.font = "10px Arial";
    a.fillStyle = "#888";
    this.graph ? (a.fillText("T: " + this.graph.globaltime.toFixed(2) + "s", 5, 13), a.fillText("I: " + this.graph.iteration, 5, 26), a.fillText("F: " + this.frame, 5, 39), a.fillText("FPS:" + this.fps.toFixed(2), 5, 52)) : a.fillText("No graph selected", 5, 13);
    a.restore();
  };
  c.prototype.drawBackCanvas = function() {
    var a = this.bgcanvas;
    if (a.width != this.canvas.width || a.height != this.canvas.height) {
      a.width = this.canvas.width, a.height = this.canvas.height;
    }
    this.bgctx || (this.bgctx = this.bgcanvas.getContext("2d"));
    var b = this.bgctx;
    b.start && b.start();
    this.clear_background && b.clearRect(0, 0, a.width, a.height);
    this._graph_stack && this._graph_stack.length && (b.strokeStyle = this._graph_stack[this._graph_stack.length - 1].bgcolor, b.lineWidth = 10, b.strokeRect(1, 1, a.width - 2, a.height - 2), b.lineWidth = 1);
    b.restore();
    b.setTransform(1, 0, 0, 1, 0, 0);
    if (this.graph) {
      b.save();
      b.scale(this.scale, this.scale);
      b.translate(this.offset[0], this.offset[1]);
      if (this.background_image && 0.5 < this.scale) {
        b.globalAlpha = (1.0 - 0.5 / this.scale) * this.editor_alpha;
        b.imageSmoothingEnabled = b.mozImageSmoothingEnabled = b.imageSmoothingEnabled = !1;
        if (!this._bg_img || this._bg_img.name != this.background_image) {
          this._bg_img = new Image;
          this._bg_img.name = this.background_image;
          this._bg_img.src = this.background_image;
          var d = this;
          this._bg_img.onload = function() {
            d.draw(!0, !0);
          };
        }
        var e = null;
        null == this._pattern && 0 < this._bg_img.width ? (e = b.createPattern(this._bg_img, "repeat"), this._pattern_img = this._bg_img, this._pattern = e) : e = this._pattern;
        e && (b.fillStyle = e, b.fillRect(this.visible_area[0], this.visible_area[1], this.visible_area[2], this.visible_area[3]), b.fillStyle = "transparent");
        b.globalAlpha = 1.0;
        b.imageSmoothingEnabled = b.mozImageSmoothingEnabled = b.imageSmoothingEnabled = !0;
      }
      if (this.onBackgroundRender) {
        this.onBackgroundRender(a, b);
      }
      b.strokeStyle = "#235";
      b.strokeRect(0, 0, a.width, a.height);
      this.render_connections_shadows ? (b.shadowColor = "#000", b.shadowOffsetX = 0, b.shadowOffsetY = 0, b.shadowBlur = 6) : b.shadowColor = "rgba(0,0,0,0)";
      this.live_mode || this.drawConnections(b);
      b.shadowColor = "rgba(0,0,0,0)";
      b.restore();
    }
    b.finish && b.finish();
    this.dirty_bgcanvas = !1;
    this.dirty_canvas = !0;
  };
  var l = new Float32Array(2);
  c.prototype.drawNode = function(a, b) {
    var d = a.color || e.NODE_DEFAULT_COLOR, c = !0;
    if (a.flags.skip_title_render || a.graph.isLive()) {
      c = !1;
    }
    a.mouseOver && (c = !0);
    a.selected || (this.render_shadows ? (b.shadowColor = "rgba(0,0,0,0.5)", b.shadowOffsetX = 2, b.shadowOffsetY = 2, b.shadowBlur = 3) : b.shadowColor = "transparent");
    if (this.live_mode) {
      if (!a.flags.collapsed && (b.shadowColor = "transparent", a.onDrawForeground)) {
        a.onDrawForeground(b);
      }
    } else {
      var h = this.editor_alpha;
      b.globalAlpha = h;
      var f = a._shape || e.BOX_SHAPE;
      l.set(a.size);
      a.flags.collapsed && (l[0] = e.NODE_COLLAPSED_WIDTH, l[1] = 0);
      a.flags.clip_area && (b.save(), f == e.BOX_SHAPE ? (b.beginPath(), b.rect(0, 0, l[0], l[1])) : f == e.ROUND_SHAPE ? b.roundRect(0, 0, l[0], l[1], 10) : f == e.CIRCLE_SHAPE && (b.beginPath(), b.arc(0.5 * l[0], 0.5 * l[1], 0.5 * l[0], 0, 2 * Math.PI)), b.clip());
      this.drawNodeShape(a, b, l, d, a.bgcolor, !c, a.selected);
      b.shadowColor = "transparent";
      b.textAlign = "left";
      b.font = this.inner_text_font;
      c = 0.6 < this.scale;
      f = this.connecting_output;
      if (!a.flags.collapsed) {
        if (a.inputs) {
          for (var n = 0; n < a.inputs.length; n++) {
            var q = a.inputs[n];
            b.globalAlpha = h;
            this.connecting_node && e.isValidConnection(q.type && f.type) && (b.globalAlpha = 0.4 * h);
            b.fillStyle = null != q.link ? "#7F7" : "#AAA";
            var p = a.getConnectionPos(!0, n);
            p[0] -= a.pos[0];
            p[1] -= a.pos[1];
            b.beginPath();
            q.type === e.EVENT ? b.rect(p[0] - 6 + 0.5, p[1] - 5 + 0.5, 14, 10) : b.arc(p[0], p[1], 4, 0, 2 * Math.PI);
            b.fill();
            c && (q = null != q.label ? q.label : q.name) && (b.fillStyle = d, b.fillText(q, p[0] + 10, p[1] + 5));
          }
        }
        this.connecting_node && (b.globalAlpha = 0.4 * h);
        b.lineWidth = 1;
        b.textAlign = "right";
        b.strokeStyle = "black";
        if (a.outputs) {
          for (n = 0; n < a.outputs.length; n++) {
            if (q = a.outputs[n], p = a.getConnectionPos(!1, n), p[0] -= a.pos[0], p[1] -= a.pos[1], b.fillStyle = q.links && q.links.length ? "#7F7" : "#AAA", b.beginPath(), q.type === e.EVENT ? b.rect(p[0] - 6 + 0.5, p[1] - 5 + 0.5, 14, 10) : b.arc(p[0], p[1], 4, 0, 2 * Math.PI), b.fill(), b.stroke(), c && (q = null != q.label ? q.label : q.name)) {
              b.fillStyle = d, b.fillText(q, p[0] - 10, p[1] + 5);
            }
          }
        }
        b.textAlign = "left";
        b.globalAlpha = 1;
        if (a.onDrawForeground) {
          a.onDrawForeground(b);
        }
      }
      a.flags.clip_area && b.restore();
      b.globalAlpha = 1.0;
    }
  };
  c.prototype.drawNodeShape = function(a, b, d, c, h, l, n) {
    b.strokeStyle = c || e.NODE_DEFAULT_COLOR;
    b.fillStyle = h || e.NODE_DEFAULT_BGCOLOR;
    h = e.NODE_TITLE_HEIGHT;
    var g = a._shape || e.BOX_SHAPE;
    g == e.BOX_SHAPE ? (b.beginPath(), b.rect(0, l ? 0 : -h, d[0] + 1, l ? d[1] : d[1] + h), b.fill(), b.shadowColor = "transparent", n && (b.strokeStyle = "#CCC", b.strokeRect(-0.5, l ? -0.5 : -h + -0.5, d[0] + 2, l ? d[1] + 2 : d[1] + h + 2 - 1), b.strokeStyle = c)) : g == e.ROUND_SHAPE ? (b.roundRect(0, l ? 0 : -h, d[0], l ? d[1] : d[1] + h, 10), b.fill()) : g == e.CIRCLE_SHAPE && (b.beginPath(), b.arc(0.5 * d[0], 0.5 * d[1], 0.5 * d[0], 0, 2 * Math.PI), b.fill());
    b.shadowColor = "transparent";
    a.bgImage && a.bgImage.width && b.drawImage(a.bgImage, 0.5 * (d[0] - a.bgImage.width), 0.5 * (d[1] - a.bgImage.height));
    a.bgImageUrl && !a.bgImage && (a.bgImage = a.loadImage(a.bgImageUrl));
    if (a.onDrawBackground) {
      a.onDrawBackground(b);
    }
    l || (b.fillStyle = c || e.NODE_DEFAULT_COLOR, c = b.globalAlpha, b.globalAlpha = 0.5 * c, g == e.BOX_SHAPE ? (b.beginPath(), b.rect(0, -h, d[0] + 1, h), b.fill()) : g == e.ROUND_SHAPE && (b.roundRect(0, -h, d[0], h, 10, 0), b.fill()), b.fillStyle = a.boxcolor || e.NODE_DEFAULT_BOXCOLOR, b.beginPath(), g == e.ROUND_SHAPE || g == e.CIRCLE_SHAPE ? b.arc(0.5 * h, -0.5 * h, 0.5 * (h - 6), 0, 2 * Math.PI) : b.rect(3, -h + 3, h - 6, h - 6), b.fill(), b.globalAlpha = c, b.font = this.title_text_font, 
    (a = a.getTitle()) && 0.5 < this.scale && (b.fillStyle = e.NODE_TITLE_COLOR, b.fillText(a, 16, 13 - h)));
  };
  c.prototype.drawNodeCollapsed = function(a, b, d, c) {
    b.strokeStyle = d || e.NODE_DEFAULT_COLOR;
    b.fillStyle = c || e.NODE_DEFAULT_BGCOLOR;
    d = e.NODE_COLLAPSED_RADIUS;
    c = a._shape || e.BOX_SHAPE;
    c == e.CIRCLE_SHAPE ? (b.beginPath(), b.arc(0.5 * a.size[0], 0.5 * a.size[1], d, 0, 2 * Math.PI), b.fill(), b.shadowColor = "rgba(0,0,0,0)", b.stroke(), b.fillStyle = a.boxcolor || e.NODE_DEFAULT_BOXCOLOR, b.beginPath(), b.arc(0.5 * a.size[0], 0.5 * a.size[1], 0.5 * d, 0, 2 * Math.PI)) : c == e.ROUND_SHAPE ? (b.beginPath(), b.roundRect(0.5 * a.size[0] - d, 0.5 * a.size[1] - d, 2 * d, 2 * d, 5), b.fill(), b.shadowColor = "rgba(0,0,0,0)", b.stroke(), b.fillStyle = a.boxcolor || e.NODE_DEFAULT_BOXCOLOR, 
    b.beginPath(), b.roundRect(0.5 * a.size[0] - 0.5 * d, 0.5 * a.size[1] - 0.5 * d, d, d, 2)) : (b.beginPath(), b.rect(0, 0, a.size[0], 2 * d), b.fill(), b.shadowColor = "rgba(0,0,0,0)", b.stroke(), b.fillStyle = a.boxcolor || e.NODE_DEFAULT_BOXCOLOR, b.beginPath(), b.rect(0.5 * d, 0.5 * d, d, d));
    b.fill();
  };
  c.prototype.drawConnections = function(a) {
    var b = e.getTime();
    a.lineWidth = this.connections_width;
    a.fillStyle = "#AAA";
    a.strokeStyle = "#AAA";
    a.globalAlpha = this.editor_alpha;
    for (var d = 0, c = this.graph._nodes.length; d < c; ++d) {
      var h = this.graph._nodes[d];
      if (h.inputs && h.inputs.length) {
        for (var l = 0; l < h.inputs.length; ++l) {
          var n = h.inputs[l];
          if (n && null != n.link && (n = this.graph.links[n.link])) {
            var f = this.graph.getNodeById(n.origin_id);
            if (null != f) {
              var q = n.origin_slot;
              f = -1 == q ? [f.pos[0] + 10, f.pos[1] + 10] : f.getConnectionPos(!1, q);
              this.renderLink(a, f, h.getConnectionPos(!0, l), n);
              if (n && n._last_time && 1000 > b - n._last_time) {
                q = 2.0 - 0.002 * (b - n._last_time);
                var p = "rgba(255,255,255, " + q.toFixed(2) + ")";
                this.renderLink(a, f, h.getConnectionPos(!0, l), n, !0, q, p);
              }
            }
          }
        }
      }
    }
    a.globalAlpha = 1;
  };
  c.prototype.renderLink = function(a, b, d, g, h, l, n) {
    if (this.highquality_render) {
      var f = p(b, d);
      this.render_connections_border && 0.6 < this.scale && (a.lineWidth = this.connections_width + 4);
      !n && g && (n = c.link_type_colors[g.type]);
      n || (n = this.default_link_color);
      null != g && this.highlighted_links[g.id] && (n = "#FFF");
      a.beginPath();
      this.render_curved_connections ? (a.moveTo(b[0], b[1]), a.bezierCurveTo(b[0] + 0.25 * f, b[1], d[0] - 0.25 * f, d[1], d[0], d[1])) : (a.moveTo(b[0] + 10, b[1]), a.lineTo(0.5 * (b[0] + 10 + (d[0] - 10)), b[1]), a.lineTo(0.5 * (b[0] + 10 + (d[0] - 10)), d[1]), a.lineTo(d[0] - 10, d[1]));
      this.render_connections_border && 0.6 < this.scale && !h && (a.strokeStyle = "rgba(0,0,0,0.5)", a.stroke());
      a.lineWidth = this.connections_width;
      a.fillStyle = a.strokeStyle = n;
      a.stroke();
      this.render_connection_arrows && 0.6 <= this.scale && this.render_connection_arrows && 0.6 < this.scale && (g = this.computeConnectionPoint(b, d, 0.5), h = this.computeConnectionPoint(b, d, 0.51), h = this.render_curved_connections ? -Math.atan2(h[0] - g[0], h[1] - g[1]) : d[1] > b[1] ? 0 : Math.PI, a.save(), a.translate(g[0], g[1]), a.rotate(h), a.beginPath(), a.moveTo(-5, -5), a.lineTo(0, 5), a.lineTo(5, -5), a.fill(), a.restore());
      if (l) {
        for (l = 0; 5 > l; ++l) {
          g = (0.001 * e.getTime() + 0.2 * l) % 1, g = this.computeConnectionPoint(b, d, g), a.beginPath(), a.arc(g[0], g[1], 5, 0, 2 * Math.PI), a.fill();
        }
      }
    } else {
      a.beginPath(), a.moveTo(b[0], b[1]), a.lineTo(d[0], d[1]), a.stroke();
    }
  };
  c.prototype.computeConnectionPoint = function(a, b, d) {
    var e = p(a, b), c = [a[0] + 0.25 * e, a[1]];
    e = [b[0] - 0.25 * e, b[1]];
    var l = (1 - d) * (1 - d) * (1 - d), n = 3 * (1 - d) * (1 - d) * d, f = 3 * (1 - d) * d * d;
    d *= d * d;
    return [l * a[0] + n * c[0] + f * e[0] + d * b[0], l * a[1] + n * c[1] + f * e[1] + d * b[1]];
  };
  c.prototype.resize = function(a, b) {
    a || b || (b = this.canvas.parentNode, a = b.offsetWidth, b = b.offsetHeight);
    if (this.canvas.width != a || this.canvas.height != b) {
      this.canvas.width = a, this.canvas.height = b, this.bgcanvas.width = this.canvas.width, this.bgcanvas.height = this.canvas.height, this.setDirty(!0, !0);
    }
  };
  c.prototype.switchLiveMode = function(a) {
    if (a) {
      var b = this, d = this.live_mode ? 1.1 : 0.9;
      this.live_mode && (this.live_mode = !1, this.editor_alpha = 0.1);
      var e = setInterval(function() {
        b.editor_alpha *= d;
        b.dirty_canvas = !0;
        b.dirty_bgcanvas = !0;
        1 > d && 0.01 > b.editor_alpha && (clearInterval(e), 1 > d && (b.live_mode = !0));
        1 < d && 0.99 < b.editor_alpha && (clearInterval(e), b.editor_alpha = 1);
      }, 1);
    } else {
      this.live_mode = !this.live_mode, this.dirty_bgcanvas = this.dirty_canvas = !0;
    }
  };
  c.prototype.onNodeSelectionChange = function(a) {
  };
  c.prototype.touchHandler = function(a) {
    var b = a.changedTouches[0];
    switch(a.type) {
      case "touchstart":
        var d = "mousedown";
        break;
      case "touchmove":
        d = "mousemove";
        break;
      case "touchend":
        d = "mouseup";
        break;
      default:
        return;
    }
    var e = this.getCanvasWindow(), c = e.document.createEvent("MouseEvent");
    c.initMouseEvent(d, !0, !0, e, 1, b.screenX, b.screenY, b.clientX, b.clientY, !1, !1, !1, !1, 0, null);
    b.target.dispatchEvent(c);
    a.preventDefault();
  };
  c.onMenuAdd = function(a, b, d, l) {
    function h(a, b) {
      b = l.getFirstEvent();
      if (a = e.createNode(a.value)) {
        a.pos = g.convertEventToCanvas(b), g.graph.add(a);
      }
    }
    var g = c.active_canvas, n = g.getCanvasWindow();
    a = e.getNodeTypesCategories();
    b = [];
    for (var f in a) {
      a[f] && b.push({value:a[f], content:a[f], has_submenu:!0});
    }
    var q = new e.ContextMenu(b, {event:d, callback:function(a, b, d) {
      a = e.getNodeTypesInCategory(a.value);
      b = [];
      for (var c in a) {
        b.push({content:a[c].title, value:a[c].type});
      }
      new e.ContextMenu(b, {event:d, callback:h, parentMenu:q}, n);
      return !1;
    }, parentMenu:l}, n);
    return !1;
  };
  c.onMenuCollapseAll = function() {
  };
  c.onMenuNodeEdit = function() {
  };
  c.showMenuNodeOptionalInputs = function(a, b, d, l, h) {
    if (h) {
      var g = this;
      a = c.active_canvas.getCanvasWindow();
      b = h.optional_inputs;
      h.onGetInputs && (b = h.onGetInputs());
      var n = [];
      if (b) {
        for (var f in b) {
          var q = b[f];
          if (q) {
            var p = q[0];
            q[2] && q[2].label && (p = q[2].label);
            p = {content:p, value:q};
            q[1] == e.ACTION && (p.className = "event");
            n.push(p);
          } else {
            n.push(null);
          }
        }
      }
      this.onMenuNodeInputs && (n = this.onMenuNodeInputs(n));
      if (n.length) {
        return new e.ContextMenu(n, {event:d, callback:function(a, b, d) {
          h && (a.callback && a.callback.call(g, h, a, b, d), a.value && (h.addInput(a.value[0], a.value[1], a.value[2]), h.setDirtyCanvas(!0, !0)));
        }, parentMenu:l, node:h}, a), !1;
      }
    }
  };
  c.showMenuNodeOptionalOutputs = function(a, b, d, l, h) {
    function g(a, b, d) {
      if (h && (a.callback && a.callback.call(n, h, a, b, d), a.value)) {
        if (d = a.value[1], !d || d.constructor !== Object && d.constructor !== Array) {
          h.addOutput(a.value[0], a.value[1], a.value[2]), h.setDirtyCanvas(!0, !0);
        } else {
          a = [];
          for (var c in d) {
            a.push({content:c, value:d[c]});
          }
          new e.ContextMenu(a, {event:b, callback:g, parentMenu:l, node:h});
          return !1;
        }
      }
    }
    if (h) {
      var n = this;
      a = c.active_canvas.getCanvasWindow();
      b = h.optional_outputs;
      h.onGetOutputs && (b = h.onGetOutputs());
      var f = [];
      if (b) {
        for (var q in b) {
          var p = b[q];
          if (!p) {
            f.push(null);
          } else {
            if (!h.flags || !h.flags.skip_repeated_outputs || -1 == h.findOutputSlot(p[0])) {
              var k = p[0];
              p[2] && p[2].label && (k = p[2].label);
              k = {content:k, value:p};
              p[1] == e.EVENT && (k.className = "event");
              f.push(k);
            }
          }
        }
      }
      this.onMenuNodeOutputs && (f = this.onMenuNodeOutputs(f));
      if (f.length) {
        return new e.ContextMenu(f, {event:d, callback:g, parentMenu:l, node:h}, a), !1;
      }
    }
  };
  c.onShowMenuNodeProperties = function(a, b, d, l, h) {
    if (h && h.properties) {
      var g = c.active_canvas;
      b = g.getCanvasWindow();
      var n = [], f;
      for (f in h.properties) {
        a = void 0 !== h.properties[f] ? h.properties[f] : " ", a = c.decodeHTML(a), n.push({content:"<span class='property_name'>" + f + "</span><span class='property_value'>" + a + "</span>", value:f});
      }
      if (n.length) {
        return new e.ContextMenu(n, {event:d, callback:function(a, b, d, e) {
          h && (b = this.getBoundingClientRect(), g.showEditPropertyValue(h, a.value, {position:[b.left, b.top]}));
        }, parentMenu:l, allow_html:!0, node:h}, b), !1;
      }
    }
  };
  c.decodeHTML = function(a) {
    var b = document.createElement("div");
    b.innerText = a;
    return b.innerHTML;
  };
  c.onResizeNode = function(a, b, d, e, c) {
    c && (c.size = c.computeSize(), c.setDirtyCanvas(!0, !0));
  };
  c.onShowTitleEditor = function(a, b, d, e, h) {
    function l() {
      h.title = g.value;
      n.parentNode.removeChild(n);
      h.setDirtyCanvas(!0, !0);
    }
    var n = document.createElement("div");
    n.className = "graphdialog";
    n.innerHTML = "<span class='name'>Title</span><input autofocus type='text' class='value'/><button>OK</button>";
    var g = n.querySelector("input");
    g && (g.value = h.title, g.addEventListener("keydown", function(a) {
      13 == a.keyCode && (l(), a.preventDefault(), a.stopPropagation());
    }));
    a = c.active_canvas.canvas;
    b = a.getBoundingClientRect();
    e = d = -20;
    b && (d -= b.left, e -= b.top);
    event ? (n.style.left = event.pageX + d + "px", n.style.top = event.pageY + e + "px") : (n.style.left = 0.5 * a.width + d + "px", n.style.top = 0.5 * a.height + e + "px");
    n.querySelector("button").addEventListener("click", l);
    a.parentNode.appendChild(n);
  };
  c.prototype.showEditPropertyValue = function(a, b, d) {
    function e() {
      c(t.value);
    }
    function c(d) {
      "number" == typeof a.properties[b] && (d = Number(d));
      a.properties[b] = d;
      if (a.onPropertyChanged) {
        a.onPropertyChanged(b, d);
      }
      k.close();
      a.setDirtyCanvas(!0, !0);
    }
    if (a && void 0 !== a.properties[b]) {
      d = d || {};
      var l = "string";
      null !== a.properties[b] && (l = typeof a.properties[b]);
      var n = null;
      a.getPropertyInfo && (n = a.getPropertyInfo(b));
      if (a.properties_info) {
        for (var f = 0; f < a.properties_info.length; ++f) {
          if (a.properties_info[f].name == b) {
            n = a.properties_info[f];
            break;
          }
        }
      }
      void 0 !== n && null !== n && n.type && (l = n.type);
      var q = "";
      if ("string" == l || "number" == l) {
        q = "<input autofocus type='text' class='value'/>";
      } else {
        if ("enum" == l && n.values) {
          q = "<select autofocus type='text' class='value'>";
          for (f in n.values) {
            var p = n.values.constructor === Array ? n.values[f] : f;
            q += "<option value='" + p + "' " + (p == a.properties[b] ? "selected" : "") + ">" + n.values[f] + "</option>";
          }
          q += "</select>";
        } else {
          "boolean" == l && (q = "<input autofocus type='checkbox' class='value' " + (a.properties[b] ? "checked" : "") + "/>");
        }
      }
      var k = this.createDialog("<span class='name'>" + b + "</span>" + q + "<button>OK</button>", d);
      if ("enum" == l && n.values) {
        var t = k.querySelector("select");
        t.addEventListener("change", function(a) {
          c(a.target.value);
        });
      } else {
        if ("boolean" == l) {
          (t = k.querySelector("input")) && t.addEventListener("click", function(a) {
            c(!!t.checked);
          });
        } else {
          if (t = k.querySelector("input")) {
            t.value = void 0 !== a.properties[b] ? a.properties[b] : "", t.addEventListener("keydown", function(a) {
              13 == a.keyCode && (e(), a.preventDefault(), a.stopPropagation());
            });
          }
        }
      }
      k.querySelector("button").addEventListener("click", e);
    }
  };
  c.prototype.createDialog = function(a, b) {
    b = b || {};
    var d = document.createElement("div");
    d.className = "graphdialog";
    d.innerHTML = a;
    a = this.canvas.getBoundingClientRect();
    var e = -20, c = -20;
    a && (e -= a.left, c -= a.top);
    b.position ? (e += b.position[0], c += b.position[1]) : b.event ? (e += b.event.pageX, c += b.event.pageY) : (e += 0.5 * this.canvas.width, c += 0.5 * this.canvas.height);
    d.style.left = e + "px";
    d.style.top = c + "px";
    this.canvas.parentNode.appendChild(d);
    d.close = function() {
      this.parentNode && this.parentNode.removeChild(this);
    };
    return d;
  };
  c.onMenuNodeCollapse = function(a, b, d, e, c) {
    c.flags.collapsed = !c.flags.collapsed;
    c.setDirtyCanvas(!0, !0);
  };
  c.onMenuNodePin = function(a, b, d, e, c) {
    c.pin();
  };
  c.onMenuNodeMode = function(a, b, d, c, l) {
    new e.ContextMenu(["Always", "On Event", "On Trigger", "Never"], {event:d, callback:function(a) {
      if (l) {
        switch(a) {
          case "On Event":
            l.mode = e.ON_EVENT;
            break;
          case "On Trigger":
            l.mode = e.ON_TRIGGER;
            break;
          case "Never":
            l.mode = e.NEVER;
            break;
          default:
            l.mode = e.ALWAYS;
        }
      }
    }, parentMenu:c, node:l});
    return !1;
  };
  c.onMenuNodeColors = function(a, b, d, l, h) {
    if (!h) {
      throw "no node for color";
    }
    b = [];
    for (var f in c.node_colors) {
      a = c.node_colors[f], a = {value:f, content:"<span style='display: block; color:" + a.color + "; background-color:" + a.bgcolor + "'>" + f + "</span>"}, b.push(a);
    }
    new e.ContextMenu(b, {event:d, callback:function(a) {
      h && (a = c.node_colors[a.value]) && (h.color = a.color, h.bgcolor = a.bgcolor, h.setDirtyCanvas(!0));
    }, parentMenu:l, node:h});
    return !1;
  };
  c.onMenuNodeShapes = function(a, b, d, c, l) {
    if (!l) {
      throw "no node passed";
    }
    new e.ContextMenu(e.VALID_SHAPES, {event:d, callback:function(a) {
      l && (l.shape = a, l.setDirtyCanvas(!0));
    }, parentMenu:c, node:l});
    return !1;
  };
  c.onMenuNodeRemove = function(a, b, d, e, c) {
    if (!c) {
      throw "no node passed";
    }
    0 != c.removable && (c.graph.remove(c), c.setDirtyCanvas(!0, !0));
  };
  c.onMenuNodeClone = function(a, b, d, e, c) {
    0 != c.clonable && (a = c.clone()) && (a.pos = [c.pos[0] + 5, c.pos[1] + 5], c.graph.add(a), c.setDirtyCanvas(!0, !0));
  };
  c.node_colors = {red:{color:"#FAA", bgcolor:"#944"}, green:{color:"#AFA", bgcolor:"#494"}, blue:{color:"#AAF", bgcolor:"#449"}, cyan:{color:"#AFF", bgcolor:"#499"}, purple:{color:"#FAF", bgcolor:"#949"}, yellow:{color:"#FFA", bgcolor:"#994"}, black:{color:"#777", bgcolor:"#000"}, white:{color:"#FFF", bgcolor:"#AAA"}};
  c.prototype.getCanvasMenuOptions = function() {
    if (this.getMenuOptions) {
      var a = this.getMenuOptions();
    } else {
      a = [{content:"Add Node", has_submenu:!0, callback:c.onMenuAdd}], this._graph_stack && 0 < this._graph_stack.length && (a = [{content:"Close subgraph", callback:this.closeSubgraph.bind(this)}, null].concat(a));
    }
    if (this.getExtraMenuOptions) {
      var b = this.getExtraMenuOptions(this, a);
      b && (a = a.concat(b));
    }
    return a;
  };
  c.prototype.getNodeMenuOptions = function(a) {
    var b = a.getMenuOptions ? a.getMenuOptions(this) : [{content:"Inputs", has_submenu:!0, disabled:!0, callback:c.showMenuNodeOptionalInputs}, {content:"Outputs", has_submenu:!0, disabled:!0, callback:c.showMenuNodeOptionalOutputs}, null, {content:"Properties", has_submenu:!0, callback:c.onShowMenuNodeProperties}, null, {content:"Title", callback:c.onShowTitleEditor}, {content:"Mode", has_submenu:!0, callback:c.onMenuNodeMode}, {content:"Resize", callback:c.onResizeNode}, {content:"Collapse", callback:c.onMenuNodeCollapse}, 
    {content:"Pin", callback:c.onMenuNodePin}, {content:"Colors", has_submenu:!0, callback:c.onMenuNodeColors}, {content:"Shapes", has_submenu:!0, callback:c.onMenuNodeShapes}, null];
    if (a.getExtraMenuOptions) {
      var d = a.getExtraMenuOptions(this);
      d && (d.push(null), b = d.concat(b));
    }
    !1 !== a.clonable && b.push({content:"Clone", callback:c.onMenuNodeClone});
    !1 !== a.removable && b.push(null, {content:"Remove", callback:c.onMenuNodeRemove});
    a.onGetInputs && (d = a.onGetInputs()) && d.length && (b[0].disabled = !1);
    a.onGetOutputs && (d = a.onGetOutputs()) && d.length && (b[1].disabled = !1);
    if (a.graph && a.graph.onGetNodeMenuOptions) {
      a.graph.onGetNodeMenuOptions(b, a);
    }
    return b;
  };
  c.prototype.processContextMenu = function(a, b) {
    var d = this, l = c.active_canvas.getCanvasWindow(), f = null, q = {event:b, callback:function(b, e, c) {
      if (b) {
        if ("Remove Slot" == b.content) {
          var l = b.slot;
          l.input ? a.removeInput(l.slot) : l.output && a.removeOutput(l.slot);
        } else {
          if ("Rename Slot" == b.content) {
            l = b.slot;
            var n = d.createDialog("<span class='name'>Name</span><input type='text'/><button>OK</button>", e), f = n.querySelector("input");
            n.querySelector("button").addEventListener("click", function(b) {
              if (f.value) {
                if (b = l.input ? a.getInputInfo(l.slot) : a.getOutputInfo(l.slot)) {
                  b.label = f.value;
                }
                d.setDirty(!0);
              }
              n.close();
            });
          }
        }
      }
    }, node:a}, n = null;
    a && (n = a.getSlotInPosition(b.canvasX, b.canvasY), c.active_node = a);
    n ? (f = [], f.push(n.locked ? "Cannot remove" : {content:"Remove Slot", slot:n}), f.push({content:"Rename Slot", slot:n}), q.title = (n.input ? n.input.type : n.output.type) || "*", n.input && n.input.type == e.ACTION && (q.title = "Action"), n.output && n.output.type == e.EVENT && (q.title = "Event")) : f = a ? this.getNodeMenuOptions(a) : this.getCanvasMenuOptions();
    f && new e.ContextMenu(f, q, l);
  };
  this.CanvasRenderingContext2D && (CanvasRenderingContext2D.prototype.roundRect = function(a, b, d, e, c, l) {
    void 0 === c && (c = 5);
    void 0 === l && (l = c);
    this.beginPath();
    this.moveTo(a + c, b);
    this.lineTo(a + d - c, b);
    this.quadraticCurveTo(a + d, b, a + d, b + c);
    this.lineTo(a + d, b + e - l);
    this.quadraticCurveTo(a + d, b + e, a + d - l, b + e);
    this.lineTo(a + l, b + e);
    this.quadraticCurveTo(a, b + e, a, b + e - l);
    this.lineTo(a, b + c);
    this.quadraticCurveTo(a, b, a + c, b);
  });
  e.compareObjects = function(a, b) {
    for (var d in a) {
      if (a[d] != b[d]) {
        return !1;
      }
    }
    return !0;
  };
  e.distance = p;
  e.colorToString = function(a) {
    return "rgba(" + Math.round(255 * a[0]).toFixed() + "," + Math.round(255 * a[1]).toFixed() + "," + Math.round(255 * a[2]).toFixed() + "," + (4 == a.length ? a[3].toFixed(2) : "1.0") + ")";
  };
  e.isInsideRectangle = t;
  e.growBounding = function(a, b, d) {
    b < a[0] ? a[0] = b : b > a[2] && (a[2] = b);
    d < a[1] ? a[1] = d : d > a[3] && (a[3] = d);
  };
  e.isInsideBounding = function(a, b) {
    return a[0] < b[0][0] || a[1] < b[0][1] || a[0] > b[1][0] || a[1] > b[1][1] ? !1 : !0;
  };
  e.overlapBounding = v;
  e.hex2num = function(a) {
    "#" == a.charAt(0) && (a = a.slice(1));
    a = a.toUpperCase();
    for (var b = Array(3), d = 0, e, c, l = 0; 6 > l; l += 2) {
      e = "0123456789ABCDEF".indexOf(a.charAt(l)), c = "0123456789ABCDEF".indexOf(a.charAt(l + 1)), b[d] = 16 * e + c, d++;
    }
    return b;
  };
  e.num2hex = function(a) {
    for (var b = "#", d, e, c = 0; 3 > c; c++) {
      d = a[c] / 16, e = a[c] % 16, b += "0123456789ABCDEF".charAt(d) + "0123456789ABCDEF".charAt(e);
    }
    return b;
  };
  w.prototype.addItem = function(a, b, d) {
    function e(a) {
      var b = this.value;
      b && b.has_submenu && c.call(this, a);
    }
    function c(a) {
      var b = this.value, e = !0;
      l.current_submenu && l.current_submenu.close(a);
      if (d.callback) {
        var c = d.callback.call(this, b, d, a, l, d.node);
        !0 === c && (e = !1);
      }
      if (b && (b.callback && !d.ignore_item_callbacks && !0 !== b.disabled && (c = b.callback.call(this, b, d, a, l, d.node), !0 === c && (e = !1)), b.submenu)) {
        if (!b.submenu.options) {
          throw "ContextMenu submenu needs options";
        }
        new l.constructor(b.submenu.options, {callback:b.submenu.callback, event:a, parentMenu:l, ignore_item_callbacks:b.submenu.ignore_item_callbacks, title:b.submenu.title, autoopen:d.autoopen});
        e = !1;
      }
      e && !l.lock && l.close();
    }
    var l = this;
    d = d || {};
    var n = document.createElement("div");
    n.className = "litemenu-entry submenu";
    var f = !1;
    if (null === b) {
      n.classList.add("separator");
    } else {
      n.innerHTML = b && b.title ? b.title : a;
      if (n.value = b) {
        b.disabled && (f = !0, n.classList.add("disabled")), (b.submenu || b.has_submenu) && n.classList.add("has_submenu");
      }
      "function" == typeof b ? (n.dataset.value = a, n.onclick_callback = b) : n.dataset.value = b;
      b.className && (n.className += " " + b.className);
    }
    this.root.appendChild(n);
    f || n.addEventListener("click", c);
    d.autoopen && n.addEventListener("mouseenter", e);
    return n;
  };
  w.prototype.close = function(a, b) {
    this.root.parentNode && this.root.parentNode.removeChild(this.root);
    this.parentMenu && !b && (this.parentMenu.lock = !1, this.parentMenu.current_submenu = null, void 0 === a ? this.parentMenu.close() : a && !w.isCursorOverElement(a, this.parentMenu.root) && w.trigger(this.parentMenu.root, "mouseleave", a));
    this.current_submenu && this.current_submenu.close(a, !0);
  };
  w.trigger = function(a, b, d, e) {
    var c = document.createEvent("CustomEvent");
    c.initCustomEvent(b, !0, !0, d);
    c.srcElement = e;
    a.dispatchEvent ? a.dispatchEvent(c) : a.__events && a.__events.dispatchEvent(c);
    return c;
  };
  w.prototype.getTopMenu = function() {
    return this.options.parentMenu ? this.options.parentMenu.getTopMenu() : this;
  };
  w.prototype.getFirstEvent = function() {
    return this.options.parentMenu ? this.options.parentMenu.getFirstEvent() : this.options.event;
  };
  w.isCursorOverElement = function(a, b) {
    var d = a.pageX;
    a = a.pageY;
    return (b = b.getBoundingClientRect()) ? a > b.top && a < b.top + b.height && d > b.left && d < b.left + b.width ? !0 : !1 : !1;
  };
  e.ContextMenu = w;
  e.closeAllContextMenus = function(a) {
    a = a || window;
    a = a.document.querySelectorAll(".litecontextmenu");
    if (a.length) {
      for (var b = [], d = 0; d < a.length; d++) {
        b.push(a[d]);
      }
      for (d in b) {
        b[d].close ? b[d].close() : b[d].parentNode && b[d].parentNode.removeChild(b[d]);
      }
    }
  };
  e.extendClass = function(a, b) {
    for (var d in b) {
      a.hasOwnProperty(d) || (a[d] = b[d]);
    }
    if (b.prototype) {
      for (d in b.prototype) {
        b.prototype.hasOwnProperty(d) && !a.prototype.hasOwnProperty(d) && (b.prototype.__lookupGetter__(d) ? a.prototype.__defineGetter__(d, b.prototype.__lookupGetter__(d)) : a.prototype[d] = b.prototype[d], b.prototype.__lookupSetter__(d) && a.prototype.__defineSetter__(d, b.prototype.__lookupSetter__(d)));
      }
    }
  };
  e.getParameterNames = function(a) {
    return (a + "").replace(/[/][/].*$/mg, "").replace(/\s+/g, "").replace(/[/][*][^/*]*[*][/]/g, "").split("){", 1)[0].replace(/^[^(]*[(]/, "").replace(/=[^,]+/g, "").split(",").filter(Boolean);
  };
  "undefined" == typeof window || window.requestAnimationFrame || (window.requestAnimationFrame = window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function(a) {
    window.setTimeout(a, 1000 / 60);
  });
})(this);
"undefined" != typeof exports && (exports.LiteGraph = this.LiteGraph);
(function(u) {
  function f() {
    this.addOutput("in ms", "number");
    this.addOutput("in sec", "number");
  }
  function k() {
    this.size = [120, 60];
    this.subgraph = new LGraph;
    this.subgraph._subgraph_node = this;
    this.subgraph._is_subgraph = !0;
    this.subgraph.onGlobalInputAdded = this.onSubgraphNewGlobalInput.bind(this);
    this.subgraph.onGlobalInputRenamed = this.onSubgraphRenamedGlobalInput.bind(this);
    this.subgraph.onGlobalInputTypeChanged = this.onSubgraphTypeChangeGlobalInput.bind(this);
    this.subgraph.onGlobalOutputAdded = this.onSubgraphNewGlobalOutput.bind(this);
    this.subgraph.onGlobalOutputRenamed = this.onSubgraphRenamedGlobalOutput.bind(this);
    this.subgraph.onGlobalOutputTypeChanged = this.onSubgraphTypeChangeGlobalOutput.bind(this);
    this.bgcolor = "#663";
  }
  function c() {
    var a = "input_" + (1000 * Math.random()).toFixed();
    this.addOutput(a, null);
    this.properties = {name:a, type:null};
    var b = this;
    Object.defineProperty(this.properties, "name", {get:function() {
      return a;
    }, set:function(d) {
      if ("" != d) {
        var e = b.getOutputInfo(0);
        e.name != d && (e.name = d, b.graph && b.graph.renameGlobalInput(a, d), a = d);
      }
    }, enumerable:!0});
    Object.defineProperty(this.properties, "type", {get:function() {
      return b.outputs[0].type;
    }, set:function(d) {
      b.outputs[0].type = d;
      b.graph && b.graph.changeGlobalInputType(a, b.outputs[0].type);
    }, enumerable:!0});
  }
  function p() {
    var a = "output_" + (1000 * Math.random()).toFixed();
    this.addInput(a, null);
    this.properties = {name:a, type:null};
    var b = this;
    Object.defineProperty(this.properties, "name", {get:function() {
      return a;
    }, set:function(d) {
      if ("" != d) {
        var e = b.getInputInfo(0);
        e.name != d && (e.name = d, b.graph && b.graph.renameGlobalOutput(a, d), a = d);
      }
    }, enumerable:!0});
    Object.defineProperty(this.properties, "type", {get:function() {
      return b.inputs[0].type;
    }, set:function(d) {
      b.inputs[0].type = d;
      b.graph && b.graph.changeGlobalInputType(a, b.inputs[0].type);
    }, enumerable:!0});
  }
  function t() {
    this.addOutput("value", "number");
    this.addProperty("value", 1.0);
    this.editable = {property:"value", type:"number"};
  }
  function v() {
    this.size = [60, 20];
    this.addInput("value", 0, {label:""});
    this.addOutput("value", 0, {label:""});
    this.addProperty("value", "");
  }
  function w() {
    this.addInput("in", 0);
    this.addOutput("out", 0);
    this.size = [40, 20];
  }
  function e() {
    this.mode = l.ON_EVENT;
    this.size = [60, 20];
    this.addProperty("msg", "");
    this.addInput("log", l.EVENT);
    this.addInput("msg", 0);
  }
  function q() {
    this.size = [60, 20];
    this.addProperty("onExecute", "");
    this.addInput("in", "");
    this.addInput("in2", "");
    this.addOutput("out", "");
    this.addOutput("out2", "");
    this._func = null;
  }
  var l = u.LiteGraph;
  f.title = "Time";
  f.desc = "Time";
  f.prototype.onExecute = function() {
    this.setOutputData(0, 1000 * this.graph.globaltime);
    this.setOutputData(1, this.graph.globaltime);
  };
  l.registerNodeType("basic/time", f);
  k.title = "Subgraph";
  k.desc = "Graph inside a node";
  k.prototype.onSubgraphNewGlobalInput = function(a, b) {
    this.addInput(a, b);
  };
  k.prototype.onSubgraphRenamedGlobalInput = function(a, b) {
    a = this.findInputSlot(a);
    -1 != a && (this.getInputInfo(a).name = b);
  };
  k.prototype.onSubgraphTypeChangeGlobalInput = function(a, b) {
    a = this.findInputSlot(a);
    -1 != a && (this.getInputInfo(a).type = b);
  };
  k.prototype.onSubgraphNewGlobalOutput = function(a, b) {
    this.addOutput(a, b);
  };
  k.prototype.onSubgraphRenamedGlobalOutput = function(a, b) {
    a = this.findOutputSlot(a);
    -1 != a && (this.getOutputInfo(a).name = b);
  };
  k.prototype.onSubgraphTypeChangeGlobalOutput = function(a, b) {
    a = this.findOutputSlot(a);
    -1 != a && (this.getOutputInfo(a).type = b);
  };
  k.prototype.getExtraMenuOptions = function(a) {
    var b = this;
    return [{content:"Open", callback:function() {
      a.openSubgraph(b.subgraph);
    }}];
  };
  k.prototype.onExecute = function() {
    if (this.inputs) {
      for (var a = 0; a < this.inputs.length; a++) {
        var b = this.inputs[a], d = this.getInputData(a);
        this.subgraph.setGlobalInputData(b.name, d);
      }
    }
    this.subgraph.runStep();
    if (this.outputs) {
      for (a = 0; a < this.outputs.length; a++) {
        d = this.subgraph.getGlobalOutputData(this.outputs[a].name), this.setOutputData(a, d);
      }
    }
  };
  k.prototype.configure = function(a) {
    LGraphNode.prototype.configure.call(this, a);
  };
  k.prototype.serialize = function() {
    var a = LGraphNode.prototype.serialize.call(this);
    a.subgraph = this.subgraph.serialize();
    return a;
  };
  k.prototype.clone = function() {
    var a = l.createNode(this.type), b = this.serialize();
    delete b.id;
    delete b.inputs;
    delete b.outputs;
    a.configure(b);
    return a;
  };
  l.registerNodeType("graph/subgraph", k);
  c.title = "Input";
  c.desc = "Input of the graph";
  c.prototype.onAdded = function() {
    this.graph.addGlobalInput(this.properties.name, this.properties.type);
  };
  c.prototype.onExecute = function() {
    var a = this.graph.global_inputs[this.properties.name];
    a && this.setOutputData(0, a.value);
  };
  l.registerNodeType("graph/input", c);
  p.title = "Ouput";
  p.desc = "Output of the graph";
  p.prototype.onAdded = function() {
    this.graph.addGlobalOutput(this.properties.name, this.properties.type);
  };
  p.prototype.onExecute = function() {
    this.graph.setGlobalOutputData(this.properties.name, this.getInputData(0));
  };
  l.registerNodeType("graph/output", p);
  t.title = "Const";
  t.desc = "Constant value";
  t.prototype.setValue = function(a) {
    "string" == typeof a && (a = parseFloat(a));
    this.properties.value = a;
    this.setDirtyCanvas(!0);
  };
  t.prototype.onExecute = function() {
    this.setOutputData(0, parseFloat(this.properties.value));
  };
  t.prototype.onDrawBackground = function(a) {
    this.outputs[0].label = this.properties.value.toFixed(3);
  };
  t.prototype.onWidget = function(a, b) {
    "value" == b.name && this.setValue(b.value);
  };
  l.registerNodeType("basic/const", t);
  v.title = "Watch";
  v.desc = "Show value of input";
  v.prototype.onExecute = function() {
    this.properties.value = this.getInputData(0);
    this.setOutputData(0, this.properties.value);
  };
  v.prototype.onDrawBackground = function(a) {
    this.inputs[0] && null != this.properties.value && (this.properties.value.constructor === Number ? this.inputs[0].label = this.properties.value.toFixed(3) : ((a = this.properties.value) && a.length && (a = Array.prototype.slice.call(a).join(",")), this.inputs[0].label = a));
  };
  l.registerNodeType("basic/watch", v);
  w.title = "Pass";
  w.desc = "Allows to connect different types";
  w.prototype.onExecute = function() {
    this.setOutputData(0, this.getInputData(0));
  };
  l.registerNodeType("basic/pass", w);
  e.title = "Console";
  e.desc = "Show value inside the console";
  e.prototype.onAction = function(a, b) {
    "log" == a ? console.log(b) : "warn" == a ? console.warn(b) : "error" == a && console.error(b);
  };
  e.prototype.onExecute = function() {
    var a = this.getInputData(1);
    null !== a && (this.properties.msg = a);
    console.log(a);
  };
  e.prototype.onGetInputs = function() {
    return [["log", l.ACTION], ["warn", l.ACTION], ["error", l.ACTION]];
  };
  l.registerNodeType("basic/console", e);
  q.title = "Script";
  q.desc = "executes a code";
  q.widgets_info = {onExecute:{type:"code"}};
  q.prototype.onPropertyChanged = function(a, b) {
    if ("onExecute" == a && l.allow_scripts) {
      this._func = null;
      try {
        this._func = new Function(b);
      } catch (d) {
        console.error("Error parsing script"), console.error(d);
      }
    }
  };
  q.prototype.onExecute = function() {
    if (this._func) {
      try {
        this._func.call(this);
      } catch (a) {
        console.error("Error in script"), console.error(a);
      }
    }
  };
  l.registerNodeType("basic/script", q);
})(this);
(function(u) {
  function f() {
    this.size = [60, 20];
    this.addInput("event", p.ACTION);
  }
  function k() {
    this.size = [60, 20];
    this.addInput("event", p.ACTION);
    this.addOutput("event", p.EVENT);
    this.properties = {equal_to:"", has_property:"", property_equal_to:""};
  }
  function c() {
    this.size = [60, 20];
    this.addProperty("time", 1000);
    this.addInput("event", p.ACTION);
    this.addOutput("on_time", p.EVENT);
    this._pending = [];
  }
  var p = u.LiteGraph;
  f.title = "Log Event";
  f.desc = "Log event in console";
  f.prototype.onAction = function(c, f) {
    console.log(c, f);
  };
  p.registerNodeType("events/log", f);
  k.title = "Filter Event";
  k.desc = "Blocks events that do not match the filter";
  k.prototype.onAction = function(c, f) {
    if (null != f && (!this.properties.equal_to || this.properties.equal_to == f)) {
      if (this.properties.has_property && (c = f[this.properties.has_property], null == c || this.properties.property_equal_to && this.properties.property_equal_to != c)) {
        return;
      }
      this.triggerSlot(0, f);
    }
  };
  p.registerNodeType("events/filter", k);
  c.title = "Delay";
  c.desc = "Delays one event";
  c.prototype.onAction = function(c, f) {
    this._pending.push([this.properties.time, f]);
  };
  c.prototype.onExecute = function() {
    for (var c = 1000 * this.graph.elapsed_time, f = 0; f < this._pending.length; ++f) {
      var p = this._pending[f];
      p[0] -= c;
      0 < p[0] || (this._pending.splice(f, 1), --f, this.trigger(null, p[1]));
    }
  };
  c.prototype.onGetInputs = function() {
    return [["event", p.ACTION]];
  };
  p.registerNodeType("events/delay", c);
})(this);
(function(u) {
  function f() {
    this.addOutput("clicked", w.EVENT);
    this.addProperty("text", "");
    this.addProperty("font", "40px Arial");
    this.addProperty("message", "");
    this.size = [64, 84];
  }
  function k() {
    this.addOutput("", "number");
    this.size = [64, 84];
    this.properties = {min:0, max:1, value:0.5, wcolor:"#7AF", size:50};
  }
  function c() {
    this.size = [160, 26];
    this.addOutput("", "number");
    this.properties = {wcolor:"#7AF", min:0, max:1, value:0.5};
  }
  function p() {
    this.size = [160, 26];
    this.addInput("", "number");
    this.properties = {min:0, max:1, value:0, wcolor:"#AAF"};
  }
  function t() {
    this.addInputs("", 0);
    this.properties = {value:"...", font:"Arial", fontsize:18, color:"#AAA", align:"left", glowSize:0, decimals:1};
  }
  function v() {
    this.size = [200, 100];
    this.properties = {borderColor:"#ffffff", bgcolorTop:"#f0f0f0", bgcolorBottom:"#e0e0e0", shadowSize:2, borderRadius:3};
  }
  var w = u.LiteGraph;
  f.title = "Button";
  f.desc = "Triggers an event";
  f.prototype.onDrawForeground = function(e) {
    !this.flags.collapsed && (e.fillStyle = "black", e.fillRect(1, 1, this.size[0] - 3, this.size[1] - 3), e.fillStyle = "#AAF", e.fillRect(0, 0, this.size[0] - 3, this.size[1] - 3), e.fillStyle = this.clicked ? "white" : this.mouseOver ? "#668" : "#334", e.fillRect(1, 1, this.size[0] - 4, this.size[1] - 4), this.properties.text || 0 === this.properties.text) && (e.textAlign = "center", e.fillStyle = this.clicked ? "black" : "white", this.properties.font && (e.font = this.properties.font), e.fillText(this.properties.text, 
    0.5 * this.size[0], 0.85 * this.size[1]), e.textAlign = "left");
  };
  f.prototype.onMouseDown = function(e, c) {
    if (1 < c[0] && 1 < c[1] && c[0] < this.size[0] - 2 && c[1] < this.size[1] - 2) {
      return this.clicked = !0, this.trigger("clicked", this.properties.message), !0;
    }
  };
  f.prototype.onMouseUp = function(e) {
    this.clicked = !1;
  };
  w.registerNodeType("widget/button", f);
  k.title = "Knob";
  k.desc = "Circular controller";
  k.widgets = [{name:"increase", text:"+", type:"minibutton"}, {name:"decrease", text:"-", type:"minibutton"}];
  k.prototype.onAdded = function() {
    this.value = (this.properties.value - this.properties.min) / (this.properties.max - this.properties.min);
    this.imgbg = this.loadImage("imgs/knob_bg.png");
    this.imgfg = this.loadImage("imgs/knob_fg.png");
  };
  k.prototype.onDrawImageKnob = function(e) {
    if (this.imgfg && this.imgfg.width) {
      var c = 0.5 * this.imgbg.width, l = this.size[0] / this.imgfg.width;
      e.save();
      e.translate(0, 20);
      e.scale(l, l);
      e.drawImage(this.imgbg, 0, 0);
      e.translate(c, c);
      e.rotate(2 * this.value * Math.PI * 6 / 8 + 10 * Math.PI / 8);
      e.translate(-c, -c);
      e.drawImage(this.imgfg, 0, 0);
      e.restore();
      this.title && (e.font = "bold 16px Criticized,Tahoma", e.fillStyle = "rgba(100,100,100,0.8)", e.textAlign = "center", e.fillText(this.title.toUpperCase(), 0.5 * this.size[0], 18), e.textAlign = "left");
    }
  };
  k.prototype.onDrawVectorKnob = function(e) {
    if (this.imgfg && this.imgfg.width) {
      e.lineWidth = 1;
      e.strokeStyle = this.mouseOver ? "#FFF" : "#AAA";
      e.fillStyle = "#000";
      e.beginPath();
      e.arc(0.5 * this.size[0], 0.5 * this.size[1] + 10, 0.5 * this.properties.size, 0, 2 * Math.PI, !0);
      e.stroke();
      0 < this.value && (e.strokeStyle = this.properties.wcolor, e.lineWidth = 0.2 * this.properties.size, e.beginPath(), e.arc(0.5 * this.size[0], 0.5 * this.size[1] + 10, 0.35 * this.properties.size, -0.5 * Math.PI + 2 * Math.PI * this.value, -0.5 * Math.PI, !0), e.stroke(), e.lineWidth = 1);
      e.font = 0.2 * this.properties.size + "px Arial";
      e.fillStyle = "#AAA";
      e.textAlign = "center";
      var c = this.properties.value;
      "number" == typeof c && (c = c.toFixed(2));
      e.fillText(c, 0.5 * this.size[0], 0.65 * this.size[1]);
      e.textAlign = "left";
    }
  };
  k.prototype.onDrawForeground = function(e) {
    this.onDrawImageKnob(e);
  };
  k.prototype.onExecute = function() {
    this.setOutputData(0, this.properties.value);
    this.boxcolor = w.colorToString([this.value, this.value, this.value]);
  };
  k.prototype.onMouseDown = function(e) {
    if (this.imgfg && this.imgfg.width) {
      this.center = [0.5 * this.size[0], 0.5 * this.size[1] + 20];
      this.radius = 0.5 * this.size[0];
      if (20 > e.canvasY - this.pos[1] || w.distance([e.canvasX, e.canvasY], [this.pos[0] + this.center[0], this.pos[1] + this.center[1]]) > this.radius) {
        return !1;
      }
      this.oldmouse = [e.canvasX - this.pos[0], e.canvasY - this.pos[1]];
      this.captureInput(!0);
      return !0;
    }
  };
  k.prototype.onMouseMove = function(e) {
    if (this.oldmouse) {
      e = [e.canvasX - this.pos[0], e.canvasY - this.pos[1]];
      var c = this.value;
      c -= 0.01 * (e[1] - this.oldmouse[1]);
      1.0 < c ? c = 1.0 : 0.0 > c && (c = 0.0);
      this.value = c;
      this.properties.value = this.properties.min + (this.properties.max - this.properties.min) * this.value;
      this.oldmouse = e;
      this.setDirtyCanvas(!0);
    }
  };
  k.prototype.onMouseUp = function(e) {
    this.oldmouse && (this.oldmouse = null, this.captureInput(!1));
  };
  k.prototype.onMouseLeave = function(e) {
  };
  k.prototype.onWidget = function(e, c) {
    if ("increase" == c.name) {
      this.onPropertyChanged("size", this.properties.size + 10);
    } else {
      if ("decrease" == c.name) {
        this.onPropertyChanged("size", this.properties.size - 10);
      }
    }
  };
  k.prototype.onPropertyChanged = function(e, c) {
    if ("wcolor" == e) {
      this.properties[e] = c;
    } else {
      if ("size" == e) {
        c = parseInt(c), this.properties[e] = c, this.size = [c + 4, c + 24], this.setDirtyCanvas(!0, !0);
      } else {
        if ("min" == e || "max" == e || "value" == e) {
          this.properties[e] = parseFloat(c);
        } else {
          return !1;
        }
      }
    }
    return !0;
  };
  w.registerNodeType("widget/knob", k);
  c.title = "H.Slider";
  c.desc = "Linear slider controller";
  c.prototype.onAdded = function() {
    this.value = 0.5;
    this.imgfg = this.loadImage("imgs/slider_fg.png");
  };
  c.prototype.onDrawVectorial = function(e) {
    this.imgfg && this.imgfg.width && (e.lineWidth = 1, e.strokeStyle = this.mouseOver ? "#FFF" : "#AAA", e.fillStyle = "#000", e.beginPath(), e.rect(2, 0, this.size[0] - 4, 20), e.stroke(), e.fillStyle = this.properties.wcolor, e.beginPath(), e.rect(2 + (this.size[0] - 4 - 20) * this.value, 0, 20, 20), e.fill());
  };
  c.prototype.onDrawImage = function(e) {
    this.imgfg && this.imgfg.width && (e.lineWidth = 1, e.fillStyle = "#000", e.fillRect(2, 9, this.size[0] - 4, 2), e.strokeStyle = "#333", e.beginPath(), e.moveTo(2, 9), e.lineTo(this.size[0] - 4, 9), e.stroke(), e.strokeStyle = "#AAA", e.beginPath(), e.moveTo(2, 11), e.lineTo(this.size[0] - 4, 11), e.stroke(), e.drawImage(this.imgfg, 2 + (this.size[0] - 4) * this.value - 0.5 * this.imgfg.width, 0.5 * -this.imgfg.height + 10));
  };
  c.prototype.onDrawForeground = function(e) {
    this.onDrawImage(e);
  };
  c.prototype.onExecute = function() {
    this.properties.value = this.properties.min + (this.properties.max - this.properties.min) * this.value;
    this.setOutputData(0, this.properties.value);
    this.boxcolor = w.colorToString([this.value, this.value, this.value]);
  };
  c.prototype.onMouseDown = function(e) {
    if (0 > e.canvasY - this.pos[1]) {
      return !1;
    }
    this.oldmouse = [e.canvasX - this.pos[0], e.canvasY - this.pos[1]];
    this.captureInput(!0);
    return !0;
  };
  c.prototype.onMouseMove = function(e) {
    if (this.oldmouse) {
      e = [e.canvasX - this.pos[0], e.canvasY - this.pos[1]];
      var c = this.value;
      c += (e[0] - this.oldmouse[0]) / this.size[0];
      1.0 < c ? c = 1.0 : 0.0 > c && (c = 0.0);
      this.value = c;
      this.oldmouse = e;
      this.setDirtyCanvas(!0);
    }
  };
  c.prototype.onMouseUp = function(e) {
    this.oldmouse = null;
    this.captureInput(!1);
  };
  c.prototype.onMouseLeave = function(e) {
  };
  c.prototype.onPropertyChanged = function(e, c) {
    if ("wcolor" == e) {
      this.properties[e] = c;
    } else {
      return !1;
    }
    return !0;
  };
  w.registerNodeType("widget/hslider", c);
  p.title = "Progress";
  p.desc = "Shows data in linear progress";
  p.prototype.onExecute = function() {
    var e = this.getInputData(0);
    void 0 != e && (this.properties.value = e);
  };
  p.prototype.onDrawForeground = function(e) {
    e.lineWidth = 1;
    e.fillStyle = this.properties.wcolor;
    var c = (this.properties.value - this.properties.min) / (this.properties.max - this.properties.min);
    c = Math.min(1, c);
    c = Math.max(0, c);
    e.fillRect(2, 2, (this.size[0] - 4) * c, this.size[1] - 4);
  };
  w.registerNodeType("widget/progress", p);
  t.title = "Text";
  t.desc = "Shows the input value";
  t.widgets = [{name:"resize", text:"Resize box", type:"button"}, {name:"led_text", text:"LED", type:"minibutton"}, {name:"normal_text", text:"Normal", type:"minibutton"}];
  t.prototype.onDrawForeground = function(e) {
    e.fillStyle = this.properties.color;
    var c = this.properties.value;
    this.properties.glowSize ? (e.shadowColor = this.properties.color, e.shadowOffsetX = 0, e.shadowOffsetY = 0, e.shadowBlur = this.properties.glowSize) : e.shadowColor = "transparent";
    var l = this.properties.fontsize;
    e.textAlign = this.properties.align;
    e.font = l.toString() + "px " + this.properties.font;
    this.str = "number" == typeof c ? c.toFixed(this.properties.decimals) : c;
    if ("string" == typeof this.str) {
      c = this.str.split("\\n");
      for (var a in c) {
        e.fillText(c[a], "left" == this.properties.align ? 15 : this.size[0] - 15, -0.15 * l + l * (parseInt(a) + 1));
      }
    }
    e.shadowColor = "transparent";
    this.last_ctx = e;
    e.textAlign = "left";
  };
  t.prototype.onExecute = function() {
    var e = this.getInputData(0);
    null != e && (this.properties.value = e);
  };
  t.prototype.resize = function() {
    if (this.last_ctx) {
      var e = this.str.split("\\n");
      this.last_ctx.font = this.properties.fontsize + "px " + this.properties.font;
      var c = 0, l;
      for (l in e) {
        var a = this.last_ctx.measureText(e[l]).width;
        c < a && (c = a);
      }
      this.size[0] = c + 20;
      this.size[1] = 4 + e.length * this.properties.fontsize;
      this.setDirtyCanvas(!0);
    }
  };
  t.prototype.onWidget = function(c, f) {
    "resize" == f.name ? this.resize() : "led_text" == f.name ? (this.properties.font = "Digital", this.properties.glowSize = 4, this.setDirtyCanvas(!0)) : "normal_text" == f.name && (this.properties.font = "Arial", this.setDirtyCanvas(!0));
  };
  t.prototype.onPropertyChanged = function(c, f) {
    this.properties[c] = f;
    this.str = "number" == typeof f ? f.toFixed(3) : f;
    return !0;
  };
  w.registerNodeType("widget/text", t);
  v.title = "Panel";
  v.desc = "Non interactive panel";
  v.widgets = [{name:"update", text:"Update", type:"button"}];
  v.prototype.createGradient = function(c) {
    "" == this.properties.bgcolorTop || "" == this.properties.bgcolorBottom ? this.lineargradient = 0 : (this.lineargradient = c.createLinearGradient(0, 0, 0, this.size[1]), this.lineargradient.addColorStop(0, this.properties.bgcolorTop), this.lineargradient.addColorStop(1, this.properties.bgcolorBottom));
  };
  v.prototype.onDrawForeground = function(c) {
    null == this.lineargradient && this.createGradient(c);
    this.lineargradient && (c.lineWidth = 1, c.strokeStyle = this.properties.borderColor, c.fillStyle = this.lineargradient, this.properties.shadowSize ? (c.shadowColor = "#000", c.shadowOffsetX = 0, c.shadowOffsetY = 0, c.shadowBlur = this.properties.shadowSize) : c.shadowColor = "transparent", c.roundRect(0, 0, this.size[0] - 1, this.size[1] - 1, this.properties.shadowSize), c.fill(), c.shadowColor = "transparent", c.stroke());
  };
  v.prototype.onWidget = function(c, f) {
    "update" == f.name && (this.lineargradient = null, this.setDirtyCanvas(!0));
  };
  w.registerNodeType("widget/panel", v);
})(this);
(function(u) {
  function f() {
    this.addOutput("left_x_axis", "number");
    this.addOutput("left_y_axis", "number");
    this.addOutput("button_pressed", k.EVENT);
    this.properties = {gamepad_index:0, threshold:0.1};
    this._left_axis = new Float32Array(2);
    this._right_axis = new Float32Array(2);
    this._triggers = new Float32Array(2);
    this._previous_buttons = new Uint8Array(17);
    this._current_buttons = new Uint8Array(17);
  }
  var k = u.LiteGraph;
  f.title = "Gamepad";
  f.desc = "gets the input of the gamepad";
  f.zero = new Float32Array(2);
  f.buttons = "a b x y lb rb lt rt back start ls rs home".split(" ");
  f.prototype.onExecute = function() {
    var c = this.getGamepad(), p = this.properties.threshold || 0.0;
    c && (this._left_axis[0] = Math.abs(c.xbox.axes.lx) > p ? c.xbox.axes.lx : 0, this._left_axis[1] = Math.abs(c.xbox.axes.ly) > p ? c.xbox.axes.ly : 0, this._right_axis[0] = Math.abs(c.xbox.axes.rx) > p ? c.xbox.axes.rx : 0, this._right_axis[1] = Math.abs(c.xbox.axes.ry) > p ? c.xbox.axes.ry : 0, this._triggers[0] = Math.abs(c.xbox.axes.ltrigger) > p ? c.xbox.axes.ltrigger : 0, this._triggers[1] = Math.abs(c.xbox.axes.rtrigger) > p ? c.xbox.axes.rtrigger : 0);
    if (this.outputs) {
      for (p = 0; p < this.outputs.length; p++) {
        var k = this.outputs[p];
        if (k.links && k.links.length) {
          var v = null;
          if (c) {
            switch(k.name) {
              case "left_axis":
                v = this._left_axis;
                break;
              case "right_axis":
                v = this._right_axis;
                break;
              case "left_x_axis":
                v = this._left_axis[0];
                break;
              case "left_y_axis":
                v = this._left_axis[1];
                break;
              case "right_x_axis":
                v = this._right_axis[0];
                break;
              case "right_y_axis":
                v = this._right_axis[1];
                break;
              case "trigger_left":
                v = this._triggers[0];
                break;
              case "trigger_right":
                v = this._triggers[1];
                break;
              case "a_button":
                v = c.xbox.buttons.a ? 1 : 0;
                break;
              case "b_button":
                v = c.xbox.buttons.b ? 1 : 0;
                break;
              case "x_button":
                v = c.xbox.buttons.x ? 1 : 0;
                break;
              case "y_button":
                v = c.xbox.buttons.y ? 1 : 0;
                break;
              case "lb_button":
                v = c.xbox.buttons.lb ? 1 : 0;
                break;
              case "rb_button":
                v = c.xbox.buttons.rb ? 1 : 0;
                break;
              case "ls_button":
                v = c.xbox.buttons.ls ? 1 : 0;
                break;
              case "rs_button":
                v = c.xbox.buttons.rs ? 1 : 0;
                break;
              case "start_button":
                v = c.xbox.buttons.start ? 1 : 0;
                break;
              case "back_button":
                v = c.xbox.buttons.back ? 1 : 0;
                break;
              case "button_pressed":
                for (k = 0; k < this._current_buttons.length; ++k) {
                  this._current_buttons[k] && !this._previous_buttons[k] && this.triggerSlot(p, f.buttons[k]);
                }
            }
          } else {
            switch(k.name) {
              case "button_pressed":
                break;
              case "left_axis":
              case "right_axis":
                v = f.zero;
                break;
              default:
                v = 0;
            }
          }
          this.setOutputData(p, v);
        }
      }
    }
  };
  f.prototype.getGamepad = function() {
    var c = navigator.getGamepads || navigator.webkitGetGamepads || navigator.mozGetGamepads;
    if (!c) {
      return null;
    }
    c = c.call(navigator);
    this._previous_buttons.set(this._current_buttons);
    for (var f = this.properties.gamepad_index; 4 > f; f++) {
      if (c[f]) {
        c = c[f];
        f = this.xbox_mapping;
        f || (f = this.xbox_mapping = {axes:[], buttons:{}, hat:""});
        f.axes.lx = c.axes[0];
        f.axes.ly = c.axes[1];
        f.axes.rx = c.axes[2];
        f.axes.ry = c.axes[3];
        f.axes.ltrigger = c.buttons[6].value;
        f.axes.rtrigger = c.buttons[7].value;
        for (var k = 0; k < c.buttons.length; k++) {
          switch(this._current_buttons[k] = c.buttons[k].pressed, k) {
            case 0:
              f.buttons.a = c.buttons[k].pressed;
              break;
            case 1:
              f.buttons.b = c.buttons[k].pressed;
              break;
            case 2:
              f.buttons.x = c.buttons[k].pressed;
              break;
            case 3:
              f.buttons.y = c.buttons[k].pressed;
              break;
            case 4:
              f.buttons.lb = c.buttons[k].pressed;
              break;
            case 5:
              f.buttons.rb = c.buttons[k].pressed;
              break;
            case 6:
              f.buttons.lt = c.buttons[k].pressed;
              break;
            case 7:
              f.buttons.rt = c.buttons[k].pressed;
              break;
            case 8:
              f.buttons.back = c.buttons[k].pressed;
              break;
            case 9:
              f.buttons.start = c.buttons[k].pressed;
              break;
            case 10:
              f.buttons.ls = c.buttons[k].pressed;
              break;
            case 11:
              f.buttons.rs = c.buttons[k].pressed;
              break;
            case 12:
              c.buttons[k].pressed && (f.hat += "up");
              break;
            case 13:
              c.buttons[k].pressed && (f.hat += "down");
              break;
            case 14:
              c.buttons[k].pressed && (f.hat += "left");
              break;
            case 15:
              c.buttons[k].pressed && (f.hat += "right");
              break;
            case 16:
              f.buttons.home = c.buttons[k].pressed;
          }
        }
        c.xbox = f;
        return c;
      }
    }
  };
  f.prototype.onDrawBackground = function(c) {
    var f = this._left_axis, k = this._right_axis;
    c.strokeStyle = "#88A";
    c.strokeRect(0.5 * (f[0] + 1) * this.size[0] - 4, 0.5 * (f[1] + 1) * this.size[1] - 4, 8, 8);
    c.strokeStyle = "#8A8";
    c.strokeRect(0.5 * (k[0] + 1) * this.size[0] - 4, 0.5 * (k[1] + 1) * this.size[1] - 4, 8, 8);
    f = this.size[1] / this._current_buttons.length;
    c.fillStyle = "#AEB";
    for (k = 0; k < this._current_buttons.length; ++k) {
      this._current_buttons[k] && c.fillRect(0, f * k, 6, f);
    }
  };
  f.prototype.onGetOutputs = function() {
    return [["left_axis", "vec2"], ["right_axis", "vec2"], ["left_x_axis", "number"], ["left_y_axis", "number"], ["right_x_axis", "number"], ["right_y_axis", "number"], ["trigger_left", "number"], ["trigger_right", "number"], ["a_button", "number"], ["b_button", "number"], ["x_button", "number"], ["y_button", "number"], ["lb_button", "number"], ["rb_button", "number"], ["ls_button", "number"], ["rs_button", "number"], ["start", "number"], ["back", "number"], ["button_pressed", k.EVENT]];
  };
  k.registerNodeType("input/gamepad", f);
})(this);
(function(u) {
  function f() {
    this.addInput("in", "*");
    this.size = [60, 20];
  }
  function k() {
    this.addInput("in");
    this.addOutput("out");
    this.size = [60, 20];
  }
  function c() {
    this.addInput("in", "number", {locked:!0});
    this.addOutput("out", "number", {locked:!0});
    this.addProperty("in", 0);
    this.addProperty("in_min", 0);
    this.addProperty("in_max", 1);
    this.addProperty("out_min", 0);
    this.addProperty("out_max", 1);
  }
  function p() {
    this.addOutput("value", "number");
    this.addProperty("min", 0);
    this.addProperty("max", 1);
    this.size = [60, 20];
  }
  function t() {
    this.addInput("in", "number");
    this.addOutput("out", "number");
    this.size = [60, 20];
    this.addProperty("min", 0);
    this.addProperty("max", 1);
  }
  function v() {
    this.properties = {f:0.5};
    this.addInput("A", "number");
    this.addInput("B", "number");
    this.addOutput("out", "number");
  }
  function w() {
    this.addInput("in", "number");
    this.addOutput("out", "number");
    this.size = [60, 20];
  }
  function e() {
    this.addInput("in", "number");
    this.addOutput("out", "number");
    this.size = [60, 20];
  }
  function q() {
    this.addInput("in", "number");
    this.addOutput("out", "number");
    this.size = [60, 20];
  }
  function l() {
    this.addInput("in", "number");
    this.addOutput("out", "number");
    this.size = [60, 20];
    this.properties = {A:0, B:1};
  }
  function a() {
    this.addInput("in", "number", {label:""});
    this.addOutput("out", "number", {label:""});
    this.size = [60, 20];
    this.addProperty("factor", 1);
  }
  function b() {
    this.addInput("in", "number");
    this.addOutput("out", "number");
    this.size = [60, 20];
    this.addProperty("samples", 10);
    this._values = new Float32Array(10);
    this._current = 0;
  }
  function d() {
    this.addInput("A", "number");
    this.addInput("B", "number");
    this.addOutput("=", "number");
    this.addProperty("A", 1);
    this.addProperty("B", 1);
    this.addProperty("OP", "+", "string", {values:d.values});
  }
  function g() {
    this.addInput("A", "number");
    this.addInput("B", "number");
    this.addOutput("A==B", "boolean");
    this.addOutput("A!=B", "boolean");
    this.addProperty("A", 0);
    this.addProperty("B", 0);
  }
  function h() {
    this.addInput("A", "number");
    this.addInput("B", "number");
    this.addOutput("out", "boolean");
    this.addProperty("A", 1);
    this.addProperty("B", 1);
    this.addProperty("OP", ">", "string", {values:h.values});
    this.size = [60, 40];
  }
  function x() {
    this.addInput("inc", "number");
    this.addOutput("total", "number");
    this.addProperty("increment", 1);
    this.addProperty("value", 0);
  }
  function n() {
    this.addInput("v", "number");
    this.addOutput("sin", "number");
    this.addProperty("amplitude", 1);
    this.addProperty("offset", 0);
    this.bgImageUrl = "nodes/imgs/icon-sin.png";
  }
  function z() {
    this.addInput("vec2", "vec2");
    this.addOutput("x", "number");
    this.addOutput("y", "number");
  }
  function A() {
    this.addInputs([["x", "number"], ["y", "number"]]);
    this.addOutput("vec2", "vec2");
    this.properties = {x:0, y:0};
    this._data = new Float32Array(2);
  }
  function D() {
    this.addInput("vec3", "vec3");
    this.addOutput("x", "number");
    this.addOutput("y", "number");
    this.addOutput("z", "number");
  }
  function B() {
    this.addInputs([["x", "number"], ["y", "number"], ["z", "number"]]);
    this.addOutput("vec3", "vec3");
    this.properties = {x:0, y:0, z:0};
    this._data = new Float32Array(3);
  }
  function C() {
    this.addInput("vec4", "vec4");
    this.addOutput("x", "number");
    this.addOutput("y", "number");
    this.addOutput("z", "number");
    this.addOutput("w", "number");
  }
  function E() {
    this.addInputs([["x", "number"], ["y", "number"], ["z", "number"], ["w", "number"]]);
    this.addOutput("vec4", "vec4");
    this.properties = {x:0, y:0, z:0, w:0};
    this._data = new Float32Array(4);
  }
  var y = u.LiteGraph;
  f.title = "Converter";
  f.desc = "type A to type B";
  f.prototype.onExecute = function() {
    var a = this.getInputData(0);
    if (null != a && this.outputs) {
      for (var b = 0; b < this.outputs.length; b++) {
        var d = this.outputs[b];
        if (d.links && d.links.length) {
          var c = null;
          switch(d.name) {
            case "number":
              c = a.length ? a[0] : parseFloat(a);
              break;
            case "vec2":
            case "vec3":
            case "vec4":
              c = 1;
              switch(d.name) {
                case "vec2":
                  c = 2;
                  break;
                case "vec3":
                  c = 3;
                  break;
                case "vec4":
                  c = 4;
              }c = new Float32Array(c);
              if (a.length) {
                for (d = 0; d < a.length && d < c.length; d++) {
                  c[d] = a[d];
                }
              } else {
                c[0] = parseFloat(a);
              }
          }
          this.setOutputData(b, c);
        }
      }
    }
  };
  f.prototype.onGetOutputs = function() {
    return [["number", "number"], ["vec2", "vec2"], ["vec3", "vec3"], ["vec4", "vec4"]];
  };
  y.registerNodeType("math/converter", f);
  k.title = "Bypass";
  k.desc = "removes the type";
  k.prototype.onExecute = function() {
    var a = this.getInputData(0);
    this.setOutputData(0, a);
  };
  y.registerNodeType("math/bypass", k);
  c.title = "Range";
  c.desc = "Convert a number from one range to another";
  c.prototype.onExecute = function() {
    if (this.inputs) {
      for (var a = 0; a < this.inputs.length; a++) {
        var b = this.inputs[a], d = this.getInputData(a);
        void 0 !== d && (this.properties[b.name] = d);
      }
    }
    d = this.properties["in"];
    if (void 0 === d || null === d || d.constructor !== Number) {
      d = 0;
    }
    a = this.properties.in_min;
    b = this.properties.out_min;
    this._last_v = (d - a) / (this.properties.in_max - a) * (this.properties.out_max - b) + b;
    this.setOutputData(0, this._last_v);
  };
  c.prototype.onDrawBackground = function(a) {
    this.outputs[0].label = this._last_v ? this._last_v.toFixed(3) : "?";
  };
  c.prototype.onGetInputs = function() {
    return [["in_min", "number"], ["in_max", "number"], ["out_min", "number"], ["out_max", "number"]];
  };
  y.registerNodeType("math/range", c);
  p.title = "Rand";
  p.desc = "Random number";
  p.prototype.onExecute = function() {
    if (this.inputs) {
      for (var a = 0; a < this.inputs.length; a++) {
        var b = this.inputs[a], d = this.getInputData(a);
        void 0 !== d && (this.properties[b.name] = d);
      }
    }
    a = this.properties.min;
    this._last_v = Math.random() * (this.properties.max - a) + a;
    this.setOutputData(0, this._last_v);
  };
  p.prototype.onDrawBackground = function(a) {
    this.outputs[0].label = this._last_v ? this._last_v.toFixed(3) : "?";
  };
  p.prototype.onGetInputs = function() {
    return [["min", "number"], ["max", "number"]];
  };
  y.registerNodeType("math/rand", p);
  t.title = "Clamp";
  t.desc = "Clamp number between min and max";
  t.filter = "shader";
  t.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null != a && (a = Math.max(this.properties.min, a), a = Math.min(this.properties.max, a), this.setOutputData(0, a));
  };
  t.prototype.getCode = function(a) {
    a = "";
    this.isInputConnected(0) && (a += "clamp({{0}}," + this.properties.min + "," + this.properties.max + ")");
    return a;
  };
  y.registerNodeType("math/clamp", t);
  v.title = "Lerp";
  v.desc = "Linear Interpolation";
  v.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null == a && (a = 0);
    var b = this.getInputData(1);
    null == b && (b = 0);
    var d = this.properties.f, c = this.getInputData(2);
    void 0 !== c && (d = c);
    this.setOutputData(0, a * (1 - d) + b * d);
  };
  v.prototype.onGetInputs = function() {
    return [["f", "number"]];
  };
  y.registerNodeType("math/lerp", v);
  w.title = "Abs";
  w.desc = "Absolute";
  w.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null != a && this.setOutputData(0, Math.abs(a));
  };
  y.registerNodeType("math/abs", w);
  e.title = "Floor";
  e.desc = "Floor number to remove fractional part";
  e.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null != a && this.setOutputData(0, Math.floor(a));
  };
  y.registerNodeType("math/floor", e);
  q.title = "Frac";
  q.desc = "Returns fractional part";
  q.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null != a && this.setOutputData(0, a % 1);
  };
  y.registerNodeType("math/frac", q);
  l.title = "Smoothstep";
  l.desc = "Smoothstep";
  l.prototype.onExecute = function() {
    var a = this.getInputData(0);
    if (void 0 !== a) {
      var b = this.properties.A;
      a = Math.clamp((a - b) / (this.properties.B - b), 0.0, 1.0);
      this.setOutputData(0, a * a * (3 - 2 * a));
    }
  };
  y.registerNodeType("math/smoothstep", l);
  a.title = "Scale";
  a.desc = "v * factor";
  a.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null != a && this.setOutputData(0, a * this.properties.factor);
  };
  y.registerNodeType("math/scale", a);
  b.title = "Average";
  b.desc = "Average Filter";
  b.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null == a && (a = 0);
    var b = this._values.length;
    this._values[this._current % b] = a;
    this._current += 1;
    this._current > b && (this._current = 0);
    for (var d = a = 0; d < b; ++d) {
      a += this._values[d];
    }
    this.setOutputData(0, a / b);
  };
  b.prototype.onPropertyChanged = function(a, b) {
    1 > b && (b = 1);
    this.properties.samples = Math.round(b);
    a = this._values;
    this._values = new Float32Array(this.properties.samples);
    a.length <= this._values.length ? this._values.set(a) : this._values.set(a.subarray(0, this._values.length));
  };
  y.registerNodeType("math/average", b);
  d.values = "+-*/%^".split("");
  d.title = "Operation";
  d.desc = "Easy math operators";
  d["@OP"] = {type:"enum", title:"operation", values:d.values};
  d.prototype.setValue = function(a) {
    "string" == typeof a && (a = parseFloat(a));
    this.properties.value = a;
  };
  d.prototype.onExecute = function() {
    var a = this.getInputData(0), b = this.getInputData(1);
    null != a ? this.properties.A = a : a = this.properties.A;
    null != b ? this.properties.B = b : b = this.properties.B;
    var d = 0;
    switch(this.properties.OP) {
      case "+":
        d = a + b;
        break;
      case "-":
        d = a - b;
        break;
      case "x":
      case "X":
      case "*":
        d = a * b;
        break;
      case "/":
        d = a / b;
        break;
      case "%":
        d = a % b;
        break;
      case "^":
        d = Math.pow(a, b);
        break;
      default:
        console.warn("Unknown operation: " + this.properties.OP);
    }
    this.setOutputData(0, d);
  };
  d.prototype.onDrawBackground = function(a) {
    this.flags.collapsed || (a.font = "40px Arial", a.fillStyle = "black", a.textAlign = "center", a.fillText(this.properties.OP, 0.5 * this.size[0], 0.5 * this.size[1] + y.NODE_TITLE_HEIGHT), a.textAlign = "left");
  };
  y.registerNodeType("math/operation", d);
  g.title = "Compare";
  g.desc = "compares between two values";
  g.prototype.onExecute = function() {
    var a = this.getInputData(0), b = this.getInputData(1);
    void 0 !== a ? this.properties.A = a : a = this.properties.A;
    void 0 !== b ? this.properties.B = b : b = this.properties.B;
    for (var d = 0, c = this.outputs.length; d < c; ++d) {
      var e = this.outputs[d];
      if (e.links && e.links.length) {
        switch(e.name) {
          case "A==B":
            value = a == b;
            break;
          case "A!=B":
            value = a != b;
            break;
          case "A>B":
            value = a > b;
            break;
          case "A<B":
            value = a < b;
            break;
          case "A<=B":
            value = a <= b;
            break;
          case "A>=B":
            value = a >= b;
        }
        this.setOutputData(d, value);
      }
    }
  };
  g.prototype.onGetOutputs = function() {
    return [["A==B", "boolean"], ["A!=B", "boolean"], ["A>B", "boolean"], ["A<B", "boolean"], ["A>=B", "boolean"], ["A<=B", "boolean"]];
  };
  y.registerNodeType("math/compare", g);
  h.values = "> < == != <= >=".split(" ");
  h["@OP"] = {type:"enum", title:"operation", values:h.values};
  h.title = "Condition";
  h.desc = "evaluates condition between A and B";
  h.prototype.onExecute = function() {
    var a = this.getInputData(0);
    void 0 === a ? a = this.properties.A : this.properties.A = a;
    var b = this.getInputData(1);
    void 0 === b ? b = this.properties.B : this.properties.B = b;
    var d = !0;
    switch(this.properties.OP) {
      case ">":
        d = a > b;
        break;
      case "<":
        d = a < b;
        break;
      case "==":
        d = a == b;
        break;
      case "!=":
        d = a != b;
        break;
      case "<=":
        d = a <= b;
        break;
      case ">=":
        d = a >= b;
    }
    this.setOutputData(0, d);
  };
  y.registerNodeType("math/condition", h);
  x.title = "Accumulate";
  x.desc = "Increments a value every time";
  x.prototype.onExecute = function() {
    null === this.properties.value && (this.properties.value = 0);
    var a = this.getInputData(0);
    this.properties.value = null !== a ? this.properties.value + a : this.properties.value + this.properties.increment;
    this.setOutputData(0, this.properties.value);
  };
  y.registerNodeType("math/accumulate", x);
  n.title = "Trigonometry";
  n.desc = "Sin Cos Tan";
  n.filter = "shader";
  n.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null == a && (a = 0);
    var b = this.properties.amplitude, d = this.findInputSlot("amplitude");
    -1 != d && (b = this.getInputData(d));
    var c = this.properties.offset;
    d = this.findInputSlot("offset");
    -1 != d && (c = this.getInputData(d));
    d = 0;
    for (var e = this.outputs.length; d < e; ++d) {
      switch(this.outputs[d].name) {
        case "sin":
          value = Math.sin(a);
          break;
        case "cos":
          value = Math.cos(a);
          break;
        case "tan":
          value = Math.tan(a);
          break;
        case "asin":
          value = Math.asin(a);
          break;
        case "acos":
          value = Math.acos(a);
          break;
        case "atan":
          value = Math.atan(a);
      }
      this.setOutputData(d, b * value + c);
    }
  };
  n.prototype.onGetInputs = function() {
    return [["v", "number"], ["amplitude", "number"], ["offset", "number"]];
  };
  n.prototype.onGetOutputs = function() {
    return [["sin", "number"], ["cos", "number"], ["tan", "number"], ["asin", "number"], ["acos", "number"], ["atan", "number"]];
  };
  y.registerNodeType("math/trigonometry", n);
  var r = function() {
    this.addInputs("x", "number");
    this.addInputs("y", "number");
    this.addOutputs("", "number");
    this.properties = {x:1.0, y:1.0, formula:"x+y"};
  };
  r.title = "Formula";
  r.desc = "Compute safe formula";
  r.prototype.onExecute = function() {
    var a = this.getInputData(0), b = this.getInputData(1);
    null != a ? this.properties.x = a : a = this.properties.x;
    null != b ? this.properties.y = b : b = this.properties.y;
    a = math.eval(this.properties.formula, {x:a, y:b, T:this.graph.globaltime});
    this.setOutputData(0, a);
  };
  r.prototype.onDrawBackground = function() {
    this.outputs[0].label = this.properties.formula;
  };
  r.prototype.onGetOutputs = function() {
    return [["A-B", "number"], ["A*B", "number"], ["A/B", "number"]];
  };
  y.registerNodeType("math/formula", r);
  z.title = "Vec2->XY";
  z.desc = "vector 2 to components";
  z.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null != a && (this.setOutputData(0, a[0]), this.setOutputData(1, a[1]));
  };
  y.registerNodeType("math3d/vec2-to-xyz", z);
  A.title = "XY->Vec2";
  A.desc = "components to vector2";
  A.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null == a && (a = this.properties.x);
    var b = this.getInputData(1);
    null == b && (b = this.properties.y);
    var d = this._data;
    d[0] = a;
    d[1] = b;
    this.setOutputData(0, d);
  };
  y.registerNodeType("math3d/xy-to-vec2", A);
  D.title = "Vec3->XYZ";
  D.desc = "vector 3 to components";
  D.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null != a && (this.setOutputData(0, a[0]), this.setOutputData(1, a[1]), this.setOutputData(2, a[2]));
  };
  y.registerNodeType("math3d/vec3-to-xyz", D);
  B.title = "XYZ->Vec3";
  B.desc = "components to vector3";
  B.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null == a && (a = this.properties.x);
    var b = this.getInputData(1);
    null == b && (b = this.properties.y);
    var d = this.getInputData(2);
    null == d && (d = this.properties.z);
    var c = this._data;
    c[0] = a;
    c[1] = b;
    c[2] = d;
    this.setOutputData(0, c);
  };
  y.registerNodeType("math3d/xyz-to-vec3", B);
  C.title = "Vec4->XYZW";
  C.desc = "vector 4 to components";
  C.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null != a && (this.setOutputData(0, a[0]), this.setOutputData(1, a[1]), this.setOutputData(2, a[2]), this.setOutputData(3, a[3]));
  };
  y.registerNodeType("math3d/vec4-to-xyzw", C);
  E.title = "XYZW->Vec4";
  E.desc = "components to vector4";
  E.prototype.onExecute = function() {
    var a = this.getInputData(0);
    null == a && (a = this.properties.x);
    var b = this.getInputData(1);
    null == b && (b = this.properties.y);
    var d = this.getInputData(2);
    null == d && (d = this.properties.z);
    var c = this.getInputData(3);
    null == c && (c = this.properties.w);
    var e = this._data;
    e[0] = a;
    e[1] = b;
    e[2] = d;
    e[3] = c;
    this.setOutputData(0, e);
  };
  y.registerNodeType("math3d/xyzw-to-vec4", E);
  if (u.glMatrix) {
    u = function() {
      this.addInputs([["A", "quat"], ["B", "quat"], ["factor", "number"]]);
      this.addOutput("slerp", "quat");
      this.addProperty("factor", 0.5);
      this._value = quat.create();
    };
    r = function() {
      this.addInputs([["A", "quat"], ["B", "quat"]]);
      this.addOutput("A*B", "quat");
      this._value = quat.create();
    };
    var F = function() {
      this.addInputs([["vec3", "vec3"], ["quat", "quat"]]);
      this.addOutput("result", "vec3");
      this.properties = {vec:[0, 0, 1]};
    }, G = function() {
      this.addInputs([["degrees", "number"], ["axis", "vec3"]]);
      this.addOutput("quat", "quat");
      this.properties = {angle:90.0, axis:vec3.fromValues(0, 1, 0)};
      this._value = quat.create();
    }, H = function() {
      this.addOutput("quat", "quat");
      this.properties = {x:0, y:0, z:0, w:1};
      this._value = quat.create();
    };
    H.title = "Quaternion";
    H.desc = "quaternion";
    H.prototype.onExecute = function() {
      this._value[0] = this.properties.x;
      this._value[1] = this.properties.y;
      this._value[2] = this.properties.z;
      this._value[3] = this.properties.w;
      this.setOutputData(0, this._value);
    };
    y.registerNodeType("math3d/quaternion", H);
    G.title = "Rotation";
    G.desc = "quaternion rotation";
    G.prototype.onExecute = function() {
      var a = this.getInputData(0);
      null == a && (a = this.properties.angle);
      var b = this.getInputData(1);
      null == b && (b = this.properties.axis);
      a = quat.setAxisAngle(this._value, b, 0.0174532925 * a);
      this.setOutputData(0, a);
    };
    y.registerNodeType("math3d/rotation", G);
    F.title = "Rot. Vec3";
    F.desc = "rotate a point";
    F.prototype.onExecute = function() {
      var a = this.getInputData(0);
      null == a && (a = this.properties.vec);
      var b = this.getInputData(1);
      null == b ? this.setOutputData(a) : this.setOutputData(0, vec3.transformQuat(vec3.create(), a, b));
    };
    y.registerNodeType("math3d/rotate_vec3", F);
    r.title = "Mult. Quat";
    r.desc = "rotate quaternion";
    r.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (null != a) {
        var b = this.getInputData(1);
        null != b && (a = quat.multiply(this._value, a, b), this.setOutputData(0, a));
      }
    };
    y.registerNodeType("math3d/mult-quat", r);
    u.title = "Quat Slerp";
    u.desc = "quaternion spherical interpolation";
    u.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (null != a) {
        var b = this.getInputData(1);
        if (null != b) {
          var d = this.properties.factor;
          null != this.getInputData(2) && (d = this.getInputData(2));
          a = quat.slerp(this._value, a, b, d);
          this.setOutputData(0, a);
        }
      }
    };
    y.registerNodeType("math3d/quat-slerp", u);
  }
})(this);
(function(u) {
  function f() {
    this.addInput("sel", "boolean");
    this.addOutput("value", "number");
    this.properties = {A:0, B:1};
    this.size = [60, 20];
  }
  u = u.LiteGraph;
  f.title = "Selector";
  f.desc = "outputs A if selector is true, B if selector is false";
  f.prototype.onExecute = function() {
    var f = this.getInputData(0);
    if (void 0 !== f) {
      for (var c = 1; c < this.inputs.length; c++) {
        var p = this.inputs[c], t = this.getInputData(c);
        void 0 !== t && (this.properties[p.name] = t);
      }
      c = this.properties.A;
      p = this.properties.B;
      this.setOutputData(0, f ? c : p);
    }
  };
  f.prototype.onGetInputs = function() {
    return [["A", 0], ["B", 0]];
  };
  u.registerNodeType("logic/selector", f);
})(this);
(function(u) {
  function f() {
    this.inputs = [];
    this.addOutput("frame", "image");
    this.properties = {url:""};
  }
  function k() {
    this.addInput("f", "number");
    this.addOutput("Color", "color");
    this.properties = {colorA:"#444444", colorB:"#44AAFF", colorC:"#44FFAA", colorD:"#FFFFFF"};
  }
  function c() {
    this.addInput("", "image");
    this.size = [200, 200];
  }
  function p() {
    this.addInputs([["img1", "image"], ["img2", "image"], ["fade", "number"]]);
    this.addOutput("", "image");
    this.properties = {fade:0.5, width:512, height:512};
  }
  function t() {
    this.addInput("", "image");
    this.addOutput("", "image");
    this.properties = {width:256, height:256, x:0, y:0, scale:1.0};
    this.size = [50, 20];
  }
  function v() {
    this.addInput("t", "number");
    this.addOutputs([["frame", "image"], ["t", "number"], ["d", "number"]]);
    this.properties = {url:""};
  }
  function w() {
    this.addOutput("Webcam", "image");
    this.properties = {};
  }
  var e = u.LiteGraph;
  f.title = "Image";
  f.desc = "Image loader";
  f.widgets = [{name:"load", text:"Load", type:"button"}];
  f.supported_extensions = ["jpg", "jpeg", "png", "gif"];
  f.prototype.onAdded = function() {
    "" != this.properties.url && null == this.img && this.loadImage(this.properties.url);
  };
  f.prototype.onDrawBackground = function(c) {
    this.img && 5 < this.size[0] && 5 < this.size[1] && c.drawImage(this.img, 0, 0, this.size[0], this.size[1]);
  };
  f.prototype.onExecute = function() {
    this.img || (this.boxcolor = "#000");
    this.img && this.img.width ? this.setOutputData(0, this.img) : this.setOutputData(0, null);
    this.img && this.img.dirty && (this.img.dirty = !1);
  };
  f.prototype.onPropertyChanged = function(c, e) {
    this.properties[c] = e;
    "url" == c && "" != e && this.loadImage(e);
    return !0;
  };
  f.prototype.loadImage = function(c, l) {
    if ("" == c) {
      this.img = null;
    } else {
      this.img = document.createElement("img");
      "http://" == c.substr(0, 7) && e.proxy && (c = e.proxy + c.substr(7));
      this.img.src = c;
      this.boxcolor = "#F95";
      var a = this;
      this.img.onload = function() {
        l && l(this);
        a.trace("Image loaded, size: " + a.img.width + "x" + a.img.height);
        this.dirty = !0;
        a.boxcolor = "#9F9";
        a.setDirtyCanvas(!0);
      };
    }
  };
  f.prototype.onWidget = function(c, e) {
    "load" == e.name && this.loadImage(this.properties.url);
  };
  f.prototype.onDropFile = function(c) {
    var e = this;
    this._url && URL.revokeObjectURL(this._url);
    this._url = URL.createObjectURL(c);
    this.properties.url = this._url;
    this.loadImage(this._url, function(a) {
      e.size[1] = a.height / a.width * e.size[0];
    });
  };
  e.registerNodeType("graphics/image", f);
  k.title = "Palette";
  k.desc = "Generates a color";
  k.prototype.onExecute = function() {
    var c = [];
    null != this.properties.colorA && c.push(hex2num(this.properties.colorA));
    null != this.properties.colorB && c.push(hex2num(this.properties.colorB));
    null != this.properties.colorC && c.push(hex2num(this.properties.colorC));
    null != this.properties.colorD && c.push(hex2num(this.properties.colorD));
    var e = this.getInputData(0);
    null == e && (e = 0.5);
    1.0 < e ? e = 1.0 : 0.0 > e && (e = 0.0);
    if (0 != c.length) {
      var a = [0, 0, 0];
      if (0 == e) {
        a = c[0];
      } else {
        if (1 == e) {
          a = c[c.length - 1];
        } else {
          var b = (c.length - 1) * e;
          e = c[Math.floor(b)];
          c = c[Math.floor(b) + 1];
          b -= Math.floor(b);
          a[0] = e[0] * (1 - b) + c[0] * b;
          a[1] = e[1] * (1 - b) + c[1] * b;
          a[2] = e[2] * (1 - b) + c[2] * b;
        }
      }
      for (var d in a) {
        a[d] /= 255;
      }
      this.boxcolor = colorToString(a);
      this.setOutputData(0, a);
    }
  };
  e.registerNodeType("color/palette", k);
  c.title = "Frame";
  c.desc = "Frame viewerew";
  c.widgets = [{name:"resize", text:"Resize box", type:"button"}, {name:"view", text:"View Image", type:"button"}];
  c.prototype.onDrawBackground = function(c) {
    this.frame && c.drawImage(this.frame, 0, 0, this.size[0], this.size[1]);
  };
  c.prototype.onExecute = function() {
    this.frame = this.getInputData(0);
    this.setDirtyCanvas(!0);
  };
  c.prototype.onWidget = function(c, e) {
    "resize" == e.name && this.frame ? (c = this.frame.width, e = this.frame.height, c || null == this.frame.videoWidth || (c = this.frame.videoWidth, e = this.frame.videoHeight), c && e && (this.size = [c, e]), this.setDirtyCanvas(!0, !0)) : "view" == e.name && this.show();
  };
  c.prototype.show = function() {
    showElement && this.frame && showElement(this.frame);
  };
  e.registerNodeType("graphics/frame", c);
  p.title = "Image fade";
  p.desc = "Fades between images";
  p.widgets = [{name:"resizeA", text:"Resize to A", type:"button"}, {name:"resizeB", text:"Resize to B", type:"button"}];
  p.prototype.onAdded = function() {
    this.createCanvas();
    var c = this.canvas.getContext("2d");
    c.fillStyle = "#000";
    c.fillRect(0, 0, this.properties.width, this.properties.height);
  };
  p.prototype.createCanvas = function() {
    this.canvas = document.createElement("canvas");
    this.canvas.width = this.properties.width;
    this.canvas.height = this.properties.height;
  };
  p.prototype.onExecute = function() {
    var c = this.canvas.getContext("2d");
    this.canvas.width = this.canvas.width;
    var e = this.getInputData(0);
    null != e && c.drawImage(e, 0, 0, this.canvas.width, this.canvas.height);
    e = this.getInputData(2);
    null == e ? e = this.properties.fade : this.properties.fade = e;
    c.globalAlpha = e;
    e = this.getInputData(1);
    null != e && c.drawImage(e, 0, 0, this.canvas.width, this.canvas.height);
    c.globalAlpha = 1.0;
    this.setOutputData(0, this.canvas);
    this.setDirtyCanvas(!0);
  };
  e.registerNodeType("graphics/imagefade", p);
  t.title = "Crop";
  t.desc = "Crop Image";
  t.prototype.onAdded = function() {
    this.createCanvas();
  };
  t.prototype.createCanvas = function() {
    this.canvas = document.createElement("canvas");
    this.canvas.width = this.properties.width;
    this.canvas.height = this.properties.height;
  };
  t.prototype.onExecute = function() {
    var c = this.getInputData(0);
    c && (c.width ? (this.canvas.getContext("2d").drawImage(c, -this.properties.x, -this.properties.y, c.width * this.properties.scale, c.height * this.properties.scale), this.setOutputData(0, this.canvas)) : this.setOutputData(0, null));
  };
  t.prototype.onDrawBackground = function(c) {
    this.flags.collapsed || this.canvas && c.drawImage(this.canvas, 0, 0, this.canvas.width, this.canvas.height, 0, 0, this.size[0], this.size[1]);
  };
  t.prototype.onPropertyChanged = function(c, e) {
    this.properties[c] = e;
    "scale" == c ? (this.properties[c] = parseFloat(e), 0 == this.properties[c] && (this.trace("Error in scale"), this.properties[c] = 1.0)) : this.properties[c] = parseInt(e);
    this.createCanvas();
    return !0;
  };
  e.registerNodeType("graphics/cropImage", t);
  v.title = "Video";
  v.desc = "Video playback";
  v.widgets = [{name:"play", text:"PLAY", type:"minibutton"}, {name:"stop", text:"STOP", type:"minibutton"}, {name:"demo", text:"Demo video", type:"button"}, {name:"mute", text:"Mute video", type:"button"}];
  v.prototype.onExecute = function() {
    if (this.properties.url && (this.properties.url != this._video_url && this.loadVideo(this.properties.url), this._video && 0 != this._video.width)) {
      var c = this.getInputData(0);
      c && 0 <= c && 1.0 >= c && (this._video.currentTime = c * this._video.duration, this._video.pause());
      this._video.dirty = !0;
      this.setOutputData(0, this._video);
      this.setOutputData(1, this._video.currentTime);
      this.setOutputData(2, this._video.duration);
      this.setDirtyCanvas(!0);
    }
  };
  v.prototype.onStart = function() {
    this.play();
  };
  v.prototype.onStop = function() {
    this.stop();
  };
  v.prototype.loadVideo = function(c) {
    this._video_url = c;
    this._video = document.createElement("video");
    this._video.src = c;
    this._video.type = "type=video/mp4";
    this._video.muted = !0;
    this._video.autoplay = !0;
    var e = this;
    this._video.addEventListener("loadedmetadata", function(a) {
      e.trace("Duration: " + this.duration + " seconds");
      e.trace("Size: " + this.videoWidth + "," + this.videoHeight);
      e.setDirtyCanvas(!0);
      this.width = this.videoWidth;
      this.height = this.videoHeight;
    });
    this._video.addEventListener("progress", function(a) {
    });
    this._video.addEventListener("error", function(a) {
      console.log("Error loading video: " + this.src);
      e.trace("Error loading video: " + this.src);
      if (this.error) {
        switch(this.error.code) {
          case this.error.MEDIA_ERR_ABORTED:
            e.trace("You stopped the video.");
            break;
          case this.error.MEDIA_ERR_NETWORK:
            e.trace("Network error - please try again later.");
            break;
          case this.error.MEDIA_ERR_DECODE:
            e.trace("Video is broken..");
            break;
          case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
            e.trace("Sorry, your browser can't play this video.");
        }
      }
    });
    this._video.addEventListener("ended", function(a) {
      e.trace("Ended.");
      this.play();
    });
  };
  v.prototype.onPropertyChanged = function(c, e) {
    this.properties[c] = e;
    "url" == c && "" != e && this.loadVideo(e);
    return !0;
  };
  v.prototype.play = function() {
    this._video && this._video.play();
  };
  v.prototype.playPause = function() {
    this._video && (this._video.paused ? this.play() : this.pause());
  };
  v.prototype.stop = function() {
    this._video && (this._video.pause(), this._video.currentTime = 0);
  };
  v.prototype.pause = function() {
    this._video && (this.trace("Video paused"), this._video.pause());
  };
  v.prototype.onWidget = function(c, e) {
  };
  e.registerNodeType("graphics/video", v);
  w.title = "Webcam";
  w.desc = "Webcam image";
  w.prototype.openStream = function() {
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    window.URL = window.URL || window.webkitURL;
    if (navigator.getUserMedia) {
      this._waiting_confirmation = !0;
      navigator.getUserMedia({video:!0}, this.streamReady.bind(this), function(e) {
        console.log("Webcam rejected", e);
        c._webcam_stream = !1;
        c.box_color = "red";
      });
      var c = this;
    }
  };
  w.prototype.onRemoved = function() {
    this._webcam_stream && (this._webcam_stream.stop(), this._video = this._webcam_stream = null);
  };
  w.prototype.streamReady = function(c) {
    this._webcam_stream = c;
    var e = this._video;
    e || (e = document.createElement("video"), e.autoplay = !0, e.src = window.URL.createObjectURL(c), this._video = e, e.onloadedmetadata = function(a) {
      console.log(a);
    });
  };
  w.prototype.onExecute = function() {
    null != this._webcam_stream || this._waiting_confirmation || this.openStream();
    this._video && this._video.videoWidth && (this._video.width = this._video.videoWidth, this._video.height = this._video.videoHeight, this.setOutputData(0, this._video));
  };
  w.prototype.getExtraMenuOptions = function(c) {
    var e = this;
    return [{content:e.properties.show ? "Hide Frame" : "Show Frame", callback:function() {
      e.properties.show = !e.properties.show;
    }}];
  };
  w.prototype.onDrawBackground = function(c) {
    this.flags.collapsed || 20 >= this.size[1] || !this.properties.show || !this._video || (c.save(), c.drawImage(this._video, 0, 0, this.size[0], this.size[1]), c.restore());
  };
  e.registerNodeType("graphics/webcam", w);
})(this);
(function(u) {
  var f = u.LiteGraph;
  u.LGraphTexture = null;
  if ("undefined" != typeof GL) {
    var k = function() {
      this.addOutput("Cubemap", "Cubemap");
      this.properties = {name:""};
      this.size = [r.image_preview_size, r.image_preview_size];
    }, c = function() {
      this.addInput("in", "Texture");
      this.addOutput("out", "Texture");
      this.properties = {key_color:vec3.fromValues(0., 1., 0.), threshold:0.8, slope:0.2, precision:r.DEFAULT};
      c._shader || (c._shader = new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER, c.pixel_shader));
    }, p = function() {
      this.addOutput("Webcam", "Texture");
      this.properties = {texture_name:""};
    }, t = function() {
      this.addInput("Texture", "Texture");
      this.addOutput("Filtered", "Texture");
      this.properties = {intensity:1, radius:5};
    }, v = function() {
      this.addInput("Texture", "Texture");
      this.addInput("Iterations", "number");
      this.addInput("Intensity", "number");
      this.addOutput("Blurred", "Texture");
      this.properties = {intensity:1, iterations:1, preserve_aspect:!1, scale:[1, 1]};
    }, w = function() {
      this.addInput("Texture", "Texture");
      this.addInput("Distance", "number");
      this.addInput("Range", "number");
      this.addOutput("Texture", "Texture");
      this.properties = {distance:100, range:50, only_depth:!1, high_precision:!1};
      this._uniforms = {u_texture:0, u_distance:100, u_range:50, u_camera_planes:null};
    }, e = function() {
      this.addInput("Tex.", "Texture");
      this.addOutput("Edges", "Texture");
      this.properties = {invert:!0, factor:1, precision:r.DEFAULT};
      e._shader || (e._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, e.pixel_shader));
    }, q = function() {
      this.addInput("A", "Texture");
      this.addInput("B", "Texture");
      this.addInput("Mixer", "Texture");
      this.addOutput("Texture", "Texture");
      this.properties = {precision:r.DEFAULT};
      q._shader || (q._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, q.pixel_shader));
    }, l = function() {
      this.addInput("A", "color");
      this.addInput("B", "color");
      this.addOutput("Texture", "Texture");
      this.properties = {angle:0, scale:1, A:[0, 0, 0], B:[1, 1, 1], texture_size:32};
      l._shader || (l._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, l.pixel_shader));
      this._uniforms = {u_angle:0, u_colorA:vec3.create(), u_colorB:vec3.create()};
    }, a = function() {
      this.addInput("R", "Texture");
      this.addInput("G", "Texture");
      this.addInput("B", "Texture");
      this.addInput("A", "Texture");
      this.addOutput("Texture", "Texture");
      this.properties = {};
      a._shader || (a._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, a.pixel_shader));
    }, b = function() {
      this.addInput("Texture", "Texture");
      this.addOutput("R", "Texture");
      this.addOutput("G", "Texture");
      this.addOutput("B", "Texture");
      this.addOutput("A", "Texture");
      this.properties = {};
      b._shader || (b._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, b.pixel_shader));
    }, d = function() {
      this.addInput("Texture", "Texture");
      this.addInput("LUT", "Texture");
      this.addInput("Intensity", "number");
      this.addOutput("", "Texture");
      this.properties = {intensity:1, precision:r.DEFAULT, texture:null};
      d._shader || (d._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, d.pixel_shader));
    }, g = function() {
      this.addInput("Image", "image");
      this.addOutput("", "Texture");
      this.properties = {};
    }, h = function() {
      this.addInput("Texture", "Texture");
      this.addOutput("", "Texture");
      this.properties = {mipmap_offset:0, low_precision:!1};
      this._uniforms = {u_texture:0, u_mipmap_offset:this.properties.mipmap_offset};
    }, x = function() {
      this.addInput("Texture", "Texture");
      this.addOutput("", "Texture");
      this.properties = {iterations:1, generate_mipmaps:!1, precision:r.DEFAULT};
    }, n = function() {
      this.addInput("Texture", "Texture");
      this.addOutput("", "Texture");
      this.properties = {size:0, generate_mipmaps:!1, precision:r.DEFAULT};
    }, z = function() {
      this.addInput("Texture", "Texture");
      this.properties = {additive:!1, antialiasing:!1, filter:!0, disable_alpha:!1, gamma:1.0};
      this.size[0] = 130;
    }, A = function() {
      this.addInput("in", "Texture");
      this.addInput("warp", "Texture");
      this.addInput("factor", "number");
      this.addOutput("out", "Texture");
      this.properties = {factor:0.01, precision:r.DEFAULT};
    }, D = function() {
      this.addInput("in", "Texture");
      this.addInput("scale", "vec2");
      this.addInput("offset", "vec2");
      this.addOutput("out", "Texture");
      this.properties = {offset:vec2.fromValues(0, 0), scale:vec2.fromValues(1, 1), precision:r.DEFAULT};
    }, B = function() {
      this.addOutput("Texture", "Texture");
      this.properties = {code:"", width:512, height:512};
      this.properties.code = "\nvoid main() {\n  vec2 uv = v_coord;\n  vec3 color = vec3(0.0);\n//your code here\n\ngl_FragColor = vec4(color, 1.0);\n}\n";
    }, C = function() {
      this.addInput("Texture", "Texture");
      this.addInput("TextureB", "Texture");
      this.addInput("value", "number");
      this.addOutput("Texture", "Texture");
      this.help = "<p>pixelcode must be vec3</p>\r\n\t\t\t<p>uvcode must be vec2, is optional</p>\r\n\t\t\t<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture</p><p><strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time</p><p><strong>value:</strong> input value</p>";
      this.properties = {value:1, uvcode:"", pixelcode:"color + colorB * value", precision:r.DEFAULT};
    }, E = function() {
      this.addInput("Texture", "Texture");
      this.addOutput("", "Texture");
      this.properties = {name:""};
    }, y = function() {
      this.addInput("Texture", "Texture");
      this.properties = {flipY:!1};
      this.size = [r.image_preview_size, r.image_preview_size];
    }, r = function() {
      this.addOutput("Texture", "Texture");
      this.properties = {name:"", filter:!0};
      this.size = [r.image_preview_size, r.image_preview_size];
    };
    u.LGraphTexture = r;
    r.title = "Texture";
    r.desc = "Texture";
    r.widgets_info = {name:{widget:"texture"}, filter:{widget:"checkbox"}};
    r.loadTextureCallback = null;
    r.image_preview_size = 256;
    r.PASS_THROUGH = 1;
    r.COPY = 2;
    r.LOW = 3;
    r.HIGH = 4;
    r.REUSE = 5;
    r.DEFAULT = 2;
    r.MODE_VALUES = {"pass through":r.PASS_THROUGH, copy:r.COPY, low:r.LOW, high:r.HIGH, reuse:r.REUSE, "default":r.DEFAULT};
    r.getTexturesContainer = function() {
      return gl.textures;
    };
    r.loadTexture = function(a, b) {
      b = b || {};
      var d = a;
      "http://" == d.substr(0, 7) && f.proxy && (d = f.proxy + d.substr(7));
      return r.getTexturesContainer()[a] = GL.Texture.fromURL(d, b);
    };
    r.getTexture = function(a) {
      var b = this.getTexturesContainer();
      if (!b) {
        throw "Cannot load texture, container of textures not found";
      }
      b = b[a];
      return !b && a && ":" != a[0] ? this.loadTexture(a) : b;
    };
    r.getTargetTexture = function(a, b, d) {
      if (!a) {
        throw "LGraphTexture.getTargetTexture expects a reference texture";
      }
      switch(d) {
        case r.LOW:
          d = gl.UNSIGNED_BYTE;
          break;
        case r.HIGH:
          d = gl.HIGH_PRECISION_FORMAT;
          break;
        case r.REUSE:
          return a;
        default:
          d = a ? a.type : gl.UNSIGNED_BYTE;
      }
      b && b.width == a.width && b.height == a.height && b.type == d || (b = new GL.Texture(a.width, a.height, {type:d, format:gl.RGBA, filter:gl.LINEAR}));
      return b;
    };
    r.getNoiseTexture = function() {
      if (this._noise_texture) {
        return this._noise_texture;
      }
      for (var a = new Uint8Array(1048576), b = 0; 1048576 > b; ++b) {
        a[b] = 255 * Math.random();
      }
      return this._noise_texture = a = GL.Texture.fromMemory(512, 512, a, {format:gl.RGBA, wrap:gl.REPEAT, filter:gl.NEAREST});
    };
    r.prototype.onDropFile = function(a, b, d) {
      a ? ("string" == typeof a ? a = GL.Texture.fromURL(a) : -1 != b.toLowerCase().indexOf(".dds") ? a = GL.Texture.fromDDSInMemory(a) : (a = new Blob([d]), a = URL.createObjectURL(a), a = GL.Texture.fromURL(a)), this._drop_texture = a, this.properties.name = b) : (this._drop_texture = null, this.properties.name = "");
    };
    r.prototype.getExtraMenuOptions = function(a) {
      var b = this;
      if (this._drop_texture) {
        return [{content:"Clear", callback:function() {
          b._drop_texture = null;
          b.properties.name = "";
        }}];
      }
    };
    r.prototype.onExecute = function() {
      var a = null;
      this.isOutputConnected(1) && (a = this.getInputData(0));
      !a && this._drop_texture && (a = this._drop_texture);
      !a && this.properties.name && (a = r.getTexture(this.properties.name));
      if (a) {
        this._last_tex = a;
        !1 === this.properties.filter ? a.setParameter(gl.TEXTURE_MAG_FILTER, gl.NEAREST) : a.setParameter(gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        this.setOutputData(0, a);
        for (var b = 1; b < this.outputs.length; b++) {
          var d = this.outputs[b];
          if (d) {
            var c = null;
            "width" == d.name ? c = a.width : "height" == d.name ? c = a.height : "aspect" == d.name && (c = a.width / a.height);
            this.setOutputData(b, c);
          }
        }
      }
    };
    r.prototype.onResourceRenamed = function(a, b) {
      this.properties.name == a && (this.properties.name = b);
    };
    r.prototype.onDrawBackground = function(a) {
      if (!(this.flags.collapsed || 20 >= this.size[1])) {
        if (this._drop_texture && a.webgl) {
          a.drawImage(this._drop_texture, 0, 0, this.size[0], this.size[1]);
        } else {
          if (this._last_preview_tex != this._last_tex) {
            if (a.webgl) {
              this._canvas = this._last_tex;
            } else {
              var b = r.generateLowResTexturePreview(this._last_tex);
              if (!b) {
                return;
              }
              this._last_preview_tex = this._last_tex;
              this._canvas = cloneCanvas(b);
            }
          }
          this._canvas && (a.save(), a.webgl || (a.translate(0, this.size[1]), a.scale(1, -1)), a.drawImage(this._canvas, 0, 0, this.size[0], this.size[1]), a.restore());
        }
      }
    };
    r.generateLowResTexturePreview = function(a) {
      if (!a) {
        return null;
      }
      var b = r.image_preview_size, d = a;
      if (a.format == gl.DEPTH_COMPONENT) {
        return null;
      }
      if (a.width > b || a.height > b) {
        d = this._preview_temp_tex, this._preview_temp_tex || (this._preview_temp_tex = d = new GL.Texture(b, b, {minFilter:gl.NEAREST})), a.copyTo(d);
      }
      a = this._preview_canvas;
      a || (this._preview_canvas = a = createCanvas(b, b));
      d && d.toCanvas(a);
      return a;
    };
    r.prototype.getResources = function(a) {
      a[this.properties.name] = GL.Texture;
      return a;
    };
    r.prototype.onGetInputs = function() {
      return [["in", "Texture"]];
    };
    r.prototype.onGetOutputs = function() {
      return [["width", "number"], ["height", "number"], ["aspect", "number"]];
    };
    f.registerNodeType("texture/texture", r);
    y.title = "Preview";
    y.desc = "Show a texture in the graph canvas";
    y.allow_preview = !1;
    y.prototype.onDrawBackground = function(a) {
      if (!this.flags.collapsed && (a.webgl || y.allow_preview)) {
        var b = this.getInputData(0);
        b && (b = !b.handle && a.webgl ? b : r.generateLowResTexturePreview(b), a.save(), this.properties.flipY && (a.translate(0, this.size[1]), a.scale(1, -1)), a.drawImage(b, 0, 0, this.size[0], this.size[1]), a.restore());
      }
    };
    f.registerNodeType("texture/preview", y);
    E.title = "Save";
    E.desc = "Save a texture in the repository";
    E.prototype.onExecute = function() {
      var a = this.getInputData(0);
      a && (this.properties.name && (r.storeTexture ? r.storeTexture(this.properties.name, a) : r.getTexturesContainer()[this.properties.name] = a), this.setOutputData(0, a));
    };
    f.registerNodeType("texture/save", E);
    C.widgets_info = {uvcode:{widget:"textarea", height:100}, pixelcode:{widget:"textarea", height:100}, precision:{widget:"combo", values:r.MODE_VALUES}};
    C.title = "Operation";
    C.desc = "Texture shader operation";
    C.prototype.getExtraMenuOptions = function(a) {
      var b = this;
      return [{content:b.properties.show ? "Hide Texture" : "Show Texture", callback:function() {
        b.properties.show = !b.properties.show;
      }}];
    };
    C.prototype.onDrawBackground = function(a) {
      this.flags.collapsed || 20 >= this.size[1] || !this.properties.show || !this._tex || this._tex.gl != a || (a.save(), a.drawImage(this._tex, 0, 0, this.size[0], this.size[1]), a.restore());
    };
    C.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (this.isOutputConnected(0)) {
        if (this.properties.precision === r.PASS_THROUGH) {
          this.setOutputData(0, a);
        } else {
          var b = this.getInputData(1);
          if (this.properties.uvcode || this.properties.pixelcode) {
            var d = 512, c = 512;
            a ? (d = a.width, c = a.height) : b && (d = b.width, c = b.height);
            this._tex = a || this._tex ? r.getTargetTexture(a || this._tex, this._tex, this.properties.precision) : new GL.Texture(d, c, {type:this.precision === r.LOW ? gl.UNSIGNED_BYTE : gl.HIGH_PRECISION_FORMAT, format:gl.RGBA, filter:gl.LINEAR});
            var e = "";
            this.properties.uvcode && (e = "uv = " + this.properties.uvcode, -1 != this.properties.uvcode.indexOf(";") && (e = this.properties.uvcode));
            var f = "";
            this.properties.pixelcode && (f = "result = " + this.properties.pixelcode, -1 != this.properties.pixelcode.indexOf(";") && (f = this.properties.pixelcode));
            var n = this._shader;
            if (!n || this._shader_code != e + "|" + f) {
              try {
                this._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, C.pixel_shader, {UV_CODE:e, PIXEL_CODE:f}), this.boxcolor = "#00FF00";
              } catch (I) {
                console.log("Error compiling shader: ", I);
                this.boxcolor = "#FF0000";
                return;
              }
              this.boxcolor = "#FF0000";
              this._shader_code = e + "|" + f;
              n = this._shader;
            }
            if (n) {
              this.boxcolor = "green";
              var l = this.getInputData(2);
              null != l ? this.properties.value = l : l = parseFloat(this.properties.value);
              var g = this.graph.getTime();
              this._tex.drawTo(function() {
                gl.disable(gl.DEPTH_TEST);
                gl.disable(gl.CULL_FACE);
                gl.disable(gl.BLEND);
                a && a.bind(0);
                b && b.bind(1);
                var e = Mesh.getScreenQuad();
                n.uniforms({u_texture:0, u_textureB:1, value:l, texSize:[d, c], time:g}).draw(e);
              });
              this.setOutputData(0, this._tex);
            } else {
              this.boxcolor = "red";
            }
          }
        }
      }
    };
    C.pixel_shader = "precision highp float;\n\r\n\t\t\t\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform sampler2D u_textureB;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform vec2 texSize;\n\r\n\t\t\tuniform float time;\n\r\n\t\t\tuniform float value;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec2 uv = v_coord;\n\r\n\t\t\t\tUV_CODE;\n\r\n\t\t\t\tvec4 color4 = texture2D(u_texture, uv);\n\r\n\t\t\t\tvec3 color = color4.rgb;\n\r\n\t\t\t\tvec4 color4B = texture2D(u_textureB, uv);\n\r\n\t\t\t\tvec3 colorB = color4B.rgb;\n\r\n\t\t\t\tvec3 result = color;\n\r\n\t\t\t\tfloat alpha = 1.0;\n\r\n\t\t\t\tPIXEL_CODE;\n\r\n\t\t\t\tgl_FragColor = vec4(result, alpha);\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/operation", C);
    B.title = "Shader";
    B.desc = "Texture shader";
    B.widgets_info = {code:{type:"code"}, precision:{widget:"combo", values:r.MODE_VALUES}};
    B.prototype.onPropertyChanged = function(a, b) {
      if ("code" == a && (a = this.getShader())) {
        b = a.uniformInfo;
        if (this.inputs) {
          for (var d = {}, c = 0; c < this.inputs.length; ++c) {
            var e = this.getInputInfo(c);
            e && (b[e.name] && !d[e.name] ? d[e.name] = !0 : (this.removeInput(c), c--));
          }
        }
        for (c in b) {
          if (e = a.uniformInfo[c], null !== e.loc && "time" != c) {
            if (this._shader.samplers[c]) {
              b = "texture";
            } else {
              switch(e.size) {
                case 1:
                  b = "number";
                  break;
                case 2:
                  b = "vec2";
                  break;
                case 3:
                  b = "vec3";
                  break;
                case 4:
                  b = "vec4";
                  break;
                case 9:
                  b = "mat3";
                  break;
                case 16:
                  b = "mat4";
                  break;
                default:
                  continue;
              }
            }
            d = this.findInputSlot(c);
            if (-1 != d && (e = this.getInputInfo(d))) {
              if (e.type == b) {
                continue;
              }
              this.removeInput(d, b);
            }
            this.addInput(c, b);
          }
        }
      }
    };
    B.prototype.getShader = function() {
      if (this._shader && this._shader_code == this.properties.code) {
        return this._shader;
      }
      this._shader_code = this.properties.code;
      this._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, B.pixel_shader + this.properties.code), this.boxcolor = "green";
      return this._shader;
    };
    B.prototype.onExecute = function() {
      if (this.isOutputConnected(0)) {
        var a = this.getShader();
        if (a) {
          for (var b = 0; b < this.inputs.length; ++b) {
            var d = this.getInputInfo(b), c = this.getInputData(b);
            null != c && (c.constructor === GL.Texture && (c.bind(slot), c = slot, slot++), a.setUniform(d.name, c));
          }
          this._tex && this._tex.width == this.properties.width && this._tex.height == this.properties.height || (this._tex = new GL.Texture(this.properties.width, this.properties.height, {format:gl.RGBA, filter:gl.LINEAR}));
          var e = this._tex, f = this.graph.getTime();
          e.drawTo(function() {
            a.uniforms({texSize:[e.width, e.height], time:f}).draw(Mesh.getScreenQuad());
          });
          this.setOutputData(0, this._tex);
        }
      }
    };
    B.pixel_shader = "precision highp float;\n\r\n\t\t\t\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform float time;\n\r\n\t\t\t";
    f.registerNodeType("texture/shader", B);
    D.widgets_info = {precision:{widget:"combo", values:r.MODE_VALUES}};
    D.title = "Scale/Offset";
    D.desc = "Applies an scaling and offseting";
    D.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (this.isOutputConnected(0) && a) {
        if (this.properties.precision === r.PASS_THROUGH) {
          this.setOutputData(0, a);
        } else {
          var b = a.width, d = a.height, c = this.precision === r.LOW ? gl.UNSIGNED_BYTE : gl.HIGH_PRECISION_FORMAT;
          this.precision === r.DEFAULT && (c = a.type);
          this._tex && this._tex.width == b && this._tex.height == d && this._tex.type == c || (this._tex = new GL.Texture(b, d, {type:c, format:gl.RGBA, filter:gl.LINEAR}));
          var e = this._shader;
          e || (e = new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER, D.pixel_shader));
          var f = this.getInputData(1);
          f ? (this.properties.scale[0] = f[0], this.properties.scale[1] = f[1]) : f = this.properties.scale;
          var n = this.getInputData(2);
          n ? (this.properties.offset[0] = n[0], this.properties.offset[1] = n[1]) : n = this.properties.offset;
          this._tex.drawTo(function() {
            gl.disable(gl.DEPTH_TEST);
            gl.disable(gl.CULL_FACE);
            gl.disable(gl.BLEND);
            a.bind(0);
            var b = Mesh.getScreenQuad();
            e.uniforms({u_texture:0, u_scale:f, u_offset:n}).draw(b);
          });
          this.setOutputData(0, this._tex);
        }
      }
    };
    D.pixel_shader = "precision highp float;\n\r\n\t\t\t\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform sampler2D u_textureB;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform vec2 u_scale;\n\r\n\t\t\tuniform vec2 u_offset;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec2 uv = v_coord;\n\r\n\t\t\t\tuv = uv / u_scale - u_offset;\n\r\n\t\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/scaleOffset", D);
    A.widgets_info = {precision:{widget:"combo", values:r.MODE_VALUES}};
    A.title = "Warp";
    A.desc = "Texture warp operation";
    A.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (this.isOutputConnected(0)) {
        if (this.properties.precision === r.PASS_THROUGH) {
          this.setOutputData(0, a);
        } else {
          var b = this.getInputData(1), d = 512, c = 512;
          a ? (d = a.width, c = a.height) : b && (d = b.width, c = b.height);
          this._tex = a || this._tex ? r.getTargetTexture(a || this._tex, this._tex, this.properties.precision) : new GL.Texture(d, c, {type:this.precision === r.LOW ? gl.UNSIGNED_BYTE : gl.HIGH_PRECISION_FORMAT, format:gl.RGBA, filter:gl.LINEAR});
          var e = this._shader;
          e || (e = new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER, A.pixel_shader));
          var f = this.getInputData(2);
          null != f ? this.properties.factor = f : f = parseFloat(this.properties.factor);
          this._tex.drawTo(function() {
            gl.disable(gl.DEPTH_TEST);
            gl.disable(gl.CULL_FACE);
            gl.disable(gl.BLEND);
            a && a.bind(0);
            b && b.bind(1);
            var d = Mesh.getScreenQuad();
            e.uniforms({u_texture:0, u_textureB:1, u_factor:f}).draw(d);
          });
          this.setOutputData(0, this._tex);
        }
      }
    };
    A.pixel_shader = "precision highp float;\n\r\n\t\t\t\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform sampler2D u_textureB;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform float u_factor;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec2 uv = v_coord;\n\r\n\t\t\t\tuv += ( texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor;\n\r\n\t\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/warp", A);
    z.title = "to Viewport";
    z.desc = "Texture to viewport";
    z.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (a) {
        this.properties.disable_alpha ? gl.disable(gl.BLEND) : (gl.enable(gl.BLEND), this.properties.additive ? gl.blendFunc(gl.SRC_ALPHA, gl.ONE) : gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA));
        gl.disable(gl.DEPTH_TEST);
        var b = this.properties.gamma || 1.0;
        this.isInputConnected(1) && (b = this.getInputData(1));
        a.setParameter(gl.TEXTURE_MAG_FILTER, this.properties.filter ? gl.LINEAR : gl.NEAREST);
        if (this.properties.antialiasing) {
          z._shader || (z._shader = new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER, z.aa_pixel_shader));
          gl.getViewport();
          var d = Mesh.getScreenQuad();
          a.bind(0);
          z._shader.uniforms({u_texture:0, uViewportSize:[a.width, a.height], u_igamma:1 / b, inverseVP:[1 / a.width, 1 / a.height]}).draw(d);
        } else {
          1.0 != b ? (z._gamma_shader || (z._gamma_shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, z.gamma_pixel_shader)), a.toViewport(z._gamma_shader, {u_texture:0, u_igamma:1 / b})) : a.toViewport();
        }
      }
    };
    z.prototype.onGetInputs = function() {
      return [["gamma", "number"]];
    };
    z.aa_pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec2 uViewportSize;\n\r\n\t\t\tuniform vec2 inverseVP;\n\r\n\t\t\tuniform float u_igamma;\n\r\n\t\t\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\r\n\t\t\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\r\n\t\t\t#define FXAA_SPAN_MAX     8.0\n\r\n\t\t\t\n\r\n\t\t\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\r\n\t\t\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\r\n\t\t\t{\n\r\n\t\t\t\tvec4 color = vec4(0.0);\n\r\n\t\t\t\t/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/\n\r\n\t\t\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;\n\r\n\t\t\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;\n\r\n\t\t\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;\n\r\n\t\t\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;\n\r\n\t\t\t\tvec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;\n\r\n\t\t\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\r\n\t\t\t\tfloat lumaNW = dot(rgbNW, luma);\n\r\n\t\t\t\tfloat lumaNE = dot(rgbNE, luma);\n\r\n\t\t\t\tfloat lumaSW = dot(rgbSW, luma);\n\r\n\t\t\t\tfloat lumaSE = dot(rgbSE, luma);\n\r\n\t\t\t\tfloat lumaM  = dot(rgbM,  luma);\n\r\n\t\t\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\r\n\t\t\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\r\n\t\t\t\t\n\r\n\t\t\t\tvec2 dir;\n\r\n\t\t\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\r\n\t\t\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\r\n\t\t\t\t\n\r\n\t\t\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\r\n\t\t\t\t\n\r\n\t\t\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\r\n\t\t\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;\n\r\n\t\t\t\t\n\r\n\t\t\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + \n\r\n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n\r\n\t\t\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + \n\r\n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\r\n\t\t\t\t\n\r\n\t\t\t\t//return vec4(rgbA,1.0);\n\r\n\t\t\t\tfloat lumaB = dot(rgbB, luma);\n\r\n\t\t\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\r\n\t\t\t\t\tcolor = vec4(rgbA, 1.0);\n\r\n\t\t\t\telse\n\r\n\t\t\t\t\tcolor = vec4(rgbB, 1.0);\n\r\n\t\t\t\tif(u_igamma != 1.0)\n\r\n\t\t\t\t\tcolor.xyz = pow( color.xyz, vec3(u_igamma) );\n\r\n\t\t\t\treturn color;\n\r\n\t\t\t}\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;\n\r\n\t\t\t}\n\r\n\t\t\t";
    z.gamma_pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform float u_igamma;\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 color = texture2D( u_texture, v_coord);\n\r\n\t\t\t\tcolor.xyz = pow(color.xyz, vec3(u_igamma) );\n\r\n\t\t\t   gl_FragColor = color;\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/toviewport", z);
    n.title = "Copy";
    n.desc = "Copy Texture";
    n.widgets_info = {size:{widget:"combo", values:[0, 32, 64, 128, 256, 512, 1024, 2048]}, precision:{widget:"combo", values:r.MODE_VALUES}};
    n.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if ((a || this._temp_texture) && this.isOutputConnected(0)) {
        if (a) {
          var b = a.width, d = a.height;
          0 != this.properties.size && (d = b = this.properties.size);
          var c = this._temp_texture, e = a.type;
          this.properties.precision === r.LOW ? e = gl.UNSIGNED_BYTE : this.properties.precision === r.HIGH && (e = gl.HIGH_PRECISION_FORMAT);
          c && c.width == b && c.height == d && c.type == e || (c = gl.LINEAR, this.properties.generate_mipmaps && isPowerOfTwo(b) && isPowerOfTwo(d) && (c = gl.LINEAR_MIPMAP_LINEAR), this._temp_texture = new GL.Texture(b, d, {type:e, format:gl.RGBA, minFilter:c, magFilter:gl.LINEAR}));
          a.copyTo(this._temp_texture);
          this.properties.generate_mipmaps && (this._temp_texture.bind(0), gl.generateMipmap(this._temp_texture.texture_type), this._temp_texture.unbind(0));
        }
        this.setOutputData(0, this._temp_texture);
      }
    };
    f.registerNodeType("texture/copy", n);
    x.title = "Downsample";
    x.desc = "Downsample Texture";
    x.widgets_info = {iterations:{type:"number", step:1, precision:0, min:1}, precision:{widget:"combo", values:r.MODE_VALUES}};
    x.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if ((a || this._temp_texture) && this.isOutputConnected(0) && a && a.texture_type === GL.TEXTURE_2D) {
        var b = x._shader;
        b || (x._shader = b = new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER, x.pixel_shader));
        var d = a.width | 0, c = a.height | 0, e = a.type;
        this.properties.precision === r.LOW ? e = gl.UNSIGNED_BYTE : this.properties.precision === r.HIGH && (e = gl.HIGH_PRECISION_FORMAT);
        var f = this.properties.iterations || 1, n = a, l = [];
        e = {type:e, format:a.format};
        var g = vec2.create(), h = {u_offset:g};
        this._texture && GL.Texture.releaseTemporary(this._texture);
        for (var k = 0; k < f; ++k) {
          g[0] = 1 / d;
          g[1] = 1 / c;
          d = d >> 1 || 0;
          c = c >> 1 || 0;
          a = GL.Texture.getTemporary(d, c, e);
          l.push(a);
          n.setParameter(GL.TEXTURE_MAG_FILTER, GL.NEAREST);
          n.copyTo(a, b, h);
          if (1 == d && 1 == c) {
            break;
          }
          n = a;
        }
        this._texture = l.pop();
        for (k = 0; k < l.length; ++k) {
          GL.Texture.releaseTemporary(l[k]);
        }
        this.properties.generate_mipmaps && (this._texture.bind(0), gl.generateMipmap(this._texture.texture_type), this._texture.unbind(0));
        this.setOutputData(0, this._texture);
      }
    };
    x.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec2 u_offset;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord );\n\r\n\t\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, 0.0 ) );\n\r\n\t\t\t\tcolor += texture2D(u_texture, v_coord + vec2( 0.0, u_offset.y ) );\n\r\n\t\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, u_offset.y ) );\n\r\n\t\t\t   gl_FragColor = color * 0.25;\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/downsample", x);
    h.title = "Average";
    h.desc = "Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture";
    h.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (a && this.isOutputConnected(0)) {
        if (!h._shader) {
          h._shader = new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER, h.pixel_shader);
          for (var b = new Float32Array(32), d = 0; 32 > d; ++d) {
            b[d] = Math.random();
          }
          h._shader.uniforms({u_samples_a:b.subarray(0, 16), u_samples_b:b.subarray(16, 32)});
        }
        b = this._temp_texture;
        d = this.properties.low_precision ? gl.UNSIGNED_BYTE : a.type;
        b && b.type == d || (this._temp_texture = new GL.Texture(1, 1, {type:d, format:gl.RGBA, filter:gl.NEAREST}));
        var c = h._shader, e = this._uniforms;
        e.u_mipmap_offset = this.properties.mipmap_offset;
        this._temp_texture.drawTo(function() {
          a.toViewport(c, e);
        });
        this.setOutputData(0, this._temp_texture);
      }
    };
    h.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tuniform mat4 u_samples_a;\n\r\n\t\t\tuniform mat4 u_samples_b;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform float u_mipmap_offset;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 color = vec4(0.0);\n\r\n\t\t\t\tfor(int i = 0; i < 4; ++i)\n\r\n\t\t\t\t\tfor(int j = 0; j < 4; ++j)\n\r\n\t\t\t\t\t{\n\r\n\t\t\t\t\t\tcolor += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );\n\r\n\t\t\t\t\t\tcolor += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );\n\r\n\t\t\t\t\t}\n\r\n\t\t\t   gl_FragColor = color * 0.03125;\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/average", h);
    g.title = "Image to Texture";
    g.desc = "Uploads an image to the GPU";
    g.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (a) {
        var b = a.videoWidth || a.width, d = a.videoHeight || a.height;
        if (a.gltexture) {
          this.setOutputData(0, a.gltexture);
        } else {
          var c = this._temp_texture;
          c && c.width == b && c.height == d || (this._temp_texture = new GL.Texture(b, d, {format:gl.RGBA, filter:gl.LINEAR}));
          try {
            this._temp_texture.uploadImage(a);
          } catch (J) {
            console.error("image comes from an unsafe location, cannot be uploaded to webgl");
            return;
          }
          this.setOutputData(0, this._temp_texture);
        }
      }
    };
    f.registerNodeType("texture/imageToTexture", g);
    d.widgets_info = {precision:{widget:"combo", values:r.MODE_VALUES}};
    d.title = "LUT";
    d.desc = "Apply LUT to Texture";
    d.widgets_info = {texture:{widget:"texture"}};
    d.prototype.onExecute = function() {
      if (this.isOutputConnected(0)) {
        var a = this.getInputData(0);
        if (this.properties.precision === r.PASS_THROUGH) {
          this.setOutputData(0, a);
        } else {
          if (a) {
            var b = this.getInputData(1);
            b || (b = r.getTexture(this.properties.texture));
            if (b) {
              b.bind(0);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
              gl.bindTexture(gl.TEXTURE_2D, null);
              var c = this.properties.intensity;
              this.isInputConnected(2) && (this.properties.intensity = c = this.getInputData(2));
              this._tex = r.getTargetTexture(a, this._tex, this.properties.precision);
              this._tex.drawTo(function() {
                b.bind(1);
                a.toViewport(d._shader, {u_texture:0, u_textureB:1, u_amount:c});
              });
              this.setOutputData(0, this._tex);
            } else {
              this.setOutputData(0, a);
            }
          }
        }
      }
    };
    d.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform sampler2D u_textureB;\n\r\n\t\t\tuniform float u_amount;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\t lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );\n\r\n\t\t\t\t mediump float blueColor = textureColor.b * 63.0;\n\r\n\t\t\t\t mediump vec2 quad1;\n\r\n\t\t\t\t quad1.y = floor(floor(blueColor) / 8.0);\n\r\n\t\t\t\t quad1.x = floor(blueColor) - (quad1.y * 8.0);\n\r\n\t\t\t\t mediump vec2 quad2;\n\r\n\t\t\t\t quad2.y = floor(ceil(blueColor) / 8.0);\n\r\n\t\t\t\t quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n\r\n\t\t\t\t highp vec2 texPos1;\n\r\n\t\t\t\t texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\r\n\t\t\t\t texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\r\n\t\t\t\t highp vec2 texPos2;\n\r\n\t\t\t\t texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\r\n\t\t\t\t texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\r\n\t\t\t\t lowp vec4 newColor1 = texture2D(u_textureB, texPos1);\n\r\n\t\t\t\t lowp vec4 newColor2 = texture2D(u_textureB, texPos2);\n\r\n\t\t\t\t lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n\r\n\t\t\t\t gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/LUT", d);
    b.title = "Texture to Channels";
    b.desc = "Split texture channels";
    b.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (a) {
        this._channels || (this._channels = Array(4));
        for (var d = 0, c = 0; 4 > c; c++) {
          this.isOutputConnected(c) ? (this._channels[c] && this._channels[c].width == a.width && this._channels[c].height == a.height && this._channels[c].type == a.type || (this._channels[c] = new GL.Texture(a.width, a.height, {type:a.type, format:gl.RGBA, filter:gl.LINEAR})), d++) : this._channels[c] = null;
        }
        if (d) {
          gl.disable(gl.BLEND);
          gl.disable(gl.DEPTH_TEST);
          var e = Mesh.getScreenQuad(), f = b._shader, n = [[1, 0, 0, 0], [0, 1, 0, 0], [0, 0, 1, 0], [0, 0, 0, 1]];
          for (c = 0; 4 > c; c++) {
            this._channels[c] && (this._channels[c].drawTo(function() {
              a.bind(0);
              f.uniforms({u_texture:0, u_mask:n[c]}).draw(e);
            }), this.setOutputData(c, this._channels[c]));
          }
        }
      }
    };
    b.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec4 u_mask;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/textureChannels", b);
    a.title = "Channels to Texture";
    a.desc = "Split texture channels";
    a.prototype.onExecute = function() {
      var b = [this.getInputData(0), this.getInputData(1), this.getInputData(2), this.getInputData(3)];
      if (b[0] && b[1] && b[2] && b[3]) {
        gl.disable(gl.BLEND);
        gl.disable(gl.DEPTH_TEST);
        var d = Mesh.getScreenQuad(), c = a._shader;
        this._tex = r.getTargetTexture(b[0], this._tex);
        this._tex.drawTo(function() {
          b[0].bind(0);
          b[1].bind(1);
          b[2].bind(2);
          b[3].bind(3);
          c.uniforms({u_textureR:0, u_textureG:1, u_textureB:2, u_textureA:3}).draw(d);
        });
        this.setOutputData(0, this._tex);
      }
    };
    a.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_textureR;\n\r\n\t\t\tuniform sampler2D u_textureG;\n\r\n\t\t\tuniform sampler2D u_textureB;\n\r\n\t\t\tuniform sampler2D u_textureA;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t   gl_FragColor = vec4( \r\n\t\t\t\t\t\ttexture2D(u_textureR, v_coord).r,\r\n\t\t\t\t\t\ttexture2D(u_textureG, v_coord).r,\r\n\t\t\t\t\t\ttexture2D(u_textureB, v_coord).r,\r\n\t\t\t\t\t\ttexture2D(u_textureA, v_coord).r);\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/channelsTexture", a);
    l.title = "Gradient";
    l.desc = "Generates a gradient";
    l["@A"] = {type:"color"};
    l["@B"] = {type:"color"};
    l["@texture_size"] = {type:"enum", values:[32, 64, 128, 256, 512]};
    l.prototype.onExecute = function() {
      gl.disable(gl.BLEND);
      gl.disable(gl.DEPTH_TEST);
      var a = GL.Mesh.getScreenQuad(), b = l._shader, d = this.getInputData(0);
      d || (d = this.properties.A);
      var c = this.getInputData(1);
      c || (c = this.properties.B);
      for (var e = 2; e < this.inputs.length; e++) {
        var f = this.inputs[e], n = this.getInputData(e);
        void 0 !== n && (this.properties[f.name] = n);
      }
      var g = this._uniforms;
      this._uniforms.u_angle = this.properties.angle * DEG2RAD;
      this._uniforms.u_scale = this.properties.scale;
      vec3.copy(g.u_colorA, d);
      vec3.copy(g.u_colorB, c);
      d = parseInt(this.properties.texture_size);
      this._tex && this._tex.width == d || (this._tex = new GL.Texture(d, d, {format:gl.RGB, filter:gl.LINEAR}));
      this._tex.drawTo(function() {
        b.uniforms(g).draw(a);
      });
      this.setOutputData(0, this._tex);
    };
    l.prototype.onGetInputs = function() {
      return [["angle", "number"], ["scale", "number"]];
    };
    l.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform float u_angle;\n\r\n\t\t\tuniform float u_scale;\n\r\n\t\t\tuniform vec3 u_colorA;\n\r\n\t\t\tuniform vec3 u_colorB;\n\r\n\t\t\t\n\r\n\t\t\tvec2 rotate(vec2 v, float angle)\n\r\n\t\t\t{\n\r\n\t\t\t\tvec2 result;\n\r\n\t\t\t\tfloat _cos = cos(angle);\n\r\n\t\t\t\tfloat _sin = sin(angle);\n\r\n\t\t\t\tresult.x = v.x * _cos - v.y * _sin;\n\r\n\t\t\t\tresult.y = v.x * _sin + v.y * _cos;\n\r\n\t\t\t\treturn result;\n\r\n\t\t\t}\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tfloat f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;\n\r\n\t\t\t\tvec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));\n\r\n\t\t\t   gl_FragColor = vec4(color,1.0);\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/gradient", l);
    q.title = "Mix";
    q.desc = "Generates a texture mixing two textures";
    q.widgets_info = {precision:{widget:"combo", values:r.MODE_VALUES}};
    q.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (this.isOutputConnected(0)) {
        if (this.properties.precision === r.PASS_THROUGH) {
          this.setOutputData(0, a);
        } else {
          var b = this.getInputData(1), d = this.getInputData(2);
          if (a && b && d) {
            this._tex = r.getTargetTexture(a, this._tex, this.properties.precision);
            gl.disable(gl.BLEND);
            gl.disable(gl.DEPTH_TEST);
            var c = Mesh.getScreenQuad(), e = q._shader;
            this._tex.drawTo(function() {
              a.bind(0);
              b.bind(1);
              d.bind(2);
              e.uniforms({u_textureA:0, u_textureB:1, u_textureMix:2}).draw(c);
            });
            this.setOutputData(0, this._tex);
          }
        }
      }
    };
    q.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_textureA;\n\r\n\t\t\tuniform sampler2D u_textureB;\n\r\n\t\t\tuniform sampler2D u_textureMix;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), texture2D(u_textureMix, v_coord) );\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/mix", q);
    e.title = "Edges";
    e.desc = "Detects edges";
    e.widgets_info = {precision:{widget:"combo", values:r.MODE_VALUES}};
    e.prototype.onExecute = function() {
      if (this.isOutputConnected(0)) {
        var a = this.getInputData(0);
        if (this.properties.precision === r.PASS_THROUGH) {
          this.setOutputData(0, a);
        } else {
          if (a) {
            this._tex = r.getTargetTexture(a, this._tex, this.properties.precision);
            gl.disable(gl.BLEND);
            gl.disable(gl.DEPTH_TEST);
            var b = Mesh.getScreenQuad(), d = e._shader, c = this.properties.invert, f = this.properties.factor;
            this._tex.drawTo(function() {
              a.bind(0);
              d.uniforms({u_texture:0, u_isize:[1 / a.width, 1 / a.height], u_factor:f, u_invert:c ? 1 : 0}).draw(b);
            });
            this.setOutputData(0, this._tex);
          }
        }
      }
    };
    e.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec2 u_isize;\n\r\n\t\t\tuniform int u_invert;\n\r\n\t\t\tuniform float u_factor;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 center = texture2D(u_texture, v_coord);\n\r\n\t\t\t\tvec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );\n\r\n\t\t\t\tvec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );\n\r\n\t\t\t\tvec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );\n\r\n\t\t\t\tvec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );\n\r\n\t\t\t\tvec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);\n\r\n\t\t\t\tdiff *= u_factor;\n\r\n\t\t\t\tif(u_invert == 1)\n\r\n\t\t\t\t\tdiff.xyz = vec3(1.0) - diff.xyz;\n\r\n\t\t\t   gl_FragColor = vec4( diff.xyz, center.a );\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/edges", e);
    w.title = "Depth Range";
    w.desc = "Generates a texture with a depth range";
    w.prototype.onExecute = function() {
      if (this.isOutputConnected(0)) {
        var a = this.getInputData(0);
        if (a) {
          var b = gl.UNSIGNED_BYTE;
          this.properties.high_precision && (b = gl.half_float_ext ? gl.HALF_FLOAT_OES : gl.FLOAT);
          this._temp_texture && this._temp_texture.type == b && this._temp_texture.width == a.width && this._temp_texture.height == a.height || (this._temp_texture = new GL.Texture(a.width, a.height, {type:b, format:gl.RGBA, filter:gl.LINEAR}));
          var d = this._uniforms;
          b = this.properties.distance;
          this.isInputConnected(1) && (b = this.getInputData(1), this.properties.distance = b);
          var c = this.properties.range;
          this.isInputConnected(2) && (c = this.getInputData(2), this.properties.range = c);
          d.u_distance = b;
          d.u_range = c;
          gl.disable(gl.BLEND);
          gl.disable(gl.DEPTH_TEST);
          var e = Mesh.getScreenQuad();
          w._shader || (w._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, w.pixel_shader), w._shader_onlydepth = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, w.pixel_shader, {ONLY_DEPTH:""}));
          var f = this.properties.only_depth ? w._shader_onlydepth : w._shader;
          b = null;
          b = a.near_far_planes ? a.near_far_planes : window.LS && LS.Renderer._main_camera ? LS.Renderer._main_camera._uniforms.u_camera_planes : [0.1, 1000];
          d.u_camera_planes = b;
          this._temp_texture.drawTo(function() {
            a.bind(0);
            f.uniforms(d).draw(e);
          });
          this.setOutputData(0, this._temp_texture);
        }
      }
    };
    w.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec2 u_camera_planes;\n\r\n\t\t\tuniform float u_distance;\n\r\n\t\t\tuniform float u_range;\n\r\n\t\t\t\n\r\n\t\t\tfloat LinearDepth()\n\r\n\t\t\t{\n\r\n\t\t\t\tfloat zNear = u_camera_planes.x;\n\r\n\t\t\t\tfloat zFar = u_camera_planes.y;\n\r\n\t\t\t\tfloat depth = texture2D(u_texture, v_coord).x;\n\r\n\t\t\t\tdepth = depth * 2.0 - 1.0;\n\r\n\t\t\t\treturn zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\r\n\t\t\t}\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tfloat depth = LinearDepth();\n\r\n\t\t\t\t#ifdef ONLY_DEPTH\n\r\n\t\t\t\t   gl_FragColor = vec4(depth);\n\r\n\t\t\t\t#else\n\r\n\t\t\t\t\tfloat diff = abs(depth * u_camera_planes.y - u_distance);\n\r\n\t\t\t\t\tfloat dof = 1.0;\n\r\n\t\t\t\t\tif(diff <= u_range)\n\r\n\t\t\t\t\t\tdof = diff / u_range;\n\r\n\t\t\t\t   gl_FragColor = vec4(dof);\n\r\n\t\t\t\t#endif\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/depth_range", w);
    v.title = "Blur";
    v.desc = "Blur a texture";
    v.max_iterations = 20;
    v.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (a && this.isOutputConnected(0)) {
        var b = this._temp_texture;
        b && b.width == a.width && b.height == a.height && b.type == a.type || (this._temp_texture = new GL.Texture(a.width, a.height, {type:a.type, format:gl.RGBA, filter:gl.LINEAR}), this._final_texture = new GL.Texture(a.width, a.height, {type:a.type, format:gl.RGBA, filter:gl.LINEAR}));
        b = this.properties.iterations;
        this.isInputConnected(1) && (b = this.getInputData(1), this.properties.iterations = b);
        b = Math.min(Math.floor(b), v.max_iterations);
        if (0 == b) {
          this.setOutputData(0, a);
        } else {
          var d = this.properties.intensity;
          this.isInputConnected(2) && (d = this.getInputData(2), this.properties.intensity = d);
          var c = f.camera_aspect;
          c || void 0 === window.gl || (c = gl.canvas.height / gl.canvas.width);
          c || (c = 1);
          c = this.properties.preserve_aspect ? c : 1;
          for (var e = this.properties.scale || [1, 1], n = 0; n < b; ++n) {
            a.applyBlur(c * e[0] * n, e[1] * n, d, this._temp_texture, this._final_texture), a = this._final_texture;
          }
          this.setOutputData(0, this._final_texture);
        }
      }
    };
    v.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec2 u_offset;\n\r\n\t\t\tuniform float u_intensity;\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t   vec4 sum = vec4(0.0);\n\r\n\t\t\t   vec4 center = texture2D(u_texture, v_coord);\n\r\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\r\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\r\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\r\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\r\n\t\t\t   sum += center * 0.16/0.98;\n\r\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\r\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\r\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\r\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\r\n\t\t\t   gl_FragColor = u_intensity * sum;\n\r\n\t\t\t   /*gl_FragColor.a = center.a*/;\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("texture/blur", v);
    t.title = "Kuwahara Filter";
    t.desc = "Filters a texture giving an artistic oil canvas painting";
    t.max_radius = 10;
    t._shaders = [];
    t.prototype.onExecute = function() {
      var a = this.getInputData(0);
      if (a && this.isOutputConnected(0)) {
        var b = this._temp_texture;
        b && b.width == a.width && b.height == a.height && b.type == a.type || (this._temp_texture = new GL.Texture(a.width, a.height, {type:a.type, format:gl.RGBA, filter:gl.LINEAR}));
        b = this.properties.radius;
        b = Math.min(Math.floor(b), t.max_radius);
        if (0 == b) {
          this.setOutputData(0, a);
        } else {
          var d = this.properties.intensity, c = f.camera_aspect;
          c || void 0 === window.gl || (c = gl.canvas.height / gl.canvas.width);
          c || (c = 1);
          c = this.properties.preserve_aspect ? c : 1;
          t._shaders[b] || (t._shaders[b] = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, t.pixel_shader, {RADIUS:b.toFixed(0)}));
          var e = t._shaders[b], n = GL.Mesh.getScreenQuad();
          a.bind(0);
          this._temp_texture.drawTo(function() {
            e.uniforms({u_texture:0, u_intensity:d, u_resolution:[a.width, a.height], u_iResolution:[1 / a.width, 1 / a.height]}).draw(n);
          });
          this.setOutputData(0, this._temp_texture);
        }
      }
    };
    t.pixel_shader = "\n\r\n\tprecision highp float;\n\r\n\tvarying vec2 v_coord;\n\r\n\tuniform sampler2D u_texture;\n\r\n\tuniform float u_intensity;\n\r\n\tuniform vec2 u_resolution;\n\r\n\tuniform vec2 u_iResolution;\n\r\n\t#ifndef RADIUS\n\r\n\t\t#define RADIUS 7\n\r\n\t#endif\n\r\n\tvoid main() {\n\r\n\t\n\r\n\t\tconst int radius = RADIUS;\n\r\n\t\tvec2 fragCoord = v_coord;\n\r\n\t\tvec2 src_size = u_iResolution;\n\r\n\t\tvec2 uv = v_coord;\n\r\n\t\tfloat n = float((radius + 1) * (radius + 1));\n\r\n\t\tint i;\n\r\n\t\tint j;\n\r\n\t\tvec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);\n\r\n\t\tvec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);\n\r\n\t\tvec3 c;\n\r\n\t\t\n\r\n\t\tfor (int j = -radius; j <= 0; ++j)  {\n\r\n\t\t\tfor (int i = -radius; i <= 0; ++i)  {\n\r\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\r\n\t\t\t\tm0 += c;\n\r\n\t\t\t\ts0 += c * c;\n\r\n\t\t\t}\n\r\n\t\t}\n\r\n\t\t\n\r\n\t\tfor (int j = -radius; j <= 0; ++j)  {\n\r\n\t\t\tfor (int i = 0; i <= radius; ++i)  {\n\r\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\r\n\t\t\t\tm1 += c;\n\r\n\t\t\t\ts1 += c * c;\n\r\n\t\t\t}\n\r\n\t\t}\n\r\n\t\t\n\r\n\t\tfor (int j = 0; j <= radius; ++j)  {\n\r\n\t\t\tfor (int i = 0; i <= radius; ++i)  {\n\r\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\r\n\t\t\t\tm2 += c;\n\r\n\t\t\t\ts2 += c * c;\n\r\n\t\t\t}\n\r\n\t\t}\n\r\n\t\t\n\r\n\t\tfor (int j = 0; j <= radius; ++j)  {\n\r\n\t\t\tfor (int i = -radius; i <= 0; ++i)  {\n\r\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\r\n\t\t\t\tm3 += c;\n\r\n\t\t\t\ts3 += c * c;\n\r\n\t\t\t}\n\r\n\t\t}\n\r\n\t\t\n\r\n\t\tfloat min_sigma2 = 1e+2;\n\r\n\t\tm0 /= n;\n\r\n\t\ts0 = abs(s0 / n - m0 * m0);\n\r\n\t\t\n\r\n\t\tfloat sigma2 = s0.r + s0.g + s0.b;\n\r\n\t\tif (sigma2 < min_sigma2) {\n\r\n\t\t\tmin_sigma2 = sigma2;\n\r\n\t\t\tgl_FragColor = vec4(m0, 1.0);\n\r\n\t\t}\n\r\n\t\t\n\r\n\t\tm1 /= n;\n\r\n\t\ts1 = abs(s1 / n - m1 * m1);\n\r\n\t\t\n\r\n\t\tsigma2 = s1.r + s1.g + s1.b;\n\r\n\t\tif (sigma2 < min_sigma2) {\n\r\n\t\t\tmin_sigma2 = sigma2;\n\r\n\t\t\tgl_FragColor = vec4(m1, 1.0);\n\r\n\t\t}\n\r\n\t\t\n\r\n\t\tm2 /= n;\n\r\n\t\ts2 = abs(s2 / n - m2 * m2);\n\r\n\t\t\n\r\n\t\tsigma2 = s2.r + s2.g + s2.b;\n\r\n\t\tif (sigma2 < min_sigma2) {\n\r\n\t\t\tmin_sigma2 = sigma2;\n\r\n\t\t\tgl_FragColor = vec4(m2, 1.0);\n\r\n\t\t}\n\r\n\t\t\n\r\n\t\tm3 /= n;\n\r\n\t\ts3 = abs(s3 / n - m3 * m3);\n\r\n\t\t\n\r\n\t\tsigma2 = s3.r + s3.g + s3.b;\n\r\n\t\tif (sigma2 < min_sigma2) {\n\r\n\t\t\tmin_sigma2 = sigma2;\n\r\n\t\t\tgl_FragColor = vec4(m3, 1.0);\n\r\n\t\t}\n\r\n\t}\n\r\n\t";
    f.registerNodeType("texture/kuwahara", t);
    p.title = "Webcam";
    p.desc = "Webcam texture";
    p.prototype.openStream = function() {
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
      window.URL = window.URL || window.webkitURL;
      if (navigator.getUserMedia) {
        this._waiting_confirmation = !0;
        var a = this;
        navigator.getUserMedia({video:!0}, this.streamReady.bind(this), function(b) {
          console.log("Webcam rejected", b);
          a._webcam_stream = !1;
          a.box_color = "red";
        });
      }
    };
    p.prototype.streamReady = function(a) {
      this._webcam_stream = a;
      var b = this._video;
      b || (b = document.createElement("video"), b.autoplay = !0, b.src = window.URL.createObjectURL(a), this._video = b, b.onloadedmetadata = function(a) {
        console.log(a);
      });
    };
    p.prototype.onRemoved = function() {
      this._webcam_stream && (this._webcam_stream.stop(), this._video = this._webcam_stream = null);
    };
    p.prototype.onDrawBackground = function(a) {
      this.flags.collapsed || 20 >= this.size[1] || !this._video || (a.save(), a.webgl ? this._temp_texture && a.drawImage(this._temp_texture, 0, 0, this.size[0], this.size[1]) : (a.translate(0, this.size[1]), a.scale(1, -1), a.drawImage(this._video, 0, 0, this.size[0], this.size[1])), a.restore());
    };
    p.prototype.onExecute = function() {
      null != this._webcam_stream || this._waiting_confirmation || this.openStream();
      if (this._video && this._video.videoWidth) {
        var a = this._video.videoWidth, b = this._video.videoHeight, d = this._temp_texture;
        d && d.width == a && d.height == b || (this._temp_texture = new GL.Texture(a, b, {format:gl.RGB, filter:gl.LINEAR}));
        this._temp_texture.uploadImage(this._video);
        this.properties.texture_name && (r.getTexturesContainer()[this.properties.texture_name] = this._temp_texture);
        this.setOutputData(0, this._temp_texture);
      }
    };
    f.registerNodeType("texture/webcam", p);
    c.title = "Matte";
    c.desc = "Extracts background";
    c.widgets_info = {key_color:{widget:"color"}, precision:{widget:"combo", values:r.MODE_VALUES}};
    c.prototype.onExecute = function() {
      if (this.isOutputConnected(0)) {
        var a = this.getInputData(0);
        if (this.properties.precision === r.PASS_THROUGH) {
          this.setOutputData(0, a);
        } else {
          if (a) {
            this._tex = r.getTargetTexture(a, this._tex, this.properties.precision);
            gl.disable(gl.BLEND);
            gl.disable(gl.DEPTH_TEST);
            this._uniforms || (this._uniforms = {u_texture:0, u_key_color:this.properties.key_color, u_threshold:1, u_slope:1});
            var b = this._uniforms, d = Mesh.getScreenQuad(), e = c._shader;
            b.u_key_color = this.properties.key_color;
            b.u_threshold = this.properties.threshold;
            b.u_slope = this.properties.slope;
            this._tex.drawTo(function() {
              a.bind(0);
              e.uniforms(b).draw(d);
            });
            this.setOutputData(0, this._tex);
          }
        }
      }
    };
    c.pixel_shader = "precision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec3 u_key_color;\n\r\n\t\t\tuniform float u_threshold;\n\r\n\t\t\tuniform float u_slope;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec3 color = texture2D( u_texture, v_coord ).xyz;\n\r\n\t\t\t\tfloat diff = length( normalize(color) - normalize(u_key_color) );\n\r\n\t\t\t\tfloat edge = u_threshold * (1.0 - u_slope);\n\r\n\t\t\t\tfloat alpha = smoothstep( edge, u_threshold, diff);\n\r\n\t\t\t\tgl_FragColor = vec4( color, alpha );\n\r\n\t\t\t}";
    f.registerNodeType("texture/matte", c);
    k.title = "Cubemap";
    k.prototype.onDropFile = function(a, b, d) {
      a ? (this._drop_texture = "string" == typeof a ? GL.Texture.fromURL(a) : GL.Texture.fromDDSInMemory(a), this.properties.name = b) : (this._drop_texture = null, this.properties.name = "");
    };
    k.prototype.onExecute = function() {
      if (this._drop_texture) {
        this.setOutputData(0, this._drop_texture);
      } else {
        if (this.properties.name) {
          var a = r.getTexture(this.properties.name);
          a && (this._last_tex = a, this.setOutputData(0, a));
        }
      }
    };
    k.prototype.onDrawBackground = function(a) {
      this.flags.collapsed || 20 >= this.size[1] || !a.webgl || gl.meshes.cube || (gl.meshes.cube = GL.Mesh.cube({size:1}));
    };
    f.registerNodeType("texture/cubemap", k);
  }
})(this);
(function(u) {
  var f = u.LiteGraph;
  if ("undefined" != typeof GL) {
    var k = function() {
      this.addInput("Tex.", "Texture");
      this.addInput("intensity", "number");
      this.addOutput("Texture", "Texture");
      this.properties = {intensity:1, invert:!1, precision:LGraphTexture.DEFAULT};
      k._shader || (k._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, k.pixel_shader));
    }, c = function() {
      this.addInput("Texture", "Texture");
      this.addInput("value1", "number");
      this.addInput("value2", "number");
      this.addOutput("Texture", "Texture");
      this.properties = {fx:"halftone", value1:1, value2:1, precision:LGraphTexture.DEFAULT};
    }, p = function() {
      this.addInput("Texture", "Texture");
      this.addInput("Blurred", "Texture");
      this.addInput("Mask", "Texture");
      this.addInput("Threshold", "number");
      this.addOutput("Texture", "Texture");
      this.properties = {shape:"", size:10, alpha:1.0, threshold:1.0, high_precision:!1};
    }, t = function() {
      this.addInput("Texture", "Texture");
      this.addInput("Aberration", "number");
      this.addInput("Distortion", "number");
      this.addInput("Blur", "number");
      this.addOutput("Texture", "Texture");
      this.properties = {aberration:1.0, distortion:1.0, blur:1.0, precision:LGraphTexture.DEFAULT};
      t._shader || (t._shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, t.pixel_shader), t._texture = new GL.Texture(3, 1, {format:gl.RGB, wrap:gl.CLAMP_TO_EDGE, magFilter:gl.LINEAR, minFilter:gl.LINEAR, pixel_data:[255, 0, 0, 0, 255, 0, 0, 0, 255]}));
    };
    t.title = "Lens";
    t.desc = "Camera Lens distortion";
    t.widgets_info = {precision:{widget:"combo", values:LGraphTexture.MODE_VALUES}};
    t.prototype.onExecute = function() {
      var c = this.getInputData(0);
      if (this.properties.precision === LGraphTexture.PASS_THROUGH) {
        this.setOutputData(0, c);
      } else {
        if (c) {
          this._tex = LGraphTexture.getTargetTexture(c, this._tex, this.properties.precision);
          var f = this.properties.aberration;
          this.isInputConnected(1) && (f = this.getInputData(1), this.properties.aberration = f);
          var e = this.properties.distortion;
          this.isInputConnected(2) && (e = this.getInputData(2), this.properties.distortion = e);
          var k = this.properties.blur;
          this.isInputConnected(3) && (k = this.getInputData(3), this.properties.blur = k);
          gl.disable(gl.BLEND);
          gl.disable(gl.DEPTH_TEST);
          var l = Mesh.getScreenQuad(), a = t._shader;
          this._tex.drawTo(function() {
            c.bind(0);
            a.uniforms({u_texture:0, u_aberration:f, u_distortion:e, u_blur:k}).draw(l);
          });
          this.setOutputData(0, this._tex);
        }
      }
    };
    t.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec2 u_camera_planes;\n\r\n\t\t\tuniform float u_aberration;\n\r\n\t\t\tuniform float u_distortion;\n\r\n\t\t\tuniform float u_blur;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec2 coord = v_coord;\n\r\n\t\t\t\tfloat dist = distance(vec2(0.5), coord);\n\r\n\t\t\t\tvec2 dist_coord = coord - vec2(0.5);\n\r\n\t\t\t\tfloat percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;\n\r\n\t\t\t\tdist_coord *= percent;\n\r\n\t\t\t\tcoord = dist_coord + vec2(0.5);\n\r\n\t\t\t\tvec4 color = texture2D(u_texture,coord, u_blur * dist);\n\r\n\t\t\t\tcolor.r = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0+0.01*u_aberration), u_blur * dist ).r;\n\r\n\t\t\t\tcolor.b = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0-0.01*u_aberration), u_blur * dist ).b;\n\r\n\t\t\t\tgl_FragColor = color;\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("fx/lens", t);
    window.LGraphFXLens = t;
    p.title = "Bokeh";
    p.desc = "applies an Bokeh effect";
    p.widgets_info = {shape:{widget:"texture"}};
    p.prototype.onExecute = function() {
      var c = this.getInputData(0), f = this.getInputData(1), e = this.getInputData(2);
      if (c && e && this.properties.shape) {
        f || (f = c);
        var k = LGraphTexture.getTexture(this.properties.shape);
        if (k) {
          var l = this.properties.threshold;
          this.isInputConnected(3) && (l = this.getInputData(3), this.properties.threshold = l);
          var a = gl.UNSIGNED_BYTE;
          this.properties.high_precision && (a = gl.half_float_ext ? gl.HALF_FLOAT_OES : gl.FLOAT);
          this._temp_texture && this._temp_texture.type == a && this._temp_texture.width == c.width && this._temp_texture.height == c.height || (this._temp_texture = new GL.Texture(c.width, c.height, {type:a, format:gl.RGBA, filter:gl.LINEAR}));
          var b = p._first_shader;
          b || (b = p._first_shader = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, p._first_pixel_shader));
          var d = p._second_shader;
          d || (d = p._second_shader = new GL.Shader(p._second_vertex_shader, p._second_pixel_shader));
          var g = this._points_mesh;
          g && g._width == c.width && g._height == c.height && 2 == g._spacing || (g = this.createPointsMesh(c.width, c.height, 2));
          var h = Mesh.getScreenQuad(), t = this.properties.size, n = this.properties.alpha;
          gl.disable(gl.DEPTH_TEST);
          gl.disable(gl.BLEND);
          this._temp_texture.drawTo(function() {
            c.bind(0);
            f.bind(1);
            e.bind(2);
            b.uniforms({u_texture:0, u_texture_blur:1, u_mask:2, u_texsize:[c.width, c.height]}).draw(h);
          });
          this._temp_texture.drawTo(function() {
            gl.enable(gl.BLEND);
            gl.blendFunc(gl.ONE, gl.ONE);
            c.bind(0);
            k.bind(3);
            d.uniforms({u_texture:0, u_mask:2, u_shape:3, u_alpha:n, u_threshold:l, u_pointSize:t, u_itexsize:[1.0 / c.width, 1.0 / c.height]}).draw(g, gl.POINTS);
          });
          this.setOutputData(0, this._temp_texture);
        }
      } else {
        this.setOutputData(0, c);
      }
    };
    p.prototype.createPointsMesh = function(c, f, e) {
      for (var k = Math.round(c / e), l = Math.round(f / e), a = new Float32Array(k * l * 2), b = -1, d = 2 / c * e, g = 2 / f * e, h = 0; h < l; ++h) {
        for (var p = -1, n = 0; n < k; ++n) {
          var t = h * k * 2 + 2 * n;
          a[t] = p;
          a[t + 1] = b;
          p += d;
        }
        b += g;
      }
      this._points_mesh = GL.Mesh.load({vertices2D:a});
      this._points_mesh._width = c;
      this._points_mesh._height = f;
      this._points_mesh._spacing = e;
      return this._points_mesh;
    };
    p._first_pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform sampler2D u_texture_blur;\n\r\n\t\t\tuniform sampler2D u_mask;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\r\n\t\t\t\tvec4 blurred_color = texture2D(u_texture_blur, v_coord);\n\r\n\t\t\t\tfloat mask = texture2D(u_mask, v_coord).x;\n\r\n\t\t\t   gl_FragColor = mix(color, blurred_color, mask);\n\r\n\t\t\t}\n\r\n\t\t\t";
    p._second_vertex_shader = "precision highp float;\n\r\n\t\t\tattribute vec2 a_vertex2D;\n\r\n\t\t\tvarying vec4 v_color;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform sampler2D u_mask;\n\r\n\t\t\tuniform vec2 u_itexsize;\n\r\n\t\t\tuniform float u_pointSize;\n\r\n\t\t\tuniform float u_threshold;\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec2 coord = a_vertex2D * 0.5 + 0.5;\n\r\n\t\t\t\tv_color = texture2D( u_texture, coord );\n\r\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(u_itexsize.x, 0.0) );\n\r\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(0.0, u_itexsize.y));\n\r\n\t\t\t\tv_color += texture2D( u_texture, coord + u_itexsize);\n\r\n\t\t\t\tv_color *= 0.25;\n\r\n\t\t\t\tfloat mask = texture2D(u_mask, coord).x;\n\r\n\t\t\t\tfloat luminance = length(v_color) * mask;\n\r\n\t\t\t\t/*luminance /= (u_pointSize*u_pointSize)*0.01 */;\n\r\n\t\t\t\tluminance -= u_threshold;\n\r\n\t\t\t\tif(luminance < 0.0)\n\r\n\t\t\t\t{\n\r\n\t\t\t\t\tgl_Position.x = -100.0;\n\r\n\t\t\t\t\treturn;\n\r\n\t\t\t\t}\n\r\n\t\t\t\tgl_PointSize = u_pointSize;\n\r\n\t\t\t\tgl_Position = vec4(a_vertex2D,0.0,1.0);\n\r\n\t\t\t}\n\r\n\t\t\t";
    p._second_pixel_shader = "precision highp float;\n\r\n\t\t\tvarying vec4 v_color;\n\r\n\t\t\tuniform sampler2D u_shape;\n\r\n\t\t\tuniform float u_alpha;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 color = texture2D( u_shape, gl_PointCoord );\n\r\n\t\t\t\tcolor *= v_color * u_alpha;\n\r\n\t\t\t\tgl_FragColor = color;\n\r\n\t\t\t}\n";
    f.registerNodeType("fx/bokeh", p);
    window.LGraphFXBokeh = p;
    c.title = "FX";
    c.desc = "applies an FX from a list";
    c.widgets_info = {fx:{widget:"combo", values:["halftone", "pixelate", "lowpalette", "noise", "gamma"]}, precision:{widget:"combo", values:LGraphTexture.MODE_VALUES}};
    c.shaders = {};
    c.prototype.onExecute = function() {
      if (this.isOutputConnected(0)) {
        var f = this.getInputData(0);
        if (this.properties.precision === LGraphTexture.PASS_THROUGH) {
          this.setOutputData(0, f);
        } else {
          if (f) {
            this._tex = LGraphTexture.getTargetTexture(f, this._tex, this.properties.precision);
            var k = this.properties.value1;
            this.isInputConnected(1) && (k = this.getInputData(1), this.properties.value1 = k);
            var e = this.properties.value2;
            this.isInputConnected(2) && (e = this.getInputData(2), this.properties.value2 = e);
            var p = this.properties.fx, l = c.shaders[p];
            if (!l) {
              var a = c["pixel_shader_" + p];
              if (!a) {
                return;
              }
              l = c.shaders[p] = new GL.Shader(Shader.SCREEN_VERTEX_SHADER, a);
            }
            gl.disable(gl.BLEND);
            gl.disable(gl.DEPTH_TEST);
            var b = Mesh.getScreenQuad();
            camera_planes = window.LS && LS.Renderer._current_camera ? [LS.Renderer._current_camera.near, LS.Renderer._current_camera.far] : [1, 100];
            var d = null;
            "noise" == p && (d = LGraphTexture.getNoiseTexture());
            this._tex.drawTo(function() {
              f.bind(0);
              "noise" == p && d.bind(1);
              l.uniforms({u_texture:0, u_noise:1, u_size:[f.width, f.height], u_rand:[Math.random(), Math.random()], u_value1:k, u_value2:e, u_camera_planes:camera_planes}).draw(b);
            });
            this.setOutputData(0, this._tex);
          }
        }
      }
    };
    c.pixel_shader_halftone = "precision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec2 u_camera_planes;\n\r\n\t\t\tuniform vec2 u_size;\n\r\n\t\t\tuniform float u_value1;\n\r\n\t\t\tuniform float u_value2;\n\r\n\t\t\t\n\r\n\t\t\tfloat pattern() {\n\r\n\t\t\t\tfloat s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);\n\r\n\t\t\t\tvec2 tex = v_coord * u_size.xy;\n\r\n\t\t\t\tvec2 point = vec2(\n\r\n\t\t\t\t   c * tex.x - s * tex.y ,\n\r\n\t\t\t\t   s * tex.x + c * tex.y \n\r\n\t\t\t\t) * u_value2;\n\r\n\t\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\n\r\n\t\t\t}\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\r\n\t\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\n\r\n\t\t\t\tgl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);\n\r\n\t\t\t}\n";
    c.pixel_shader_pixelate = "precision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec2 u_camera_planes;\n\r\n\t\t\tuniform vec2 u_size;\n\r\n\t\t\tuniform float u_value1;\n\r\n\t\t\tuniform float u_value2;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec2 coord = vec2( floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2 );\n\r\n\t\t\t\tvec4 color = texture2D(u_texture, coord);\n\r\n\t\t\t\tgl_FragColor = color;\n\r\n\t\t\t}\n";
    c.pixel_shader_lowpalette = "precision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform vec2 u_camera_planes;\n\r\n\t\t\tuniform vec2 u_size;\n\r\n\t\t\tuniform float u_value1;\n\r\n\t\t\tuniform float u_value2;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\r\n\t\t\t\tgl_FragColor = floor(color * u_value1) / u_value1;\n\r\n\t\t\t}\n";
    c.pixel_shader_noise = "precision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform sampler2D u_noise;\n\r\n\t\t\tuniform vec2 u_size;\n\r\n\t\t\tuniform float u_value1;\n\r\n\t\t\tuniform float u_value2;\n\r\n\t\t\tuniform vec2 u_rand;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\r\n\t\t\t\tvec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);\n\r\n\t\t\t\tgl_FragColor = vec4( color.xyz + noise * u_value1, color.a );\n\r\n\t\t\t}\n";
    c.pixel_shader_gamma = "precision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform float u_value1;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\r\n\t\t\t\tfloat gamma = 1.0 / u_value1;\n\r\n\t\t\t\tgl_FragColor = vec4( pow( color.xyz, vec3(gamma) ), color.a );\n\r\n\t\t\t}\n";
    f.registerNodeType("fx/generic", c);
    window.LGraphFXGeneric = c;
    k.title = "Vigneting";
    k.desc = "Vigneting";
    k.widgets_info = {precision:{widget:"combo", values:LGraphTexture.MODE_VALUES}};
    k.prototype.onExecute = function() {
      var c = this.getInputData(0);
      if (this.properties.precision === LGraphTexture.PASS_THROUGH) {
        this.setOutputData(0, c);
      } else {
        if (c) {
          this._tex = LGraphTexture.getTargetTexture(c, this._tex, this.properties.precision);
          var f = this.properties.intensity;
          this.isInputConnected(1) && (f = this.getInputData(1), this.properties.intensity = f);
          gl.disable(gl.BLEND);
          gl.disable(gl.DEPTH_TEST);
          var e = Mesh.getScreenQuad(), p = k._shader, l = this.properties.invert;
          this._tex.drawTo(function() {
            c.bind(0);
            p.uniforms({u_texture:0, u_intensity:f, u_isize:[1 / c.width, 1 / c.height], u_invert:l ? 1 : 0}).draw(e);
          });
          this.setOutputData(0, this._tex);
        }
      }
    };
    k.pixel_shader = "precision highp float;\n\r\n\t\t\tprecision highp float;\n\r\n\t\t\tvarying vec2 v_coord;\n\r\n\t\t\tuniform sampler2D u_texture;\n\r\n\t\t\tuniform float u_intensity;\n\r\n\t\t\tuniform int u_invert;\n\r\n\t\t\t\n\r\n\t\t\tvoid main() {\n\r\n\t\t\t\tfloat luminance = 1.0 - length( v_coord - vec2(0.5) ) * 1.414;\n\r\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\r\n\t\t\t\tif(u_invert == 1)\n\r\n\t\t\t\t\tluminance = 1.0 - luminance;\n\r\n\t\t\t\tluminance = mix(1.0, luminance, u_intensity);\n\r\n\t\t\t   gl_FragColor = vec4( luminance * color.xyz, color.a);\n\r\n\t\t\t}\n\r\n\t\t\t";
    f.registerNodeType("fx/vigneting", k);
    u.LGraphFXVigneting = k;
  }
})(this);
(function(u) {
  function f(c) {
    this.cmd = this.channel = 0;
    c ? this.setup(c) : this.data = [0, 0, 0];
  }
  function k(c, a) {
    navigator.requestMIDIAccess ? (this.on_ready = c, this.state = {note:[], cc:[]}, navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this), this.onMIDIFailure.bind(this))) : (this.error = "not suppoorted", a ? a("Not supported") : console.error("MIDI NOT SUPPORTED, enable by chrome://flags"));
  }
  function c() {
    this.addOutput("on_midi", q.EVENT);
    this.addOutput("out", "midi");
    this.properties = {port:0};
    this._current_midi_event = this._last_midi_event = null;
    var c = this;
    new k(function(a) {
      c._midi = a;
      if (c._waiting) {
        c.onStart();
      }
      c._waiting = !1;
    });
  }
  function p() {
    this.addInput("send", q.EVENT);
    this.properties = {port:0};
    var c = this;
    new k(function(a) {
      c._midi = a;
    });
  }
  function t() {
    this.addInput("on_midi", q.EVENT);
    this._str = "";
    this.size = [200, 40];
  }
  function v() {
    this.properties = {channel:-1, cmd:-1, min_value:-1, max_value:-1};
    this.addInput("in", q.EVENT);
    this.addOutput("on_midi", q.EVENT);
  }
  function w() {
    this.properties = {channel:0, cmd:"CC", value1:1, value2:1};
    this.addInput("send", q.EVENT);
    this.addInput("assign", q.EVENT);
    this.addOutput("on_midi", q.EVENT);
  }
  function e() {
    this.properties = {cc:1, value:0};
    this.addOutput("value", "number");
  }
  var q = u.LiteGraph;
  f.prototype.setup = function(c) {
    this.data = c;
    this.status = c = c[0];
    var a = c & 240;
    this.cmd = 240 <= c ? c : a;
    this.cmd == f.NOTEON && 0 == this.velocity && (this.cmd = f.NOTEOFF);
    this.cmd_str = f.commands[this.cmd] || "";
    if (a >= f.NOTEON || a <= f.NOTEOFF) {
      this.channel = c & 15;
    }
  };
  Object.defineProperty(f.prototype, "velocity", {get:function() {
    return this.cmd == f.NOTEON ? this.data[2] : -1;
  }, set:function(c) {
    this.data[2] = c;
  }, enumerable:!0});
  f.notes = "A A# B C C# D D# E F F# G G#".split(" ");
  f.prototype.getPitch = function() {
    return 440 * Math.pow(2, (this.data[1] - 69) / 12);
  };
  f.computePitch = function(c) {
    return 440 * Math.pow(2, (c - 69) / 12);
  };
  f.prototype.getCC = function() {
    return this.data[1];
  };
  f.prototype.getCCValue = function() {
    return this.data[2];
  };
  f.prototype.getPitchBend = function() {
    return this.data[1] + (this.data[2] << 7) - 8192;
  };
  f.computePitchBend = function(c, a) {
    return c + (a << 7) - 8192;
  };
  f.prototype.setCommandFromString = function(c) {
    this.cmd = f.computeCommandFromString(c);
  };
  f.computeCommandFromString = function(c) {
    if (!c) {
      return 0;
    }
    if (c && c.constructor === Number) {
      return c;
    }
    c = c.toUpperCase();
    switch(c) {
      case "NOTE ON":
      case "NOTEON":
        return f.NOTEON;
      case "NOTE OFF":
      case "NOTEOFF":
        return f.NOTEON;
      case "KEY PRESSURE":
      case "KEYPRESSURE":
        return f.KEYPRESSURE;
      case "CONTROLLER CHANGE":
      case "CONTROLLERCHANGE":
      case "CC":
        return f.CONTROLLERCHANGE;
      case "PROGRAM CHANGE":
      case "PROGRAMCHANGE":
      case "PC":
        return f.PROGRAMCHANGE;
      case "CHANNEL PRESSURE":
      case "CHANNELPRESSURE":
        return f.CHANNELPRESSURE;
      case "PITCH BEND":
      case "PITCHBEND":
        return f.PITCHBEND;
      case "TIME TICK":
      case "TIMETICK":
        return f.TIMETICK;
      default:
        return Number(c);
    }
  };
  f.toNoteString = function(c) {
    var a = (c - 21) % 12;
    0 > a && (a = 12 + a);
    return f.notes[a] + Math.floor((c - 24) / 12 + 1);
  };
  f.prototype.toString = function() {
    var c = "" + this.channel + ". ";
    switch(this.cmd) {
      case f.NOTEON:
        c += "NOTEON " + f.toNoteString(this.data[1]);
        break;
      case f.NOTEOFF:
        c += "NOTEOFF " + f.toNoteString(this.data[1]);
        break;
      case f.CONTROLLERCHANGE:
        c += "CC " + this.data[1] + " " + this.data[2];
        break;
      case f.PROGRAMCHANGE:
        c += "PC " + this.data[1];
        break;
      case f.PITCHBEND:
        c += "PITCHBEND " + this.getPitchBend();
        break;
      case f.KEYPRESSURE:
        c += "KEYPRESS " + this.data[1];
    }
    return c;
  };
  f.prototype.toHexString = function() {
    for (var c = "", a = 0; a < this.data.length; a++) {
      c += this.data[a].toString(16) + " ";
    }
  };
  f.NOTEOFF = 128;
  f.NOTEON = 144;
  f.KEYPRESSURE = 160;
  f.CONTROLLERCHANGE = 176;
  f.PROGRAMCHANGE = 192;
  f.CHANNELPRESSURE = 208;
  f.PITCHBEND = 224;
  f.TIMETICK = 248;
  f.commands = {128:"note off", 144:"note on", 160:"key pressure", 176:"controller change", 192:"program change", 208:"channel pressure", 224:"pitch bend", 240:"system", 242:"Song pos", 243:"Song select", 246:"Tune request", 248:"time tick", 250:"Start Song", 251:"Continue Song", 252:"Stop Song", 254:"Sensing", 255:"Reset"};
  k.input = null;
  k.MIDIEvent = f;
  k.prototype.onMIDISuccess = function(c) {
    console.log("MIDI ready!");
    console.log(c);
    this.midi = c;
    this.updatePorts();
    if (this.on_ready) {
      this.on_ready(this);
    }
  };
  k.prototype.updatePorts = function() {
    var c = this.midi;
    this.input_ports = c.inputs;
    for (var a = 0, b = this.input_ports.values(), d = b.next(); d && !1 === d.done;) {
      d = d.value, console.log("Input port [type:'" + d.type + "'] id:'" + d.id + "' manufacturer:'" + d.manufacturer + "' name:'" + d.name + "' version:'" + d.version + "'"), a++, d = b.next();
    }
    this.num_input_ports = a;
    a = 0;
    this.output_ports = c.outputs;
    b = this.output_ports.values();
    for (d = b.next(); d && !1 === d.done;) {
      d = d.value, console.log("Output port [type:'" + d.type + "'] id:'" + d.id + "' manufacturer:'" + d.manufacturer + "' name:'" + d.name + "' version:'" + d.version + "'"), a++, d = b.next();
    }
    this.num_output_ports = a;
  };
  k.prototype.onMIDIFailure = function(c) {
    console.error("Failed to get MIDI access - " + c);
  };
  k.prototype.openInputPort = function(c, a) {
    c = this.input_ports.get("input-" + c);
    if (!c) {
      return !1;
    }
    k.input = this;
    var b = this;
    c.onmidimessage = function(d) {
      var c = new f(d.data);
      b.updateState(c);
      a && a(d.data, c);
      if (k.on_message) {
        k.on_message(d.data, c);
      }
    };
    console.log("port open: ", c);
    return !0;
  };
  k.parseMsg = function(c) {
  };
  k.prototype.updateState = function(c) {
    switch(c.cmd) {
      case f.NOTEON:
        this.state.note[c.value1 | 0] = c.value2;
        break;
      case f.NOTEOFF:
        this.state.note[c.value1 | 0] = 0;
        break;
      case f.CONTROLLERCHANGE:
        this.state.cc[c.getCC()] = c.getCCValue();
    }
  };
  k.prototype.sendMIDI = function(c, a) {
    a && (c = this.output_ports.get("output-" + c)) && (k.output = this, a.constructor === f ? c.send(a.data) : c.send(a));
  };
  c.MIDIInterface = k;
  c.title = "MIDI Input";
  c.desc = "Reads MIDI from a input port";
  c.prototype.getPropertyInfo = function(c) {
    if (this._midi && "port" == c) {
      c = {};
      for (var a = 0; a < this._midi.input_ports.size; ++a) {
        var b = this._midi.input_ports.get("input-" + a);
        c[a] = a + ".- " + b.name + " version:" + b.version;
      }
      return {type:"enum", values:c};
    }
  };
  c.prototype.onStart = function() {
    this._midi ? this._midi.openInputPort(this.properties.port, this.onMIDIEvent.bind(this)) : this._waiting = !0;
  };
  c.prototype.onMIDIEvent = function(c, a) {
    this._last_midi_event = a;
    this.trigger("on_midi", a);
    a.cmd == f.NOTEON ? this.trigger("on_noteon", a) : a.cmd == f.NOTEOFF ? this.trigger("on_noteoff", a) : a.cmd == f.CONTROLLERCHANGE ? this.trigger("on_cc", a) : a.cmd == f.PROGRAMCHANGE ? this.trigger("on_pc", a) : a.cmd == f.PITCHBEND && this.trigger("on_pitchbend", a);
  };
  c.prototype.onExecute = function() {
    if (this.outputs) {
      for (var c = this._last_midi_event, a = 0; a < this.outputs.length; ++a) {
        switch(this.outputs[a].name) {
          case "midi":
            var b = this._midi;
            break;
          case "last_midi":
            b = c;
            break;
          default:
            continue;
        }
        this.setOutputData(a, b);
      }
    }
  };
  c.prototype.onGetOutputs = function() {
    return [["last_midi", "midi"], ["on_midi", q.EVENT], ["on_noteon", q.EVENT], ["on_noteoff", q.EVENT], ["on_cc", q.EVENT], ["on_pc", q.EVENT], ["on_pitchbend", q.EVENT]];
  };
  q.registerNodeType("midi/input", c);
  p.MIDIInterface = k;
  p.title = "MIDI Output";
  p.desc = "Sends MIDI to output channel";
  p.prototype.getPropertyInfo = function(c) {
    if (this._midi && "port" == c) {
      c = {};
      for (var a = 0; a < this._midi.output_ports.size; ++a) {
        var b = this._midi.output_ports.get(a);
        c[a] = a + ".- " + b.name + " version:" + b.version;
      }
      return {type:"enum", values:c};
    }
  };
  p.prototype.onAction = function(c, a) {
    console.log(a);
    this._midi && ("send" == c && this._midi.sendMIDI(this.port, a), this.trigger("midi", a));
  };
  p.prototype.onGetInputs = function() {
    return [["send", q.ACTION]];
  };
  p.prototype.onGetOutputs = function() {
    return [["on_midi", q.EVENT]];
  };
  q.registerNodeType("midi/output", p);
  t.title = "MIDI Show";
  t.desc = "Shows MIDI in the graph";
  t.prototype.onAction = function(c, a) {
    a && (this._str = a.constructor === f ? a.toString() : "???");
  };
  t.prototype.onDrawForeground = function(c) {
    this._str && (c.font = "30px Arial", c.fillText(this._str, 10, 0.8 * this.size[1]));
  };
  t.prototype.onGetInputs = function() {
    return [["in", q.ACTION]];
  };
  t.prototype.onGetOutputs = function() {
    return [["on_midi", q.EVENT]];
  };
  q.registerNodeType("midi/show", t);
  v.title = "MIDI Filter";
  v.desc = "Filters MIDI messages";
  v.prototype.onAction = function(c, a) {
    !a || a.constructor !== f || -1 != this.properties.channel && a.channel != this.properties.channel || -1 != this.properties.cmd && a.cmd != this.properties.cmd || -1 != this.properties.min_value && a.data[1] < this.properties.min_value || -1 != this.properties.max_value && a.data[1] > this.properties.max_value || this.trigger("on_midi", a);
  };
  q.registerNodeType("midi/filter", v);
  w.title = "MIDIEvent";
  w.desc = "Create a MIDI Event";
  w.prototype.onAction = function(c, a) {
    "assign" == c ? (this.properties.channel = a.channel, this.properties.cmd = a.cmd, this.properties.value1 = a.data[1], this.properties.value2 = a.data[2]) : (a = new f, a.channel = this.properties.channel, this.properties.cmd && this.properties.cmd.constructor === String ? a.setCommandFromString(this.properties.cmd) : a.cmd = this.properties.cmd, a.data[0] = a.cmd | a.channel, a.data[1] = Number(this.properties.value1), a.data[2] = Number(this.properties.value2), this.trigger("on_midi", a));
  };
  w.prototype.onExecute = function() {
    var c = this.properties;
    if (this.outputs) {
      for (var a = 0; a < this.outputs.length; ++a) {
        switch(this.outputs[a].name) {
          case "midi":
            var b = new f;
            b.setup([c.cmd, c.value1, c.value2]);
            b.channel = c.channel;
            break;
          case "command":
            b = c.cmd;
            break;
          case "cc":
            b = c.value1;
            break;
          case "cc_value":
            b = c.value2;
            break;
          case "note":
            b = c.cmd == f.NOTEON || c.cmd == f.NOTEOFF ? c.value1 : null;
            break;
          case "velocity":
            b = c.cmd == f.NOTEON ? c.value2 : null;
            break;
          case "pitch":
            b = c.cmd == f.NOTEON ? f.computePitch(c.value1) : null;
            break;
          case "pitchbend":
            b = c.cmd == f.PITCHBEND ? f.computePitchBend(c.value1, c.value2) : null;
            break;
          default:
            continue;
        }
        null !== b && this.setOutputData(a, b);
      }
    }
  };
  w.prototype.onPropertyChanged = function(c, a) {
    "cmd" == c && (this.properties.cmd = f.computeCommandFromString(a));
  };
  w.prototype.onGetOutputs = function() {
    return [["midi", "midi"], ["on_midi", q.EVENT], ["command", "number"], ["note", "number"], ["velocity", "number"], ["cc", "number"], ["cc_value", "number"], ["pitch", "number"], ["pitchbend", "number"]];
  };
  q.registerNodeType("midi/event", w);
  e.title = "MIDICC";
  e.desc = "gets a Controller Change";
  e.prototype.onExecute = function() {
    k.input && (this.properties.value = k.input.state.cc[this.properties.cc]);
    this.setOutputData(0, this.properties.value);
  };
  q.registerNodeType("midi/cc", e);
})(this);
(function(u) {
  function f() {
    this.properties = {src:"", gain:0.5, loop:!0, autoplay:!0, playbackRate:1};
    this._loading_audio = !1;
    this._audiobuffer = null;
    this._audionodes = [];
    this._last_sourcenode = null;
    this.addOutput("out", "audio");
    this.addInput("gain", "number");
    this.audionode = x.getAudioContext().createGain();
    this.audionode.graphnode = this;
    this.audionode.gain.value = this.properties.gain;
    this.properties.src && this.loadSound(this.properties.src);
  }
  function k() {
    this.properties = {fftSize:2048, minDecibels:-100, maxDecibels:-10, smoothingTimeConstant:0.5};
    this.audionode = x.getAudioContext().createAnalyser();
    this.audionode.graphnode = this;
    this.audionode.fftSize = this.properties.fftSize;
    this.audionode.minDecibels = this.properties.minDecibels;
    this.audionode.maxDecibels = this.properties.maxDecibels;
    this.audionode.smoothingTimeConstant = this.properties.smoothingTimeConstant;
    this.addInput("in", "audio");
    this.addOutput("freqs", "array");
    this.addOutput("samples", "array");
    this._time_bin = this._freq_bin = null;
  }
  function c() {
    this.properties = {gain:1};
    this.audionode = x.getAudioContext().createGain();
    this.addInput("in", "audio");
    this.addInput("gain", "number");
    this.addOutput("out", "audio");
  }
  function p() {
    this.properties = {impulse_src:"", normalize:!0};
    this.audionode = x.getAudioContext().createConvolver();
    this.addInput("in", "audio");
    this.addOutput("out", "audio");
  }
  function t() {
    this.properties = {threshold:-50, knee:40, ratio:12, reduction:-20, attack:0, release:0.25};
    this.audionode = x.getAudioContext().createDynamicsCompressor();
    this.addInput("in", "audio");
    this.addOutput("out", "audio");
  }
  function v() {
    this.properties = {};
    this.audionode = x.getAudioContext().createWaveShaper();
    this.addInput("in", "audio");
    this.addInput("shape", "waveshape");
    this.addOutput("out", "audio");
  }
  function w() {
    this.properties = {gain1:0.5, gain2:0.5};
    this.audionode = x.getAudioContext().createGain();
    this.audionode1 = x.getAudioContext().createGain();
    this.audionode1.gain.value = this.properties.gain1;
    this.audionode2 = x.getAudioContext().createGain();
    this.audionode2.gain.value = this.properties.gain2;
    this.audionode1.connect(this.audionode);
    this.audionode2.connect(this.audionode);
    this.addInput("in1", "audio");
    this.addInput("in1 gain", "number");
    this.addInput("in2", "audio");
    this.addInput("in2 gain", "number");
    this.addOutput("out", "audio");
  }
  function e() {
    this.properties = {delayTime:0.5};
    this.audionode = x.getAudioContext().createDelay(10);
    this.audionode.delayTime.value = this.properties.delayTime;
    this.addInput("in", "audio");
    this.addInput("time", "number");
    this.addOutput("out", "audio");
  }
  function q() {
    this.properties = {frequency:350, detune:0, Q:1};
    this.addProperty("type", "lowpass", "enum", {values:"lowpass highpass bandpass lowshelf highshelf peaking notch allpass".split(" ")});
    this.audionode = x.getAudioContext().createBiquadFilter();
    this.addInput("in", "audio");
    this.addOutput("out", "audio");
  }
  function l() {
    this.properties = {frequency:440, detune:0, type:"sine"};
    this.addProperty("type", "sine", "enum", {values:["sine", "square", "sawtooth", "triangle", "custom"]});
    this.audionode = x.getAudioContext().createOscillator();
    this.addOutput("out", "audio");
  }
  function a() {
    this.properties = {continuous:!0, mark:-1};
    this.addInput("data", "array");
    this.addInput("mark", "number");
    this.size = [300, 200];
    this._last_buffer = null;
  }
  function b() {
    this.properties = {band:440, amplitude:1};
    this.addInput("freqs", "array");
    this.addOutput("signal", "number");
  }
  function d() {
    if (!d.default_code) {
      var a = d.default_function.toString(), b = a.indexOf("{") + 1, c = a.lastIndexOf("}");
      d.default_code = a.substr(b, c - b);
    }
    this.properties = {code:d.default_code};
    a = x.getAudioContext();
    a.createScriptProcessor ? this.audionode = a.createScriptProcessor(4096, 1, 1) : (console.warn("ScriptProcessorNode deprecated"), this.audionode = a.createGain());
    this.processCode();
    d._bypass_function || (d._bypass_function = this.audionode.onaudioprocess);
    this.addInput("in", "audio");
    this.addOutput("out", "audio");
  }
  function g() {
    this.audionode = x.getAudioContext().destination;
    this.addInput("in", "audio");
  }
  var h = u.LiteGraph, x = {};
  u.LGAudio = x;
  x.getAudioContext = function() {
    if (!this._audio_context) {
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!window.AudioContext) {
        return console.error("AudioContext not supported by browser"), null;
      }
      this._audio_context = new AudioContext;
      this._audio_context.onmessage = function(a) {
        console.log("msg", a);
      };
      this._audio_context.onended = function(a) {
        console.log("ended", a);
      };
      this._audio_context.oncomplete = function(a) {
        console.log("complete", a);
      };
    }
    return this._audio_context;
  };
  x.connect = function(a, b) {
    try {
      a.connect(b);
    } catch (A) {
      console.warn("LGraphAudio:", A);
    }
  };
  x.disconnect = function(a, b) {
    try {
      a.disconnect(b);
    } catch (A) {
      console.warn("LGraphAudio:", A);
    }
  };
  x.changeAllAudiosConnections = function(a, b) {
    if (a.inputs) {
      for (var d = 0; d < a.inputs.length; ++d) {
        var c = a.graph.links[a.inputs[d].link];
        if (c) {
          var e = a.graph.getNodeById(c.origin_id);
          e = e.getAudioNodeInOutputSlot ? e.getAudioNodeInOutputSlot(c.origin_slot) : e.audionode;
          c = a.getAudioNodeInInputSlot ? a.getAudioNodeInInputSlot(d) : a.audionode;
          b ? x.connect(e, c) : x.disconnect(e, c);
        }
      }
    }
    if (a.outputs) {
      for (d = 0; d < a.outputs.length; ++d) {
        for (var f = a.outputs[d], n = 0; n < f.links.length; ++n) {
          if (c = a.graph.links[f.links[n]]) {
            e = a.getAudioNodeInOutputSlot ? a.getAudioNodeInOutputSlot(d) : a.audionode;
            var g = a.graph.getNodeById(c.target_id);
            c = g.getAudioNodeInInputSlot ? g.getAudioNodeInInputSlot(c.target_slot) : g.audionode;
            b ? x.connect(e, c) : x.disconnect(e, c);
          }
        }
      }
    }
  };
  x.onConnectionsChange = function(a, b, d, c) {
    a == h.OUTPUT && (a = null, c && (a = this.graph.getNodeById(c.target_id)), a && (b = this.getAudioNodeInOutputSlot ? this.getAudioNodeInOutputSlot(b) : this.audionode, c = a.getAudioNodeInInputSlot ? a.getAudioNodeInInputSlot(c.target_slot) : a.audionode, d ? x.connect(b, c) : x.disconnect(b, c)));
  };
  x.createAudioNodeWrapper = function(a) {
    var b = a.prototype.onPropertyChanged;
    a.prototype.onPropertyChanged = function(a, c) {
      b && b.call(this, a, c);
      this.audionode && void 0 !== this.audionode[a] && (void 0 !== this.audionode[a].value ? this.audionode[a].value = c : this.audionode[a] = c);
    };
    a.prototype.onConnectionsChange = x.onConnectionsChange;
  };
  x.cached_audios = {};
  x.loadSound = function(a, b, c) {
    function d(a) {
      console.log("Audio loading sample error:", a);
      c && c(a);
    }
    if (x.cached_audios[a] && -1 == a.indexOf("blob:")) {
      b && b(x.cached_audios[a]);
    } else {
      x.onProcessAudioURL && (a = x.onProcessAudioURL(a));
      var e = new XMLHttpRequest;
      e.open("GET", a, !0);
      e.responseType = "arraybuffer";
      var f = x.getAudioContext();
      e.onload = function() {
        console.log("AudioSource loaded");
        f.decodeAudioData(e.response, function(c) {
          console.log("AudioSource decoded");
          x.cached_audios[a] = c;
          b && b(c);
        }, d);
      };
      e.send();
      return e;
    }
  };
  f["@src"] = {widget:"resource"};
  f.supported_extensions = ["wav", "ogg", "mp3"];
  f.prototype.onAdded = function(a) {
    if (a.status === LGraph.STATUS_RUNNING) {
      this.onStart();
    }
  };
  f.prototype.onStart = function() {
    this._audiobuffer && this.properties.autoplay && this.playBuffer(this._audiobuffer);
  };
  f.prototype.onStop = function() {
    this.stopAllSounds();
  };
  f.prototype.onPause = function() {
    this.pauseAllSounds();
  };
  f.prototype.onUnpause = function() {
    this.unpauseAllSounds();
  };
  f.prototype.onRemoved = function() {
    this.stopAllSounds();
    this._dropped_url && URL.revokeObjectURL(this._url);
  };
  f.prototype.stopAllSounds = function() {
    for (var a = 0; a < this._audionodes.length; ++a) {
      this._audionodes[a].started && (this._audionodes[a].started = !1, this._audionodes[a].stop());
    }
    this._audionodes.length = 0;
  };
  f.prototype.pauseAllSounds = function() {
    x.getAudioContext().suspend();
  };
  f.prototype.unpauseAllSounds = function() {
    x.getAudioContext().resume();
  };
  f.prototype.onExecute = function() {
    if (this.inputs) {
      for (var a = 0; a < this.inputs.length; ++a) {
        var b = this.inputs[a];
        if (null != b.link) {
          var c = this.getInputData(a);
          if (void 0 !== c) {
            if ("gain" == b.name) {
              this.audionode.gain.value = c;
            } else {
              if ("playbackRate" == b.name) {
                for (this.properties.playbackRate = c, b = 0; b < this._audionodes.length; ++b) {
                  this._audionodes[b].playbackRate.value = c;
                }
              }
            }
          }
        }
      }
    }
    if (this.outputs) {
      for (a = 0; a < this.outputs.length; ++a) {
        "buffer" == this.outputs[a].name && this._audiobuffer && this.setOutputData(a, this._audiobuffer);
      }
    }
  };
  f.prototype.onAction = function(a) {
    this._audiobuffer && ("Play" == a ? this.playBuffer(this._audiobuffer) : "Stop" == a && this.stopAllSounds());
  };
  f.prototype.onPropertyChanged = function(a, b) {
    if ("src" == a) {
      this.loadSound(b);
    } else {
      if ("gain" == a) {
        this.audionode.gain.value = b;
      } else {
        if ("playbackRate" == a) {
          for (a = 0; a < this._audionodes.length; ++a) {
            this._audionodes[a].playbackRate.value = b;
          }
        }
      }
    }
  };
  f.prototype.playBuffer = function(a) {
    var b = this, c = x.getAudioContext().createBufferSource();
    this._last_sourcenode = c;
    c.graphnode = this;
    c.buffer = a;
    c.loop = this.properties.loop;
    c.playbackRate.value = this.properties.playbackRate;
    this._audionodes.push(c);
    c.connect(this.audionode);
    this._audionodes.push(c);
    c.onended = function() {
      b.trigger("ended");
      var a = b._audionodes.indexOf(c);
      -1 != a && b._audionodes.splice(a, 1);
    };
    c.started || (c.started = !0, c.start());
    return c;
  };
  f.prototype.loadSound = function(a) {
    var b = this;
    this._request && (this._request.abort(), this._request = null);
    this._audiobuffer = null;
    this._loading_audio = !1;
    a && (this._request = x.loadSound(a, function(a) {
      this.boxcolor = h.NODE_DEFAULT_BOXCOLOR;
      b._audiobuffer = a;
      b._loading_audio = !1;
      if (b.graph && b.graph.status === LGraph.STATUS_RUNNING) {
        b.onStart();
      }
    }), this._loading_audio = !0, this.boxcolor = "#AA4");
  };
  f.prototype.onConnectionsChange = x.onConnectionsChange;
  f.prototype.onGetInputs = function() {
    return [["playbackRate", "number"], ["Play", h.ACTION], ["Stop", h.ACTION]];
  };
  f.prototype.onGetOutputs = function() {
    return [["buffer", "audiobuffer"], ["ended", h.EVENT]];
  };
  f.prototype.onDropFile = function(a) {
    this._dropped_url && URL.revokeObjectURL(this._dropped_url);
    a = URL.createObjectURL(a);
    this.properties.src = a;
    this.loadSound(a);
    this._dropped_url = a;
  };
  f.title = "Source";
  f.desc = "Plays audio";
  h.registerNodeType("audio/source", f);
  k.prototype.onPropertyChanged = function(a, b) {
    this.audionode[a] = b;
  };
  k.prototype.onExecute = function() {
    if (this.isOutputConnected(0)) {
      var a = this.audionode.frequencyBinCount;
      this._freq_bin && this._freq_bin.length == a || (this._freq_bin = new Uint8Array(a));
      this.audionode.getByteFrequencyData(this._freq_bin);
      this.setOutputData(0, this._freq_bin);
    }
    this.isOutputConnected(1) && (a = this.audionode.frequencyBinCount, this._time_bin && this._time_bin.length == a || (this._time_bin = new Uint8Array(a)), this.audionode.getByteTimeDomainData(this._time_bin), this.setOutputData(1, this._time_bin));
    for (a = 1; a < this.inputs.length; ++a) {
      var b = this.inputs[a];
      if (null != b.link) {
        var c = this.getInputData(a);
        void 0 !== c && (this.audionode[b.name].value = c);
      }
    }
  };
  k.prototype.onGetInputs = function() {
    return [["minDecibels", "number"], ["maxDecibels", "number"], ["smoothingTimeConstant", "number"]];
  };
  k.prototype.onGetOutputs = function() {
    return [["freqs", "array"], ["samples", "array"]];
  };
  k.title = "Analyser";
  k.desc = "Audio Analyser";
  h.registerNodeType("audio/analyser", k);
  c.prototype.onExecute = function() {
    if (this.inputs && this.inputs.length) {
      for (var a = 1; a < this.inputs.length; ++a) {
        var b = this.inputs[a], c = this.getInputData(a);
        void 0 !== c && (this.audionode[b.name].value = c);
      }
    }
  };
  x.createAudioNodeWrapper(c);
  c.title = "Gain";
  c.desc = "Audio gain";
  h.registerNodeType("audio/gain", c);
  x.createAudioNodeWrapper(p);
  p.prototype.onRemove = function() {
    this._dropped_url && URL.revokeObjectURL(this._dropped_url);
  };
  p.prototype.onPropertyChanged = function(a, b) {
    "impulse_src" == a ? this.loadImpulse(b) : "normalize" == a && (this.audionode.normalize = b);
  };
  p.prototype.onDropFile = function(a) {
    this._dropped_url && URL.revokeObjectURL(this._dropped_url);
    this._dropped_url = URL.createObjectURL(a);
    this.properties.impulse_src = this._dropped_url;
    this.loadImpulse(this._dropped_url);
  };
  p.prototype.loadImpulse = function(a) {
    var b = this;
    this._request && (this._request.abort(), this._request = null);
    this._impulse_buffer = null;
    this._loading_impulse = !1;
    a && (this._request = x.loadSound(a, function(a) {
      b._impulse_buffer = a;
      b.audionode.buffer = a;
      console.log("Impulse signal set");
      b._loading_impulse = !1;
    }), this._loading_impulse = !0);
  };
  p.title = "Convolver";
  p.desc = "Convolves the signal (used for reverb)";
  h.registerNodeType("audio/convolver", p);
  x.createAudioNodeWrapper(t);
  t.prototype.onExecute = function() {
    if (this.inputs && this.inputs.length) {
      for (var a = 1; a < this.inputs.length; ++a) {
        var b = this.inputs[a];
        if (null != b.link) {
          var c = this.getInputData(a);
          void 0 !== c && (this.audionode[b.name].value = c);
        }
      }
    }
  };
  t.prototype.onGetInputs = function() {
    return [["threshold", "number"], ["knee", "number"], ["ratio", "number"], ["reduction", "number"], ["attack", "number"], ["release", "number"]];
  };
  t.title = "DynamicsCompressor";
  t.desc = "Dynamics Compressor";
  h.registerNodeType("audio/dynamicsCompressor", t);
  v.prototype.onExecute = function() {
    if (this.inputs && this.inputs.length) {
      var a = this.getInputData(1);
      void 0 !== a && (this.audionode.curve = a);
    }
  };
  v.prototype.setWaveShape = function(a) {
    this.audionode.curve = a;
  };
  x.createAudioNodeWrapper(v);
  w.prototype.getAudioNodeInInputSlot = function(a) {
    if (0 == a) {
      return this.audionode1;
    }
    if (2 == a) {
      return this.audionode2;
    }
  };
  w.prototype.onPropertyChanged = function(a, b) {
    "gain1" == a ? this.audionode1.gain.value = b : "gain2" == a && (this.audionode2.gain.value = b);
  };
  w.prototype.onExecute = function() {
    if (this.inputs && this.inputs.length) {
      for (var a = 1; a < this.inputs.length; ++a) {
        var b = this.inputs[a];
        null != b.link && "audio" != b.type && (b = this.getInputData(a), void 0 !== b && (1 == a ? this.audionode1.gain.value = b : 3 == a && (this.audionode2.gain.value = b)));
      }
    }
  };
  x.createAudioNodeWrapper(w);
  w.title = "Mixer";
  w.desc = "Audio mixer";
  h.registerNodeType("audio/mixer", w);
  x.createAudioNodeWrapper(e);
  e.prototype.onExecute = function() {
    var a = this.getInputData(1);
    void 0 !== a && (this.audionode.delayTime.value = a);
  };
  e.title = "Delay";
  e.desc = "Audio delay";
  h.registerNodeType("audio/delay", e);
  q.prototype.onExecute = function() {
    if (this.inputs && this.inputs.length) {
      for (var a = 1; a < this.inputs.length; ++a) {
        var b = this.inputs[a];
        if (null != b.link) {
          var c = this.getInputData(a);
          void 0 !== c && (this.audionode[b.name].value = c);
        }
      }
    }
  };
  q.prototype.onGetInputs = function() {
    return [["frequency", "number"], ["detune", "number"], ["Q", "number"]];
  };
  x.createAudioNodeWrapper(q);
  q.title = "BiquadFilter";
  q.desc = "Audio filter";
  h.registerNodeType("audio/biquadfilter", q);
  l.prototype.onStart = function() {
    this.audionode.started || (this.audionode.started = !0, this.audionode.start());
  };
  l.prototype.onStop = function() {
    this.audionode.started && (this.audionode.started = !1, this.audionode.stop());
  };
  l.prototype.onPause = function() {
    this.onStop();
  };
  l.prototype.onUnpause = function() {
    this.onStart();
  };
  l.prototype.onExecute = function() {
    if (this.inputs && this.inputs.length) {
      for (var a = 0; a < this.inputs.length; ++a) {
        var b = this.inputs[a];
        if (null != b.link) {
          var c = this.getInputData(a);
          void 0 !== c && (this.audionode[b.name].value = c);
        }
      }
    }
  };
  l.prototype.onGetInputs = function() {
    return [["frequency", "number"], ["detune", "number"], ["type", "string"]];
  };
  x.createAudioNodeWrapper(l);
  l.title = "Oscillator";
  l.desc = "Oscillator";
  h.registerNodeType("audio/oscillator", l);
  a.prototype.onExecute = function() {
    this._last_buffer = this.getInputData(0);
    var a = this.getInputData(1);
    void 0 !== a && (this.properties.mark = a);
    this.setDirtyCanvas(!0, !1);
  };
  a.prototype.onDrawForeground = function(a) {
    if (this._last_buffer) {
      var b = this._last_buffer, c = b.length / this.size[0], d = this.size[1];
      a.fillStyle = "black";
      a.fillRect(0, 0, this.size[0], this.size[1]);
      a.strokeStyle = "white";
      a.beginPath();
      var e = 0;
      if (this.properties.continuous) {
        a.moveTo(e, d);
        for (var f = 0; f < b.length; f += c) {
          a.lineTo(e, d - b[f | 0] / 255 * d), e++;
        }
      } else {
        for (f = 0; f < b.length; f += c) {
          a.moveTo(e + 0.5, d), a.lineTo(e + 0.5, d - b[f | 0] / 255 * d), e++;
        }
      }
      a.stroke();
      0 <= this.properties.mark && (b = x.getAudioContext().sampleRate / b.length, e = this.properties.mark / b * 2 / c, e >= this.size[0] && (e = this.size[0] - 1), a.strokeStyle = "red", a.beginPath(), a.moveTo(e, d), a.lineTo(e, 0), a.stroke());
    }
  };
  a.title = "Visualization";
  a.desc = "Audio Visualization";
  h.registerNodeType("audio/visualization", a);
  b.prototype.onExecute = function() {
    if (this._freqs = this.getInputData(0)) {
      var a = this.properties.band, b = this.getInputData(1);
      void 0 !== b && (a = b);
      b = x.getAudioContext().sampleRate / this._freqs.length;
      b = a / b * 2;
      b >= this._freqs.length ? b = this._freqs[this._freqs.length - 1] : (a = b | 0, b -= a, b = this._freqs[a] * (1 - b) + this._freqs[a + 1] * b);
      this.setOutputData(0, b / 255 * this.properties.amplitude);
    }
  };
  b.prototype.onGetInputs = function() {
    return [["band", "number"]];
  };
  b.title = "Signal";
  b.desc = "extract the signal of some frequency";
  h.registerNodeType("audio/signal", b);
  d.prototype.onAdded = function(a) {
    a.status == LGraph.STATUS_RUNNING && (this.audionode.onaudioprocess = this._callback);
  };
  d["@code"] = {widget:"code"};
  d.prototype.onStart = function() {
    this.audionode.onaudioprocess = this._callback;
  };
  d.prototype.onStop = function() {
    this.audionode.onaudioprocess = d._bypass_function;
  };
  d.prototype.onPause = function() {
    this.audionode.onaudioprocess = d._bypass_function;
  };
  d.prototype.onUnpause = function() {
    this.audionode.onaudioprocess = this._callback;
  };
  d.prototype.onExecute = function() {
  };
  d.prototype.onRemoved = function() {
    this.audionode.onaudioprocess = d._bypass_function;
  };
  d.prototype.processCode = function() {
    try {
      this._script = new (new Function("properties", this.properties.code))(this.properties), this._old_code = this.properties.code, this._callback = this._script.onaudioprocess;
    } catch (n) {
      console.error("Error in onaudioprocess code", n), this._callback = d._bypass_function, this.audionode.onaudioprocess = this._callback;
    }
  };
  d.prototype.onPropertyChanged = function(a, b) {
    "code" == a && (this.properties.code = b, this.processCode(), this.graph && this.graph.status == LGraph.STATUS_RUNNING && (this.audionode.onaudioprocess = this._callback));
  };
  d.default_function = function() {
    this.onaudioprocess = function(a) {
      var b = a.inputBuffer;
      a = a.outputBuffer;
      for (var c = 0; c < a.numberOfChannels; c++) {
        for (var d = b.getChannelData(c), e = a.getChannelData(c), f = 0; f < b.length; f++) {
          e[f] = d[f];
        }
      }
    };
  };
  x.createAudioNodeWrapper(d);
  d.title = "Script";
  d.desc = "apply script to signal";
  h.registerNodeType("audio/script", d);
  g.title = "Destination";
  g.desc = "Audio output";
  h.registerNodeType("audio/destination", g);
})(this);
(function(u) {
  function f() {
    this.size = [60, 20];
    this.addInput("send", c.ACTION);
    this.addOutput("received", c.EVENT);
    this.addInput("in", 0);
    this.addOutput("out", 0);
    this.properties = {url:"", room:"lgraph"};
    this._ws = null;
    this._last_data = [];
  }
  function k() {
    this.size = [60, 20];
    this.addInput("send", c.ACTION);
    this.addOutput("received", c.EVENT);
    this.addInput("in", 0);
    this.addOutput("out", 0);
    this.properties = {url:"tamats.com:55000", room:"lgraph", save_bandwidth:!0};
    this._server = null;
    this.createSocket();
    this._last_input_data = [];
    this._last_output_data = [];
  }
  var c = u.LiteGraph;
  f.title = "WebSocket";
  f.desc = "Send data through a websocket";
  f.prototype.onPropertyChanged = function(c, f) {
    "url" == c && this.createSocket();
  };
  f.prototype.onExecute = function() {
    !this._ws && this.properties.url && this.createSocket();
    if (this._ws && this._ws.readyState == WebSocket.OPEN) {
      for (var c = this.properties.room, f = 1; f < this.inputs.length; ++f) {
        var k = this.getInputData(f);
        if (null != k) {
          try {
            var u = JSON.stringify({type:0, room:c, channel:f, data:k});
          } catch (e) {
            continue;
          }
          this._ws.send(u);
        }
      }
      for (f = 1; f < this.outputs.length; ++f) {
        this.setOutputData(f, this._last_data[f]);
      }
    }
  };
  f.prototype.createSocket = function() {
    var c = this, f = this.properties.url;
    "ws" != f.substr(0, 2) && (f = "ws://" + f);
    this._ws = new WebSocket(f);
    this._ws.onopen = function() {
      console.log("ready");
      c.boxcolor = "#8E8";
    };
    this._ws.onmessage = function(f) {
      var k = JSON.parse(f.data);
      k.room && k.room != this.properties.room || (1 == f.data.type ? c.triggerSlot(0, k) : c._last_data[f.data.channel || 0] = k.data);
    };
    this._ws.onerror = function(f) {
      console.log("couldnt connect to websocket");
      c.boxcolor = "#E88";
    };
    this._ws.onclose = function(f) {
      console.log("connection closed");
      c.boxcolor = "#000";
    };
  };
  f.prototype.send = function(c) {
    this._ws && this._ws.readyState == WebSocket.OPEN && this._ws.send(JSON.stringify({type:1, msg:c}));
  };
  f.prototype.onAction = function(c, f) {
    this._ws && this._ws.readyState == WebSocket.OPEN && this._ws.send({type:1, room:this.properties.room, action:c, data:f});
  };
  f.prototype.onGetInputs = function() {
    return [["in", 0]];
  };
  f.prototype.onGetOutputs = function() {
    return [["out", 0]];
  };
  c.registerNodeType("network/websocket", f);
  k.title = "SillyClient";
  k.desc = "Connects to SillyServer to broadcast messages";
  k.prototype.onPropertyChanged = function(c, f) {
    c = this.properties.url + "/" + this.properties.room;
    this._server && this._final_url != c && (this._server.connect(this.properties.url, this.properties.room), this._final_url = c);
  };
  k.prototype.onExecute = function() {
    if (this._server && this._server.is_connected) {
      for (var c = this.properties.save_bandwidth, f = 1; f < this.inputs.length; ++f) {
        var k = this.getInputData(f);
        null == k || c && this._last_input_data[f] == k || (this._server.sendMessage({type:0, channel:f, data:k}), this._last_input_data[f] = k);
      }
      for (f = 1; f < this.outputs.length; ++f) {
        this.setOutputData(f, this._last_output_data[f]);
      }
    }
  };
  k.prototype.createSocket = function() {
    var c = this;
    "undefined" == typeof SillyClient ? (this._error || console.error("SillyClient node cannot be used, you must include SillyServer.js"), this._error = !0) : (this._server = new SillyClient, this._server.on_ready = function() {
      console.log("ready");
      c.boxcolor = "#8E8";
    }, this._server.on_message = function(f, k) {
      f = null;
      try {
        f = JSON.parse(k);
      } catch (w) {
        return;
      }
      1 == f.type ? c.triggerSlot(0, f) : c._last_output_data[f.channel || 0] = f.data;
    }, this._server.on_error = function(f) {
      console.log("couldnt connect to websocket");
      c.boxcolor = "#E88";
    }, this._server.on_close = function(f) {
      console.log("connection closed");
      c.boxcolor = "#000";
    }, this.properties.url && this.properties.room && (this._server.connect(this.properties.url, this.properties.room), this._final_url = this.properties.url + "/" + this.properties.room));
  };
  k.prototype.send = function(c) {
    this._server && this._server.is_connected && this._server.sendMessage({type:1, data:c});
  };
  k.prototype.onAction = function(c, f) {
    this._server && this._server.is_connected && this._server.sendMessage({type:1, action:c, data:f});
  };
  k.prototype.onGetInputs = function() {
    return [["in", 0]];
  };
  k.prototype.onGetOutputs = function() {
    return [["out", 0]];
  };
  c.registerNodeType("network/sillyclient", k);
})(this);

=======
(function(r){function g(){l.debug&&console.log("Graph created");this.list_of_graphcanvas=null;this.clear()}function f(a){this._ctor(a)}function e(a,b,c){c=c||{};this.background_image="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=";
a&&a.constructor===String&&(a=document.querySelector(a));this.max_zoom=10;this.min_zoom=0.1;this.title_text_font="bold 14px Arial";this.inner_text_font="normal 12px Arial";this.default_link_color="#AAC";this.default_connection_color={input_off:"#AAB",input_on:"#7F7",output_off:"#AAB",output_on:"#7F7"};this.highquality_render=!0;this.editor_alpha=1;this.pause_rendering=!1;this.render_only_selected=this.clear_background=this.render_shadows=!0;this.live_mode=!1;this.allow_interaction=this.allow_dragnodes=
this.allow_dragcanvas=this.show_info=!0;this.drag_mode=!1;this.dragging_rectangle=null;this.always_render_background=!1;this.render_canvas_area=!0;this.render_connections_shadows=!1;this.render_connection_arrows=this.render_curved_connections=this.render_connections_border=!0;this.connections_width=3;b&&b.attachCanvas(this);this.setCanvas(a);this.clear();c.skip_render||this.startRendering();this.autoresize=c.autoresize}function p(a,b){return Math.sqrt((b[0]-a[0])*(b[0]-a[0])+(b[1]-a[1])*(b[1]-a[1]))}
function q(a,b,c,m,k,d){return c<a&&c+k>a&&m<b&&m+d>b?!0:!1}function s(a,b){var c=a[0]+a[2],m=a[1]+a[3],k=b[1]+b[3];return a[0]>b[0]+b[2]||a[1]>k||c<b[0]||m<b[1]?!1:!0}function u(a,b){this.options=b=b||{};var c=this;b.parentMenu&&(b.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),b.parentMenu=null):(this.parentMenu=b.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));b.event&&b.event.constructor!==MouseEvent&&
b.event.constructor!==CustomEvent&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it."),b.event=null);var m=document.createElement("div");m.className="litegraph litecontextmenu litemenubar-panel";m.style.minWidth=100;m.style.minHeight=100;m.style.pointerEvents="none";setTimeout(function(){m.style.pointerEvents="auto"},100);m.addEventListener("mouseup",function(a){a.preventDefault();return!0},!0);m.addEventListener("contextmenu",function(a){if(2!=a.button)return!1;
a.preventDefault();return!1},!0);m.addEventListener("mousedown",function(a){if(2==a.button)return c.close(),a.preventDefault(),!0},!0);this.root=m;if(b.title){var k=document.createElement("div");k.className="litemenu-title";k.innerHTML=b.title;m.appendChild(k)}var k=0,d;for(d in a){var h=a.constructor==Array?a[d]:d;null!=h&&h.constructor!==String&&(h=void 0===h.content?String(h):h.content);this.addItem(h,a[d],b);k++}m.addEventListener("mouseleave",function(a){c.lock||c.close(a)});d=document;b.event&&
(d=b.event.target.ownerDocument);d||(d=document);d.body.appendChild(m);k=b.left||0;d=b.top||0;if(b.event){k=b.event.pageX-10;d=b.event.pageY-10;b.title&&(d-=20);b.parentMenu&&(k=b.parentMenu.root.getBoundingClientRect(),k=k.left+k.width);var h=document.body.getBoundingClientRect(),e=m.getBoundingClientRect();k>h.width-e.width-10&&(k=h.width-e.width-10);d>h.height-e.height-10&&(d=h.height-e.height-10)}m.style.left=k+"px";m.style.top=d+"px"}var l=r.LiteGraph={NODE_TITLE_HEIGHT:16,NODE_SLOT_HEIGHT:15,
NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,CANVAS_GRID_SIZE:10,NODE_TITLE_COLOR:"#222",NODE_DEFAULT_COLOR:"#999",NODE_DEFAULT_BGCOLOR:"#444",NODE_DEFAULT_BOXCOLOR:"#AEF",NODE_DEFAULT_SHAPE:"box",MAX_NUMBER_OF_NODES:1E3,DEFAULT_POSITION:[100,100],node_images_path:"",VALID_SHAPES:["box","round"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,proxy:null,debug:!1,throw_errors:!0,allow_scripts:!0,
registered_node_types:{},node_types_by_file_extension:{},Nodes:{},registerNodeType:function(a,b){if(!b.prototype)throw"Cannot register a simple object, it must be a class with a prototype";b.type=a;l.debug&&console.log("Node registered: "+a);a.split("/");var c=b.name,m=a.lastIndexOf("/");b.category=a.substr(0,m);b.title||(b.title=c);if(b.prototype)for(var k in f.prototype)b.prototype[k]||(b.prototype[k]=f.prototype[k]);Object.defineProperty(b.prototype,"shape",{set:function(a){switch(a){case "box":this._shape=
l.BOX_SHAPE;break;case "round":this._shape=l.ROUND_SHAPE;break;case "circle":this._shape=l.CIRCLE_SHAPE;break;default:this._shape=a}},get:function(a){return this._shape},enumerable:!0});this.registered_node_types[a]=b;b.constructor.name&&(this.Nodes[c]=b);b.prototype.onPropertyChange&&console.warn("LiteGraph node class "+a+" has onPropertyChange method, it must be called onPropertyChanged with d at the end");if(b.supported_extensions)for(k in b.supported_extensions)this.node_types_by_file_extension[b.supported_extensions[k].toLowerCase()]=
b},wrapFunctionAsNode:function(a,b,c,m){for(var k=Array(b.length),d="",h=l.getParameterNames(b),e=0;e<h.length;++e)d+="this.addInput('"+h[e]+"',"+(c&&c[e]?"'"+c[e]+"'":"0")+");\n";c=Function(d+("this.addOutput('out',"+(m?"'"+m+"'":0)+");\n"));c.title=a.split("/").pop();c.desc="Generated from "+b.name;c.prototype.onExecute=function(){for(var a=0;a<k.length;++a)k[a]=this.getInputData(a);a=b.apply(this,k);this.setOutputData(0,a)};this.registerNodeType(a,c)},addNodeMethod:function(a,b){f.prototype[a]=
b;for(var c in this.registered_node_types){var m=this.registered_node_types[c];m.prototype[a]&&(m.prototype["_"+a]=m.prototype[a]);m.prototype[a]=b}},createNode:function(a,b,c){var m=this.registered_node_types[a];if(!m)return l.debug&&console.log('GraphNode type "'+a+'" not registered.'),null;b=b||m.title||a;m=new m(b);m.type=a;!m.title&&b&&(m.title=b);m.properties||(m.properties={});m.properties_info||(m.properties_info=[]);m.flags||(m.flags={});m.size||(m.size=m.computeSize());m.pos||(m.pos=l.DEFAULT_POSITION.concat());
m.mode||(m.mode=l.ALWAYS);if(c)for(var k in c)m[k]=c[k];return m},getNodeType:function(a){return this.registered_node_types[a]},getNodeTypesInCategory:function(a){var b=[],c;for(c in this.registered_node_types)""==a?null==this.registered_node_types[c].category&&b.push(this.registered_node_types[c]):this.registered_node_types[c].category==a&&b.push(this.registered_node_types[c]);return b},getNodeTypesCategories:function(){var a={"":1},b;for(b in this.registered_node_types)this.registered_node_types[b].category&&
!this.registered_node_types[b].skip_list&&(a[this.registered_node_types[b].category]=1);var c=[];for(b in a)c.push(b);return c},reloadNodes:function(a){var b=document.getElementsByTagName("script"),c=[],m;for(m in b)c.push(b[m]);b=document.getElementsByTagName("head")[0];a=document.location.href+a;for(m in c){var k=c[m].src;if(k&&k.substr(0,a.length)==a)try{l.debug&&console.log("Reloading: "+k);var d=document.createElement("script");d.type="text/javascript";d.src=k;b.appendChild(d);b.removeChild(c[m])}catch(h){if(l.throw_errors)throw h;
l.debug&&console.log("Error while reloading "+k)}}l.debug&&console.log("Nodes reloaded")},cloneObject:function(a,b){if(null==a)return null;var c=JSON.parse(JSON.stringify(a));if(!b)return c;for(var m in c)b[m]=c[m];return b},isValidConnection:function(a,b){if(!a||!b||a==b||a==l.EVENT&&b==l.ACTION)return!0;a=a.toLowerCase();b=b.toLowerCase();if(-1==a.indexOf(",")&&-1==b.indexOf(","))return a==b;for(var c=a.split(","),m=b.split(","),k=0;k<c.length;++k)for(var d=0;d<m.length;++d)if(c[k]==m[d])return!0;
return!1}};l.getTime="undefined"!=typeof performance?performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?Date.now.bind(Date):"undefined"!=typeof process?function(){var a=process.hrtime();return 0.001*a[0]+1E-6*a[1]}:function(){return(new Date).getTime()};r.LGraph=l.LGraph=g;g.supported_types=["number","string","boolean"];g.prototype.getSupportedTypes=function(){return this.supported_types||g.supported_types};g.STATUS_STOPPED=1;g.STATUS_RUNNING=2;g.prototype.clear=function(){this.stop();
this.status=g.STATUS_STOPPED;this.last_node_id=0;this._nodes=[];this._nodes_by_id={};this._nodes_executable=this._nodes_in_order=null;this.last_link_id=0;this.links={};this.iteration=0;this.config={};this.fixedtime=this.runningtime=this.globaltime=0;this.elapsed_time=this.fixedtime_lapse=0.01;this.starttime=0;this.catch_errors=!0;this.global_inputs={};this.global_outputs={};this.debug=!0;this.change();this.sendActionToCanvas("clear")};g.prototype.attachCanvas=function(a){if(a.constructor!=e)throw"attachCanvas expects a LGraphCanvas instance";
a.graph&&a.graph!=this&&a.graph.detachCanvas(a);a.graph=this;this.list_of_graphcanvas||(this.list_of_graphcanvas=[]);this.list_of_graphcanvas.push(a)};g.prototype.detachCanvas=function(a){if(this.list_of_graphcanvas){var b=this.list_of_graphcanvas.indexOf(a);-1!=b&&(a.graph=null,this.list_of_graphcanvas.splice(b,1))}};g.prototype.start=function(a){if(this.status!=g.STATUS_RUNNING){this.status=g.STATUS_RUNNING;if(this.onPlayEvent)this.onPlayEvent();this.sendEventToAllNodes("onStart");this.starttime=
l.getTime();var b=this;this.execution_timer_id=setInterval(function(){b.runStep(1,!this.catch_errors)},a||1)}};g.prototype.stop=function(){if(this.status!=g.STATUS_STOPPED){this.status=g.STATUS_STOPPED;if(this.onStopEvent)this.onStopEvent();null!=this.execution_timer_id&&clearInterval(this.execution_timer_id);this.execution_timer_id=null;this.sendEventToAllNodes("onStop")}};g.prototype.runStep=function(a,b){a=a||1;var c=l.getTime();this.globaltime=0.001*(c-this.starttime);var m=this._nodes_executable?
this._nodes_executable:this._nodes;if(m){if(b){for(var k=0;k<a;k++){for(var d=0,h=m.length;d<h;++d){var e=m[d];if(e.mode==l.ALWAYS&&e.onExecute)e.onExecute()}this.fixedtime+=this.fixedtime_lapse;if(this.onExecuteStep)this.onExecuteStep()}if(this.onAfterExecute)this.onAfterExecute()}else try{for(k=0;k<a;k++){d=0;for(h=m.length;d<h;++d)if(e=m[d],e.mode==l.ALWAYS&&e.onExecute)e.onExecute();this.fixedtime+=this.fixedtime_lapse;if(this.onExecuteStep)this.onExecuteStep()}if(this.onAfterExecute)this.onAfterExecute();
this.errors_in_execution=!1}catch(f){this.errors_in_execution=!0;if(l.throw_errors)throw f;l.debug&&console.log("Error during execution: "+f);this.stop()}c=l.getTime()-c;0==c&&(c=1);this.elapsed_time=0.001*c;this.globaltime+=0.001*c;this.iteration+=1}};g.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1);this._nodes_executable=[];for(var a=0;a<this._nodes_in_order.length;++a)this._nodes_in_order[a].onExecute&&this._nodes_executable.push(this._nodes_in_order[a])};
g.prototype.computeExecutionOrder=function(a,b){for(var c=[],m=[],k={},d={},h={},e=0,f=this._nodes.length;e<f;++e){var n=this._nodes[e];if(!a||n.onExecute){k[n.id]=n;var g=0;if(n.inputs)for(var p=0,q=n.inputs.length;p<q;p++)n.inputs[p]&&null!=n.inputs[p].link&&(g+=1);0==g?(m.push(n),b&&(n._level=1)):(b&&(n._level=0),h[n.id]=g)}}for(;0!=m.length;)if(n=m.shift(),c.push(n),delete k[n.id],n.outputs)for(e=0;e<n.outputs.length;e++)if(f=n.outputs[e],null!=f&&null!=f.links&&0!=f.links.length)for(p=0;p<f.links.length;p++)(g=
this.links[f.links[p]])&&!d[g.id]&&(q=this.getNodeById(g.target_id),null==q?d[g.id]=!0:(b&&(!q._level||q._level<=n._level)&&(q._level=n._level+1),d[g.id]=!0,h[q.id]-=1,0==h[q.id]&&m.push(q)));for(e in k)c.push(k[e]);c.length!=this._nodes.length&&l.debug&&console.warn("something went wrong, nodes missing");for(e=0;e<c.length;++e)c[e].order=e;return c};g.prototype.arrange=function(a){a=a||40;for(var b=this.computeExecutionOrder(!1,!0),c=[],m=0;m<b.length;++m){var k=b[m],d=k._level||1;c[d]||(c[d]=[]);
c[d].push(k)}b=a;for(m=0;m<c.length;++m)if(d=c[m]){for(var h=100,e=a,f=0;f<d.length;++f)k=d[f],k.pos[0]=b,k.pos[1]=e,k.size[0]>h&&(h=k.size[0]),e+=k.size[1]+a;b+=h+a}this.setDirtyCanvas(!0,!0)};g.prototype.getTime=function(){return this.globaltime};g.prototype.getFixedTime=function(){return this.fixedtime};g.prototype.getElapsedTime=function(){return this.elapsed_time};g.prototype.sendEventToAllNodes=function(a,b,c){c=c||l.ALWAYS;var m=this._nodes_in_order?this._nodes_in_order:this._nodes;if(m)for(var k=
0,d=m.length;k<d;++k){var h=m[k];if(h[a]&&h.mode==c)if(void 0===b)h[a]();else if(b&&b.constructor===Array)h[a].apply(h,b);else h[a](b)}};g.prototype.sendActionToCanvas=function(a,b){if(this.list_of_graphcanvas)for(var c=0;c<this.list_of_graphcanvas.length;++c){var m=this.list_of_graphcanvas[c];m[a]&&m[a].apply(m,b)}};g.prototype.add=function(a,b){if(a){-1!=a.id&&null!=this._nodes_by_id[a.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),a.id=++this.last_node_id);if(this._nodes.length>=
l.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";null==a.id||-1==a.id?a.id=++this.last_node_id:this.last_node_id<a.id&&(this.last_node_id=a.id);a.graph=this;this._nodes.push(a);this._nodes_by_id[a.id]=a;if(a.onAdded)a.onAdded(this);this.config.align_to_grid&&a.alignToGrid();b||this.updateExecutionOrder();if(this.onNodeAdded)this.onNodeAdded(a);this.setDirtyCanvas(!0);this.change();return a}};g.prototype.remove=function(a){if(null!=this._nodes_by_id[a.id]&&!a.ignore_remove){if(a.inputs)for(var b=
0;b<a.inputs.length;b++){var c=a.inputs[b];null!=c.link&&a.disconnectInput(b)}if(a.outputs)for(b=0;b<a.outputs.length;b++)c=a.outputs[b],null!=c.links&&c.links.length&&a.disconnectOutput(b);if(a.onRemoved)a.onRemoved();a.graph=null;if(this.list_of_graphcanvas)for(b=0;b<this.list_of_graphcanvas.length;++b)c=this.list_of_graphcanvas[b],c.selected_nodes[a.id]&&delete c.selected_nodes[a.id],c.node_dragged==a&&(c.node_dragged=null);b=this._nodes.indexOf(a);-1!=b&&this._nodes.splice(b,1);delete this._nodes_by_id[a.id];
if(this.onNodeRemoved)this.onNodeRemoved(a);this.setDirtyCanvas(!0,!0);this.change();this.updateExecutionOrder()}};g.prototype.getNodeById=function(a){return null==a?null:this._nodes_by_id[a]};g.prototype.findNodesByClass=function(a){for(var b=[],c=0,m=this._nodes.length;c<m;++c)this._nodes[c].constructor===a&&b.push(this._nodes[c]);return b};g.prototype.findNodesByType=function(a){a=a.toLowerCase();for(var b=[],c=0,m=this._nodes.length;c<m;++c)this._nodes[c].type.toLowerCase()==a&&b.push(this._nodes[c]);
return b};g.prototype.findNodesByTitle=function(a){for(var b=[],c=0,m=this._nodes.length;c<m;++c)this._nodes[c].title==a&&b.push(this._nodes[c]);return b};g.prototype.getNodeOnPos=function(a,b,c){c=c||this._nodes;for(var m=c.length-1;0<=m;m--){var k=c[m];if(k.isPointInsideNode(a,b,2))return k}return null};g.prototype.addGlobalInput=function(a,b,c){this.global_inputs[a]={name:a,type:b,value:c};if(this.onGlobalInputAdded)this.onGlobalInputAdded(a,b);if(this.onGlobalsChange)this.onGlobalsChange()};g.prototype.setGlobalInputData=
function(a,b){var c=this.global_inputs[a];c&&(c.value=b)};g.prototype.setInputData=g.prototype.setGlobalInputData;g.prototype.getGlobalInputData=function(a){return(a=this.global_inputs[a])?a.value:null};g.prototype.renameGlobalInput=function(a,b){if(b!=a){if(!this.global_inputs[a])return!1;if(this.global_inputs[b])return console.error("there is already one input with that name"),!1;this.global_inputs[b]=this.global_inputs[a];delete this.global_inputs[a];if(this.onGlobalInputRenamed)this.onGlobalInputRenamed(a,
b);if(this.onGlobalsChange)this.onGlobalsChange()}};g.prototype.changeGlobalInputType=function(a,b){if(!this.global_inputs[a])return!1;if(this.global_inputs[a].type.toLowerCase()!=b.toLowerCase()&&(this.global_inputs[a].type=b,this.onGlobalInputTypeChanged))this.onGlobalInputTypeChanged(a,b)};g.prototype.removeGlobalInput=function(a){if(!this.global_inputs[a])return!1;delete this.global_inputs[a];if(this.onGlobalInputRemoved)this.onGlobalInputRemoved(a);if(this.onGlobalsChange)this.onGlobalsChange();
return!0};g.prototype.addGlobalOutput=function(a,b,c){this.global_outputs[a]={name:a,type:b,value:c};if(this.onGlobalOutputAdded)this.onGlobalOutputAdded(a,b);if(this.onGlobalsChange)this.onGlobalsChange()};g.prototype.setGlobalOutputData=function(a,b){var c=this.global_outputs[a];c&&(c.value=b)};g.prototype.getGlobalOutputData=function(a){return(a=this.global_outputs[a])?a.value:null};g.prototype.getOutputData=g.prototype.getGlobalOutputData;g.prototype.renameGlobalOutput=function(a,b){if(!this.global_outputs[a])return!1;
if(this.global_outputs[b])return console.error("there is already one output with that name"),!1;this.global_outputs[b]=this.global_outputs[a];delete this.global_outputs[a];if(this.onGlobalOutputRenamed)this.onGlobalOutputRenamed(a,b);if(this.onGlobalsChange)this.onGlobalsChange()};g.prototype.changeGlobalOutputType=function(a,b){if(!this.global_outputs[a])return!1;if(this.global_outputs[a].type.toLowerCase()!=b.toLowerCase()&&(this.global_outputs[a].type=b,this.onGlobalOutputTypeChanged))this.onGlobalOutputTypeChanged(a,
b)};g.prototype.removeGlobalOutput=function(a){if(!this.global_outputs[a])return!1;delete this.global_outputs[a];if(this.onGlobalOutputRemoved)this.onGlobalOutputRemoved(a);if(this.onGlobalsChange)this.onGlobalsChange();return!0};g.prototype.triggerInput=function(a,b){for(var c=this.findNodesByTitle(a),m=0;m<c.length;++m)c[m].onTrigger(b)};g.prototype.setCallback=function(a,b){for(var c=this.findNodesByTitle(a),m=0;m<c.length;++m)c[m].setTrigger(b)};g.prototype.connectionChange=function(a){this.updateExecutionOrder();
if(this.onConnectionChange)this.onConnectionChange(a);this.sendActionToCanvas("onConnectionChange")};g.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var a=0;a<this.list_of_graphcanvas.length;++a)if(this.list_of_graphcanvas[a].live_mode)return!0;return!1};g.prototype.change=function(){l.debug&&console.log("Graph changed");this.sendActionToCanvas("setDirty",[!0,!0]);if(this.on_change)this.on_change(this)};g.prototype.setDirtyCanvas=function(a,b){this.sendActionToCanvas("setDirty",
[a,b])};g.prototype.serialize=function(){for(var a=[],b=0,c=this._nodes.length;b<c;++b)a.push(this._nodes[b].serialize());c=[];for(b in this.links){var m=this.links[b];c.push([m.id,m.origin_id,m.origin_slot,m.target_id,m.target_slot,m.type])}return{iteration:this.iteration,frame:this.frame,last_node_id:this.last_node_id,last_link_id:this.last_link_id,links:c,config:this.config,nodes:a}};g.prototype.configure=function(a,b){b||this.clear();var c=a.nodes;if(a.links&&a.links.constructor===Array){for(var m=
{},k=0;k<a.links.length;++k){var d=a.links[k];m[d[0]]={id:d[0],origin_id:d[1],origin_slot:d[2],target_id:d[3],target_slot:d[4],type:d[5]}}a.links=m}for(k in a)this[k]=a[k];m=!1;this._nodes=[];k=0;for(d=c.length;k<d;++k){var h=c[k],e=l.createNode(h.type,h.title);e?(e.id=h.id,this.add(e,!0)):(l.debug&&console.log("Node not found: "+h.type),m=!0)}k=0;for(d=c.length;k<d;++k)h=c[k],(e=this.getNodeById(h.id))&&e.configure(h);this.updateExecutionOrder();this.setDirtyCanvas(!0,!0);return m};g.prototype.load=
function(a){var b=this,c=new XMLHttpRequest;c.open("GET",a,!0);c.send(null);c.onload=function(a){200!==c.status?console.error("Error loading graph:",c.status,c.response):(a=JSON.parse(c.response),b.configure(a))};c.onerror=function(a){console.error("Error loading graph:",a)}};g.prototype.onNodeTrace=function(a,b,c){};r.LGraphNode=l.LGraphNode=f;f.prototype._ctor=function(a){this.title=a||"Unnamed";this.size=[l.NODE_WIDTH,60];this.graph=null;this._pos=new Float32Array(10,10);Object.defineProperty(this,
"pos",{set:function(a){!a||2>!a.length||(this._pos[0]=a[0],this._pos[1]=a[1])},get:function(){return this._pos},enumerable:!0});this.id=-1;this.type=null;this.inputs=[];this.outputs=[];this.connections=[];this.properties={};this.properties_info=[];this.data=null;this.flags={}};f.prototype.configure=function(a){for(var b in a)if("console"!=b)if("properties"==b)for(var c in a.properties){if(this.properties[c]=a.properties[c],this.onPropertyChanged)this.onPropertyChanged(c,a.properties[c])}else null!=
a[b]&&("object"==typeof a[b]?this[b]&&this[b].configure?this[b].configure(a[b]):this[b]=l.cloneObject(a[b],this[b]):this[b]=a[b]);a.title||(this.title=this.constructor.title);if(this.onConnectionsChange){if(this.inputs)for(var m=0;m<this.inputs.length;++m){c=this.inputs[m];var d=this.graph.links[c.link];this.onConnectionsChange(l.INPUT,m,!0,d,c)}if(this.outputs)for(m=0;m<this.outputs.length;++m)if(c=this.outputs[m],c.links)for(b=0;b<c.links.length;++b)d=this.graph.links[c.links[b]],this.onConnectionsChange(l.OUTPUT,
m,!0,d,c)}for(m in this.inputs)c=this.inputs[m],c.link&&c.link.length&&(d=c.link,"object"==typeof d&&(c.link=d[0],this.graph.links[d[0]]={id:d[0],origin_id:d[1],origin_slot:d[2],target_id:d[3],target_slot:d[4]}));for(m in this.outputs)if(c=this.outputs[m],c.links&&0!=c.links.length)for(b in c.links)d=c.links[b],"object"==typeof d&&(c.links[b]=d[0]);if(this.onConfigure)this.onConfigure(a)};f.prototype.serialize=function(){var a={id:this.id,type:this.type,pos:this.pos,size:this.size,data:this.data,
flags:l.cloneObject(this.flags),mode:this.mode};this.inputs&&(a.inputs=this.inputs);if(this.outputs){for(var b=0;b<this.outputs.length;b++)delete this.outputs[b]._data;a.outputs=this.outputs}this.title&&this.title!=this.constructor.title&&(a.title=this.title);this.properties&&(a.properties=l.cloneObject(this.properties));a.type||(a.type=this.constructor.type);this.color&&(a.color=this.color);this.bgcolor&&(a.bgcolor=this.bgcolor);this.boxcolor&&(a.boxcolor=this.boxcolor);this.shape&&(a.shape=this.shape);
if(this.onSerialize)this.onSerialize(a);return a};f.prototype.clone=function(){var a=l.createNode(this.type),b=l.cloneObject(this.serialize());if(b.inputs)for(var c=0;c<b.inputs.length;++c)b.inputs[c].link=null;if(b.outputs)for(c=0;c<b.outputs.length;++c)b.outputs[c].links&&(b.outputs[c].links.length=0);delete b.id;a.configure(b);return a};f.prototype.toString=function(){return JSON.stringify(this.serialize())};f.prototype.getTitle=function(){return this.title||this.constructor.title};f.prototype.setOutputData=
function(a,b){if(this.outputs&&!(-1==a||a>=this.outputs.length)){var c=this.outputs[a];if(c&&(c._data=b,this.outputs[a].links))for(c=0;c<this.outputs[a].links.length;c++)this.graph.links[this.outputs[a].links[c]].data=b}};f.prototype.getInputData=function(a,b){if(this.inputs&&!(a>=this.inputs.length||null==this.inputs[a].link)){var c=this.graph.links[this.inputs[a].link];if(!c)return null;if(!b)return c.data;var m=this.graph.getNodeById(c.origin_id);if(!m)return c.data;if(m.updateOutputData)m.updateOutputData(c.origin_slot);
else if(m.onExecute)m.onExecute();return c.data}};f.prototype.getInputDataByName=function(a,b){var c=this.findInputSlot(a);return-1==c?null:this.getInputData(c,b)};f.prototype.isInputConnected=function(a){return this.inputs?a<this.inputs.length&&null!=this.inputs[a].link:!1};f.prototype.getInputInfo=function(a){return this.inputs?a<this.inputs.length?this.inputs[a]:null:null};f.prototype.getInputNode=function(a){if(!this.inputs||a>=this.inputs.length)return null;a=this.inputs[a];return a&&a.link?
(a=this.graph.links[a.link])?this.graph.getNodeById(a.origin_id):null:null};f.prototype.getInputOrProperty=function(a){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[a]:null;for(var b=0,c=this.inputs.length;b<c;++b)if(a==this.inputs[b].name)return(a=this.graph.links[this.inputs[b].link])?a.data:null;return this.properties[a]};f.prototype.getOutputData=function(a){return!this.outputs||a>=this.outputs.length?null:this.outputs[a]._data};f.prototype.getOutputInfo=function(a){return this.outputs?
a<this.outputs.length?this.outputs[a]:null:null};f.prototype.isOutputConnected=function(a){return this.outputs?a<this.outputs.length&&this.outputs[a].links&&this.outputs[a].links.length:!1};f.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var a=0;a<this.outputs.length;++a)if(this.outputs[a].links&&this.outputs[a].links.length)return!0;return!1};f.prototype.getOutputNodes=function(a){if(!this.outputs||0==this.outputs.length||a>=this.outputs.length)return null;a=this.outputs[a];
if(!a.links||0==a.links.length)return null;for(var b=[],c=0;c<a.links.length;c++){var m=this.graph.links[a.links[c]];m&&(m=this.graph.getNodeById(m.target_id))&&b.push(m)}return b};f.prototype.trigger=function(a,b){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=l.getTime());for(var c=0;c<this.outputs.length;++c){var m=this.outputs[c];!m||m.type!==l.EVENT||a&&m.name!=a||this.triggerSlot(c,b)}}};f.prototype.triggerSlot=function(a,b){if(this.outputs){var c=this.outputs[a];
if(c&&(c=c.links)&&c.length){this.graph&&(this.graph._last_trigger_time=l.getTime());for(var m=0;m<c.length;++m){var d=this.graph.links[c[m]];if(d){var e=this.graph.getNodeById(d.target_id);if(e)if(d._last_time=l.getTime(),d=e.inputs[d.target_slot],e.onAction)e.onAction(d.name,b);else if(e.mode===l.ON_TRIGGER&&e.onExecute)e.onExecute(b)}}}}};f.prototype.addProperty=function(a,b,c,m){c={name:a,type:c,default_value:b};if(m)for(var d in m)c[d]=m[d];this.properties_info||(this.properties_info=[]);this.properties_info.push(c);
this.properties||(this.properties={});this.properties[a]=b;return c};f.prototype.addOutput=function(a,b,c){a={name:a,type:b,links:null};if(c)for(var m in c)a[m]=c[m];this.outputs||(this.outputs=[]);this.outputs.push(a);if(this.onOutputAdded)this.onOutputAdded(a);this.size=this.computeSize();return a};f.prototype.addOutputs=function(a){for(var b=0;b<a.length;++b){var c=a[b],m={name:c[0],type:c[1],link:null};if(a[2])for(var d in c[2])m[d]=c[2][d];this.outputs||(this.outputs=[]);this.outputs.push(m);
if(this.onOutputAdded)this.onOutputAdded(m)}this.size=this.computeSize()};f.prototype.removeOutput=function(a){this.disconnectOutput(a);this.outputs.splice(a,1);this.size=this.computeSize();if(this.onOutputRemoved)this.onOutputRemoved(a)};f.prototype.addInput=function(a,b,c){a={name:a,type:b||0,link:null};if(c)for(var m in c)a[m]=c[m];this.inputs||(this.inputs=[]);this.inputs.push(a);this.size=this.computeSize();if(this.onInputAdded)this.onInputAdded(a);return a};f.prototype.addInputs=function(a){for(var b=
0;b<a.length;++b){var c=a[b],m={name:c[0],type:c[1],link:null};if(a[2])for(var d in c[2])m[d]=c[2][d];this.inputs||(this.inputs=[]);this.inputs.push(m);if(this.onInputAdded)this.onInputAdded(m)}this.size=this.computeSize()};f.prototype.removeInput=function(a){this.disconnectInput(a);this.inputs.splice(a,1);this.size=this.computeSize();if(this.onInputRemoved)this.onInputRemoved(a)};f.prototype.addConnection=function(a,b,c,m){a={name:a,type:b,pos:c,direction:m,links:null};this.connections.push(a);return a};
f.prototype.computeSize=function(a,b){function c(a){return a?e*a.length*0.6:0}var m=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),d=b||new Float32Array([0,0]),m=Math.max(m,1);d[1]=14*m+6;var e=14,m=c(this.title),h=0,f=0;if(this.inputs)for(var n=0,g=this.inputs.length;n<g;++n){var p=this.inputs[n],p=p.label||p.name||"",p=c(p);h<p&&(h=p)}if(this.outputs)for(n=0,g=this.outputs.length;n<g;++n)p=this.outputs[n],p=p.label||p.name||"",p=c(p),f<p&&(f=p);d[0]=Math.max(h+f+10,
m);d[0]=Math.max(d[0],l.NODE_WIDTH);return d};f.prototype.getBounding=function(a){a=a||new Float32Array(4);a[0]=this.pos[0]-4;a[1]=this.pos[1]-l.NODE_TITLE_HEIGHT;a[2]=this.size[0]+4;a[3]=this.size[1]+l.NODE_TITLE_HEIGHT;return a};f.prototype.isPointInsideNode=function(a,b,c){c=c||0;var d=this.graph&&this.graph.isLive()?0:20;if(this.flags.collapsed){if(q(a,b,this.pos[0]-c,this.pos[1]-l.NODE_TITLE_HEIGHT-c,l.NODE_COLLAPSED_WIDTH+2*c,l.NODE_TITLE_HEIGHT+2*c))return!0}else if(this.pos[0]-4-c<a&&this.pos[0]+
this.size[0]+4+c>a&&this.pos[1]-d-c<b&&this.pos[1]+this.size[1]+c>b)return!0;return!1};f.prototype.getSlotInPosition=function(a,b){if(this.inputs)for(var c=0,d=this.inputs.length;c<d;++c){var k=this.inputs[c],e=this.getConnectionPos(!0,c);if(q(a,b,e[0]-10,e[1]-5,20,10))return{input:k,slot:c,link_pos:e,locked:k.locked}}if(this.outputs)for(c=0,d=this.outputs.length;c<d;++c)if(k=this.outputs[c],e=this.getConnectionPos(!1,c),q(a,b,e[0]-10,e[1]-5,20,10))return{output:k,slot:c,link_pos:e,locked:k.locked};
return null};f.prototype.findInputSlot=function(a){if(!this.inputs)return-1;for(var b=0,c=this.inputs.length;b<c;++b)if(a==this.inputs[b].name)return b;return-1};f.prototype.findOutputSlot=function(a){if(!this.outputs)return-1;for(var b=0,c=this.outputs.length;b<c;++b)if(a==this.outputs[b].name)return b;return-1};f.prototype.connect=function(a,b,c){c=c||0;if(a.constructor===String){if(a=this.findOutputSlot(a),-1==a)return l.debug&&console.log("Connect: Error, no slot of name "+a),!1}else if(!this.outputs||
a>=this.outputs.length)return l.debug&&console.log("Connect: Error, slot number not found"),!1;b&&b.constructor===Number&&(b=this.graph.getNodeById(b));if(!b)throw"Node not found";if(b==this)return!1;if(c.constructor===String){if(c=b.findInputSlot(c),-1==c)return l.debug&&console.log("Connect: Error, no slot of name "+c),!1}else{if(c===l.EVENT)return!1;if(!b.inputs||c>=b.inputs.length)return l.debug&&console.log("Connect: Error, slot number not found"),!1}null!=b.inputs[c].link&&b.disconnectInput(c);
this.setDirtyCanvas(!1,!0);this.graph.connectionChange(this);var d=this.outputs[a];if(b.onConnectInput&&!1===b.onConnectInput(c,d.type,d))return!1;var k=b.inputs[c];if(l.isValidConnection(d.type,k.type)){var e={id:this.graph.last_link_id++,type:k.type,origin_id:this.id,origin_slot:a,target_id:b.id,target_slot:c};this.graph.links[e.id]=e;null==d.links&&(d.links=[]);d.links.push(e.id);b.inputs[c].link=e.id;if(this.onConnectionsChange)this.onConnectionsChange(l.OUTPUT,a,!0,e,d);if(b.onConnectionsChange)b.onConnectionsChange(l.INPUT,
c,!0,e,k)}this.setDirtyCanvas(!1,!0);this.graph.connectionChange(this);return!0};f.prototype.disconnectOutput=function(a,b){if(a.constructor===String){if(a=this.findOutputSlot(a),-1==a)return l.debug&&console.log("Connect: Error, no slot of name "+a),!1}else if(!this.outputs||a>=this.outputs.length)return l.debug&&console.log("Connect: Error, slot number not found"),!1;var c=this.outputs[a];if(!c.links||0==c.links.length)return!1;if(b){b.constructor===Number&&(b=this.graph.getNodeById(b));if(!b)throw"Target Node not found";
for(var d=0,k=c.links.length;d<k;d++){var e=c.links[d],h=this.graph.links[e];if(h.target_id==b.id){c.links.splice(d,1);var f=b.inputs[h.target_slot];f.link=null;delete this.graph.links[e];if(b.onConnectionsChange)b.onConnectionsChange(l.INPUT,h.target_slot,!1,h,f);if(this.onConnectionsChange)this.onConnectionsChange(l.OUTPUT,a,!1,h,c);break}}}else{d=0;for(k=c.links.length;d<k;d++)if(e=c.links[d],h=this.graph.links[e]){if(b=this.graph.getNodeById(h.target_id))if(f=b.inputs[h.target_slot],f.link=null,
b.onConnectionsChange)b.onConnectionsChange(l.INPUT,h.target_slot,!1,h,f);delete this.graph.links[e];if(this.onConnectionsChange)this.onConnectionsChange(l.OUTPUT,a,!1,h,c)}c.links=null}this.setDirtyCanvas(!1,!0);this.graph.connectionChange(this);return!0};f.prototype.disconnectInput=function(a){if(a.constructor===String){if(a=this.findInputSlot(a),-1==a)return l.debug&&console.log("Connect: Error, no slot of name "+a),!1}else if(!this.inputs||a>=this.inputs.length)return l.debug&&console.log("Connect: Error, slot number not found"),
!1;var b=this.inputs[a];if(!b)return!1;var c=this.inputs[a].link;this.inputs[a].link=null;var d=this.graph.links[c];if(d){var k=this.graph.getNodeById(d.origin_id);if(!k)return!1;var e=k.outputs[d.origin_slot];if(!e||!e.links||0==e.links.length)return!1;for(var h=0,f=e.links.length;h<f;h++)if(e.links[h]==c){e.links.splice(h,1);break}delete this.graph.links[c];if(this.onConnectionsChange)this.onConnectionsChange(l.INPUT,a,!1,d,b);if(k.onConnectionsChange)k.onConnectionsChange(l.OUTPUT,h,!1,d,e)}this.setDirtyCanvas(!1,
!0);this.graph.connectionChange(this);return!0};f.prototype.getConnectionPos=function(a,b){return this.flags.collapsed?a?[this.pos[0],this.pos[1]-0.5*l.NODE_TITLE_HEIGHT]:[this.pos[0]+l.NODE_COLLAPSED_WIDTH,this.pos[1]-0.5*l.NODE_TITLE_HEIGHT]:a&&-1==b?[this.pos[0]+10,this.pos[1]+10]:a&&this.inputs.length>b&&this.inputs[b].pos?[this.pos[0]+this.inputs[b].pos[0],this.pos[1]+this.inputs[b].pos[1]]:!a&&this.outputs.length>b&&this.outputs[b].pos?[this.pos[0]+this.outputs[b].pos[0],this.pos[1]+this.outputs[b].pos[1]]:
a?[this.pos[0],this.pos[1]+10+b*l.NODE_SLOT_HEIGHT]:[this.pos[0]+this.size[0]+1,this.pos[1]+10+b*l.NODE_SLOT_HEIGHT]};f.prototype.alignToGrid=function(){this.pos[0]=l.CANVAS_GRID_SIZE*Math.round(this.pos[0]/l.CANVAS_GRID_SIZE);this.pos[1]=l.CANVAS_GRID_SIZE*Math.round(this.pos[1]/l.CANVAS_GRID_SIZE)};f.prototype.trace=function(a){this.console||(this.console=[]);this.console.push(a);this.console.length>f.MAX_CONSOLE&&this.console.shift();this.graph.onNodeTrace(this,a)};f.prototype.setDirtyCanvas=function(a,
b){this.graph&&this.graph.sendActionToCanvas("setDirty",[a,b])};f.prototype.loadImage=function(a){var b=new Image;b.src=l.node_images_path+a;b.ready=!1;var c=this;b.onload=function(){this.ready=!0;c.setDirtyCanvas(!0)};return b};f.prototype.captureInput=function(a){if(this.graph&&this.graph.list_of_graphcanvas)for(var b=this.graph.list_of_graphcanvas,c=0;c<b.length;++c){var d=b[c];if(a||d.node_capturing_input==this)d.node_capturing_input=a?this:null}};f.prototype.collapse=function(){this.flags.collapsed=
this.flags.collapsed?!1:!0;this.setDirtyCanvas(!0,!0)};f.prototype.pin=function(a){this.flags.pinned=void 0===a?!this.flags.pinned:a};f.prototype.localToScreen=function(a,b,c){return[(a+this.pos[0])*c.scale+c.offset[0],(b+this.pos[1])*c.scale+c.offset[1]]};r.LGraphCanvas=l.LGraphCanvas=e;e.link_type_colors={"-1":"#F85",number:"#AAC",node:"#DCA"};e.prototype.clear=function(){this.fps=this.render_time=this.last_draw_time=this.frame=0;this.scale=1;this.offset=[0,0];this.dragging_rectangle=null;this.selected_nodes=
{};this.visible_nodes=[];this.connecting_node=this.node_capturing_input=this.node_over=this.node_dragged=null;this.highlighted_links={};this.dirty_bgcanvas=this.dirty_canvas=!0;this.node_in_panel=this.dirty_area=null;this.last_mouse=[0,0];this.last_mouseclick=0;if(this.onClear)this.onClear()};e.prototype.setGraph=function(a,b){this.graph!=a&&(b||this.clear(),!a&&this.graph?this.graph.detachCanvas(this):(a.attachCanvas(this),this.setDirty(!0,!0)))};e.prototype.openSubgraph=function(a){if(!a)throw"graph cannot be null";
if(this.graph==a)throw"graph cannot be the same";this.clear();this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph));a.attachCanvas(this);this.setDirty(!0,!0)};e.prototype.closeSubgraph=function(){if(this._graph_stack&&0!=this._graph_stack.length){var a=this._graph_stack.pop();this.selected_nodes={};this.highlighted_links={};a.attachCanvas(this);this.setDirty(!0,!0)}};e.prototype.setCanvas=function(a,b){if(a&&a.constructor===String&&(a=document.getElementById(a),
!a))throw"Error creating LiteGraph canvas: Canvas not found";if(a!==this.canvas&&(!a&&this.canvas&&(b||this.unbindEvents()),this.canvas=a)){a.className+=" lgraphcanvas";a.data=this;this.bgcanvas=null;this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height);if(null==a.getContext){if("canvas"!=a.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+a.localName;throw"This browser doesnt support Canvas";
}null==(this.ctx=a.getContext("2d"))&&(console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL());this._mousemove_callback=this.processMouseMove.bind(this);this._mouseup_callback=this.processMouseUp.bind(this);b||this.bindEvents()}};e.prototype._doNothing=function(a){a.preventDefault();return!1};e.prototype._doReturnTrue=function(a){a.preventDefault();return!0};e.prototype.bindEvents=function(){if(this._events_binded)console.warn("LGraphCanvas: events already binded");
else{var a=this.canvas,b=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this);this._mousewheel_callback=this.processMouseWheel.bind(this);a.addEventListener("mousedown",this._mousedown_callback,!0);a.addEventListener("mousemove",this._mousemove_callback);a.addEventListener("mousewheel",this._mousewheel_callback,!1);a.addEventListener("contextmenu",this._doNothing);a.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1);a.addEventListener("touchstart",
this.touchHandler,!0);a.addEventListener("touchmove",this.touchHandler,!0);a.addEventListener("touchend",this.touchHandler,!0);a.addEventListener("touchcancel",this.touchHandler,!0);this._key_callback=this.processKey.bind(this);a.addEventListener("keydown",this._key_callback,!0);b.addEventListener("keyup",this._key_callback,!0);this._ondrop_callback=this.processDrop.bind(this);a.addEventListener("dragover",this._doNothing,!1);a.addEventListener("dragend",this._doNothing,!1);a.addEventListener("drop",
this._ondrop_callback,!1);a.addEventListener("dragenter",this._doReturnTrue,!1);this._events_binded=!0}};e.prototype.unbindEvents=function(){if(this._events_binded){var a=this.getCanvasWindow().document;this.canvas.removeEventListener("mousedown",this._mousedown_callback);this.canvas.removeEventListener("mousewheel",this._mousewheel_callback);this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback);this.canvas.removeEventListener("keydown",this._key_callback);a.removeEventListener("keyup",
this._key_callback);this.canvas.removeEventListener("contextmenu",this._doNothing);this.canvas.removeEventListener("drop",this._ondrop_callback);this.canvas.removeEventListener("dragenter",this._doReturnTrue);this.canvas.removeEventListener("touchstart",this.touchHandler);this.canvas.removeEventListener("touchmove",this.touchHandler);this.canvas.removeEventListener("touchend",this.touchHandler);this.canvas.removeEventListener("touchcancel",this.touchHandler);this._ondrop_callback=this._key_callback=
this._mousewheel_callback=this._mousedown_callback=null;this._events_binded=!1}else console.warn("LGraphCanvas: no events binded")};e.getFileExtension=function(a){var b=a.indexOf("?");-1!=b&&(a=a.substr(0,b));b=a.lastIndexOf(".");return-1==b?"":a.substr(b+1).toLowerCase()};e.prototype.enableWebGL=function(){if(void 0===typeof GL)throw"litegl.js must be included to use a WebGL canvas";if(void 0===typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas);
this.ctx.webgl=!0;this.bgcanvas=this.canvas;this.bgctx=this.gl};e.prototype.setDirty=function(a,b){a&&(this.dirty_canvas=!0);b&&(this.dirty_bgcanvas=!0)};e.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var a=this.canvas.ownerDocument;return a.defaultView||a.parentWindow};e.prototype.startRendering=function(){function a(){this.pause_rendering||this.draw();var b=this.getCanvasWindow();this.is_rendering&&b.requestAnimationFrame(a.bind(this))}this.is_rendering||(this.is_rendering=
!0,a.call(this))};e.prototype.stopRendering=function(){this.is_rendering=!1};e.prototype.processMouseDown=function(a){if(this.graph){this.adjustMouseEvent(a);var b=this.getCanvasWindow();e.active_canvas=this;this.canvas.removeEventListener("mousemove",this._mousemove_callback);b.document.addEventListener("mousemove",this._mousemove_callback,!0);b.document.addEventListener("mouseup",this._mouseup_callback,!0);var c=this.graph.getNodeOnPos(a.canvasX,a.canvasY,this.visible_nodes),d=!1;l.closeAllContextMenus(b);
if(1==a.which){a.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=a.canvasX,this.dragging_rectangle[1]=a.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,d=!0);var k=!1;if(c&&this.allow_interaction&&!d){this.live_mode||c.flags.pinned||this.bringToFront(c);if(!this.connecting_node&&!c.flags.collapsed&&!this.live_mode){if(c.outputs)for(var f=0,h=c.outputs.length;f<h;++f){var n=c.outputs[f],g=c.getConnectionPos(!1,f);if(q(a.canvasX,a.canvasY,g[0]-10,g[1]-
5,20,10)){this.connecting_node=c;this.connecting_output=n;this.connecting_pos=c.getConnectionPos(!1,f);this.connecting_slot=f;d=!0;break}}if(c.inputs)for(f=0,h=c.inputs.length;f<h;++f)n=c.inputs[f],g=c.getConnectionPos(!0,f),q(a.canvasX,a.canvasY,g[0]-10,g[1]-5,20,10)&&null!==n.link&&(c.disconnectInput(f),d=this.dirty_bgcanvas=!0);!d&&q(a.canvasX,a.canvasY,c.pos[0]+c.size[0]-5,c.pos[1]+c.size[1]-5,5,5)&&(this.resizing_node=c,this.canvas.style.cursor="se-resize",d=!0)}!d&&q(a.canvasX,a.canvasY,c.pos[0],
c.pos[1]-l.NODE_TITLE_HEIGHT,l.NODE_TITLE_HEIGHT,l.NODE_TITLE_HEIGHT)&&(c.collapse(),d=!0);if(!d){f=!1;if(300>l.getTime()-this.last_mouseclick&&this.selected_nodes[c.id]){if(c.onDblClick)c.onDblClick(a);this.processNodeDblClicked(c);f=!0}c.onMouseDown&&c.onMouseDown(a,[a.canvasX-c.pos[0],a.canvasY-c.pos[1]])?f=!0:this.live_mode&&(f=k=!0);f||(this.allow_dragnodes&&(this.node_dragged=c),this.selected_nodes[c.id]||this.processNodeSelected(c,a));this.dirty_canvas=!0}}else k=!0;!d&&k&&this.allow_dragcanvas&&
(this.dragging_canvas=!0)}else 2!=a.which&&3==a.which&&this.processContextMenu(c,a);this.last_mouse[0]=a.localX;this.last_mouse[1]=a.localY;this.last_mouseclick=l.getTime();this.canvas_mouse=[a.canvasX,a.canvasY];this.graph.change();(!b.document.activeElement||"input"!=b.document.activeElement.nodeName.toLowerCase()&&"textarea"!=b.document.activeElement.nodeName.toLowerCase())&&a.preventDefault();a.stopPropagation();if(this.onMouseDown)this.onMouseDown(a);return!1}};e.prototype.processMouseMove=function(a){this.autoresize&&
this.resize();if(this.graph){e.active_canvas=this;this.adjustMouseEvent(a);var b=[a.localX,a.localY],c=[b[0]-this.last_mouse[0],b[1]-this.last_mouse[1]];this.last_mouse=b;this.canvas_mouse=[a.canvasX,a.canvasY];if(this.dragging_rectangle)this.dragging_rectangle[2]=a.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=a.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.dragging_canvas)this.offset[0]+=c[0]/this.scale,this.offset[1]+=c[1]/this.scale,this.dirty_bgcanvas=this.dirty_canvas=
!0;else if(this.allow_interaction){this.connecting_node&&(this.dirty_canvas=!0);for(var b=this.graph.getNodeOnPos(a.canvasX,a.canvasY,this.visible_nodes),d=0,k=this.graph._nodes.length;d<k;++d)if(this.graph._nodes[d].mouseOver&&b!=this.graph._nodes[d]){this.graph._nodes[d].mouseOver=!1;if(this.node_over&&this.node_over.onMouseLeave)this.node_over.onMouseLeave(a);this.node_over=null;this.dirty_canvas=!0}if(b){if(!b.mouseOver&&(b.mouseOver=!0,this.node_over=b,this.dirty_canvas=!0,b.onMouseEnter))b.onMouseEnter(a);
if(b.onMouseMove)b.onMouseMove(a);if(this.connecting_node&&(k=this._highlight_input||[0,0],!this.isOverNodeBox(b,a.canvasX,a.canvasY))){var f=this.isOverNodeInput(b,a.canvasX,a.canvasY,k);-1!=f&&b.inputs[f]?l.isValidConnection(this.connecting_output.type,b.inputs[f].type)&&(this._highlight_input=k):this._highlight_input=null}q(a.canvasX,a.canvasY,b.pos[0]+b.size[0]-5,b.pos[1]+b.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor=null}else this.canvas.style.cursor=null;if(this.node_capturing_input&&
this.node_capturing_input!=b&&this.node_capturing_input.onMouseMove)this.node_capturing_input.onMouseMove(a);if(this.node_dragged&&!this.live_mode){for(d in this.selected_nodes)b=this.selected_nodes[d],b.pos[0]+=c[0]/this.scale,b.pos[1]+=c[1]/this.scale;this.dirty_bgcanvas=this.dirty_canvas=!0}this.resizing_node&&!this.live_mode&&(this.resizing_node.size[0]+=c[0]/this.scale,this.resizing_node.size[1]+=c[1]/this.scale,c=Math.max(this.resizing_node.inputs?this.resizing_node.inputs.length:0,this.resizing_node.outputs?
this.resizing_node.outputs.length:0),this.resizing_node.size[1]<c*l.NODE_SLOT_HEIGHT+4&&(this.resizing_node.size[1]=c*l.NODE_SLOT_HEIGHT+4),this.resizing_node.size[0]<l.NODE_MIN_WIDTH&&(this.resizing_node.size[0]=l.NODE_MIN_WIDTH),this.canvas.style.cursor="se-resize",this.dirty_bgcanvas=this.dirty_canvas=!0)}a.preventDefault();return!1}};e.prototype.processMouseUp=function(a){if(this.graph){var b=this.getCanvasWindow().document;e.active_canvas=this;b.removeEventListener("mousemove",this._mousemove_callback,
!0);this.canvas.addEventListener("mousemove",this._mousemove_callback,!0);b.removeEventListener("mouseup",this._mouseup_callback,!0);this.adjustMouseEvent(a);if(1==a.which)if(this.dragging_rectangle){if(this.graph){var c=this.graph._nodes,d=new Float32Array(4);this.deselectAllNodes();0>this.dragging_rectangle[2]&&(this.dragging_rectangle[0]+=this.dragging_rectangle[2]);0>this.dragging_rectangle[3]&&(this.dragging_rectangle[1]+=this.dragging_rectangle[3]);this.dragging_rectangle[2]=Math.abs(this.dragging_rectangle[2]*
this.scale);this.dragging_rectangle[3]=Math.abs(this.dragging_rectangle[3]*this.scale);for(var k=0;k<c.length;++k)b=c[k],b.getBounding(d),s(this.dragging_rectangle,d)&&this.selectNode(b,!0)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_bgcanvas=this.dirty_canvas=!0;if(b=this.graph.getNodeOnPos(a.canvasX,a.canvasY,this.visible_nodes))this.connecting_output.type==l.EVENT&&this.isOverNodeBox(b,a.canvasX,a.canvasY)?this.connecting_node.connect(this.connecting_slot,b,l.EVENT):(c=
this.isOverNodeInput(b,a.canvasX,a.canvasY),-1!=c?this.connecting_node.connect(this.connecting_slot,b,c):(c=b.getInputInfo(0),this.connecting_output.type==l.EVENT?this.connecting_node.connect(this.connecting_slot,b,l.EVENT):c&&!c.link&&l.isValidConnection(c.type&&this.connecting_output.type)&&this.connecting_node.connect(this.connecting_slot,b,0)));this.connecting_node=this.connecting_pos=this.connecting_output=null;this.connecting_slot=-1}else if(this.resizing_node)this.dirty_bgcanvas=this.dirty_canvas=
!0,this.resizing_node=null;else if(this.node_dragged)this.dirty_bgcanvas=this.dirty_canvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),this.graph.config.align_to_grid&&this.node_dragged.alignToGrid(),this.node_dragged=null;else{b=this.graph.getNodeOnPos(a.canvasX,a.canvasY,this.visible_nodes);c=l.getTime();!b&&300>c-this.last_mouseclick&&this.deselectAllNodes();this.dirty_canvas=!0;this.dragging_canvas=!1;if(this.node_over&&
this.node_over.onMouseUp)this.node_over.onMouseUp(a,[a.canvasX-this.node_over.pos[0],a.canvasY-this.node_over.pos[1]]);if(this.node_capturing_input&&this.node_capturing_input.onMouseUp)this.node_capturing_input.onMouseUp(a,[a.canvasX-this.node_capturing_input.pos[0],a.canvasY-this.node_capturing_input.pos[1]])}else 2==a.which?(this.dirty_canvas=!0,this.dragging_canvas=!1):3==a.which&&(this.dirty_canvas=!0,this.dragging_canvas=!1);this.graph.change();a.stopPropagation();a.preventDefault();return!1}};
e.prototype.processMouseWheel=function(a){if(this.graph&&this.allow_dragcanvas){var b=null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail;this.adjustMouseEvent(a);var c=this.scale;0<b?c*=1.1:0>b&&(c*=1/1.1);this.setZoom(c,[a.localX,a.localY]);this.graph.change();a.preventDefault();return!1}};e.prototype.isOverNodeBox=function(a,b,c){var d=l.NODE_TITLE_HEIGHT;return q(b,c,a.pos[0]+2,a.pos[1]+2-d,d-4,d-4)?!0:!1};e.prototype.isOverNodeInput=function(a,b,c,d){if(a.inputs)for(var k=0,e=a.inputs.length;k<e;++k){var h=
a.getConnectionPos(!0,k);if(q(b,c,h[0]-10,h[1]-5,20,10))return d&&(d[0]=h[0],d[1]=h[1]),k}return-1};e.prototype.processKey=function(a){if(this.graph){var b=!1;if("input"!=a.target.localName){if("keydown"==a.type){32==a.keyCode&&(b=this.dragging_canvas=!0);65==a.keyCode&&a.ctrlKey&&(this.selectNodes(),b=!0);"KeyC"==a.code&&(a.metaKey||a.ctrlKey)&&!a.shiftKey&&this.selected_nodes&&(this.copyToClipboard(),b=!0);"KeyV"!=a.code||!a.metaKey&&!a.ctrlKey||a.shiftKey||this.pasteFromClipboard();if(46==a.keyCode||
8==a.keyCode)this.deleteSelectedNodes(),b=!0;if(this.selected_nodes)for(var c in this.selected_nodes)if(this.selected_nodes[c].onKeyDown)this.selected_nodes[c].onKeyDown(a)}else if("keyup"==a.type&&(32==a.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(c in this.selected_nodes)if(this.selected_nodes[c].onKeyUp)this.selected_nodes[c].onKeyUp(a);this.graph.change();if(b)return a.preventDefault(),!1}}};e.prototype.copyToClipboard=function(){var a={nodes:[],links:[]},b=0,c=[],d;for(d in this.selected_nodes){var k=
this.selected_nodes[d];k._relative_id=b;c.push(k);b+=1}for(d=0;d<c.length;++d)if(k=c[d],a.nodes.push(k.clone().serialize()),k.inputs&&k.inputs.length)for(b=0;b<k.inputs.length;++b){var e=k.inputs[b];if(e&&null!=e.link&&(e=this.graph.links[e.link])){var h=this.graph.getNodeById(e.origin_id);h&&this.selected_nodes[h.id]&&a.links.push([h._relative_id,b,k._relative_id,e.target_slot])}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(a))};e.prototype.pasteFromClipboard=function(){var a=
localStorage.getItem("litegrapheditor_clipboard");if(a){for(var a=JSON.parse(a),b=[],c=0;c<a.nodes.length;++c){var d=a.nodes[c],k=l.createNode(d.type);k&&(k.configure(d),k.pos[0]+=5,k.pos[1]+=5,this.graph.add(k),b.push(k))}for(c=0;c<a.links.length;++c)d=a.links[c],b[d[0]].connect(d[1],b[d[2]],d[3]);this.selectNodes(b)}};e.prototype.processDrop=function(a){a.preventDefault();this.adjustMouseEvent(a);var b=[a.canvasX,a.canvasY],c=this.graph.getNodeOnPos(b[0],b[1]);if(c){if((c.onDropFile||c.onDropData)&&
(b=a.dataTransfer.files)&&b.length)for(var d=0;d<b.length;d++){var k=a.dataTransfer.files[0],f=k.name;e.getFileExtension(f);if(c.onDropFile)c.onDropFile(k);if(c.onDropData){var h=new FileReader;h.onload=function(a){c.onDropData(a.target.result,f,k)};var n=k.type.split("/")[0];"text"==n||""==n?h.readAsText(k):"image"==n?h.readAsDataURL(k):h.readAsArrayBuffer(k)}}return c.onDropItem&&c.onDropItem(event)?!0:this.onDropItem?this.onDropItem(event):!1}b=null;this.onDropItem&&(b=this.onDropItem(event));
b||this.checkDropItem(a)};e.prototype.checkDropItem=function(a){if(a.dataTransfer.files.length){var b=a.dataTransfer.files[0],c=e.getFileExtension(b.name).toLowerCase();if(c=l.node_types_by_file_extension[c])if(c=l.createNode(c.type),c.pos=[a.canvasX,a.canvasY],this.graph.add(c),c.onDropFile)c.onDropFile(b)}};e.prototype.processNodeDblClicked=function(a){if(this.onShowNodePanel)this.onShowNodePanel(a);if(this.onNodeDblClicked)this.onNodeDblClicked(a);this.setDirty(!0)};e.prototype.processNodeSelected=
function(a,b){this.selectNode(a,b&&b.shiftKey);if(this.onNodeSelected)this.onNodeSelected(a)};e.prototype.processNodeDeselected=function(a){this.deselectNode(a);if(this.onNodeDeselected)this.onNodeDeselected(a)};e.prototype.selectNode=function(a,b){null==a?this.deselectAllNodes():this.selectNodes([a],b)};e.prototype.selectNodes=function(a,b){b||this.deselectAllNodes();a=a||this.graph._nodes;for(var c=0;c<a.length;++c){var d=a[c];if(!d.selected){if(!d.selected&&d.onSelected)d.onSelected();d.selected=
!0;this.selected_nodes[d.id]=d;if(d.inputs)for(c=0;c<d.inputs.length;++c)this.highlighted_links[d.inputs[c].link]=!0;if(d.outputs)for(c=0;c<d.outputs.length;++c){var k=d.outputs[c];if(k.links)for(var e=0;e<k.links.length;++e)this.highlighted_links[k.links[e]]=!0}}}this.setDirty(!0)};e.prototype.deselectNode=function(a){if(a.selected){if(a.onDeselected)a.onDeselected();a.selected=!1;if(a.inputs)for(var b=0;b<a.inputs.length;++b)delete this.highlighted_links[a.inputs[b].link];if(a.outputs)for(b=0;b<
a.outputs.length;++b){var c=a.outputs[b];if(c.links)for(var d=0;d<c.links.length;++d)delete this.highlighted_links[c.links[d]]}}};e.prototype.deselectAllNodes=function(){if(this.graph){for(var a=this.graph._nodes,b=0,c=a.length;b<c;++b){var d=a[b];if(d.selected){if(d.onDeselected)d.onDeselected();d.selected=!1}}this.selected_nodes={};this.highlighted_links={};this.setDirty(!0)}};e.prototype.deleteSelectedNodes=function(){for(var a in this.selected_nodes)this.graph.remove(this.selected_nodes[a]);this.selected_nodes=
{};this.highlighted_links={};this.setDirty(!0)};e.prototype.centerOnNode=function(a){this.offset[0]=-a.pos[0]-0.5*a.size[0]+0.5*this.canvas.width/this.scale;this.offset[1]=-a.pos[1]-0.5*a.size[1]+0.5*this.canvas.height/this.scale;this.setDirty(!0,!0)};e.prototype.adjustMouseEvent=function(a){var b=this.canvas.getBoundingClientRect();a.localX=a.pageX-b.left;a.localY=a.pageY-b.top;a.canvasX=a.localX/this.scale-this.offset[0];a.canvasY=a.localY/this.scale-this.offset[1]};e.prototype.setZoom=function(a,
b){b||(b=[0.5*this.canvas.width,0.5*this.canvas.height]);var c=this.convertOffsetToCanvas(b);this.scale=a;this.scale>this.max_zoom?this.scale=this.max_zoom:this.scale<this.min_zoom&&(this.scale=this.min_zoom);var d=this.convertOffsetToCanvas(b),c=[d[0]-c[0],d[1]-c[1]];this.offset[0]+=c[0];this.offset[1]+=c[1];this.dirty_bgcanvas=this.dirty_canvas=!0};e.prototype.convertOffsetToCanvas=function(a,b){b=b||[];b[0]=a[0]/this.scale-this.offset[0];b[1]=a[1]/this.scale-this.offset[1];return b};e.prototype.convertCanvasToOffset=
function(a,b){b=b||[];b[0]=(a[0]+this.offset[0])*this.scale;b[1]=(a[1]+this.offset[1])*this.scale;return b};e.prototype.convertEventToCanvas=function(a){var b=this.canvas.getBoundingClientRect();return this.convertOffsetToCanvas([a.pageX-b.left,a.pageY-b.top])};e.prototype.bringToFront=function(a){var b=this.graph._nodes.indexOf(a);-1!=b&&(this.graph._nodes.splice(b,1),this.graph._nodes.push(a))};e.prototype.sendToBack=function(a){var b=this.graph._nodes.indexOf(a);-1!=b&&(this.graph._nodes.splice(b,
1),this.graph._nodes.unshift(a))};var n=new Float32Array(4);e.prototype.computeVisibleNodes=function(a,b){var c=b||[];c.length=0;a=a||this.graph._nodes;for(var d=0,k=a.length;d<k;++d){var e=a[d];(!this.live_mode||e.onDrawBackground||e.onDrawForeground)&&s(this.visible_area,e.getBounding(n))&&c.push(e)}return c};e.prototype.draw=function(a,b){if(this.canvas){var c=l.getTime();this.render_time=0.001*(c-this.last_draw_time);this.last_draw_time=c;if(this.graph){var d=[-this.offset[0],-this.offset[1]],
k=[d[0]+this.canvas.width/this.scale,d[1]+this.canvas.height/this.scale];this.visible_area=new Float32Array([d[0],d[1],k[0]-d[0],k[1]-d[1]])}(this.dirty_bgcanvas||b||this.always_render_background||this.graph&&this.graph._last_trigger_time&&1E3>c-this.graph._last_trigger_time)&&this.drawBackCanvas();(this.dirty_canvas||a)&&this.drawFrontCanvas();this.fps=this.render_time?1/this.render_time:0;this.frame+=1}};e.prototype.drawFrontCanvas=function(){this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));
var a=this.ctx;if(a){a.start2D&&a.start2D();var b=this.canvas;a.restore();a.setTransform(1,0,0,1,0,0);this.dirty_area&&(a.save(),a.beginPath(),a.rect(this.dirty_area[0],this.dirty_area[1],this.dirty_area[2],this.dirty_area[3]),a.clip());this.clear_background&&a.clearRect(0,0,b.width,b.height);this.bgcanvas==this.canvas?this.drawBackCanvas():a.drawImage(this.bgcanvas,0,0);if(this.onRender)this.onRender(b,a);this.show_info&&this.renderInfo(a);if(this.graph){a.save();a.scale(this.scale,this.scale);a.translate(this.offset[0],
this.offset[1]);for(var b=this.computeVisibleNodes(null,this.visible_nodes),c=0;c<b.length;++c){var d=b[c];a.save();a.translate(d.pos[0],d.pos[1]);this.drawNode(d,a);a.restore()}this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(a));if(null!=this.connecting_pos){a.lineWidth=this.connections_width;b=null;switch(this.connecting_output.type){case l.EVENT:b="#F85";break;default:b="#AFA"}this.renderLink(a,this.connecting_pos,[this.canvas_mouse[0],this.canvas_mouse[1]],null,!1,null,b);
a.beginPath();this.connecting_output.type===l.EVENT?a.rect(this.connecting_pos[0]-6+0.5,this.connecting_pos[1]-5+0.5,14,10):a.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI);a.fill();a.fillStyle="#ffcc00";this._highlight_input&&(a.beginPath(),a.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),a.fill())}this.dragging_rectangle&&(a.strokeStyle="#FFF",a.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3]));
a.restore()}this.dirty_area&&a.restore();a.finish2D&&a.finish2D();this.dirty_canvas=!1}};e.prototype.renderInfo=function(a,b,c){b=b||0;c=c||0;a.save();a.translate(b,c);a.font="10px Arial";a.fillStyle="#888";this.graph?(a.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),a.fillText("I: "+this.graph.iteration,5,26),a.fillText("F: "+this.frame,5,39),a.fillText("FPS:"+this.fps.toFixed(2),5,52)):a.fillText("No graph selected",5,13);a.restore()};e.prototype.drawBackCanvas=function(){var a=this.bgcanvas;
if(a.width!=this.canvas.width||a.height!=this.canvas.height)a.width=this.canvas.width,a.height=this.canvas.height;this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var b=this.bgctx;b.start&&b.start();this.clear_background&&b.clearRect(0,0,a.width,a.height);this._graph_stack&&this._graph_stack.length&&(b.strokeStyle=this._graph_stack[this._graph_stack.length-1].bgcolor,b.lineWidth=10,b.strokeRect(1,1,a.width-2,a.height-2),b.lineWidth=1);b.restore();b.setTransform(1,0,0,1,0,0);if(this.graph){b.save();
b.scale(this.scale,this.scale);b.translate(this.offset[0],this.offset[1]);if(this.background_image&&0.5<this.scale){b.globalAlpha=(1-0.5/this.scale)*this.editor_alpha;b.imageSmoothingEnabled=b.mozImageSmoothingEnabled=b.imageSmoothingEnabled=!1;if(!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image;this._bg_img.name=this.background_image;this._bg_img.src=this.background_image;var c=this;this._bg_img.onload=function(){c.draw(!0,!0)}}var d=null;null==this._pattern&&0<this._bg_img.width?
(d=b.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=d):d=this._pattern;d&&(b.fillStyle=d,b.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),b.fillStyle="transparent");b.globalAlpha=1;b.imageSmoothingEnabled=b.mozImageSmoothingEnabled=b.imageSmoothingEnabled=!0}if(this.onBackgroundRender)this.onBackgroundRender(a,b);this.render_canvas_area&&(b.strokeStyle="#235",b.strokeRect(0,0,a.width,a.height));this.render_connections_shadows?
(b.shadowColor="#000",b.shadowOffsetX=0,b.shadowOffsetY=0,b.shadowBlur=6):b.shadowColor="rgba(0,0,0,0)";this.live_mode||this.drawConnections(b);b.shadowColor="rgba(0,0,0,0)";b.restore()}b.finish&&b.finish();this.dirty_bgcanvas=!1;this.dirty_canvas=!0};var d=new Float32Array(2);e.prototype.drawNode=function(a,b){var c=a.color||l.NODE_DEFAULT_COLOR,e=!0;if(a.flags.skip_title_render||a.graph.isLive())e=!1;a.mouseOver&&(e=!0);a.selected||(this.render_shadows?(b.shadowColor="rgba(0,0,0,0.5)",b.shadowOffsetX=
2,b.shadowOffsetY=2,b.shadowBlur=3):b.shadowColor="transparent");if(this.live_mode){if(!a.flags.collapsed&&(b.shadowColor="transparent",a.onDrawForeground))a.onDrawForeground(b)}else{var k=this.editor_alpha;b.globalAlpha=k;var f=a._shape||l.BOX_SHAPE;d.set(a.size);a.flags.collapsed&&(d[0]=l.NODE_COLLAPSED_WIDTH,d[1]=0);a.flags.clip_area&&(b.save(),f==l.BOX_SHAPE?(b.beginPath(),b.rect(0,0,d[0],d[1])):f==l.ROUND_SHAPE?b.roundRect(0,0,d[0],d[1],10):f==l.CIRCLE_SHAPE&&(b.beginPath(),b.arc(0.5*d[0],0.5*
d[1],0.5*d[0],0,2*Math.PI)),b.clip());this.drawNodeShape(a,b,d,c,a.bgcolor,!e,a.selected);b.shadowColor="transparent";b.textAlign="left";b.font=this.inner_text_font;e=0.6<this.scale;f=this.connecting_output;if(!a.flags.collapsed){if(a.inputs)for(var h=0;h<a.inputs.length;h++){var n=a.inputs[h];b.globalAlpha=k;this.connecting_node&&l.isValidConnection(n.type&&f.type)&&(b.globalAlpha=0.4*k);b.fillStyle=null!=n.link?this.default_connection_color.input_on:this.default_connection_color.input_off;var g=
a.getConnectionPos(!0,h);g[0]-=a.pos[0];g[1]-=a.pos[1];b.beginPath();n.type===l.EVENT?b.rect(g[0]-6+0.5,g[1]-5+0.5,14,10):b.arc(g[0],g[1],4,0,2*Math.PI);b.fill();e&&(n=null!=n.label?n.label:n.name)&&(b.fillStyle=c,b.fillText(n,g[0]+10,g[1]+5))}this.connecting_node&&(b.globalAlpha=0.4*k);b.lineWidth=1;b.textAlign="right";b.strokeStyle="black";if(a.outputs)for(h=0;h<a.outputs.length;h++)if(n=a.outputs[h],g=a.getConnectionPos(!1,h),g[0]-=a.pos[0],g[1]-=a.pos[1],b.fillStyle=n.links&&n.links.length?this.default_connection_color.output_on:
this.default_connection_color.output_off,b.beginPath(),n.type===l.EVENT?b.rect(g[0]-6+0.5,g[1]-5+0.5,14,10):b.arc(g[0],g[1],4,0,2*Math.PI),b.fill(),b.stroke(),e&&(n=null!=n.label?n.label:n.name))b.fillStyle=c,b.fillText(n,g[0]-10,g[1]+5);b.textAlign="left";b.globalAlpha=1;if(a.onDrawForeground)a.onDrawForeground(b)}a.flags.clip_area&&b.restore();b.globalAlpha=1}};e.prototype.drawNodeShape=function(a,b,c,d,k,e,h){b.strokeStyle=d||l.NODE_DEFAULT_COLOR;b.fillStyle=k||l.NODE_DEFAULT_BGCOLOR;k=l.NODE_TITLE_HEIGHT;
var f=a._shape||l.BOX_SHAPE;f==l.BOX_SHAPE?(b.beginPath(),b.rect(0,e?0:-k,c[0]+1,e?c[1]:c[1]+k),b.fill(),b.shadowColor="transparent",h&&(b.strokeStyle="#CCC",b.strokeRect(-0.5,e?-0.5:-k+-0.5,c[0]+2,e?c[1]+2:c[1]+k+2-1),b.strokeStyle=d)):f==l.ROUND_SHAPE?(b.roundRect(0,e?0:-k,c[0],e?c[1]:c[1]+k,10),b.fill()):f==l.CIRCLE_SHAPE&&(b.beginPath(),b.arc(0.5*c[0],0.5*c[1],0.5*c[0],0,2*Math.PI),b.fill());b.shadowColor="transparent";a.bgImage&&a.bgImage.width&&b.drawImage(a.bgImage,0.5*(c[0]-a.bgImage.width),
0.5*(c[1]-a.bgImage.height));a.bgImageUrl&&!a.bgImage&&(a.bgImage=a.loadImage(a.bgImageUrl));if(a.onDrawBackground)a.onDrawBackground(b);e||(b.fillStyle=d||l.NODE_DEFAULT_COLOR,d=b.globalAlpha,b.globalAlpha=0.5*d,f==l.BOX_SHAPE?(b.beginPath(),b.rect(0,-k,c[0]+1,k),b.fill()):f==l.ROUND_SHAPE&&(b.roundRect(0,-k,c[0],k,10,0),b.fill()),b.fillStyle=a.boxcolor||l.NODE_DEFAULT_BOXCOLOR,b.beginPath(),f==l.ROUND_SHAPE||f==l.CIRCLE_SHAPE?b.arc(0.5*k,-0.5*k,0.5*(k-6),0,2*Math.PI):b.rect(3,-k+3,k-6,k-6),b.fill(),
b.globalAlpha=d,b.font=this.title_text_font,(a=a.getTitle())&&0.5<this.scale&&(b.fillStyle=l.NODE_TITLE_COLOR,b.fillText(a,16,13-k)))};e.prototype.drawNodeCollapsed=function(a,b,c,d){b.strokeStyle=c||l.NODE_DEFAULT_COLOR;b.fillStyle=d||l.NODE_DEFAULT_BGCOLOR;c=l.NODE_COLLAPSED_RADIUS;d=a._shape||l.BOX_SHAPE;d==l.CIRCLE_SHAPE?(b.beginPath(),b.arc(0.5*a.size[0],0.5*a.size[1],c,0,2*Math.PI),b.fill(),b.shadowColor="rgba(0,0,0,0)",b.stroke(),b.fillStyle=a.boxcolor||l.NODE_DEFAULT_BOXCOLOR,b.beginPath(),
b.arc(0.5*a.size[0],0.5*a.size[1],0.5*c,0,2*Math.PI)):d==l.ROUND_SHAPE?(b.beginPath(),b.roundRect(0.5*a.size[0]-c,0.5*a.size[1]-c,2*c,2*c,5),b.fill(),b.shadowColor="rgba(0,0,0,0)",b.stroke(),b.fillStyle=a.boxcolor||l.NODE_DEFAULT_BOXCOLOR,b.beginPath(),b.roundRect(0.5*a.size[0]-0.5*c,0.5*a.size[1]-0.5*c,c,c,2)):(b.beginPath(),b.rect(0,0,a.size[0],2*c),b.fill(),b.shadowColor="rgba(0,0,0,0)",b.stroke(),b.fillStyle=a.boxcolor||l.NODE_DEFAULT_BOXCOLOR,b.beginPath(),b.rect(0.5*c,0.5*c,c,c));b.fill()};
e.prototype.drawConnections=function(a){var b=l.getTime();a.lineWidth=this.connections_width;a.fillStyle="#AAA";a.strokeStyle="#AAA";a.globalAlpha=this.editor_alpha;for(var c=0,d=this.graph._nodes.length;c<d;++c){var e=this.graph._nodes[c];if(e.inputs&&e.inputs.length)for(var f=0;f<e.inputs.length;++f){var h=e.inputs[f];if(h&&null!=h.link&&(h=this.graph.links[h.link])){var n=this.graph.getNodeById(h.origin_id);if(null!=n){var g=h.origin_slot,p=null,p=-1==g?[n.pos[0]+10,n.pos[1]+10]:n.getConnectionPos(!1,
g);this.renderLink(a,p,e.getConnectionPos(!0,f),h);h&&h._last_time&&1E3>b-h._last_time&&(n=2-0.002*(b-h._last_time),g="rgba(255,255,255, "+n.toFixed(2)+")",this.renderLink(a,p,e.getConnectionPos(!0,f),h,!0,n,g))}}}}a.globalAlpha=1};e.prototype.renderLink=function(a,b,c,d,k,f,h){if(this.highquality_render){var n=p(b,c);this.render_connections_border&&0.6<this.scale&&(a.lineWidth=this.connections_width+4);!h&&d&&(h=e.link_type_colors[d.type]);h||(h=this.default_link_color);null!=d&&this.highlighted_links[d.id]&&
(h="#FFF");a.beginPath();this.render_curved_connections?(a.moveTo(b[0],b[1]),a.bezierCurveTo(b[0]+0.25*n,b[1],c[0]-0.25*n,c[1],c[0],c[1])):(a.moveTo(b[0]+10,b[1]),a.lineTo(0.5*(b[0]+10+(c[0]-10)),b[1]),a.lineTo(0.5*(b[0]+10+(c[0]-10)),c[1]),a.lineTo(c[0]-10,c[1]));this.render_connections_border&&0.6<this.scale&&!k&&(a.strokeStyle="rgba(0,0,0,0.5)",a.stroke());a.lineWidth=this.connections_width;a.fillStyle=a.strokeStyle=h;a.stroke();this.render_connection_arrows&&0.6<=this.scale&&this.render_connection_arrows&&
0.6<this.scale&&(d=this.computeConnectionPoint(b,c,0.5),k=this.computeConnectionPoint(b,c,0.51),h=0,h=this.render_curved_connections?-Math.atan2(k[0]-d[0],k[1]-d[1]):c[1]>b[1]?0:Math.PI,a.save(),a.translate(d[0],d[1]),a.rotate(h),a.beginPath(),a.moveTo(-5,-5),a.lineTo(0,5),a.lineTo(5,-5),a.fill(),a.restore());if(f)for(f=0;5>f;++f)d=(0.001*l.getTime()+0.2*f)%1,d=this.computeConnectionPoint(b,c,d),a.beginPath(),a.arc(d[0],d[1],5,0,2*Math.PI),a.fill()}else a.beginPath(),a.moveTo(b[0],b[1]),a.lineTo(c[0],
c[1]),a.stroke()};e.prototype.computeConnectionPoint=function(a,b,c){var d=p(a,b),e=[a[0]+0.25*d,a[1]],d=[b[0]-0.25*d,b[1]],f=(1-c)*(1-c)*(1-c),h=3*(1-c)*(1-c)*c,n=3*(1-c)*c*c;c*=c*c;return[f*a[0]+h*e[0]+n*d[0]+c*b[0],f*a[1]+h*e[1]+n*d[1]+c*b[1]]};e.prototype.resize=function(a,b){if(!a&&!b){var c=this.canvas.parentNode;a=c.offsetWidth;b=c.offsetHeight}if(this.canvas.width!=a||this.canvas.height!=b)this.canvas.width=a,this.canvas.height=b,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=
this.canvas.height,this.setDirty(!0,!0)};e.prototype.switchLiveMode=function(a){if(a){var b=this,c=this.live_mode?1.1:0.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=0.1);var d=setInterval(function(){b.editor_alpha*=c;b.dirty_canvas=!0;b.dirty_bgcanvas=!0;1>c&&0.01>b.editor_alpha&&(clearInterval(d),1>c&&(b.live_mode=!0));1<c&&0.99<b.editor_alpha&&(clearInterval(d),b.editor_alpha=1)},1)}else this.live_mode=!this.live_mode,this.dirty_bgcanvas=this.dirty_canvas=!0};e.prototype.onNodeSelectionChange=
function(a){};e.prototype.touchHandler=function(a){var b=a.changedTouches[0],c="";switch(a.type){case "touchstart":c="mousedown";break;case "touchmove":c="mousemove";break;case "touchend":c="mouseup";break;default:return}var d=this.getCanvasWindow(),e=d.document.createEvent("MouseEvent");e.initMouseEvent(c,!0,!0,d,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null);b.target.dispatchEvent(e);a.preventDefault()};e.onMenuAdd=function(a,b,c,d){function k(a,b){var c=d.getFirstEvent(),h=l.createNode(a.value);
h&&(h.pos=f.convertEventToCanvas(c),f.graph.add(h))}var f=e.active_canvas,h=f.getCanvasWindow();a=l.getNodeTypesCategories();b=[];for(var n in a)a[n]&&b.push({value:a[n],content:a[n],has_submenu:!0});var g=new l.ContextMenu(b,{event:c,callback:function(a,b,c){a=l.getNodeTypesInCategory(a.value);b=[];for(var d in a)b.push({content:a[d].title,value:a[d].type});new l.ContextMenu(b,{event:c,callback:k,parentMenu:g},h);return!1},parentMenu:d},h);return!1};e.onMenuCollapseAll=function(){};e.onMenuNodeEdit=
function(){};e.showMenuNodeOptionalInputs=function(a,b,c,d,k){function f(a,b,c){k&&(a.callback&&a.callback.call(h,k,a,b,c),a.value&&(k.addInput(a.value[0],a.value[1],a.value[2]),k.setDirtyCanvas(!0,!0)))}if(k){var h=this;a=e.active_canvas.getCanvasWindow();b=k.optional_inputs;k.onGetInputs&&(b=k.onGetInputs());var n=[];if(b)for(var g in b){var p=b[g];if(p){var q=p[0];p[2]&&p[2].label&&(q=p[2].label);q={content:q,value:p};p[1]==l.ACTION&&(q.className="event");n.push(q)}else n.push(null)}this.onMenuNodeInputs&&
(n=this.onMenuNodeInputs(n));if(n.length)return new l.ContextMenu(n,{event:c,callback:f,parentMenu:d,node:k},a),!1}};e.showMenuNodeOptionalOutputs=function(a,b,c,d,k){function f(a,b,c){if(k&&(a.callback&&a.callback.call(h,k,a,b,c),a.value))if(c=a.value[1],!c||c.constructor!==Object&&c.constructor!==Array)k.addOutput(a.value[0],a.value[1],a.value[2]),k.setDirtyCanvas(!0,!0);else{a=[];for(var e in c)a.push({content:e,value:c[e]});new l.ContextMenu(a,{event:b,callback:f,parentMenu:d,node:k});return!1}}
if(k){var h=this;a=e.active_canvas.getCanvasWindow();b=k.optional_outputs;k.onGetOutputs&&(b=k.onGetOutputs());var n=[];if(b)for(var g in b){var p=b[g];if(!p)n.push(null);else if(!k.flags||!k.flags.skip_repeated_outputs||-1==k.findOutputSlot(p[0])){var q=p[0];p[2]&&p[2].label&&(q=p[2].label);q={content:q,value:p};p[1]==l.EVENT&&(q.className="event");n.push(q)}}this.onMenuNodeOutputs&&(n=this.onMenuNodeOutputs(n));if(n.length)return new l.ContextMenu(n,{event:c,callback:f,parentMenu:d,node:k},a),!1}};
e.onShowMenuNodeProperties=function(a,b,c,d,k){function f(a,b,c,d){k&&(b=this.getBoundingClientRect(),h.showEditPropertyValue(k,a.value,{position:[b.left,b.top]}))}if(k&&k.properties){var h=e.active_canvas;b=h.getCanvasWindow();var n=[],g;for(g in k.properties)a=void 0!==k.properties[g]?k.properties[g]:" ",a=e.decodeHTML(a),n.push({content:"<span class='property_name'>"+g+"</span><span class='property_value'>"+a+"</span>",value:g});if(n.length)return new l.ContextMenu(n,{event:c,callback:f,parentMenu:d,
allow_html:!0,node:k},b),!1}};e.decodeHTML=function(a){var b=document.createElement("div");b.innerText=a;return b.innerHTML};e.onResizeNode=function(a,b,c,d,e){e&&(e.size=e.computeSize(),e.setDirtyCanvas(!0,!0))};e.onShowTitleEditor=function(a,b,c,d,k){function f(){k.title=n.value;h.parentNode.removeChild(h);k.setDirtyCanvas(!0,!0)}var h=document.createElement("div");h.className="graphdialog";h.innerHTML="<span class='name'>Title</span><input autofocus type='text' class='value'/><button>OK</button>";
var n=h.querySelector("input");n&&(n.value=k.title,n.addEventListener("keydown",function(a){13==a.keyCode&&(f(),a.preventDefault(),a.stopPropagation())}));a=e.active_canvas.canvas;b=a.getBoundingClientRect();d=c=-20;b&&(c-=b.left,d-=b.top);event?(h.style.left=event.pageX+c+"px",h.style.top=event.pageY+d+"px"):(h.style.left=0.5*a.width+c+"px",h.style.top=0.5*a.height+d+"px");h.querySelector("button").addEventListener("click",f);a.parentNode.appendChild(h)};e.prototype.showEditPropertyValue=function(a,
b,c){function d(){e(q.value)}function e(c){"number"==typeof a.properties[b]&&(c=Number(c));a.properties[b]=c;if(a.onPropertyChanged)a.onPropertyChanged(b,c);p.close();a.setDirtyCanvas(!0,!0)}if(a&&void 0!==a.properties[b]){c=c||{};var f="string";null!==a.properties[b]&&(f=typeof a.properties[b]);var h=null;a.getPropertyInfo&&(h=a.getPropertyInfo(b));if(a.properties_info)for(var n=0;n<a.properties_info.length;++n)if(a.properties_info[n].name==b){h=a.properties_info[n];break}void 0!==h&&null!==h&&h.type&&
(f=h.type);var g="";if("string"==f||"number"==f)g="<input autofocus type='text' class='value'/>";else if("enum"==f&&h.values){g="<select autofocus type='text' class='value'>";for(n in h.values)var l=h.values.constructor===Array?h.values[n]:n,g=g+("<option value='"+l+"' "+(l==a.properties[b]?"selected":"")+">"+h.values[n]+"</option>");g+="</select>"}else"boolean"==f&&(g="<input autofocus type='checkbox' class='value' "+(a.properties[b]?"checked":"")+"/>");var p=this.createDialog("<span class='name'>"+
b+"</span>"+g+"<button>OK</button>",c);if("enum"==f&&h.values){var q=p.querySelector("select");q.addEventListener("change",function(a){e(a.target.value)})}else if("boolean"==f)(q=p.querySelector("input"))&&q.addEventListener("click",function(a){e(!!q.checked)});else if(q=p.querySelector("input"))q.value=void 0!==a.properties[b]?a.properties[b]:"",q.addEventListener("keydown",function(a){13==a.keyCode&&(d(),a.preventDefault(),a.stopPropagation())});p.querySelector("button").addEventListener("click",
d)}};e.prototype.createDialog=function(a,b){b=b||{};var c=document.createElement("div");c.className="graphdialog";c.innerHTML=a;var d=this.canvas.getBoundingClientRect(),e=-20,f=-20;d&&(e-=d.left,f-=d.top);b.position?(e+=b.position[0],f+=b.position[1]):b.event?(e+=b.event.pageX,f+=b.event.pageY):(e+=0.5*this.canvas.width,f+=0.5*this.canvas.height);c.style.left=e+"px";c.style.top=f+"px";this.canvas.parentNode.appendChild(c);c.close=function(){this.parentNode&&this.parentNode.removeChild(this)};return c};
e.onMenuNodeCollapse=function(a,b,c,d,e){e.flags.collapsed=!e.flags.collapsed;e.setDirtyCanvas(!0,!0)};e.onMenuNodePin=function(a,b,c,d,e){e.pin()};e.onMenuNodeMode=function(a,b,c,d,e){new l.ContextMenu(["Always","On Event","On Trigger","Never"],{event:c,callback:function(a){if(e)switch(a){case "On Event":e.mode=l.ON_EVENT;break;case "On Trigger":e.mode=l.ON_TRIGGER;break;case "Never":e.mode=l.NEVER;break;default:e.mode=l.ALWAYS}},parentMenu:d,node:e});return!1};e.onMenuNodeColors=function(a,b,c,
d,f){if(!f)throw"no node for color";b=[];for(var n in e.node_colors)a=e.node_colors[n],a={value:n,content:"<span style='display: block; color:"+a.color+"; background-color:"+a.bgcolor+"'>"+n+"</span>"},b.push(a);new l.ContextMenu(b,{event:c,callback:function(a){f&&(a=e.node_colors[a.value])&&(f.color=a.color,f.bgcolor=a.bgcolor,f.setDirtyCanvas(!0))},parentMenu:d,node:f});return!1};e.onMenuNodeShapes=function(a,b,c,d,e){if(!e)throw"no node passed";new l.ContextMenu(l.VALID_SHAPES,{event:c,callback:function(a){e&&
(e.shape=a,e.setDirtyCanvas(!0))},parentMenu:d,node:e});return!1};e.onMenuNodeRemove=function(a,b,c,d,e){if(!e)throw"no node passed";!1!=e.removable&&(e.graph.remove(e),e.setDirtyCanvas(!0,!0))};e.onMenuNodeClone=function(a,b,c,d,e){!1!=e.clonable&&(a=e.clone())&&(a.pos=[e.pos[0]+5,e.pos[1]+5],e.graph.add(a),e.setDirtyCanvas(!0,!0))};e.node_colors={red:{color:"#FAA",bgcolor:"#944"},green:{color:"#AFA",bgcolor:"#494"},blue:{color:"#AAF",bgcolor:"#449"},cyan:{color:"#AFF",bgcolor:"#499"},purple:{color:"#FAF",
bgcolor:"#949"},yellow:{color:"#FFA",bgcolor:"#994"},black:{color:"#777",bgcolor:"#000"},white:{color:"#FFF",bgcolor:"#AAA"}};e.prototype.getCanvasMenuOptions=function(){var a=null;this.getMenuOptions?a=this.getMenuOptions():(a=[{content:"Add Node",has_submenu:!0,callback:e.onMenuAdd}],this._graph_stack&&0<this._graph_stack.length&&(a=[{content:"Close subgraph",callback:this.closeSubgraph.bind(this)},null].concat(a)));if(this.getExtraMenuOptions){var b=this.getExtraMenuOptions(this,a);b&&(a=a.concat(b))}return a};
e.prototype.getNodeMenuOptions=function(a){var b=null,b=a.getMenuOptions?a.getMenuOptions(this):[{content:"Inputs",has_submenu:!0,disabled:!0,callback:e.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:e.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:e.onShowMenuNodeProperties},null,{content:"Title",callback:e.onShowTitleEditor},{content:"Mode",has_submenu:!0,callback:e.onMenuNodeMode},{content:"Resize",callback:e.onResizeNode},{content:"Collapse",
callback:e.onMenuNodeCollapse},{content:"Pin",callback:e.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:e.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:e.onMenuNodeShapes},null];if(a.getExtraMenuOptions){var c=a.getExtraMenuOptions(this);c&&(c.push(null),b=c.concat(b))}!1!==a.clonable&&b.push({content:"Clone",callback:e.onMenuNodeClone});!1!==a.removable&&b.push(null,{content:"Remove",callback:e.onMenuNodeRemove});a.onGetInputs&&(c=a.onGetInputs())&&c.length&&(b[0].disabled=
!1);a.onGetOutputs&&(c=a.onGetOutputs())&&c.length&&(b[1].disabled=!1);if(a.graph&&a.graph.onGetNodeMenuOptions)a.graph.onGetNodeMenuOptions(b,a);return b};e.prototype.processContextMenu=function(a,b){var c=this,d=e.active_canvas.getCanvasWindow(),f=null,n={event:b,callback:function(b,d,e){if(b)if("Remove Slot"==b.content){var h=b.slot;h.input?a.removeInput(h.slot):h.output&&a.removeOutput(h.slot)}else if("Rename Slot"==b.content){var h=b.slot,f=c.createDialog("<span class='name'>Name</span><input type='text'/><button>OK</button>",
d),n=f.querySelector("input");f.querySelector("button").addEventListener("click",function(b){if(n.value){if(b=h.input?a.getInputInfo(h.slot):a.getOutputInfo(h.slot))b.label=n.value;c.setDirty(!0)}f.close()})}},node:a},h=null;a&&(h=a.getSlotInPosition(b.canvasX,b.canvasY),e.active_node=a);h?(f=[],f.push(h.locked?"Cannot remove":{content:"Remove Slot",slot:h}),f.push({content:"Rename Slot",slot:h}),n.title=(h.input?h.input.type:h.output.type)||"*",h.input&&h.input.type==l.ACTION&&(n.title="Action"),
h.output&&h.output.type==l.EVENT&&(n.title="Event")):f=a?this.getNodeMenuOptions(a):this.getCanvasMenuOptions();f&&new l.ContextMenu(f,n,d)};this.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.roundRect=function(a,b,c,d,e,f){void 0===e&&(e=5);void 0===f&&(f=e);this.beginPath();this.moveTo(a+e,b);this.lineTo(a+c-e,b);this.quadraticCurveTo(a+c,b,a+c,b+e);this.lineTo(a+c,b+d-f);this.quadraticCurveTo(a+c,b+d,a+c-f,b+d);this.lineTo(a+f,b+d);this.quadraticCurveTo(a,b+d,a,b+d-f);this.lineTo(a,
b+e);this.quadraticCurveTo(a,b,a+e,b)});l.compareObjects=function(a,b){for(var c in a)if(a[c]!=b[c])return!1;return!0};l.distance=p;l.colorToString=function(a){return"rgba("+Math.round(255*a[0]).toFixed()+","+Math.round(255*a[1]).toFixed()+","+Math.round(255*a[2]).toFixed()+","+(4==a.length?a[3].toFixed(2):"1.0")+")"};l.isInsideRectangle=q;l.growBounding=function(a,b,c){b<a[0]?a[0]=b:b>a[2]&&(a[2]=b);c<a[1]?a[1]=c:c>a[3]&&(a[3]=c)};l.isInsideBounding=function(a,b){return a[0]<b[0][0]||a[1]<b[0][1]||
a[0]>b[1][0]||a[1]>b[1][1]?!1:!0};l.overlapBounding=s;l.hex2num=function(a){"#"==a.charAt(0)&&(a=a.slice(1));a=a.toUpperCase();for(var b=Array(3),c=0,d,e,f=0;6>f;f+=2)d="0123456789ABCDEF".indexOf(a.charAt(f)),e="0123456789ABCDEF".indexOf(a.charAt(f+1)),b[c]=16*d+e,c++;return b};l.num2hex=function(a){for(var b="#",c,d,e=0;3>e;e++)c=a[e]/16,d=a[e]%16,b+="0123456789ABCDEF".charAt(c)+"0123456789ABCDEF".charAt(d);return b};u.prototype.addItem=function(a,b,c){function d(a){var b=this.value;b&&b.has_submenu&&
e.call(this,a)}function e(a){var b=this.value,d=!0;f.current_submenu&&f.current_submenu.close(a);if(c.callback){var h=c.callback.call(this,b,c,a,f,c.node);!0===h&&(d=!1)}if(b&&(b.callback&&!c.ignore_item_callbacks&&!0!==b.disabled&&(h=b.callback.call(this,b,c,a,f,c.node),!0===h&&(d=!1)),b.submenu)){if(!b.submenu.options)throw"ContextMenu submenu needs options";new f.constructor(b.submenu.options,{callback:b.submenu.callback,event:a,parentMenu:f,ignore_item_callbacks:b.submenu.ignore_item_callbacks,
title:b.submenu.title,autoopen:c.autoopen});d=!1}d&&!f.lock&&f.close()}var f=this;c=c||{};var h=document.createElement("div");h.className="litemenu-entry submenu";var n=!1;if(null===b)h.classList.add("separator");else{h.innerHTML=b&&b.title?b.title:a;if(h.value=b)b.disabled&&(n=!0,h.classList.add("disabled")),(b.submenu||b.has_submenu)&&h.classList.add("has_submenu");"function"==typeof b?(h.dataset.value=a,h.onclick_callback=b):h.dataset.value=b;b.className&&(h.className+=" "+b.className)}this.root.appendChild(h);
n||h.addEventListener("click",e);c.autoopen&&h.addEventListener("mouseenter",d);return h};u.prototype.close=function(a,b){this.root.parentNode&&this.root.parentNode.removeChild(this.root);this.parentMenu&&!b&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===a?this.parentMenu.close():a&&!u.isCursorOverElement(a,this.parentMenu.root)&&u.trigger(this.parentMenu.root,"mouseleave",a));this.current_submenu&&this.current_submenu.close(a,!0)};u.trigger=function(a,b,c,d){var e=document.createEvent("CustomEvent");
e.initCustomEvent(b,!0,!0,c);e.srcElement=d;a.dispatchEvent?a.dispatchEvent(e):a.__events&&a.__events.dispatchEvent(e);return e};u.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this};u.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event};u.isCursorOverElement=function(a,b){var c=a.pageX,d=a.pageY,e=b.getBoundingClientRect();return e?d>e.top&&d<e.top+e.height&&c>e.left&&c<
e.left+e.width?!0:!1:!1};l.ContextMenu=u;l.closeAllContextMenus=function(a){a=a||window;a=a.document.querySelectorAll(".litecontextmenu");if(a.length){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);for(c in b)b[c].close?b[c].close():b[c].parentNode&&b[c].parentNode.removeChild(b[c])}};l.extendClass=function(a,b){for(var c in b)a.hasOwnProperty(c)||(a[c]=b[c]);if(b.prototype)for(c in b.prototype)b.prototype.hasOwnProperty(c)&&!a.prototype.hasOwnProperty(c)&&(b.prototype.__lookupGetter__(c)?a.prototype.__defineGetter__(c,
b.prototype.__lookupGetter__(c)):a.prototype[c]=b.prototype[c],b.prototype.__lookupSetter__(c)&&a.prototype.__defineSetter__(c,b.prototype.__lookupSetter__(c)))};l.getParameterNames=function(a){return(a+"").replace(/[/][/].*$/mg,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)};Math.clamp=function(a,b,c){return b>a?b:c<a?c:a};"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=
window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)})})(this);"undefined"!=typeof exports&&(exports.LiteGraph=this.LiteGraph);
(function(r){function g(){this.addOutput("in ms","number");this.addOutput("in sec","number")}function f(){this.size=[120,60];this.subgraph=new LGraph;this.subgraph._subgraph_node=this;this.subgraph._is_subgraph=!0;this.subgraph.onGlobalInputAdded=this.onSubgraphNewGlobalInput.bind(this);this.subgraph.onGlobalInputRenamed=this.onSubgraphRenamedGlobalInput.bind(this);this.subgraph.onGlobalInputTypeChanged=this.onSubgraphTypeChangeGlobalInput.bind(this);this.subgraph.onGlobalOutputAdded=this.onSubgraphNewGlobalOutput.bind(this);
this.subgraph.onGlobalOutputRenamed=this.onSubgraphRenamedGlobalOutput.bind(this);this.subgraph.onGlobalOutputTypeChanged=this.onSubgraphTypeChangeGlobalOutput.bind(this);this.bgcolor="#663"}function e(){var a="input_"+(1E3*Math.random()).toFixed();this.addOutput(a,null);this.properties={name:a,type:null};var b=this;Object.defineProperty(this.properties,"name",{get:function(){return a},set:function(c){if(""!=c){var d=b.getOutputInfo(0);d.name!=c&&(d.name=c,b.graph&&b.graph.renameGlobalInput(a,c),
a=c)}},enumerable:!0});Object.defineProperty(this.properties,"type",{get:function(){return b.outputs[0].type},set:function(c){b.outputs[0].type=c;b.graph&&b.graph.changeGlobalInputType(a,b.outputs[0].type)},enumerable:!0})}function p(){var a="output_"+(1E3*Math.random()).toFixed();this.addInput(a,null);this._value=null;this.properties={name:a,type:null};var b=this;Object.defineProperty(this.properties,"name",{get:function(){return a},set:function(c){if(""!=c){var d=b.getInputInfo(0);d.name!=c&&(d.name=
c,b.graph&&b.graph.renameGlobalOutput(a,c),a=c)}},enumerable:!0});Object.defineProperty(this.properties,"type",{get:function(){return b.inputs[0].type},set:function(c){b.inputs[0].type=c;b.graph&&b.graph.changeGlobalInputType(a,b.inputs[0].type)},enumerable:!0})}function q(){this.addOutput("value","number");this.addProperty("value",1);this.editable={property:"value",type:"number"}}function s(){this.size=[60,20];this.addInput("value",0,{label:""});this.addOutput("value",0,{label:""});this.addProperty("value",
"")}function u(){this.addInput("in",0);this.addOutput("out",0);this.size=[40,20]}function l(){this.mode=d.ON_EVENT;this.size=[60,20];this.addProperty("msg","");this.addInput("log",d.EVENT);this.addInput("msg",0)}function n(){this.size=[60,20];this.addProperty("onExecute","");this.addInput("in","");this.addInput("in2","");this.addOutput("out","");this.addOutput("out2","");this._func=null}var d=r.LiteGraph;g.title="Time";g.desc="Time";g.prototype.onExecute=function(){this.setOutputData(0,1E3*this.graph.globaltime);
this.setOutputData(1,this.graph.globaltime)};d.registerNodeType("basic/time",g);f.title="Subgraph";f.desc="Graph inside a node";f.prototype.onSubgraphNewGlobalInput=function(a,b){this.addInput(a,b)};f.prototype.onSubgraphRenamedGlobalInput=function(a,b){var c=this.findInputSlot(a);-1!=c&&(this.getInputInfo(c).name=b)};f.prototype.onSubgraphTypeChangeGlobalInput=function(a,b){var c=this.findInputSlot(a);-1!=c&&(this.getInputInfo(c).type=b)};f.prototype.onSubgraphNewGlobalOutput=function(a,b){this.addOutput(a,
b)};f.prototype.onSubgraphRenamedGlobalOutput=function(a,b){var c=this.findOutputSlot(a);-1!=c&&(this.getOutputInfo(c).name=b)};f.prototype.onSubgraphTypeChangeGlobalOutput=function(a,b){var c=this.findOutputSlot(a);-1!=c&&(this.getOutputInfo(c).type=b)};f.prototype.getExtraMenuOptions=function(a){var b=this;return[{content:"Open",callback:function(){a.openSubgraph(b.subgraph)}}]};f.prototype.onExecute=function(){if(this.inputs)for(var a=0;a<this.inputs.length;a++){var b=this.inputs[a],c=this.getInputData(a);
this.subgraph.setGlobalInputData(b.name,c)}this.subgraph.runStep();if(this.outputs)for(a=0;a<this.outputs.length;a++)c=this.subgraph.getGlobalOutputData(this.outputs[a].name),this.setOutputData(a,c)};f.prototype.configure=function(a){LGraphNode.prototype.configure.call(this,a)};f.prototype.serialize=function(){var a=LGraphNode.prototype.serialize.call(this);a.subgraph=this.subgraph.serialize();return a};f.prototype.clone=function(){var a=d.createNode(this.type),b=this.serialize();delete b.id;delete b.inputs;
delete b.outputs;a.configure(b);return a};d.registerNodeType("graph/subgraph",f);e.title="Input";e.desc="Input of the graph";e.prototype.onAdded=function(){this.graph.addGlobalInput(this.properties.name,this.properties.type)};e.prototype.onExecute=function(){var a=this.graph.global_inputs[this.properties.name];a&&this.setOutputData(0,a.value)};d.registerNodeType("graph/input",e);p.title="Output";p.desc="Output of the graph";p.prototype.onAdded=function(){this.graph.addGlobalOutput(this.properties.name,
this.properties.type)};p.prototype.getValue=function(){return this._value};p.prototype.onExecute=function(){this._value=this.getInputData(0);this.graph.setGlobalOutputData(this.properties.name,this._value)};d.registerNodeType("graph/output",p);q.title="Const";q.desc="Constant value";q.prototype.setValue=function(a){"string"==typeof a&&(a=parseFloat(a));this.properties.value=a;this.setDirtyCanvas(!0)};q.prototype.onExecute=function(){this.setOutputData(0,parseFloat(this.properties.value))};q.prototype.onDrawBackground=
function(a){this.outputs[0].label=this.properties.value.toFixed(3)};q.prototype.onWidget=function(a,b){"value"==b.name&&this.setValue(b.value)};d.registerNodeType("basic/const",q);s.title="Watch";s.desc="Show value of input";s.prototype.onExecute=function(){this.properties.value=this.getInputData(0);this.setOutputData(0,this.properties.value)};s.prototype.onDrawBackground=function(a){this.inputs[0]&&null!=this.properties.value&&(this.properties.value.constructor===Number?this.inputs[0].label=this.properties.value.toFixed(3):
((a=this.properties.value)&&a.length&&(a=Array.prototype.slice.call(a).join(",")),this.inputs[0].label=a))};d.registerNodeType("basic/watch",s);u.title="Pass";u.desc="Allows to connect different types";u.prototype.onExecute=function(){this.setOutputData(0,this.getInputData(0))};d.registerNodeType("basic/pass",u);l.title="Console";l.desc="Show value inside the console";l.prototype.onAction=function(a,b){"log"==a?console.log(b):"warn"==a?console.warn(b):"error"==a&&console.error(b)};l.prototype.onExecute=
function(){var a=this.getInputData(1);null!==a&&(this.properties.msg=a);console.log(a)};l.prototype.onGetInputs=function(){return[["log",d.ACTION],["warn",d.ACTION],["error",d.ACTION]]};d.registerNodeType("basic/console",l);n.title="Script";n.desc="executes a code";n.widgets_info={onExecute:{type:"code"}};n.prototype.onPropertyChanged=function(a,b){if("onExecute"==a&&d.allow_scripts){this._func=null;try{this._func=new Function(b)}catch(c){console.error("Error parsing script"),console.error(c)}}};
n.prototype.onExecute=function(){if(this._func)try{this._func.call(this)}catch(a){console.error("Error in script"),console.error(a)}};d.registerNodeType("basic/script",n)})(this);
(function(r){function g(){this.size=[60,20];this.addInput("event",p.ACTION)}function f(){this.size=[60,20];this.addInput("event",p.ACTION);this.addOutput("event",p.EVENT);this.properties={equal_to:"",has_property:"",property_equal_to:""}}function e(){this.size=[60,20];this.addProperty("time",1E3);this.addInput("event",p.ACTION);this.addOutput("on_time",p.EVENT);this._pending=[]}var p=r.LiteGraph;g.title="Log Event";g.desc="Log event in console";g.prototype.onAction=function(e,f){console.log(e,f)};
p.registerNodeType("events/log",g);f.title="Filter Event";f.desc="Blocks events that do not match the filter";f.prototype.onAction=function(e,f){if(null!=f&&(!this.properties.equal_to||this.properties.equal_to==f)){if(this.properties.has_property){var g=f[this.properties.has_property];if(null==g||this.properties.property_equal_to&&this.properties.property_equal_to!=g)return}this.triggerSlot(0,f)}};p.registerNodeType("events/filter",f);e.title="Delay";e.desc="Delays one event";e.prototype.onAction=
function(e,f){this._pending.push([this.properties.time,f])};e.prototype.onExecute=function(){for(var e=1E3*this.graph.elapsed_time,f=0;f<this._pending.length;++f){var g=this._pending[f];g[0]-=e;0<g[0]||(this._pending.splice(f,1),--f,this.trigger(null,g[1]))}};e.prototype.onGetInputs=function(){return[["event",p.ACTION]]};p.registerNodeType("events/delay",e)})(this);
(function(r){function g(){this.addOutput("clicked",l.EVENT);this.addProperty("text","");this.addProperty("font","40px Arial");this.addProperty("message","");this.size=[64,84]}function f(){this.addInput("","boolean");this.addOutput("v","boolean");this.addOutput("e",l.EVENT);this.properties={font:"",value:!1};this.size=[124,64]}function e(){this.addOutput("","number");this.size=[64,84];this.properties={min:0,max:1,value:0.5,wcolor:"#7AF",size:50}}function p(){this.size=[160,26];this.addOutput("","number");
this.properties={wcolor:"#7AF",min:0,max:1,value:0.5}}function q(){this.size=[160,26];this.addInput("","number");this.properties={min:0,max:1,value:0,wcolor:"#AAF"}}function s(){this.addInputs("",0);this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}function u(){this.size=[200,100];this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}var l=r.LiteGraph;g.title="Button";g.desc="Triggers an event";
g.prototype.onDrawForeground=function(e){!this.flags.collapsed&&(e.fillStyle="black",e.fillRect(1,1,this.size[0]-3,this.size[1]-3),e.fillStyle="#AAF",e.fillRect(0,0,this.size[0]-3,this.size[1]-3),e.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",e.fillRect(1,1,this.size[0]-4,this.size[1]-4),this.properties.text||0===this.properties.text)&&(e.textAlign="center",e.fillStyle=this.clicked?"black":"white",this.properties.font&&(e.font=this.properties.font),e.fillText(this.properties.text,0.5*
this.size[0],0.85*this.size[1]),e.textAlign="left")};g.prototype.onMouseDown=function(e,d){if(1<d[0]&&1<d[1]&&d[0]<this.size[0]-2&&d[1]<this.size[1]-2)return this.clicked=!0,this.trigger("clicked",this.properties.message),!0};g.prototype.onMouseUp=function(e){this.clicked=!1};l.registerNodeType("widget/button",g);f.title="Toggle";f.desc="Toggles between true or false";f.prototype.onDrawForeground=function(e){if(!this.flags.collapsed){var d=0.5*this.size[1],a=0.8*this.size[1];e.fillStyle="#AAA";e.fillRect(10,
a-d,d,d);e.fillStyle=this.properties.value?"#AEF":"#000";e.fillRect(10+0.25*d,a-d+0.25*d,0.5*d,0.5*d);e.textAlign="left";e.font=this.properties.font||(0.8*d).toFixed(0)+"px Arial";e.fillStyle="#AAA";e.fillText(this.title,d+20,0.85*a);e.textAlign="left"}};f.prototype.onExecute=function(){var e=this.getInputData(0);null!=e&&(this.properties.value=e);this.setOutputData(0,this.properties.value)};f.prototype.onMouseDown=function(e,d){if(1<d[0]&&1<d[1]&&d[0]<this.size[0]-2&&d[1]<this.size[1]-2)return this.properties.value=
!this.properties.value,this.trigger("clicked",this.properties.value),!0};l.registerNodeType("widget/toggle",f);e.title="Knob";e.desc="Circular controller";e.widgets=[{name:"increase",text:"+",type:"minibutton"},{name:"decrease",text:"-",type:"minibutton"}];e.prototype.onAdded=function(){this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);this.imgbg=this.loadImage("imgs/knob_bg.png");this.imgfg=this.loadImage("imgs/knob_fg.png")};e.prototype.onDrawImageKnob=
function(e){if(this.imgfg&&this.imgfg.width){var d=0.5*this.imgbg.width,a=this.size[0]/this.imgfg.width;e.save();e.translate(0,20);e.scale(a,a);e.drawImage(this.imgbg,0,0);e.translate(d,d);e.rotate(2*this.value*Math.PI*6/8+10*Math.PI/8);e.translate(-d,-d);e.drawImage(this.imgfg,0,0);e.restore();this.title&&(e.font="bold 16px Criticized,Tahoma",e.fillStyle="rgba(100,100,100,0.8)",e.textAlign="center",e.fillText(this.title.toUpperCase(),0.5*this.size[0],18),e.textAlign="left")}};e.prototype.onDrawVectorKnob=
function(e){if(this.imgfg&&this.imgfg.width){e.lineWidth=1;e.strokeStyle=this.mouseOver?"#FFF":"#AAA";e.fillStyle="#000";e.beginPath();e.arc(0.5*this.size[0],0.5*this.size[1]+10,0.5*this.properties.size,0,2*Math.PI,!0);e.stroke();0<this.value&&(e.strokeStyle=this.properties.wcolor,e.lineWidth=0.2*this.properties.size,e.beginPath(),e.arc(0.5*this.size[0],0.5*this.size[1]+10,0.35*this.properties.size,-0.5*Math.PI+2*Math.PI*this.value,-0.5*Math.PI,!0),e.stroke(),e.lineWidth=1);e.font=0.2*this.properties.size+
"px Arial";e.fillStyle="#AAA";e.textAlign="center";var d=this.properties.value;"number"==typeof d&&(d=d.toFixed(2));e.fillText(d,0.5*this.size[0],0.65*this.size[1]);e.textAlign="left"}};e.prototype.onDrawForeground=function(e){this.onDrawImageKnob(e)};e.prototype.onExecute=function(){this.setOutputData(0,this.properties.value);this.boxcolor=l.colorToString([this.value,this.value,this.value])};e.prototype.onMouseDown=function(e){if(this.imgfg&&this.imgfg.width){this.center=[0.5*this.size[0],0.5*this.size[1]+
20];this.radius=0.5*this.size[0];if(20>e.canvasY-this.pos[1]||l.distance([e.canvasX,e.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius)return!1;this.oldmouse=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]];this.captureInput(!0);return!0}};e.prototype.onMouseMove=function(e){if(this.oldmouse){e=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]];var d=this.value,d=d-0.01*(e[1]-this.oldmouse[1]);1<d?d=1:0>d&&(d=0);this.value=d;this.properties.value=this.properties.min+(this.properties.max-
this.properties.min)*this.value;this.oldmouse=e;this.setDirtyCanvas(!0)}};e.prototype.onMouseUp=function(e){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))};e.prototype.onMouseLeave=function(e){};e.prototype.onWidget=function(e,d){if("increase"==d.name)this.onPropertyChanged("size",this.properties.size+10);else if("decrease"==d.name)this.onPropertyChanged("size",this.properties.size-10)};e.prototype.onPropertyChanged=function(e,d){if("wcolor"==e)this.properties[e]=d;else if("size"==e)d=
parseInt(d),this.properties[e]=d,this.size=[d+4,d+24],this.setDirtyCanvas(!0,!0);else if("min"==e||"max"==e||"value"==e)this.properties[e]=parseFloat(d);else return!1;return!0};l.registerNodeType("widget/knob",e);p.title="H.Slider";p.desc="Linear slider controller";p.prototype.onAdded=function(){this.value=0.5;this.imgfg=this.loadImage("imgs/slider_fg.png")};p.prototype.onDrawVectorial=function(e){this.imgfg&&this.imgfg.width&&(e.lineWidth=1,e.strokeStyle=this.mouseOver?"#FFF":"#AAA",e.fillStyle=
"#000",e.beginPath(),e.rect(2,0,this.size[0]-4,20),e.stroke(),e.fillStyle=this.properties.wcolor,e.beginPath(),e.rect(2+(this.size[0]-4-20)*this.value,0,20,20),e.fill())};p.prototype.onDrawImage=function(e){this.imgfg&&this.imgfg.width&&(e.lineWidth=1,e.fillStyle="#000",e.fillRect(2,9,this.size[0]-4,2),e.strokeStyle="#333",e.beginPath(),e.moveTo(2,9),e.lineTo(this.size[0]-4,9),e.stroke(),e.strokeStyle="#AAA",e.beginPath(),e.moveTo(2,11),e.lineTo(this.size[0]-4,11),e.stroke(),e.drawImage(this.imgfg,
2+(this.size[0]-4)*this.value-0.5*this.imgfg.width,0.5*-this.imgfg.height+10))};p.prototype.onDrawForeground=function(e){this.onDrawImage(e)};p.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value;this.setOutputData(0,this.properties.value);this.boxcolor=l.colorToString([this.value,this.value,this.value])};p.prototype.onMouseDown=function(e){if(0>e.canvasY-this.pos[1])return!1;this.oldmouse=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]];
this.captureInput(!0);return!0};p.prototype.onMouseMove=function(e){if(this.oldmouse){e=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]];var d=this.value,d=d+(e[0]-this.oldmouse[0])/this.size[0];1<d?d=1:0>d&&(d=0);this.value=d;this.oldmouse=e;this.setDirtyCanvas(!0)}};p.prototype.onMouseUp=function(e){this.oldmouse=null;this.captureInput(!1)};p.prototype.onMouseLeave=function(e){};p.prototype.onPropertyChanged=function(e,d){if("wcolor"==e)this.properties[e]=d;else return!1;return!0};l.registerNodeType("widget/hslider",
p);q.title="Progress";q.desc="Shows data in linear progress";q.prototype.onExecute=function(){var e=this.getInputData(0);void 0!=e&&(this.properties.value=e)};q.prototype.onDrawForeground=function(e){e.lineWidth=1;e.fillStyle=this.properties.wcolor;var d=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min),d=Math.min(1,d),d=Math.max(0,d);e.fillRect(2,2,(this.size[0]-4)*d,this.size[1]-4)};l.registerNodeType("widget/progress",q);s.title="Text";s.desc="Shows the input value";
s.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}];s.prototype.onDrawForeground=function(e){e.fillStyle=this.properties.color;var d=this.properties.value;this.properties.glowSize?(e.shadowColor=this.properties.color,e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=this.properties.glowSize):e.shadowColor="transparent";var a=this.properties.fontsize;e.textAlign=this.properties.align;e.font=a.toString()+
"px "+this.properties.font;this.str="number"==typeof d?d.toFixed(this.properties.decimals):d;if("string"==typeof this.str){var d=this.str.split("\\n"),b;for(b in d)e.fillText(d[b],"left"==this.properties.align?15:this.size[0]-15,-0.15*a+a*(parseInt(b)+1))}e.shadowColor="transparent";this.last_ctx=e;e.textAlign="left"};s.prototype.onExecute=function(){var e=this.getInputData(0);null!=e&&(this.properties.value=e)};s.prototype.resize=function(){if(this.last_ctx){var e=this.str.split("\\n");this.last_ctx.font=
this.properties.fontsize+"px "+this.properties.font;var d=0,a;for(a in e){var b=this.last_ctx.measureText(e[a]).width;d<b&&(d=b)}this.size[0]=d+20;this.size[1]=4+e.length*this.properties.fontsize;this.setDirtyCanvas(!0)}};s.prototype.onWidget=function(e,d){"resize"==d.name?this.resize():"led_text"==d.name?(this.properties.font="Digital",this.properties.glowSize=4,this.setDirtyCanvas(!0)):"normal_text"==d.name&&(this.properties.font="Arial",this.setDirtyCanvas(!0))};s.prototype.onPropertyChanged=function(e,
d){this.properties[e]=d;this.str="number"==typeof d?d.toFixed(3):d;return!0};l.registerNodeType("widget/text",s);u.title="Panel";u.desc="Non interactive panel";u.widgets=[{name:"update",text:"Update",type:"button"}];u.prototype.createGradient=function(e){""==this.properties.bgcolorTop||""==this.properties.bgcolorBottom?this.lineargradient=0:(this.lineargradient=e.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,
this.properties.bgcolorBottom))};u.prototype.onDrawForeground=function(e){null==this.lineargradient&&this.createGradient(e);this.lineargradient&&(e.lineWidth=1,e.strokeStyle=this.properties.borderColor,e.fillStyle=this.lineargradient,this.properties.shadowSize?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=this.properties.shadowSize):e.shadowColor="transparent",e.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),e.fill(),e.shadowColor="transparent",e.stroke())};
u.prototype.onWidget=function(e,d){"update"==d.name&&(this.lineargradient=null,this.setDirtyCanvas(!0))};l.registerNodeType("widget/panel",u)})(this);
(function(r){function g(){this.addOutput("left_x_axis","number");this.addOutput("left_y_axis","number");this.addOutput("button_pressed",f.EVENT);this.properties={gamepad_index:0,threshold:0.1};this._left_axis=new Float32Array(2);this._right_axis=new Float32Array(2);this._triggers=new Float32Array(2);this._previous_buttons=new Uint8Array(17);this._current_buttons=new Uint8Array(17)}var f=r.LiteGraph;g.title="Gamepad";g.desc="gets the input of the gamepad";g.zero=new Float32Array(2);g.buttons="a b x y lb rb lt rt back start ls rs home".split(" ");
g.prototype.onExecute=function(){var e=this.getGamepad(),f=this.properties.threshold||0;e&&(this._left_axis[0]=Math.abs(e.xbox.axes.lx)>f?e.xbox.axes.lx:0,this._left_axis[1]=Math.abs(e.xbox.axes.ly)>f?e.xbox.axes.ly:0,this._right_axis[0]=Math.abs(e.xbox.axes.rx)>f?e.xbox.axes.rx:0,this._right_axis[1]=Math.abs(e.xbox.axes.ry)>f?e.xbox.axes.ry:0,this._triggers[0]=Math.abs(e.xbox.axes.ltrigger)>f?e.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(e.xbox.axes.rtrigger)>f?e.xbox.axes.rtrigger:0);if(this.outputs)for(f=
0;f<this.outputs.length;f++){var q=this.outputs[f];if(q.links&&q.links.length){var s=null;if(e)switch(q.name){case "left_axis":s=this._left_axis;break;case "right_axis":s=this._right_axis;break;case "left_x_axis":s=this._left_axis[0];break;case "left_y_axis":s=this._left_axis[1];break;case "right_x_axis":s=this._right_axis[0];break;case "right_y_axis":s=this._right_axis[1];break;case "trigger_left":s=this._triggers[0];break;case "trigger_right":s=this._triggers[1];break;case "a_button":s=e.xbox.buttons.a?
1:0;break;case "b_button":s=e.xbox.buttons.b?1:0;break;case "x_button":s=e.xbox.buttons.x?1:0;break;case "y_button":s=e.xbox.buttons.y?1:0;break;case "lb_button":s=e.xbox.buttons.lb?1:0;break;case "rb_button":s=e.xbox.buttons.rb?1:0;break;case "ls_button":s=e.xbox.buttons.ls?1:0;break;case "rs_button":s=e.xbox.buttons.rs?1:0;break;case "start_button":s=e.xbox.buttons.start?1:0;break;case "back_button":s=e.xbox.buttons.back?1:0;break;case "button_pressed":for(q=0;q<this._current_buttons.length;++q)this._current_buttons[q]&&
!this._previous_buttons[q]&&this.triggerSlot(f,g.buttons[q])}else switch(q.name){case "button_pressed":break;case "left_axis":case "right_axis":s=g.zero;break;default:s=0}this.setOutputData(f,s)}}};g.prototype.getGamepad=function(){var e=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!e)return null;var f=e.call(navigator),e=null;this._previous_buttons.set(this._current_buttons);for(e=this.properties.gamepad_index;4>e;e++)if(f[e]){e=f[e];f=this.xbox_mapping;f||(f=this.xbox_mapping=
{axes:[],buttons:{},hat:""});f.axes.lx=e.axes[0];f.axes.ly=e.axes[1];f.axes.rx=e.axes[2];f.axes.ry=e.axes[3];f.axes.ltrigger=e.buttons[6].value;f.axes.rtrigger=e.buttons[7].value;for(var g=0;g<e.buttons.length;g++)switch(this._current_buttons[g]=e.buttons[g].pressed,g){case 0:f.buttons.a=e.buttons[g].pressed;break;case 1:f.buttons.b=e.buttons[g].pressed;break;case 2:f.buttons.x=e.buttons[g].pressed;break;case 3:f.buttons.y=e.buttons[g].pressed;break;case 4:f.buttons.lb=e.buttons[g].pressed;break;
case 5:f.buttons.rb=e.buttons[g].pressed;break;case 6:f.buttons.lt=e.buttons[g].pressed;break;case 7:f.buttons.rt=e.buttons[g].pressed;break;case 8:f.buttons.back=e.buttons[g].pressed;break;case 9:f.buttons.start=e.buttons[g].pressed;break;case 10:f.buttons.ls=e.buttons[g].pressed;break;case 11:f.buttons.rs=e.buttons[g].pressed;break;case 12:e.buttons[g].pressed&&(f.hat+="up");break;case 13:e.buttons[g].pressed&&(f.hat+="down");break;case 14:e.buttons[g].pressed&&(f.hat+="left");break;case 15:e.buttons[g].pressed&&
(f.hat+="right");break;case 16:f.buttons.home=e.buttons[g].pressed}e.xbox=f;return e}};g.prototype.onDrawBackground=function(e){var f=this._left_axis,g=this._right_axis;e.strokeStyle="#88A";e.strokeRect(0.5*(f[0]+1)*this.size[0]-4,0.5*(f[1]+1)*this.size[1]-4,8,8);e.strokeStyle="#8A8";e.strokeRect(0.5*(g[0]+1)*this.size[0]-4,0.5*(g[1]+1)*this.size[1]-4,8,8);f=this.size[1]/this._current_buttons.length;e.fillStyle="#AEB";for(g=0;g<this._current_buttons.length;++g)this._current_buttons[g]&&e.fillRect(0,
f*g,6,f)};g.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start","number"],["back","number"],["button_pressed",f.EVENT]]};f.registerNodeType("input/gamepad",
g)})(this);
(function(r){function g(){this.addInput("in","*");this.size=[60,20]}function f(){this.addInput("in");this.addOutput("out");this.size=[60,20]}function e(){this.addInput("in","number",{locked:!0});this.addOutput("out","number",{locked:!0});this.addProperty("in",0);this.addProperty("in_min",0);this.addProperty("in_max",1);this.addProperty("out_min",0);this.addProperty("out_max",1)}function p(){this.addOutput("value","number");this.addProperty("min",0);this.addProperty("max",1);this.size=[60,20]}function q(){this.addInput("in",
"number");this.addOutput("out","number");this.size=[60,20];this.addProperty("min",0);this.addProperty("max",1)}function s(){this.properties={f:0.5};this.addInput("A","number");this.addInput("B","number");this.addOutput("out","number")}function u(){this.addInput("in","number");this.addOutput("out","number");this.size=[60,20]}function l(){this.addInput("in","number");this.addOutput("out","number");this.size=[60,20]}function n(){this.addInput("in","number");this.addOutput("out","number");this.size=[60,
20]}function d(){this.addInput("in","number");this.addOutput("out","number");this.size=[60,20];this.properties={A:0,B:1}}function a(){this.addInput("in","number",{label:""});this.addOutput("out","number",{label:""});this.size=[60,20];this.addProperty("factor",1)}function b(){this.addInput("in","number");this.addOutput("out","number");this.size=[60,20];this.addProperty("samples",10);this._values=new Float32Array(10);this._current=0}function c(){this.addInput("in","number");this.addOutput("out","number");
this.addProperty("factor",0.1);this.size=[60,20];this._value=null}function m(){this.addInput("A","number");this.addInput("B","number");this.addOutput("=","number");this.addProperty("A",1);this.addProperty("B",1);this.addProperty("OP","+","string",{values:m.values})}function k(){this.addInput("A","number");this.addInput("B","number");this.addOutput("A==B","boolean");this.addOutput("A!=B","boolean");this.addProperty("A",0);this.addProperty("B",0)}function t(){this.addInput("A","number");this.addInput("B",
"number");this.addOutput("out","boolean");this.addProperty("A",1);this.addProperty("B",1);this.addProperty("OP",">","string",{values:t.values});this.size=[60,40]}function h(){this.addInput("inc","number");this.addOutput("total","number");this.addProperty("increment",1);this.addProperty("value",0)}function x(){this.addInput("v","number");this.addOutput("sin","number");this.addProperty("amplitude",1);this.addProperty("offset",0);this.bgImageUrl="nodes/imgs/icon-sin.png"}function w(){this.addInput("vec2",
"vec2");this.addOutput("x","number");this.addOutput("y","number")}function y(){this.addInputs([["x","number"],["y","number"]]);this.addOutput("vec2","vec2");this.properties={x:0,y:0};this._data=new Float32Array(2)}function A(){this.addInput("vec3","vec3");this.addOutput("x","number");this.addOutput("y","number");this.addOutput("z","number")}function B(){this.addInputs([["x","number"],["y","number"],["z","number"]]);this.addOutput("vec3","vec3");this.properties={x:0,y:0,z:0};this._data=new Float32Array(3)}
function z(){this.addInput("vec4","vec4");this.addOutput("x","number");this.addOutput("y","number");this.addOutput("z","number");this.addOutput("w","number")}function C(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]);this.addOutput("vec4","vec4");this.properties={x:0,y:0,z:0,w:0};this._data=new Float32Array(4)}var v=r.LiteGraph;g.title="Converter";g.desc="type A to type B";g.prototype.onExecute=function(){var a=this.getInputData(0);if(null!=a&&this.outputs)for(var b=
0;b<this.outputs.length;b++){var c=this.outputs[b];if(c.links&&c.links.length){var d=null;switch(c.name){case "number":d=a.length?a[0]:parseFloat(a);break;case "vec2":case "vec3":case "vec4":d=1;switch(c.name){case "vec2":d=2;break;case "vec3":d=3;break;case "vec4":d=4}d=new Float32Array(d);if(a.length)for(c=0;c<a.length&&c<d.length;c++)d[c]=a[c];else d[0]=parseFloat(a)}this.setOutputData(b,d)}}};g.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4",
"vec4"]]};v.registerNodeType("math/converter",g);f.title="Bypass";f.desc="removes the type";f.prototype.onExecute=function(){var a=this.getInputData(0);this.setOutputData(0,a)};v.registerNodeType("math/bypass",f);e.title="Range";e.desc="Convert a number from one range to another";e.prototype.onExecute=function(){if(this.inputs)for(var a=0;a<this.inputs.length;a++){var b=this.inputs[a],c=this.getInputData(a);void 0!==c&&(this.properties[b.name]=c)}c=this.properties["in"];if(void 0===c||null===c||c.constructor!==
Number)c=0;a=this.properties.in_min;b=this.properties.out_min;this._last_v=(c-a)/(this.properties.in_max-a)*(this.properties.out_max-b)+b;this.setOutputData(0,this._last_v)};e.prototype.onDrawBackground=function(a){this.outputs[0].label=this._last_v?this._last_v.toFixed(3):"?"};e.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]};v.registerNodeType("math/range",e);p.title="Rand";p.desc="Random number";p.prototype.onExecute=function(){if(this.inputs)for(var a=
0;a<this.inputs.length;a++){var b=this.inputs[a],c=this.getInputData(a);void 0!==c&&(this.properties[b.name]=c)}a=this.properties.min;b=this.properties.max;this._last_v=Math.random()*(b-a)+a;this.setOutputData(0,this._last_v)};p.prototype.onDrawBackground=function(a){this.outputs[0].label=this._last_v?this._last_v.toFixed(3):"?"};p.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]};v.registerNodeType("math/rand",p);q.title="Clamp";q.desc="Clamp number between min and max";
q.filter="shader";q.prototype.onExecute=function(){var a=this.getInputData(0);null!=a&&(a=Math.max(this.properties.min,a),a=Math.min(this.properties.max,a),this.setOutputData(0,a))};q.prototype.getCode=function(a){a="";this.isInputConnected(0)&&(a+="clamp({{0}},"+this.properties.min+","+this.properties.max+")");return a};v.registerNodeType("math/clamp",q);s.title="Lerp";s.desc="Linear Interpolation";s.prototype.onExecute=function(){var a=this.getInputData(0);null==a&&(a=0);var b=this.getInputData(1);
null==b&&(b=0);var c=this.properties.f,d=this.getInputData(2);void 0!==d&&(c=d);this.setOutputData(0,a*(1-c)+b*c)};s.prototype.onGetInputs=function(){return[["f","number"]]};v.registerNodeType("math/lerp",s);u.title="Abs";u.desc="Absolute";u.prototype.onExecute=function(){var a=this.getInputData(0);null!=a&&this.setOutputData(0,Math.abs(a))};v.registerNodeType("math/abs",u);l.title="Floor";l.desc="Floor number to remove fractional part";l.prototype.onExecute=function(){var a=this.getInputData(0);
null!=a&&this.setOutputData(0,Math.floor(a))};v.registerNodeType("math/floor",l);n.title="Frac";n.desc="Returns fractional part";n.prototype.onExecute=function(){var a=this.getInputData(0);null!=a&&this.setOutputData(0,a%1)};v.registerNodeType("math/frac",n);d.title="Smoothstep";d.desc="Smoothstep";d.prototype.onExecute=function(){var a=this.getInputData(0);if(void 0!==a){var b=this.properties.A,a=Math.clamp((a-b)/(this.properties.B-b),0,1);this.setOutputData(0,a*a*(3-2*a))}};v.registerNodeType("math/smoothstep",
d);a.title="Scale";a.desc="v * factor";a.prototype.onExecute=function(){var a=this.getInputData(0);null!=a&&this.setOutputData(0,a*this.properties.factor)};v.registerNodeType("math/scale",a);b.title="Average";b.desc="Average Filter";b.prototype.onExecute=function(){var a=this.getInputData(0);null==a&&(a=0);var b=this._values.length;this._values[this._current%b]=a;this._current+=1;this._current>b&&(this._current=0);for(var c=a=0;c<b;++c)a+=this._values[c];this.setOutputData(0,a/b)};b.prototype.onPropertyChanged=
function(a,b){1>b&&(b=1);this.properties.samples=Math.round(b);var c=this._values;this._values=new Float32Array(this.properties.samples);c.length<=this._values.length?this._values.set(c):this._values.set(c.subarray(0,this._values.length))};v.registerNodeType("math/average",b);c.title="TendTo";c.desc="moves the output value always closer to the input";c.prototype.onExecute=function(){var a=this.getInputData(0);null==a&&(a=0);var b=this.properties.factor;this._value=null==this._value?a:this._value*
(1-b)+a*b;this.setOutputData(0,this._value)};v.registerNodeType("math/tendTo",c);m.values="+-*/%^".split("");m.title="Operation";m.desc="Easy math operators";m["@OP"]={type:"enum",title:"operation",values:m.values};m.prototype.setValue=function(a){"string"==typeof a&&(a=parseFloat(a));this.properties.value=a};m.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1);null!=a?this.properties.A=a:a=this.properties.A;null!=b?this.properties.B=b:b=this.properties.B;var c=0;switch(this.properties.OP){case "+":c=
a+b;break;case "-":c=a-b;break;case "x":case "X":case "*":c=a*b;break;case "/":c=a/b;break;case "%":c=a%b;break;case "^":c=Math.pow(a,b);break;default:console.warn("Unknown operation: "+this.properties.OP)}this.setOutputData(0,c)};m.prototype.onDrawBackground=function(a){this.flags.collapsed||(a.font="40px Arial",a.fillStyle="black",a.textAlign="center",a.fillText(this.properties.OP,0.5*this.size[0],0.5*this.size[1]+v.NODE_TITLE_HEIGHT),a.textAlign="left")};v.registerNodeType("math/operation",m);
k.title="Compare";k.desc="compares between two values";k.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1);void 0!==a?this.properties.A=a:a=this.properties.A;void 0!==b?this.properties.B=b:b=this.properties.B;for(var c=0,d=this.outputs.length;c<d;++c){var e=this.outputs[c];if(e.links&&e.links.length){switch(e.name){case "A==B":value=a==b;break;case "A!=B":value=a!=b;break;case "A>B":value=a>b;break;case "A<B":value=a<b;break;case "A<=B":value=a<=b;break;case "A>=B":value=
a>=b}this.setOutputData(c,value)}}};k.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]};v.registerNodeType("math/compare",k);t.values="> < == != <= >=".split(" ");t["@OP"]={type:"enum",title:"operation",values:t.values};t.title="Condition";t.desc="evaluates condition between A and B";t.prototype.onExecute=function(){var a=this.getInputData(0);void 0===a?a=this.properties.A:this.properties.A=a;
var b=this.getInputData(1);void 0===b?b=this.properties.B:this.properties.B=b;var c=!0;switch(this.properties.OP){case ">":c=a>b;break;case "<":c=a<b;break;case "==":c=a==b;break;case "!=":c=a!=b;break;case "<=":c=a<=b;break;case ">=":c=a>=b}this.setOutputData(0,c)};v.registerNodeType("math/condition",t);h.title="Accumulate";h.desc="Increments a value every time";h.prototype.onExecute=function(){null===this.properties.value&&(this.properties.value=0);var a=this.getInputData(0);this.properties.value=
null!==a?this.properties.value+a:this.properties.value+this.properties.increment;this.setOutputData(0,this.properties.value)};v.registerNodeType("math/accumulate",h);x.title="Trigonometry";x.desc="Sin Cos Tan";x.filter="shader";x.prototype.onExecute=function(){var a=this.getInputData(0);null==a&&(a=0);var b=this.properties.amplitude,c=this.findInputSlot("amplitude");-1!=c&&(b=this.getInputData(c));var d=this.properties.offset,c=this.findInputSlot("offset");-1!=c&&(d=this.getInputData(c));for(var c=
0,e=this.outputs.length;c<e;++c){switch(this.outputs[c].name){case "sin":value=Math.sin(a);break;case "cos":value=Math.cos(a);break;case "tan":value=Math.tan(a);break;case "asin":value=Math.asin(a);break;case "acos":value=Math.acos(a);break;case "atan":value=Math.atan(a)}this.setOutputData(c,b*value+d)}};x.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]};x.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],
["asin","number"],["acos","number"],["atan","number"]]};v.registerNodeType("math/trigonometry",x);if(void 0!=typeof math){var D=function(){this.addInputs("x","number");this.addInputs("y","number");this.addOutputs("","number");this.properties={x:1,y:1,formula:"x+y"}};D.title="Formula";D.desc="Compute safe formula";D.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1);null!=a?this.properties.x=a:a=this.properties.x;null!=b?this.properties.y=b:b=this.properties.y;a=math.eval(this.properties.formula,
{x:a,y:b,T:this.graph.globaltime});this.setOutputData(0,a)};D.prototype.onDrawBackground=function(){this.outputs[0].label=this.properties.formula};D.prototype.onGetOutputs=function(){return[["A-B","number"],["A*B","number"],["A/B","number"]]};v.registerNodeType("math/formula",D)}w.title="Vec2->XY";w.desc="vector 2 to components";w.prototype.onExecute=function(){var a=this.getInputData(0);null!=a&&(this.setOutputData(0,a[0]),this.setOutputData(1,a[1]))};v.registerNodeType("math3d/vec2-to-xyz",w);y.title=
"XY->Vec2";y.desc="components to vector2";y.prototype.onExecute=function(){var a=this.getInputData(0);null==a&&(a=this.properties.x);var b=this.getInputData(1);null==b&&(b=this.properties.y);var c=this._data;c[0]=a;c[1]=b;this.setOutputData(0,c)};v.registerNodeType("math3d/xy-to-vec2",y);A.title="Vec3->XYZ";A.desc="vector 3 to components";A.prototype.onExecute=function(){var a=this.getInputData(0);null!=a&&(this.setOutputData(0,a[0]),this.setOutputData(1,a[1]),this.setOutputData(2,a[2]))};v.registerNodeType("math3d/vec3-to-xyz",
A);B.title="XYZ->Vec3";B.desc="components to vector3";B.prototype.onExecute=function(){var a=this.getInputData(0);null==a&&(a=this.properties.x);var b=this.getInputData(1);null==b&&(b=this.properties.y);var c=this.getInputData(2);null==c&&(c=this.properties.z);var d=this._data;d[0]=a;d[1]=b;d[2]=c;this.setOutputData(0,d)};v.registerNodeType("math3d/xyz-to-vec3",B);z.title="Vec4->XYZW";z.desc="vector 4 to components";z.prototype.onExecute=function(){var a=this.getInputData(0);null!=a&&(this.setOutputData(0,
a[0]),this.setOutputData(1,a[1]),this.setOutputData(2,a[2]),this.setOutputData(3,a[3]))};v.registerNodeType("math3d/vec4-to-xyzw",z);C.title="XYZW->Vec4";C.desc="components to vector4";C.prototype.onExecute=function(){var a=this.getInputData(0);null==a&&(a=this.properties.x);var b=this.getInputData(1);null==b&&(b=this.properties.y);var c=this.getInputData(2);null==c&&(c=this.properties.z);var d=this.getInputData(3);null==d&&(d=this.properties.w);var e=this._data;e[0]=a;e[1]=b;e[2]=c;e[3]=d;this.setOutputData(0,
e)};v.registerNodeType("math3d/xyzw-to-vec4",C);r.glMatrix&&(r=function(){this.addOutput("quat","quat");this.properties={x:0,y:0,z:0,w:1};this._value=quat.create()},r.title="Quaternion",r.desc="quaternion",r.prototype.onExecute=function(){this._value[0]=this.properties.x;this._value[1]=this.properties.y;this._value[2]=this.properties.z;this._value[3]=this.properties.w;this.setOutputData(0,this._value)},v.registerNodeType("math3d/quaternion",r),r=function(){this.addInputs([["degrees","number"],["axis",
"vec3"]]);this.addOutput("quat","quat");this.properties={angle:90,axis:vec3.fromValues(0,1,0)};this._value=quat.create()},r.title="Rotation",r.desc="quaternion rotation",r.prototype.onExecute=function(){var a=this.getInputData(0);null==a&&(a=this.properties.angle);var b=this.getInputData(1);null==b&&(b=this.properties.axis);a=quat.setAxisAngle(this._value,b,0.0174532925*a);this.setOutputData(0,a)},v.registerNodeType("math3d/rotation",r),r=function(){this.addInputs([["vec3","vec3"],["quat","quat"]]);
this.addOutput("result","vec3");this.properties={vec:[0,0,1]}},r.title="Rot. Vec3",r.desc="rotate a point",r.prototype.onExecute=function(){var a=this.getInputData(0);null==a&&(a=this.properties.vec);var b=this.getInputData(1);null==b?this.setOutputData(a):this.setOutputData(0,vec3.transformQuat(vec3.create(),a,b))},v.registerNodeType("math3d/rotate_vec3",r),r=function(){this.addInputs([["A","quat"],["B","quat"]]);this.addOutput("A*B","quat");this._value=quat.create()},r.title="Mult. Quat",r.desc=
"rotate quaternion",r.prototype.onExecute=function(){var a=this.getInputData(0);if(null!=a){var b=this.getInputData(1);null!=b&&(a=quat.multiply(this._value,a,b),this.setOutputData(0,a))}},v.registerNodeType("math3d/mult-quat",r),r=function(){this.addInputs([["A","quat"],["B","quat"],["factor","number"]]);this.addOutput("slerp","quat");this.addProperty("factor",0.5);this._value=quat.create()},r.title="Quat Slerp",r.desc="quaternion spherical interpolation",r.prototype.onExecute=function(){var a=this.getInputData(0);
if(null!=a){var b=this.getInputData(1);if(null!=b){var c=this.properties.factor;null!=this.getInputData(2)&&(c=this.getInputData(2));a=quat.slerp(this._value,a,b,c);this.setOutputData(0,a)}}},v.registerNodeType("math3d/quat-slerp",r))})(this);
(function(r){function g(){this.addInput("sel","boolean");this.addOutput("value","number");this.properties={A:0,B:1};this.size=[60,20]}r=r.LiteGraph;g.title="Selector";g.desc="outputs A if selector is true, B if selector is false";g.prototype.onExecute=function(){var f=this.getInputData(0);if(void 0!==f){for(var e=1;e<this.inputs.length;e++){var g=this.inputs[e],q=this.getInputData(e);void 0!==q&&(this.properties[g.name]=q)}e=this.properties.A;g=this.properties.B;this.setOutputData(0,f?e:g)}};g.prototype.onGetInputs=
function(){return[["A",0],["B",0]]};r.registerNodeType("logic/selector",g)})(this);
(function(r){function g(){this.addInput("A","Number");this.addInput("B","Number");this.addInput("C","Number");this.addInput("D","Number");this.values=[[],[],[],[]];this.properties={scale:2}}function f(){this.addOutput("frame","image");this.properties={url:""}}function e(){this.addInput("f","number");this.addOutput("Color","color");this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}function p(){this.addInput("","image");this.size=[200,200]}function q(){this.addInputs([["img1",
"image"],["img2","image"],["fade","number"]]);this.addOutput("","image");this.properties={fade:0.5,width:512,height:512}}function s(){this.addInput("","image");this.addOutput("","image");this.properties={width:256,height:256,x:0,y:0,scale:1};this.size=[50,20]}function u(){this.addInput("t","number");this.addOutputs([["frame","image"],["t","number"],["d","number"]]);this.properties={url:""}}function l(){this.addOutput("Webcam","image");this.properties={}}var n=r.LiteGraph;g.title="Plot";g.desc="Plots data over time";
g.colors=["#FFF","#F99","#9F9","#99F"];g.prototype.onExecute=function(d){if(!this.flags.collapsed){d=this.size;for(var a=0;4>a;++a){var b=this.getInputData(a);if(null!=b){var c=this.values[a];c.push(b);c.length>d[0]&&c.shift()}}}};g.prototype.onDrawBackground=function(d){if(!this.flags.collapsed){var a=this.size,b=0.5*a[1]/this.properties.scale,c=g.colors,e=0.5*a[1];d.fillStyle="#000";d.fillRect(0,0,a[0],a[1]);d.strokeStyle="#555";d.beginPath();d.moveTo(0,e);d.lineTo(a[0],e);d.stroke();for(var f=
0;4>f;++f){var l=this.values[f];d.strokeStyle=c[f];d.beginPath();var h=l[0]*b*-1+e;d.moveTo(0,Math.clamp(h,0,a[1]));for(var n=1;n<l.length&&n<a[0];++n)h=l[n]*b*-1+e,d.lineTo(n,Math.clamp(h,0,a[1]));d.stroke()}}};n.registerNodeType("graphics/plot",g);f.title="Image";f.desc="Image loader";f.widgets=[{name:"load",text:"Load",type:"button"}];f.supported_extensions=["jpg","jpeg","png","gif"];f.prototype.onAdded=function(){""!=this.properties.url&&null==this.img&&this.loadImage(this.properties.url)};f.prototype.onDrawBackground=
function(d){this.img&&5<this.size[0]&&5<this.size[1]&&d.drawImage(this.img,0,0,this.size[0],this.size[1])};f.prototype.onExecute=function(){this.img||(this.boxcolor="#000");this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null);this.img&&this.img.dirty&&(this.img.dirty=!1)};f.prototype.onPropertyChanged=function(d,a){this.properties[d]=a;"url"==d&&""!=a&&this.loadImage(a);return!0};f.prototype.loadImage=function(d,a){if(""==d)this.img=null;else{this.img=document.createElement("img");
"http://"==d.substr(0,7)&&n.proxy&&(d=n.proxy+d.substr(7));this.img.src=d;this.boxcolor="#F95";var b=this;this.img.onload=function(){a&&a(this);b.trace("Image loaded, size: "+b.img.width+"x"+b.img.height);this.dirty=!0;b.boxcolor="#9F9";b.setDirtyCanvas(!0)}}};f.prototype.onWidget=function(d,a){"load"==a.name&&this.loadImage(this.properties.url)};f.prototype.onDropFile=function(d){var a=this;this._url&&URL.revokeObjectURL(this._url);this._url=URL.createObjectURL(d);this.properties.url=this._url;this.loadImage(this._url,
function(b){a.size[1]=b.height/b.width*a.size[0]})};n.registerNodeType("graphics/image",f);e.title="Palette";e.desc="Generates a color";e.prototype.onExecute=function(){var d=[];null!=this.properties.colorA&&d.push(hex2num(this.properties.colorA));null!=this.properties.colorB&&d.push(hex2num(this.properties.colorB));null!=this.properties.colorC&&d.push(hex2num(this.properties.colorC));null!=this.properties.colorD&&d.push(hex2num(this.properties.colorD));var a=this.getInputData(0);null==a&&(a=0.5);
1<a?a=1:0>a&&(a=0);if(0!=d.length){var b=[0,0,0];if(0==a)b=d[0];else if(1==a)b=d[d.length-1];else{var c=(d.length-1)*a,a=d[Math.floor(c)],d=d[Math.floor(c)+1],c=c-Math.floor(c);b[0]=a[0]*(1-c)+d[0]*c;b[1]=a[1]*(1-c)+d[1]*c;b[2]=a[2]*(1-c)+d[2]*c}for(var e in b)b[e]/=255;this.boxcolor=colorToString(b);this.setOutputData(0,b)}};n.registerNodeType("color/palette",e);p.title="Frame";p.desc="Frame viewerew";p.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}];
p.prototype.onDrawBackground=function(d){this.frame&&d.drawImage(this.frame,0,0,this.size[0],this.size[1])};p.prototype.onExecute=function(){this.frame=this.getInputData(0);this.setDirtyCanvas(!0)};p.prototype.onWidget=function(d,a){if("resize"==a.name&&this.frame){var b=this.frame.width,c=this.frame.height;b||null==this.frame.videoWidth||(b=this.frame.videoWidth,c=this.frame.videoHeight);b&&c&&(this.size=[b,c]);this.setDirtyCanvas(!0,!0)}else"view"==a.name&&this.show()};p.prototype.show=function(){showElement&&
this.frame&&showElement(this.frame)};n.registerNodeType("graphics/frame",p);q.title="Image fade";q.desc="Fades between images";q.widgets=[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}];q.prototype.onAdded=function(){this.createCanvas();var d=this.canvas.getContext("2d");d.fillStyle="#000";d.fillRect(0,0,this.properties.width,this.properties.height)};q.prototype.createCanvas=function(){this.canvas=document.createElement("canvas");this.canvas.width=
this.properties.width;this.canvas.height=this.properties.height};q.prototype.onExecute=function(){var d=this.canvas.getContext("2d");this.canvas.width=this.canvas.width;var a=this.getInputData(0);null!=a&&d.drawImage(a,0,0,this.canvas.width,this.canvas.height);a=this.getInputData(2);null==a?a=this.properties.fade:this.properties.fade=a;d.globalAlpha=a;a=this.getInputData(1);null!=a&&d.drawImage(a,0,0,this.canvas.width,this.canvas.height);d.globalAlpha=1;this.setOutputData(0,this.canvas);this.setDirtyCanvas(!0)};
n.registerNodeType("graphics/imagefade",q);s.title="Crop";s.desc="Crop Image";s.prototype.onAdded=function(){this.createCanvas()};s.prototype.createCanvas=function(){this.canvas=document.createElement("canvas");this.canvas.width=this.properties.width;this.canvas.height=this.properties.height};s.prototype.onExecute=function(){var d=this.getInputData(0);d&&(d.width?(this.canvas.getContext("2d").drawImage(d,-this.properties.x,-this.properties.y,d.width*this.properties.scale,d.height*this.properties.scale),
this.setOutputData(0,this.canvas)):this.setOutputData(0,null))};s.prototype.onDrawBackground=function(d){this.flags.collapsed||this.canvas&&d.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])};s.prototype.onPropertyChanged=function(d,a){this.properties[d]=a;"scale"==d?(this.properties[d]=parseFloat(a),0==this.properties[d]&&(this.trace("Error in scale"),this.properties[d]=1)):this.properties[d]=parseInt(a);this.createCanvas();return!0};n.registerNodeType("graphics/cropImage",
s);u.title="Video";u.desc="Video playback";u.widgets=[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}];u.prototype.onExecute=function(){if(this.properties.url&&(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),this._video&&0!=this._video.width)){var d=this.getInputData(0);d&&0<=d&&1>=d&&(this._video.currentTime=d*this._video.duration,this._video.pause());
this._video.dirty=!0;this.setOutputData(0,this._video);this.setOutputData(1,this._video.currentTime);this.setOutputData(2,this._video.duration);this.setDirtyCanvas(!0)}};u.prototype.onStart=function(){this.play()};u.prototype.onStop=function(){this.stop()};u.prototype.loadVideo=function(d){this._video_url=d;this._video=document.createElement("video");this._video.src=d;this._video.type="type=video/mp4";this._video.muted=!0;this._video.autoplay=!0;var a=this;this._video.addEventListener("loadedmetadata",
function(b){a.trace("Duration: "+this.duration+" seconds");a.trace("Size: "+this.videoWidth+","+this.videoHeight);a.setDirtyCanvas(!0);this.width=this.videoWidth;this.height=this.videoHeight});this._video.addEventListener("progress",function(a){});this._video.addEventListener("error",function(b){console.log("Error loading video: "+this.src);a.trace("Error loading video: "+this.src);if(this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:a.trace("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:a.trace("Network error - please try again later.");
break;case this.error.MEDIA_ERR_DECODE:a.trace("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:a.trace("Sorry, your browser can't play this video.")}});this._video.addEventListener("ended",function(b){a.trace("Ended.");this.play()})};u.prototype.onPropertyChanged=function(d,a){this.properties[d]=a;"url"==d&&""!=a&&this.loadVideo(a);return!0};u.prototype.play=function(){this._video&&this._video.play()};u.prototype.playPause=function(){this._video&&(this._video.paused?this.play():
this.pause())};u.prototype.stop=function(){this._video&&(this._video.pause(),this._video.currentTime=0)};u.prototype.pause=function(){this._video&&(this.trace("Video paused"),this._video.pause())};u.prototype.onWidget=function(d,a){};n.registerNodeType("graphics/video",u);l.title="Webcam";l.desc="Webcam image";l.prototype.openStream=function(){function d(b){console.log("Webcam rejected",b);a._webcam_stream=!1;a.box_color="red"}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||
navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;if(navigator.getUserMedia){this._waiting_confirmation=!0;navigator.getUserMedia({video:!0},this.streamReady.bind(this),d);var a=this}};l.prototype.onRemoved=function(){this._webcam_stream&&(this._webcam_stream.stop(),this._video=this._webcam_stream=null)};l.prototype.streamReady=function(d){this._webcam_stream=d;var a=this._video;a||(a=document.createElement("video"),a.autoplay=!0,a.src=window.URL.createObjectURL(d),
this._video=a,a.onloadedmetadata=function(a){console.log(a)})};l.prototype.onExecute=function(){null!=this._webcam_stream||this._waiting_confirmation||this.openStream();this._video&&this._video.videoWidth&&(this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video))};l.prototype.getExtraMenuOptions=function(d){var a=this;return[{content:a.properties.show?"Hide Frame":"Show Frame",callback:function(){a.properties.show=!a.properties.show}}]};
l.prototype.onDrawBackground=function(d){this.flags.collapsed||20>=this.size[1]||!this.properties.show||!this._video||(d.save(),d.drawImage(this._video,0,0,this.size[0],this.size[1]),d.restore())};n.registerNodeType("graphics/webcam",l)})(this);
(function(r){var g=r.LiteGraph;r.LGraphTexture=null;if("undefined"!=typeof GL){var f=function(){this.addOutput("Texture","Texture");this.properties={name:"",filter:!0};this.size=[f.image_preview_size,f.image_preview_size]};r.LGraphTexture=f;f.title="Texture";f.desc="Texture";f.widgets_info={name:{widget:"texture"},filter:{widget:"checkbox"}};f.loadTextureCallback=null;f.image_preview_size=256;f.PASS_THROUGH=1;f.COPY=2;f.LOW=3;f.HIGH=4;f.REUSE=5;f.DEFAULT=2;f.MODE_VALUES={"pass through":f.PASS_THROUGH,
copy:f.COPY,low:f.LOW,high:f.HIGH,reuse:f.REUSE,"default":f.DEFAULT};f.getTexturesContainer=function(){return gl.textures};f.loadTexture=function(a,b){b=b||{};var c=a;"http://"==c.substr(0,7)&&g.proxy&&(c=g.proxy+c.substr(7));return f.getTexturesContainer()[a]=GL.Texture.fromURL(c,b)};f.getTexture=function(a){var b=this.getTexturesContainer();if(!b)throw"Cannot load texture, container of textures not found";b=b[a];return!b&&a&&":"!=a[0]?this.loadTexture(a):b};f.getTargetTexture=function(a,b,c){if(!a)throw"LGraphTexture.getTargetTexture expects a reference texture";
var d=null;switch(c){case f.LOW:d=gl.UNSIGNED_BYTE;break;case f.HIGH:d=gl.HIGH_PRECISION_FORMAT;break;case f.REUSE:return a;default:d=a?a.type:gl.UNSIGNED_BYTE}b&&b.width==a.width&&b.height==a.height&&b.type==d||(b=new GL.Texture(a.width,a.height,{type:d,format:gl.RGBA,filter:gl.LINEAR}));return b};f.getTextureType=function(a,b){var c=b?b.type:gl.UNSIGNED_BYTE;switch(a){case f.LOW:c=gl.UNSIGNED_BYTE;break;case f.HIGH:c=gl.HIGH_PRECISION_FORMAT}return c};f.getNoiseTexture=function(){if(this._noise_texture)return this._noise_texture;
for(var a=new Uint8Array(1048576),b=0;1048576>b;++b)a[b]=255*Math.random();return this._noise_texture=a=GL.Texture.fromMemory(512,512,a,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST})};f.prototype.onDropFile=function(a,b,c){if(a){var d=null;"string"==typeof a?d=GL.Texture.fromURL(a):-1!=b.toLowerCase().indexOf(".dds")?d=GL.Texture.fromDDSInMemory(a):(a=new Blob([c]),a=URL.createObjectURL(a),d=GL.Texture.fromURL(a));this._drop_texture=d;this.properties.name=b}else this._drop_texture=null,this.properties.name=
""};f.prototype.getExtraMenuOptions=function(a){var b=this;if(this._drop_texture)return[{content:"Clear",callback:function(){b._drop_texture=null;b.properties.name=""}}]};f.prototype.onExecute=function(){var a=null;this.isOutputConnected(1)&&(a=this.getInputData(0));!a&&this._drop_texture&&(a=this._drop_texture);!a&&this.properties.name&&(a=f.getTexture(this.properties.name));if(a){this._last_tex=a;!1===this.properties.filter?a.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST):a.setParameter(gl.TEXTURE_MAG_FILTER,
gl.LINEAR);this.setOutputData(0,a);for(var b=1;b<this.outputs.length;b++){var c=this.outputs[b];if(c){var d=null;"width"==c.name?d=a.width:"height"==c.name?d=a.height:"aspect"==c.name&&(d=a.width/a.height);this.setOutputData(b,d)}}}};f.prototype.onResourceRenamed=function(a,b){this.properties.name==a&&(this.properties.name=b)};f.prototype.onDrawBackground=function(a){if(!(this.flags.collapsed||20>=this.size[1]))if(this._drop_texture&&a.webgl)a.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);
else{if(this._last_preview_tex!=this._last_tex)if(a.webgl)this._canvas=this._last_tex;else{var b=f.generateLowResTexturePreview(this._last_tex);if(!b)return;this._last_preview_tex=this._last_tex;this._canvas=cloneCanvas(b)}this._canvas&&(a.save(),a.webgl||(a.translate(0,this.size[1]),a.scale(1,-1)),a.drawImage(this._canvas,0,0,this.size[0],this.size[1]),a.restore())}};f.generateLowResTexturePreview=function(a){if(!a)return null;var b=f.image_preview_size,c=a;if(a.format==gl.DEPTH_COMPONENT)return null;
if(a.width>b||a.height>b)c=this._preview_temp_tex,this._preview_temp_tex||(this._preview_temp_tex=c=new GL.Texture(b,b,{minFilter:gl.NEAREST})),a.copyTo(c);a=this._preview_canvas;a||(this._preview_canvas=a=createCanvas(b,b));c&&c.toCanvas(a);return a};f.prototype.getResources=function(a){a[this.properties.name]=GL.Texture;return a};f.prototype.onGetInputs=function(){return[["in","Texture"]]};f.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["aspect","number"]]};g.registerNodeType("texture/texture",
f);var e=function(){this.addInput("Texture","Texture");this.properties={flipY:!1};this.size=[f.image_preview_size,f.image_preview_size]};e.title="Preview";e.desc="Show a texture in the graph canvas";e.allow_preview=!1;e.prototype.onDrawBackground=function(a){if(!this.flags.collapsed&&(a.webgl||e.allow_preview)){var b=this.getInputData(0);if(b){var c=null,c=!b.handle&&a.webgl?b:f.generateLowResTexturePreview(b);a.save();this.properties.flipY&&(a.translate(0,this.size[1]),a.scale(1,-1));a.drawImage(c,
0,0,this.size[0],this.size[1]);a.restore()}}};g.registerNodeType("texture/preview",e);r=function(){this.addInput("Texture","Texture");this.addOutput("","Texture");this.properties={name:""}};r.title="Save";r.desc="Save a texture in the repository";r.prototype.onExecute=function(){var a=this.getInputData(0);a&&(this.properties.name&&(f.storeTexture?f.storeTexture(this.properties.name,a):f.getTexturesContainer()[this.properties.name]=a),this.setOutputData(0,a))};g.registerNodeType("texture/save",r);
var p=function(){this.addInput("Texture","Texture");this.addInput("TextureB","Texture");this.addInput("value","number");this.addOutput("Texture","Texture");this.help="<p>pixelcode must be vec3</p>\t\t\t<p>uvcode must be vec2, is optional</p>\t\t\t<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture</p><p><strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time</p><p><strong>value:</strong> input value</p>";this.properties={value:1,uvcode:"",pixelcode:"color + colorB * value",
precision:f.DEFAULT}};p.widgets_info={uvcode:{widget:"textarea",height:100},pixelcode:{widget:"textarea",height:100},precision:{widget:"combo",values:f.MODE_VALUES}};p.title="Operation";p.desc="Texture shader operation";p.prototype.getExtraMenuOptions=function(a){var b=this;return[{content:b.properties.show?"Hide Texture":"Show Texture",callback:function(){b.properties.show=!b.properties.show}}]};p.prototype.onDrawBackground=function(a){this.flags.collapsed||20>=this.size[1]||!this.properties.show||
!this._tex||this._tex.gl!=a||(a.save(),a.drawImage(this._tex,0,0,this.size[0],this.size[1]),a.restore())};p.prototype.onExecute=function(){var a=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision===f.PASS_THROUGH)this.setOutputData(0,a);else{var b=this.getInputData(1);if(this.properties.uvcode||this.properties.pixelcode){var c=512,d=512;a?(c=a.width,d=a.height):b&&(c=b.width,d=b.height);var e=f.getTextureType(this.properties.precision,a);this._tex=a||this._tex?f.getTargetTexture(a||
this._tex,this._tex,this.properties.precision):new GL.Texture(c,d,{type:e,format:gl.RGBA,filter:gl.LINEAR});e="";this.properties.uvcode&&(e="uv = "+this.properties.uvcode,-1!=this.properties.uvcode.indexOf(";")&&(e=this.properties.uvcode));var h="";this.properties.pixelcode&&(h="result = "+this.properties.pixelcode,-1!=this.properties.pixelcode.indexOf(";")&&(h=this.properties.pixelcode));var g=this._shader;if(!g||this._shader_code!=e+"|"+h){try{this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,
p.pixel_shader,{UV_CODE:e,PIXEL_CODE:h}),this.boxcolor="#00FF00"}catch(k){console.log("Error compiling shader: ",k);this.boxcolor="#FF0000";return}this.boxcolor="#FF0000";this._shader_code=e+"|"+h;g=this._shader}if(g){this.boxcolor="green";var l=this.getInputData(2);null!=l?this.properties.value=l:l=parseFloat(this.properties.value);var m=this.graph.getTime();this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);a&&a.bind(0);b&&b.bind(1);var e=Mesh.getScreenQuad();
g.uniforms({u_texture:0,u_textureB:1,value:l,texSize:[c,d],time:m}).draw(e)});this.setOutputData(0,this._tex)}else this.boxcolor="red"}}};p.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 texSize;\n\t\t\tuniform float time;\n\t\t\tuniform float value;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tUV_CODE;\n\t\t\t\tvec4 color4 = texture2D(u_texture, uv);\n\t\t\t\tvec3 color = color4.rgb;\n\t\t\t\tvec4 color4B = texture2D(u_textureB, uv);\n\t\t\t\tvec3 colorB = color4B.rgb;\n\t\t\t\tvec3 result = color;\n\t\t\t\tfloat alpha = 1.0;\n\t\t\t\tPIXEL_CODE;\n\t\t\t\tgl_FragColor = vec4(result, alpha);\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/operation",p);var q=function(){this.addOutput("Texture","Texture");this.properties={code:"",width:512,height:512,precision:f.DEFAULT};this.properties.code="\nvoid main() {\n  vec2 uv = v_coord;\n  vec3 color = vec3(0.0);\n//your code here\n\ngl_FragColor = vec4(color, 1.0);\n}\n";this._uniforms={texSize:vec2.create(),time:time}};q.title="Shader";q.desc="Texture shader";q.widgets_info={code:{type:"code"},precision:{widget:"combo",values:f.MODE_VALUES}};q.prototype.onPropertyChanged=
function(a,b){if("code"==a){var c=this.getShader();if(c){var d=c.uniformInfo;if(this.inputs)for(var e={},f=0;f<this.inputs.length;++f){var h=this.getInputInfo(f);h&&(d[h.name]&&!e[h.name]?e[h.name]=!0:(this.removeInput(f),f--))}for(f in d)if(h=c.uniformInfo[f],null!==h.loc&&"time"!=f){d="number";if(this._shader.samplers[f])d="texture";else switch(h.size){case 1:d="number";break;case 2:d="vec2";break;case 3:d="vec3";break;case 4:d="vec4";break;case 9:d="mat3";break;case 16:d="mat4";break;default:continue}h=
this.findInputSlot(f);-1==h?this.addInput(f,d):(e=this.getInputInfo(h),e)?e.type!=d&&(this.removeInput(h,d),this.addInput(f,d)):this.addInput(f,d)}}}};q.prototype.getShader=function(){if(this._shader&&this._shader_code==this.properties.code)return this._shader;this._shader_code=this.properties.code;if(this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,q.pixel_shader+this.properties.code))this.boxcolor="green";else return this.boxcolor="red",null;return this._shader};q.prototype.onExecute=function(){if(this.isOutputConnected(0)){var a=
this.getShader();if(a){for(var b=0;b<this.inputs.length;++b){var c=this.getInputInfo(b),d=this.getInputData(b);null!=d&&(d.constructor===GL.Texture&&(d.bind(slot),d=slot,slot++),a.setUniform(c.name,d))}var e=this._uniforms,b=f.getTextureType(this.properties.precision),c=this.properties.width|0,d=this.properties.height|0;e.texSize[0]=c;e.texSize[1]=d;this._tex&&this._tex.type==b&&this._tex.width==c&&this._tex.height==d||(this._tex=new GL.Texture(c,d,{type:b,format:gl.RGBA,filter:gl.LINEAR}));b=this._tex;
this.graph.getTime();b.drawTo(function(){a.uniforms(e).draw(GL.Mesh.getScreenQuad())});this.setOutputData(0,this._tex)}}};q.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform float time;\n\t\t\t";g.registerNodeType("texture/shader",q);var s=function(){this.addInput("in","Texture");this.addInput("scale","vec2");this.addInput("offset","vec2");this.addOutput("out","Texture");this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:f.DEFAULT}};
s.widgets_info={precision:{widget:"combo",values:f.MODE_VALUES}};s.title="Scale/Offset";s.desc="Applies an scaling and offseting";s.prototype.onExecute=function(){var a=this.getInputData(0);if(this.isOutputConnected(0)&&a)if(this.properties.precision===f.PASS_THROUGH)this.setOutputData(0,a);else{var b=a.width,c=a.height,d=this.precision===f.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===f.DEFAULT&&(d=a.type);this._tex&&this._tex.width==b&&this._tex.height==c&&this._tex.type==d||(this._tex=
new GL.Texture(b,c,{type:d,format:gl.RGBA,filter:gl.LINEAR}));var e=this._shader;e||(e=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,s.pixel_shader));var h=this.getInputData(1);h?(this.properties.scale[0]=h[0],this.properties.scale[1]=h[1]):h=this.properties.scale;var g=this.getInputData(2);g?(this.properties.offset[0]=g[0],this.properties.offset[1]=g[1]):g=this.properties.offset;this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);a.bind(0);var b=Mesh.getScreenQuad();
e.uniforms({u_texture:0,u_scale:h,u_offset:g}).draw(b)});this.setOutputData(0,this._tex)}};s.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_scale;\n\t\t\tuniform vec2 u_offset;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tuv = uv / u_scale - u_offset;\n\t\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";g.registerNodeType("texture/scaleOffset",
s);var u=function(){this.addInput("in","Texture");this.addInput("warp","Texture");this.addInput("factor","number");this.addOutput("out","Texture");this.properties={factor:0.01,precision:f.DEFAULT}};u.widgets_info={precision:{widget:"combo",values:f.MODE_VALUES}};u.title="Warp";u.desc="Texture warp operation";u.prototype.onExecute=function(){var a=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision===f.PASS_THROUGH)this.setOutputData(0,a);else{var b=this.getInputData(1),
c=512,d=512;a?(c=a.width,d=a.height):b&&(c=b.width,d=b.height);this._tex=a||this._tex?f.getTargetTexture(a||this._tex,this._tex,this.properties.precision):new GL.Texture(c,d,{type:this.precision===f.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,format:gl.RGBA,filter:gl.LINEAR});var e=this._shader;e||(e=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,u.pixel_shader));var h=this.getInputData(2);null!=h?this.properties.factor=h:h=parseFloat(this.properties.factor);this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);
gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);a&&a.bind(0);b&&b.bind(1);var c=Mesh.getScreenQuad();e.uniforms({u_texture:0,u_textureB:1,u_factor:h}).draw(c)});this.setOutputData(0,this._tex)}};u.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform float u_factor;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tuv += ( texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor;\n\t\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/warp",u);var l=function(){this.addInput("Texture","Texture");this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1};this.size[0]=130};l.title="to Viewport";l.desc="Texture to viewport";l.prototype.onExecute=function(){var a=this.getInputData(0);if(a){this.properties.disable_alpha?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),this.properties.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA));gl.disable(gl.DEPTH_TEST);
var b=this.properties.gamma||1;this.isInputConnected(1)&&(b=this.getInputData(1));a.setParameter(gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST);if(this.properties.antialiasing){l._shader||(l._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,l.aa_pixel_shader));gl.getViewport();var c=Mesh.getScreenQuad();a.bind(0);l._shader.uniforms({u_texture:0,uViewportSize:[a.width,a.height],u_igamma:1/b,inverseVP:[1/a.width,1/a.height]}).draw(c)}else 1!=b?(l._gamma_shader||(l._gamma_shader=
new GL.Shader(Shader.SCREEN_VERTEX_SHADER,l.gamma_pixel_shader)),a.toViewport(l._gamma_shader,{u_texture:0,u_igamma:1/b})):a.toViewport()}};l.prototype.onGetInputs=function(){return[["gamma","number"]]};l.aa_pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 uViewportSize;\n\t\t\tuniform vec2 inverseVP;\n\t\t\tuniform float u_igamma;\n\t\t\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t\t\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t\t\t#define FXAA_SPAN_MAX     8.0\n\t\t\t\n\t\t\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t\t\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t\t\t{\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\t/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/\n\t\t\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;\n\t\t\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\t\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\t\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\t\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\t\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\t\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\t\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\t\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\t\t\n\t\t\t\tvec2 dir;\n\t\t\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\t\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\t\t\n\t\t\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\t\t\n\t\t\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\t\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;\n\t\t\t\t\n\t\t\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\t\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\t\t\t\t\n\t\t\t\t//return vec4(rgbA,1.0);\n\t\t\t\tfloat lumaB = dot(rgbB, luma);\n\t\t\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\t\t\tcolor = vec4(rgbA, 1.0);\n\t\t\t\telse\n\t\t\t\t\tcolor = vec4(rgbB, 1.0);\n\t\t\t\tif(u_igamma != 1.0)\n\t\t\t\t\tcolor.xyz = pow( color.xyz, vec3(u_igamma) );\n\t\t\t\treturn color;\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;\n\t\t\t}\n\t\t\t";
l.gamma_pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_igamma;\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_texture, v_coord);\n\t\t\t\tcolor.xyz = pow(color.xyz, vec3(u_igamma) );\n\t\t\t   gl_FragColor = color;\n\t\t\t}\n\t\t\t";g.registerNodeType("texture/toviewport",l);r=function(){this.addInput("Texture","Texture");this.addOutput("","Texture");this.properties={size:0,generate_mipmaps:!1,
precision:f.DEFAULT}};r.title="Copy";r.desc="Copy Texture";r.widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:f.MODE_VALUES}};r.prototype.onExecute=function(){var a=this.getInputData(0);if((a||this._temp_texture)&&this.isOutputConnected(0)){if(a){var b=a.width,c=a.height;0!=this.properties.size&&(c=b=this.properties.size);var d=this._temp_texture,e=a.type;this.properties.precision===f.LOW?e=gl.UNSIGNED_BYTE:this.properties.precision===f.HIGH&&
(e=gl.HIGH_PRECISION_FORMAT);d&&d.width==b&&d.height==c&&d.type==e||(d=gl.LINEAR,this.properties.generate_mipmaps&&isPowerOfTwo(b)&&isPowerOfTwo(c)&&(d=gl.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL.Texture(b,c,{type:e,format:gl.RGBA,minFilter:d,magFilter:gl.LINEAR}));a.copyTo(this._temp_texture);this.properties.generate_mipmaps&&(this._temp_texture.bind(0),gl.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0))}this.setOutputData(0,this._temp_texture)}};g.registerNodeType("texture/copy",
r);var n=function(){this.addInput("Texture","Texture");this.addOutput("","Texture");this.properties={iterations:1,generate_mipmaps:!1,precision:f.DEFAULT}};n.title="Downsample";n.desc="Downsample Texture";n.widgets_info={iterations:{type:"number",step:1,precision:0,min:1},precision:{widget:"combo",values:f.MODE_VALUES}};n.prototype.onExecute=function(){var a=this.getInputData(0);if((a||this._temp_texture)&&this.isOutputConnected(0)&&a&&a.texture_type===GL.TEXTURE_2D){var b=n._shader;b||(n._shader=
b=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,n.pixel_shader));var c=a.width|0,d=a.height|0,e=a.type;this.properties.precision===f.LOW?e=gl.UNSIGNED_BYTE:this.properties.precision===f.HIGH&&(e=gl.HIGH_PRECISION_FORMAT);var h=this.properties.iterations||1,g=a,k=null,l=[],a={type:e,format:a.format},e=vec2.create(),m={u_offset:e};this._texture&&GL.Texture.releaseTemporary(this._texture);for(var p=0;p<h;++p){e[0]=1/c;e[1]=1/d;c=c>>1||0;d=d>>1||0;k=GL.Texture.getTemporary(c,d,a);l.push(k);g.setParameter(GL.TEXTURE_MAG_FILTER,
GL.NEAREST);g.copyTo(k,b,m);if(1==c&&1==d)break;g=k}this._texture=l.pop();for(p=0;p<l.length;++p)GL.Texture.releaseTemporary(l[p]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0));this.setOutputData(0,this._texture)}};n.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tvarying vec2 v_coord;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord );\n\t\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, 0.0 ) );\n\t\t\t\tcolor += texture2D(u_texture, v_coord + vec2( 0.0, u_offset.y ) );\n\t\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, u_offset.y ) );\n\t\t\t   gl_FragColor = color * 0.25;\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/downsample",n);var d=function(){this.addInput("Texture","Texture");this.addOutput("tex","Texture");this.addOutput("avg","vec4");this.addOutput("lum","number");this.properties={mipmap_offset:0,low_precision:!1};this._uniforms={u_texture:0,u_mipmap_offset:this.properties.mipmap_offset};this._luminance=new Float32Array(4)};d.title="Average";d.desc="Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture";d.prototype.onExecute=function(){var a=
this.getInputData(0);if(a&&(this.isOutputConnected(0)||this.isOutputConnected(1)||this.isOutputConnected(2))){if(!d._shader){d._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,d.pixel_shader);for(var b=new Float32Array(32),c=0;32>c;++c)b[c]=Math.random();d._shader.uniforms({u_samples_a:b.subarray(0,16),u_samples_b:b.subarray(16,32)})}c=this._temp_texture;b=gl.UNSIGNED_BYTE;a.type!=b&&(b=gl.FLOAT);c&&c.type==b||(this._temp_texture=new GL.Texture(1,1,{type:b,format:gl.RGBA,filter:gl.NEAREST}));
var e=d._shader,f=this._uniforms;f.u_mipmap_offset=this.properties.mipmap_offset;this._temp_texture.drawTo(function(){a.toViewport(e,f)});this.setOutputData(0,this._temp_texture);if(this.isOutputConnected(1)||this.isOutputConnected(2))if(c=this._temp_texture.getPixels()){var h=this._luminance,b=this._temp_texture.type;h.set(c);b==gl.UNSIGNED_BYTE?vec4.scale(h,h,1/255):b!=GL.HALF_FLOAT&&b!=GL.HALF_FLOAT_OES||vec4.scale(h,h,1/65025);this.setOutputData(1,h);this.setOutputData(2,(h[0]+h[1]+h[2])/3)}}};
d.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tuniform mat4 u_samples_a;\n\t\t\tuniform mat4 u_samples_b;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_mipmap_offset;\n\t\t\tvarying vec2 v_coord;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor(int i = 0; i < 4; ++i)\n\t\t\t\t\tfor(int j = 0; j < 4; ++j)\n\t\t\t\t\t{\n\t\t\t\t\t\tcolor += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t\t\tcolor += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t\t}\n\t\t\t   gl_FragColor = color * 0.03125;\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/average",d);r=function(){this.addInput("Image","image");this.addOutput("","Texture");this.properties={}};r.title="Image to Texture";r.desc="Uploads an image to the GPU";r.prototype.onExecute=function(){var a=this.getInputData(0);if(a){var b=a.videoWidth||a.width,c=a.videoHeight||a.height;if(a.gltexture)this.setOutputData(0,a.gltexture);else{var d=this._temp_texture;d&&d.width==b&&d.height==c||(this._temp_texture=new GL.Texture(b,c,{format:gl.RGBA,filter:gl.LINEAR}));try{this._temp_texture.uploadImage(a)}catch(e){console.error("image comes from an unsafe location, cannot be uploaded to webgl");
return}this.setOutputData(0,this._temp_texture)}}};g.registerNodeType("texture/imageToTexture",r);var a=function(){this.addInput("Texture","Texture");this.addInput("LUT","Texture");this.addInput("Intensity","number");this.addOutput("","Texture");this.properties={intensity:1,precision:f.DEFAULT,texture:null};a._shader||(a._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,a.pixel_shader))};a.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:f.MODE_VALUES}};a.title="LUT";a.desc=
"Apply LUT to Texture";a.prototype.onExecute=function(){if(this.isOutputConnected(0)){var b=this.getInputData(0);if(this.properties.precision===f.PASS_THROUGH)this.setOutputData(0,b);else if(b){var c=this.getInputData(1);c||(c=f.getTexture(this.properties.texture));if(c){c.bind(0);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,
null);var d=this.properties.intensity;this.isInputConnected(2)&&(this.properties.intensity=d=this.getInputData(2));this._tex=f.getTargetTexture(b,this._tex,this.properties.precision);this._tex.drawTo(function(){c.bind(1);b.toViewport(a._shader,{u_texture:0,u_textureB:1,u_amount:d})});this.setOutputData(0,this._tex)}else this.setOutputData(0,b)}}};a.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tuniform float u_amount;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\t lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );\n\t\t\t\t mediump float blueColor = textureColor.b * 63.0;\n\t\t\t\t mediump vec2 quad1;\n\t\t\t\t quad1.y = floor(floor(blueColor) / 8.0);\n\t\t\t\t quad1.x = floor(blueColor) - (quad1.y * 8.0);\n\t\t\t\t mediump vec2 quad2;\n\t\t\t\t quad2.y = floor(ceil(blueColor) / 8.0);\n\t\t\t\t quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n\t\t\t\t highp vec2 texPos1;\n\t\t\t\t texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t\t texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t\t highp vec2 texPos2;\n\t\t\t\t texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t\t texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t\t lowp vec4 newColor1 = texture2D(u_textureB, texPos1);\n\t\t\t\t lowp vec4 newColor2 = texture2D(u_textureB, texPos2);\n\t\t\t\t lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n\t\t\t\t gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/LUT",a);var b=function(){this.addInput("Texture","Texture");this.addOutput("R","Texture");this.addOutput("G","Texture");this.addOutput("B","Texture");this.addOutput("A","Texture");this.properties={};b._shader||(b._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,b.pixel_shader))};b.title="Texture to Channels";b.desc="Split texture channels";b.prototype.onExecute=function(){var a=this.getInputData(0);if(a){this._channels||(this._channels=Array(4));for(var c=0,d=0;4>d;d++)this.isOutputConnected(d)?
(this._channels[d]&&this._channels[d].width==a.width&&this._channels[d].height==a.height&&this._channels[d].type==a.type||(this._channels[d]=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR})),c++):this._channels[d]=null;if(c){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);for(var e=Mesh.getScreenQuad(),f=b._shader,h=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],d=0;4>d;d++)this._channels[d]&&(this._channels[d].drawTo(function(){a.bind(0);f.uniforms({u_texture:0,u_mask:h[d]}).draw(e)}),
this.setOutputData(d,this._channels[d]))}}};b.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_mask;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );\n\t\t\t}\n\t\t\t";g.registerNodeType("texture/textureChannels",b);var c=function(){this.addInput("R","Texture");this.addInput("G","Texture");this.addInput("B","Texture");this.addInput("A",
"Texture");this.addOutput("Texture","Texture");this.properties={};c._shader||(c._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,c.pixel_shader))};c.title="Channels to Texture";c.desc="Split texture channels";c.prototype.onExecute=function(){var a=[this.getInputData(0),this.getInputData(1),this.getInputData(2),this.getInputData(3)];if(a[0]&&a[1]&&a[2]&&a[3]){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var b=Mesh.getScreenQuad(),d=c._shader;this._tex=f.getTargetTexture(a[0],this._tex);this._tex.drawTo(function(){a[0].bind(0);
a[1].bind(1);a[2].bind(2);a[3].bind(3);d.uniforms({u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3}).draw(b)});this.setOutputData(0,this._tex)}};c.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_textureR;\n\t\t\tuniform sampler2D u_textureG;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tuniform sampler2D u_textureA;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = vec4( \t\t\t\t\t\ttexture2D(u_textureR, v_coord).r,\t\t\t\t\t\ttexture2D(u_textureG, v_coord).r,\t\t\t\t\t\ttexture2D(u_textureB, v_coord).r,\t\t\t\t\t\ttexture2D(u_textureA, v_coord).r);\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/channelsTexture",c);var m=function(){this.addInput("A","color");this.addInput("B","color");this.addOutput("Texture","Texture");this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32};m._shader||(m._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,m.pixel_shader));this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}};m.title="Gradient";m.desc="Generates a gradient";m["@A"]={type:"color"};m["@B"]={type:"color"};m["@texture_size"]={type:"enum",
values:[32,64,128,256,512]};m.prototype.onExecute=function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var a=GL.Mesh.getScreenQuad(),b=m._shader,c=this.getInputData(0);c||(c=this.properties.A);var d=this.getInputData(1);d||(d=this.properties.B);for(var e=2;e<this.inputs.length;e++){var f=this.inputs[e],h=this.getInputData(e);void 0!==h&&(this.properties[f.name]=h)}var g=this._uniforms;this._uniforms.u_angle=this.properties.angle*DEG2RAD;this._uniforms.u_scale=this.properties.scale;vec3.copy(g.u_colorA,
c);vec3.copy(g.u_colorB,d);c=parseInt(this.properties.texture_size);this._tex&&this._tex.width==c||(this._tex=new GL.Texture(c,c,{format:gl.RGB,filter:gl.LINEAR}));this._tex.drawTo(function(){b.uniforms(g).draw(a)});this.setOutputData(0,this._tex)};m.prototype.onGetInputs=function(){return[["angle","number"],["scale","number"]]};m.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform float u_angle;\n\t\t\tuniform float u_scale;\n\t\t\tuniform vec3 u_colorA;\n\t\t\tuniform vec3 u_colorB;\n\t\t\t\n\t\t\tvec2 rotate(vec2 v, float angle)\n\t\t\t{\n\t\t\t\tvec2 result;\n\t\t\t\tfloat _cos = cos(angle);\n\t\t\t\tfloat _sin = sin(angle);\n\t\t\t\tresult.x = v.x * _cos - v.y * _sin;\n\t\t\t\tresult.y = v.x * _sin + v.y * _cos;\n\t\t\t\treturn result;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tfloat f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;\n\t\t\t\tvec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));\n\t\t\t   gl_FragColor = vec4(color,1.0);\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/gradient",m);var k=function(){this.addInput("A","Texture");this.addInput("B","Texture");this.addInput("Mixer","Texture");this.addOutput("Texture","Texture");this.properties={precision:f.DEFAULT};k._shader||(k._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,k.pixel_shader))};k.title="Mix";k.desc="Generates a texture mixing two textures";k.widgets_info={precision:{widget:"combo",values:f.MODE_VALUES}};k.prototype.onExecute=function(){var a=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision===
f.PASS_THROUGH)this.setOutputData(0,a);else{var b=this.getInputData(1),c=this.getInputData(2);if(a&&b&&c){this._tex=f.getTargetTexture(a,this._tex,this.properties.precision);gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var d=Mesh.getScreenQuad(),e=k._shader;this._tex.drawTo(function(){a.bind(0);b.bind(1);c.bind(2);e.uniforms({u_textureA:0,u_textureB:1,u_textureMix:2}).draw(d)});this.setOutputData(0,this._tex)}}};k.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_textureA;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tuniform sampler2D u_textureMix;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), texture2D(u_textureMix, v_coord) );\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/mix",k);var t=function(){this.addInput("Tex.","Texture");this.addOutput("Edges","Texture");this.properties={invert:!0,threshold:!1,factor:1,precision:f.DEFAULT};t._shader||(t._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,t.pixel_shader))};t.title="Edges";t.desc="Detects edges";t.widgets_info={precision:{widget:"combo",values:f.MODE_VALUES}};t.prototype.onExecute=function(){if(this.isOutputConnected(0)){var a=this.getInputData(0);if(this.properties.precision===f.PASS_THROUGH)this.setOutputData(0,
a);else if(a){this._tex=f.getTargetTexture(a,this._tex,this.properties.precision);gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var b=Mesh.getScreenQuad(),c=t._shader,d=this.properties.invert,e=this.properties.factor,h=this.properties.threshold?1:0;this._tex.drawTo(function(){a.bind(0);c.uniforms({u_texture:0,u_isize:[1/a.width,1/a.height],u_factor:e,u_threshold:h,u_invert:d?1:0}).draw(b)});this.setOutputData(0,this._tex)}}};t.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_isize;\n\t\t\tuniform int u_invert;\n\t\t\tuniform float u_factor;\n\t\t\tuniform float u_threshold;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 center = texture2D(u_texture, v_coord);\n\t\t\t\tvec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );\n\t\t\t\tvec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );\n\t\t\t\tvec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );\n\t\t\t\tvec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );\n\t\t\t\tvec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);\n\t\t\t\tdiff *= u_factor;\n\t\t\t\tif(u_invert == 1)\n\t\t\t\t\tdiff.xyz = vec3(1.0) - diff.xyz;\n\t\t\t\tif( u_threshold == 0.0 )\n\t\t\t\t\tgl_FragColor = vec4( diff.xyz, center.a );\n\t\t\t\telse\n\t\t\t\t\tgl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/edges",t);var h=function(){this.addInput("Texture","Texture");this.addInput("Distance","number");this.addInput("Range","number");this.addOutput("Texture","Texture");this.properties={distance:100,range:50,only_depth:!1,high_precision:!1};this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}};h.title="Depth Range";h.desc="Generates a texture with a depth range";h.prototype.onExecute=function(){if(this.isOutputConnected(0)){var a=this.getInputData(0);
if(a){var b=gl.UNSIGNED_BYTE;this.properties.high_precision&&(b=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT);this._temp_texture&&this._temp_texture.type==b&&this._temp_texture.width==a.width&&this._temp_texture.height==a.height||(this._temp_texture=new GL.Texture(a.width,a.height,{type:b,format:gl.RGBA,filter:gl.LINEAR}));var c=this._uniforms,b=this.properties.distance;this.isInputConnected(1)&&(b=this.getInputData(1),this.properties.distance=b);var d=this.properties.range;this.isInputConnected(2)&&
(d=this.getInputData(2),this.properties.range=d);c.u_distance=b;c.u_range=d;gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var e=Mesh.getScreenQuad();h._shader||(h._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,h.pixel_shader),h._shader_onlydepth=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,h.pixel_shader,{ONLY_DEPTH:""}));var f=this.properties.only_depth?h._shader_onlydepth:h._shader,b=null,b=a.near_far_planes?a.near_far_planes:window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:
[0.1,1E3];c.u_camera_planes=b;this._temp_texture.drawTo(function(){a.bind(0);f.uniforms(c).draw(e)});this._temp_texture.near_far_planes=b;this.setOutputData(0,this._temp_texture)}}};h.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform float u_distance;\n\t\t\tuniform float u_range;\n\t\t\t\n\t\t\tfloat LinearDepth()\n\t\t\t{\n\t\t\t\tfloat zNear = u_camera_planes.x;\n\t\t\t\tfloat zFar = u_camera_planes.y;\n\t\t\t\tfloat depth = texture2D(u_texture, v_coord).x;\n\t\t\t\tdepth = depth * 2.0 - 1.0;\n\t\t\t\treturn zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = LinearDepth();\n\t\t\t\t#ifdef ONLY_DEPTH\n\t\t\t\t   gl_FragColor = vec4(depth);\n\t\t\t\t#else\n\t\t\t\t\tfloat diff = abs(depth * u_camera_planes.y - u_distance);\n\t\t\t\t\tfloat dof = 1.0;\n\t\t\t\t\tif(diff <= u_range)\n\t\t\t\t\t\tdof = diff / u_range;\n\t\t\t\t   gl_FragColor = vec4(dof);\n\t\t\t\t#endif\n\t\t\t}\n\t\t\t";
g.registerNodeType("texture/depth_range",h);var x=function(){this.addInput("Texture","Texture");this.addInput("Iterations","number");this.addInput("Intensity","number");this.addOutput("Blurred","Texture");this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:f.DEFAULT}};x.title="Blur";x.desc="Blur a texture";x.widgets_info={precision:{widget:"combo",values:f.MODE_VALUES}};x.max_iterations=20;x.prototype.onExecute=function(){var a=this.getInputData(0);if(a&&this.isOutputConnected(0)){var b=
this._final_texture;b&&b.width==a.width&&b.height==a.height&&b.type==a.type||(b=this._final_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));var c=this.properties.iterations;this.isInputConnected(1)&&(c=this.getInputData(1),this.properties.iterations=c);c=Math.min(Math.floor(c),x.max_iterations);if(0==c)this.setOutputData(0,a);else{var d=this.properties.intensity;this.isInputConnected(2)&&(d=this.getInputData(2),this.properties.intensity=d);var e=g.camera_aspect;
e||void 0===window.gl||(e=gl.canvas.height/gl.canvas.width);e||(e=1);var e=this.properties.preserve_aspect?e:1,f=this.properties.scale||[1,1];a.applyBlur(e*f[0],f[1],d,b);for(a=1;a<c;++a)b.applyBlur(e*f[0]*(a+1),f[1]*(a+1),d);this.setOutputData(0,b)}}};g.registerNodeType("texture/blur",x);var w=function(){this.addInput("in","Texture");this.addInput("dirt","Texture");this.addOutput("out","Texture");this.addOutput("glow","Texture");this.properties={intensity:1,persistence:0.99,iterations:16,threshold:0,
scale:1,dirt_factor:0.5,precision:f.DEFAULT};this._textures=[];this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}};w.title="Glow";w.desc="Filters a texture giving it a glow effect";w.weights=new Float32Array([0.5,0.4,0.3,0.2]);w.widgets_info={iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:0.01,precision:2},precision:{widget:"combo",values:f.MODE_VALUES}};w.prototype.onGetInputs=function(){return[["enabled",
"boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]};w.prototype.onGetOutputs=function(){return[["average","Texture"]]};w.prototype.onExecute=function(){var a=this.getInputData(0);if(a&&this.isAnyOutputConnected())if(this.properties.precision===f.PASS_THROUGH||!1===this.getInputDataByName("enabled"))this.setOutputData(0,a);else{var b=a.width,c=a.height,d={format:a.format,type:a.type,minFilter:GL.LINEAR,magFilter:GL.LINEAR,
wrap:gl.CLAMP_TO_EDGE},e=f.getTextureType(this.properties.precision,a),h=this._uniforms,g=this._textures,k=w._cut_shader;k||(k=w._cut_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,w.cut_pixel_shader));gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);h.u_threshold=this.getInputOrProperty("threshold");var l=g[0]=GL.Texture.getTemporary(b,c,d);a.blit(l,k.uniforms(h));var m=l,n=this.getInputOrProperty("iterations"),n=Math.clamp(n,1,16)|0,p=h.u_texel_size,q=this.getInputOrProperty("intensity");h.u_intensity=
1;h.u_delta=this.properties.scale;k=w._shader;k||(k=w._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,w.scale_pixel_shader));for(var s=1;s<n;s++){b>>=1;1<(c|0)&&(c>>=1);if(2>b)break;l=g[s]=GL.Texture.getTemporary(b,c,d);p[0]=1/m.width;p[1]=1/m.height;m.blit(l,k.uniforms(h));m=l}this.isOutputConnected(2)&&(b=this._average_texture,b&&b.type==a.type&&b.format==a.format||(b=this._average_texture=new GL.Texture(1,1,{type:a.type,format:a.format,filter:gl.LINEAR})),p[0]=1/m.width,p[1]=1/m.height,h.u_intensity=
q,h.u_delta=1,m.blit(b,k.uniforms(h)),this.setOutputData(2,b));gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);h.u_intensity=this.getInputOrProperty("persistence");h.u_delta=0.5;for(s-=2;0<=s;s--)l=g[s],g[s]=null,p[0]=1/m.width,p[1]=1/m.height,m.blit(l,k.uniforms(h)),GL.Texture.releaseTemporary(m),m=l;gl.disable(gl.BLEND);this.isOutputConnected(1)&&(g=this._glow_texture,g&&g.width==a.width&&g.height==a.height&&g.type==e&&g.format==a.format||(g=this._glow_texture=new GL.Texture(a.width,a.height,{type:e,
format:a.format,filter:gl.LINEAR})),m.blit(g),this.setOutputData(1,g));if(this.isOutputConnected(0)){g=this._final_texture;g&&g.width==a.width&&g.height==a.height&&g.type==e&&g.format==a.format||(g=this._final_texture=new GL.Texture(a.width,a.height,{type:e,format:a.format,filter:gl.LINEAR}));var x=this.getInputData(1),u=this.getInputOrProperty("dirt_factor");h.u_intensity=q;k=x?w._dirt_final_shader:w._final_shader;k||(k=x?w._dirt_final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,w.final_pixel_shader,
{USE_DIRT:""}):w._final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,w.final_pixel_shader));g.drawTo(function(){a.bind(0);m.bind(1);x&&(k.setUniform("u_dirt_factor",u),k.setUniform("u_dirt_texture",x.bind(2)));k.toViewport(h)});this.setOutputData(0,g)}GL.Texture.releaseTemporary(m)}};w.cut_pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_threshold;\n\t\tvoid main() {\n\t\t\tgl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );\n\t\t}";
w.scale_pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_texel_size;\n\t\tuniform float u_delta;\n\t\tuniform float u_intensity;\n\t\t\n\t\tvec4 sampleBox(vec2 uv) {\n\t\t\tvec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n\t\t\tvec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);\n\t\t\treturn s * 0.25;\n\t\t}\n\t\tvoid main() {\n\t\t\tgl_FragColor = u_intensity * sampleBox( v_coord );\n\t\t}";
w.final_pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_glow_texture;\n\t\t#ifdef USE_DIRT\n\t\t\tuniform sampler2D u_dirt_texture;\n\t\t#endif\n\t\tuniform vec2 u_texel_size;\n\t\tuniform float u_delta;\n\t\tuniform float u_intensity;\n\t\tuniform float u_dirt_factor;\n\t\t\n\t\tvec4 sampleBox(vec2 uv) {\n\t\t\tvec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n\t\t\tvec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);\n\t\t\treturn s * 0.25;\n\t\t}\n\t\tvoid main() {\n\t\t\tvec4 glow = sampleBox( v_coord );\n\t\t\t#ifdef USE_DIRT\n\t\t\t\tglow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );\n\t\t\t#endif\n\t\t\tgl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;\n\t\t}";
g.registerNodeType("texture/glow",w);var y=function(){this.addInput("Texture","Texture");this.addOutput("Filtered","Texture");this.properties={intensity:1,radius:5}};y.title="Kuwahara Filter";y.desc="Filters a texture giving an artistic oil canvas painting";y.max_radius=10;y._shaders=[];y.prototype.onExecute=function(){var a=this.getInputData(0);if(a&&this.isOutputConnected(0)){var b=this._temp_texture;b&&b.width==a.width&&b.height==a.height&&b.type==a.type||(this._temp_texture=new GL.Texture(a.width,
a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));b=this.properties.radius;b=Math.min(Math.floor(b),y.max_radius);if(0==b)this.setOutputData(0,a);else{var c=this.properties.intensity,d=g.camera_aspect;d||void 0===window.gl||(d=gl.canvas.height/gl.canvas.width);d||(d=1);d=this.properties.preserve_aspect?d:1;y._shaders[b]||(y._shaders[b]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,y.pixel_shader,{RADIUS:b.toFixed(0)}));var e=y._shaders[b],f=GL.Mesh.getScreenQuad();a.bind(0);this._temp_texture.drawTo(function(){e.uniforms({u_texture:0,
u_intensity:c,u_resolution:[a.width,a.height],u_iResolution:[1/a.width,1/a.height]}).draw(f)});this.setOutputData(0,this._temp_texture)}}};y.pixel_shader="\n\tprecision highp float;\n\tvarying vec2 v_coord;\n\tuniform sampler2D u_texture;\n\tuniform float u_intensity;\n\tuniform vec2 u_resolution;\n\tuniform vec2 u_iResolution;\n\t#ifndef RADIUS\n\t\t#define RADIUS 7\n\t#endif\n\tvoid main() {\n\t\n\t\tconst int radius = RADIUS;\n\t\tvec2 fragCoord = v_coord;\n\t\tvec2 src_size = u_iResolution;\n\t\tvec2 uv = v_coord;\n\t\tfloat n = float((radius + 1) * (radius + 1));\n\t\tint i;\n\t\tint j;\n\t\tvec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);\n\t\tvec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);\n\t\tvec3 c;\n\t\t\n\t\tfor (int j = -radius; j <= 0; ++j)  {\n\t\t\tfor (int i = -radius; i <= 0; ++i)  {\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\t\tm0 += c;\n\t\t\t\ts0 += c * c;\n\t\t\t}\n\t\t}\n\t\t\n\t\tfor (int j = -radius; j <= 0; ++j)  {\n\t\t\tfor (int i = 0; i <= radius; ++i)  {\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\t\tm1 += c;\n\t\t\t\ts1 += c * c;\n\t\t\t}\n\t\t}\n\t\t\n\t\tfor (int j = 0; j <= radius; ++j)  {\n\t\t\tfor (int i = 0; i <= radius; ++i)  {\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\t\tm2 += c;\n\t\t\t\ts2 += c * c;\n\t\t\t}\n\t\t}\n\t\t\n\t\tfor (int j = 0; j <= radius; ++j)  {\n\t\t\tfor (int i = -radius; i <= 0; ++i)  {\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\t\tm3 += c;\n\t\t\t\ts3 += c * c;\n\t\t\t}\n\t\t}\n\t\t\n\t\tfloat min_sigma2 = 1e+2;\n\t\tm0 /= n;\n\t\ts0 = abs(s0 / n - m0 * m0);\n\t\t\n\t\tfloat sigma2 = s0.r + s0.g + s0.b;\n\t\tif (sigma2 < min_sigma2) {\n\t\t\tmin_sigma2 = sigma2;\n\t\t\tgl_FragColor = vec4(m0, 1.0);\n\t\t}\n\t\t\n\t\tm1 /= n;\n\t\ts1 = abs(s1 / n - m1 * m1);\n\t\t\n\t\tsigma2 = s1.r + s1.g + s1.b;\n\t\tif (sigma2 < min_sigma2) {\n\t\t\tmin_sigma2 = sigma2;\n\t\t\tgl_FragColor = vec4(m1, 1.0);\n\t\t}\n\t\t\n\t\tm2 /= n;\n\t\ts2 = abs(s2 / n - m2 * m2);\n\t\t\n\t\tsigma2 = s2.r + s2.g + s2.b;\n\t\tif (sigma2 < min_sigma2) {\n\t\t\tmin_sigma2 = sigma2;\n\t\t\tgl_FragColor = vec4(m2, 1.0);\n\t\t}\n\t\t\n\t\tm3 /= n;\n\t\ts3 = abs(s3 / n - m3 * m3);\n\t\t\n\t\tsigma2 = s3.r + s3.g + s3.b;\n\t\tif (sigma2 < min_sigma2) {\n\t\t\tmin_sigma2 = sigma2;\n\t\t\tgl_FragColor = vec4(m3, 1.0);\n\t\t}\n\t}\n\t";
g.registerNodeType("texture/kuwahara",y);r=function(){this.addOutput("Webcam","Texture");this.properties={texture_name:""}};r.title="Webcam";r.desc="Webcam texture";r.prototype.openStream=function(){function a(c){console.log("Webcam rejected",c);b._webcam_stream=!1;b.box_color="red"}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;if(navigator.getUserMedia){this._waiting_confirmation=
!0;var b=this;navigator.getUserMedia({video:!0},this.streamReady.bind(this),a)}};r.prototype.streamReady=function(a){this._webcam_stream=a;var b=this._video;b||(b=document.createElement("video"),b.autoplay=!0,b.src=window.URL.createObjectURL(a),this._video=b,b.onloadedmetadata=function(a){console.log(a)})};r.prototype.onRemoved=function(){if(this._webcam_stream){var a=this._webcam_stream.getVideoTracks();a.length&&a[0].stop();this._video=this._webcam_stream=null}};r.prototype.onDrawBackground=function(a){this.flags.collapsed||
20>=this.size[1]||!this._video||(a.save(),a.webgl?this._temp_texture&&a.drawImage(this._temp_texture,0,0,this.size[0],this.size[1]):(a.translate(0,this.size[1]),a.scale(1,-1),a.drawImage(this._video,0,0,this.size[0],this.size[1])),a.restore())};r.prototype.onExecute=function(){null!=this._webcam_stream||this._waiting_confirmation||this.openStream();if(this._video&&this._video.videoWidth){var a=this._video.videoWidth,b=this._video.videoHeight,c=this._temp_texture;c&&c.width==a&&c.height==b||(this._temp_texture=
new GL.Texture(a,b,{format:gl.RGB,filter:gl.LINEAR}));this._temp_texture.uploadImage(this._video);this.properties.texture_name&&(f.getTexturesContainer()[this.properties.texture_name]=this._temp_texture);this.setOutputData(0,this._temp_texture)}};g.registerNodeType("texture/webcam",r);var A=function(){this.addInput("in","Texture");this.addInput("f","number");this.addOutput("out","Texture");this.properties={factor:1,precision:f.LOW};this._uniforms={u_texture:0,u_factor:1}};A.title="Lens FX";A.desc=
"distortion and chromatic aberration";A.widgets_info={precision:{widget:"combo",values:f.MODE_VALUES}};A.prototype.onExecute=function(){var a=this.getInputData(0);if(a&&this.isOutputConnected(0)){var b=this._temp_texture;b&&b.width==a.width&&b.height==a.height&&b.type==a.type||(b=this._temp_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));var c=A._shader;c||(c=A._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,A.pixel_shader));var d=this.getInputData(1);
null==d&&(d=this.properties.factor);var e=this._uniforms;e.u_factor=d;gl.disable(gl.DEPTH_TEST);b.drawTo(function(){a.bind(0);c.uniforms(e).draw(GL.Mesh.getScreenQuad())});this.setOutputData(0,b)}};A.pixel_shader="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_factor;\n\t\t\tvec2 barrelDistortion(vec2 coord, float amt) {\n\t\t\t\tvec2 cc = coord - 0.5;\n\t\t\t\tfloat dist = dot(cc, cc);\n\t\t\t\treturn coord + cc * dist * amt;\n\t\t\t}\n\t\t\t\n\t\t\tfloat sat( float t )\n\t\t\t{\n\t\t\t\treturn clamp( t, 0.0, 1.0 );\n\t\t\t}\n\t\t\t\n\t\t\tfloat linterp( float t ) {\n\t\t\t\treturn sat( 1.0 - abs( 2.0*t - 1.0 ) );\n\t\t\t}\n\t\t\t\n\t\t\tfloat remap( float t, float a, float b ) {\n\t\t\t\treturn sat( (t - a) / (b - a) );\n\t\t\t}\n\t\t\t\n\t\t\tvec4 spectrum_offset( float t ) {\n\t\t\t\tvec4 ret;\n\t\t\t\tfloat lo = step(t,0.5);\n\t\t\t\tfloat hi = 1.0-lo;\n\t\t\t\tfloat w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );\n\t\t\t\tret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);\n\t\t\t\n\t\t\t\treturn pow( ret, vec4(1.0/2.2) );\n\t\t\t}\n\t\t\t\n\t\t\tconst float max_distort = 2.2;\n\t\t\tconst int num_iter = 12;\n\t\t\tconst float reci_num_iter_f = 1.0 / float(num_iter);\n\t\t\t\n\t\t\tvoid main()\n\t\t\t{\t\n\t\t\t\tvec2 uv=v_coord;\n\t\t\t\tvec4 sumcol = vec4(0.0);\n\t\t\t\tvec4 sumw = vec4(0.0);\t\n\t\t\t\tfor ( int i=0; i<num_iter;++i )\n\t\t\t\t{\n\t\t\t\t\tfloat t = float(i) * reci_num_iter_f;\n\t\t\t\t\tvec4 w = spectrum_offset( t );\n\t\t\t\t\tsumw += w;\n\t\t\t\t\tsumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );\n\t\t\t\t}\n\t\t\t\tgl_FragColor = sumcol / sumw;\n\t\t\t}";
g.registerNodeType("texture/lensfx",A);var B=function(){this.addInput("in","Texture");this.addInput("exp","number");this.addOutput("out","Texture");this.properties={exposition:1,precision:f.LOW};this._uniforms={u_texture:0,u_exposition:exp}};B.title="Exposition";B.desc="Controls texture exposition";B.widgets_info={exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:f.MODE_VALUES}};B.prototype.onExecute=function(){var a=this.getInputData(0);if(a&&this.isOutputConnected(0)){var b=
this._temp_texture;b&&b.width==a.width&&b.height==a.height&&b.type==a.type||(b=this._temp_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));var c=B._shader;c||(c=B._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,B.pixel_shader));var d=this.getInputData(1);null!=d&&(this.properties.exposition=d);var e=this._uniforms;b.drawTo(function(){gl.disable(gl.DEPTH_TEST);a.bind(0);c.uniforms(e).draw(GL.Mesh.getScreenQuad())});this.setOutputData(0,b)}};B.pixel_shader=
"precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_exposition;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_texture, v_coord );\n\t\t\t\tgl_FragColor = vec4( color.xyz * u_exposition, color.a );\n\t\t\t}";g.registerNodeType("texture/exposition",B);var z=function(){this.addInput("in","Texture");this.addInput("avg","number");this.addOutput("out","Texture");this.properties={scale:1,gamma:1,average_lum:1,lum_white:1,precision:f.LOW};
this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}};z.title="Tone Mapping";z.desc="Applies Tone Mapping to convert from high to low";z.widgets_info={precision:{widget:"combo",values:f.MODE_VALUES}};z.prototype.onGetInputs=function(){return[["enabled","boolean"]]};z.prototype.onExecute=function(){var a=this.getInputData(0);if(a&&this.isOutputConnected(0))if(this.properties.precision===f.PASS_THROUGH||!1===this.getInputDataByName("enabled"))this.setOutputData(0,a);else{var b=
this._temp_texture;b&&b.width==a.width&&b.height==a.height&&b.type==a.type||(b=this._temp_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));var c=z._shader;c||(c=z._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,z.pixel_shader));var d=this.getInputData(1);null!=d&&(this.properties.average_lum=d);var e=this._uniforms;e.u_lumwhite2=this.properties.lum_white*this.properties.lum_white;e.u_scale=this.properties.scale;e.u_average_lum=this.properties.average_lum;
e.u_igamma=1/this.properties.gamma;gl.disable(gl.DEPTH_TEST);b.drawTo(function(){a.bind(0);c.uniforms(e).draw(GL.Mesh.getScreenQuad())});this.setOutputData(0,this._temp_texture)}};z.pixel_shader="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_scale;\n\t\t\tuniform float u_average_lum;\n\t\t\tuniform float u_lumwhite2;\n\t\t\tuniform float u_igamma;\n\t\t\tvec3 RGB2xyY (vec3 rgb)\n\t\t\t{\n\t\t\t\t const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,\n\t\t\t\t\t\t\t\t\t\t   0.2126, 0.7152, 0.0722,\n\t\t\t\t\t\t\t\t\t\t   0.0193, 0.1192, 0.9505);\n\t\t\t\tvec3 XYZ = RGB2XYZ * rgb;\n\t\t\t\t\n\t\t\t\tfloat f = (XYZ.x + XYZ.y + XYZ.z);\n\t\t\t\treturn vec3(XYZ.x / f,\n\t\t\t\t\t\t\tXYZ.y / f,\n\t\t\t\t\t\t\tXYZ.y);\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_texture, v_coord );\n\t\t\t\tvec3 rgb = color.xyz;\n\t\t\t\t//Ld - this part of the code is the same for both versions\n\t\t\t\tfloat lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));\n\t\t\t\tfloat L = (u_scale / u_average_lum) * lum;\n\t\t\t\tfloat Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);\n\t\t\t\t//first\n\t\t\t\t//vec3 xyY = RGB2xyY(rgb);\n\t\t\t\t//xyY.z *= Ld;\n\t\t\t\t//rgb = xyYtoRGB(xyY);\n\t\t\t\t//second\n\t\t\t\trgb = (rgb / lum) * Ld;\n\t\t\t\trgb = pow( rgb, vec3( u_igamma ) );\n\t\t\t\tgl_FragColor = vec4( rgb, color.a );\n\t\t\t}";
g.registerNodeType("texture/tonemapping",z);var C=function(){this.addOutput("out","Texture");this.properties={width:512,height:512,seed:0,persistence:0.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:f.DEFAULT};this._key=0;this._uniforms={u_persistence:0.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}};C.title="Perlin";C.desc="Generates a perlin noise texture";C.widgets_info={precision:{widget:"combo",values:f.MODE_VALUES},width:{type:"Number",precision:0,step:1},height:{type:"Number",
precision:0,step:1},octaves:{type:"Number",precision:0,step:1,min:1,max:50}};C.prototype.onExecute=function(){if(this.isOutputConnected(0)){var a=this.properties.width|0,b=this.properties.height|0;0==a&&(a=gl.viewport_data[2]);0==b&&(b=gl.viewport_data[3]);var c=f.getTextureType(this.properties.precision),d=this._temp_texture;d&&d.width==a&&d.height==b&&d.type==c||(d=this._temp_texture=new GL.Texture(a,b,{type:c,format:gl.RGB,filter:gl.LINEAR}));c=a+b+c+this.properties.persistence+this.properties.octaves+
this.properties.scale+this.properties.seed+this.properties.offset[0]+this.properties.offset[1]+this.properties.amplitude;if(c!=this._key){this._key=c;var e=this._uniforms;e.u_persistence=this.properties.persistence;e.u_octaves=this.properties.octaves;e.u_offset[0]=this.properties.offset[0];e.u_offset[1]=this.properties.offset[1];e.u_scale=this.properties.scale;e.u_amplitude=this.properties.amplitude;e.u_viewport[0]=a;e.u_viewport[1]=b;e.u_seed=128*this.properties.seed;var h=C._shader;h||(h=C._shader=
new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,C.pixel_shader));gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);d.drawTo(function(){h.uniforms(e).draw(GL.Mesh.getScreenQuad())})}this.setOutputData(0,d)}};C.pixel_shader="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_scale;\n\t\t\tuniform float u_persistence;\n\t\t\tuniform int u_octaves;\n\t\t\tuniform float u_amplitude;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform float u_seed;\n\t\t\t#define M_PI 3.14159265358979323846\n\t\t\t\n\t\t\tfloat rand(vec2 c){\treturn fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }\n\t\t\t\n\t\t\tfloat noise(vec2 p, float freq ){\n\t\t\t\tfloat unit = u_viewport.x/freq;\n\t\t\t\tvec2 ij = floor(p/unit);\n\t\t\t\tvec2 xy = mod(p,unit)/unit;\n\t\t\t\t//xy = 3.*xy*xy-2.*xy*xy*xy;\n\t\t\t\txy = .5*(1.-cos(M_PI*xy));\n\t\t\t\tfloat a = rand((ij+vec2(0.,0.)));\n\t\t\t\tfloat b = rand((ij+vec2(1.,0.)));\n\t\t\t\tfloat c = rand((ij+vec2(0.,1.)));\n\t\t\t\tfloat d = rand((ij+vec2(1.,1.)));\n\t\t\t\tfloat x1 = mix(a, b, xy.x);\n\t\t\t\tfloat x2 = mix(c, d, xy.x);\n\t\t\t\treturn mix(x1, x2, xy.y);\n\t\t\t}\n\t\t\t\n\t\t\tfloat pNoise(vec2 p, int res){\n\t\t\t\tfloat persistance = u_persistence;\n\t\t\t\tfloat n = 0.;\n\t\t\t\tfloat normK = 0.;\n\t\t\t\tfloat f = 4.;\n\t\t\t\tfloat amp = 1.0;\n\t\t\t\tint iCount = 0;\n\t\t\t\tfor (int i = 0; i<50; i++){\n\t\t\t\t\tn+=amp*noise(p, f);\n\t\t\t\t\tf*=2.;\n\t\t\t\t\tnormK+=amp;\n\t\t\t\t\tamp*=persistance;\n\t\t\t\t\tif (iCount >= res)\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tiCount++;\n\t\t\t\t}\n\t\t\t\tfloat nf = n/normK;\n\t\t\t\treturn nf*nf*nf*nf;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;\n\t\t\t\tvec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );\n\t\t\t\tgl_FragColor = color;\n\t\t\t}";
g.registerNodeType("texture/perlin",C);var v=function(){this.addInput("in","Texture");this.addOutput("out","Texture");this.properties={key_color:vec3.fromValues(0,1,0),threshold:0.8,slope:0.2,precision:f.DEFAULT}};v.title="Matte";v.desc="Extracts background";v.widgets_info={key_color:{widget:"color"},precision:{widget:"combo",values:f.MODE_VALUES}};v.prototype.onExecute=function(){if(this.isOutputConnected(0)){var a=this.getInputData(0);if(this.properties.precision===f.PASS_THROUGH)this.setOutputData(0,
a);else if(a){this._tex=f.getTargetTexture(a,this._tex,this.properties.precision);gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1});var b=this._uniforms,c=Mesh.getScreenQuad(),d=v._shader;d||(d=v._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,v.pixel_shader));b.u_key_color=this.properties.key_color;b.u_threshold=this.properties.threshold;b.u_slope=this.properties.slope;this._tex.drawTo(function(){a.bind(0);
d.uniforms(b).draw(c)});this.setOutputData(0,this._tex)}}};v.pixel_shader="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec3 u_key_color;\n\t\t\tuniform float u_threshold;\n\t\t\tuniform float u_slope;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec3 color = texture2D( u_texture, v_coord ).xyz;\n\t\t\t\tfloat diff = length( normalize(color) - normalize(u_key_color) );\n\t\t\t\tfloat edge = u_threshold * (1.0 - u_slope);\n\t\t\t\tfloat alpha = smoothstep( edge, u_threshold, diff);\n\t\t\t\tgl_FragColor = vec4( color, alpha );\n\t\t\t}";
g.registerNodeType("texture/matte",v);r=function(){this.addOutput("Cubemap","Cubemap");this.properties={name:""};this.size=[f.image_preview_size,f.image_preview_size]};r.title="Cubemap";r.prototype.onDropFile=function(a,b,c){a?(this._drop_texture="string"==typeof a?GL.Texture.fromURL(a):GL.Texture.fromDDSInMemory(a),this.properties.name=b):(this._drop_texture=null,this.properties.name="")};r.prototype.onExecute=function(){if(this._drop_texture)this.setOutputData(0,this._drop_texture);else if(this.properties.name){var a=
f.getTexture(this.properties.name);a&&(this._last_tex=a,this.setOutputData(0,a))}};r.prototype.onDrawBackground=function(a){this.flags.collapsed||20>=this.size[1]||a.webgl&&(gl.meshes.cube||(gl.meshes.cube=GL.Mesh.cube({size:1})))};g.registerNodeType("texture/cubemap",r)}})(this);
(function(r){var g=r.LiteGraph;if("undefined"!=typeof GL){var f=function(){this.addInput("Texture","Texture");this.addInput("Aberration","number");this.addInput("Distortion","number");this.addInput("Blur","number");this.addOutput("Texture","Texture");this.properties={aberration:1,distortion:1,blur:1,precision:LGraphTexture.DEFAULT};f._shader||(f._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,f.pixel_shader),f._texture=new GL.Texture(3,1,{format:gl.RGB,wrap:gl.CLAMP_TO_EDGE,magFilter:gl.LINEAR,
minFilter:gl.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))};f.title="Lens";f.desc="Camera Lens distortion";f.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};f.prototype.onExecute=function(){var e=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH)this.setOutputData(0,e);else if(e){this._tex=LGraphTexture.getTargetTexture(e,this._tex,this.properties.precision);var g=this.properties.aberration;this.isInputConnected(1)&&(g=this.getInputData(1),
this.properties.aberration=g);var l=this.properties.distortion;this.isInputConnected(2)&&(l=this.getInputData(2),this.properties.distortion=l);var n=this.properties.blur;this.isInputConnected(3)&&(n=this.getInputData(3),this.properties.blur=n);gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var d=Mesh.getScreenQuad(),a=f._shader;this._tex.drawTo(function(){e.bind(0);a.uniforms({u_texture:0,u_aberration:g,u_distortion:l,u_blur:n}).draw(d)});this.setOutputData(0,this._tex)}};f.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform float u_aberration;\n\t\t\tuniform float u_distortion;\n\t\t\tuniform float u_blur;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = v_coord;\n\t\t\t\tfloat dist = distance(vec2(0.5), coord);\n\t\t\t\tvec2 dist_coord = coord - vec2(0.5);\n\t\t\t\tfloat percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;\n\t\t\t\tdist_coord *= percent;\n\t\t\t\tcoord = dist_coord + vec2(0.5);\n\t\t\t\tvec4 color = texture2D(u_texture,coord, u_blur * dist);\n\t\t\t\tcolor.r = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0+0.01*u_aberration), u_blur * dist ).r;\n\t\t\t\tcolor.b = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0-0.01*u_aberration), u_blur * dist ).b;\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";
g.registerNodeType("fx/lens",f);r.LGraphFXLens=f;var e=function(){this.addInput("Texture","Texture");this.addInput("Blurred","Texture");this.addInput("Mask","Texture");this.addInput("Threshold","number");this.addOutput("Texture","Texture");this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}};e.title="Bokeh";e.desc="applies an Bokeh effect";e.widgets_info={shape:{widget:"texture"}};e.prototype.onExecute=function(){var f=this.getInputData(0),g=this.getInputData(1),l=this.getInputData(2);
if(f&&l&&this.properties.shape){g||(g=f);var n=LGraphTexture.getTexture(this.properties.shape);if(n){var d=this.properties.threshold;this.isInputConnected(3)&&(d=this.getInputData(3),this.properties.threshold=d);var a=gl.UNSIGNED_BYTE;this.properties.high_precision&&(a=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT);this._temp_texture&&this._temp_texture.type==a&&this._temp_texture.width==f.width&&this._temp_texture.height==f.height||(this._temp_texture=new GL.Texture(f.width,f.height,{type:a,format:gl.RGBA,
filter:gl.LINEAR}));var b=e._first_shader;b||(b=e._first_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,e._first_pixel_shader));var c=e._second_shader;c||(c=e._second_shader=new GL.Shader(e._second_vertex_shader,e._second_pixel_shader));var m=this._points_mesh;m&&m._width==f.width&&m._height==f.height&&2==m._spacing||(m=this.createPointsMesh(f.width,f.height,2));var k=Mesh.getScreenQuad(),p=this.properties.size,h=this.properties.alpha;gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);this._temp_texture.drawTo(function(){f.bind(0);
g.bind(1);l.bind(2);b.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[f.width,f.height]}).draw(k)});this._temp_texture.drawTo(function(){gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);f.bind(0);n.bind(3);c.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:h,u_threshold:d,u_pointSize:p,u_itexsize:[1/f.width,1/f.height]}).draw(m,gl.POINTS)});this.setOutputData(0,this._temp_texture)}}else this.setOutputData(0,f)};e.prototype.createPointsMesh=function(e,f,g){for(var n=Math.round(e/g),d=Math.round(f/
g),a=new Float32Array(n*d*2),b=-1,c=2/e*g,m=2/f*g,k=0;k<d;++k){for(var p=-1,h=0;h<n;++h){var q=k*n*2+2*h;a[q]=p;a[q+1]=b;p+=c}b+=m}this._points_mesh=GL.Mesh.load({vertices2D:a});this._points_mesh._width=e;this._points_mesh._height=f;this._points_mesh._spacing=g;return this._points_mesh};e._first_pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture_blur;\n\t\t\tuniform sampler2D u_mask;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tvec4 blurred_color = texture2D(u_texture_blur, v_coord);\n\t\t\t\tfloat mask = texture2D(u_mask, v_coord).x;\n\t\t\t   gl_FragColor = mix(color, blurred_color, mask);\n\t\t\t}\n\t\t\t";
e._second_vertex_shader="precision highp float;\n\t\t\tattribute vec2 a_vertex2D;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_mask;\n\t\t\tuniform vec2 u_itexsize;\n\t\t\tuniform float u_pointSize;\n\t\t\tuniform float u_threshold;\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = a_vertex2D * 0.5 + 0.5;\n\t\t\t\tv_color = texture2D( u_texture, coord );\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(u_itexsize.x, 0.0) );\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(0.0, u_itexsize.y));\n\t\t\t\tv_color += texture2D( u_texture, coord + u_itexsize);\n\t\t\t\tv_color *= 0.25;\n\t\t\t\tfloat mask = texture2D(u_mask, coord).x;\n\t\t\t\tfloat luminance = length(v_color) * mask;\n\t\t\t\t/*luminance /= (u_pointSize*u_pointSize)*0.01 */;\n\t\t\t\tluminance -= u_threshold;\n\t\t\t\tif(luminance < 0.0)\n\t\t\t\t{\n\t\t\t\t\tgl_Position.x = -100.0;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tgl_PointSize = u_pointSize;\n\t\t\t\tgl_Position = vec4(a_vertex2D,0.0,1.0);\n\t\t\t}\n\t\t\t";
e._second_pixel_shader="precision highp float;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_shape;\n\t\t\tuniform float u_alpha;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_shape, gl_PointCoord );\n\t\t\t\tcolor *= v_color * u_alpha;\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n";g.registerNodeType("fx/bokeh",e);r.LGraphFXBokeh=e;var p=function(){this.addInput("Texture","Texture");this.addInput("value1","number");this.addInput("value2","number");this.addOutput("Texture",
"Texture");this.properties={fx:"halftone",value1:1,value2:1,precision:LGraphTexture.DEFAULT}};p.title="FX";p.desc="applies an FX from a list";p.widgets_info={fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};p.shaders={};p.prototype.onExecute=function(){if(this.isOutputConnected(0)){var e=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH)this.setOutputData(0,e);else if(e){this._tex=
LGraphTexture.getTargetTexture(e,this._tex,this.properties.precision);var f=this.properties.value1;this.isInputConnected(1)&&(f=this.getInputData(1),this.properties.value1=f);var g=this.properties.value2;this.isInputConnected(2)&&(g=this.getInputData(2),this.properties.value2=g);var n=this.properties.fx,d=p.shaders[n];if(!d){var a=p["pixel_shader_"+n];if(!a)return;d=p.shaders[n]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,a)}gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var b=Mesh.getScreenQuad();
camera_planes=r.LS&&LS.Renderer._current_camera?[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:[1,100];var c=null;"noise"==n&&(c=LGraphTexture.getNoiseTexture());this._tex.drawTo(function(){e.bind(0);"noise"==n&&c.bind(1);d.uniforms({u_texture:0,u_noise:1,u_size:[e.width,e.height],u_rand:[Math.random(),Math.random()],u_value1:f,u_value2:g,u_camera_planes:camera_planes}).draw(b)});this.setOutputData(0,this._tex)}}};p.pixel_shader_halftone="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tfloat pattern() {\n\t\t\t\tfloat s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);\n\t\t\t\tvec2 tex = v_coord * u_size.xy;\n\t\t\t\tvec2 point = vec2(\n\t\t\t\t   c * tex.x - s * tex.y ,\n\t\t\t\t   s * tex.x + c * tex.y \n\t\t\t\t) * u_value2;\n\t\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\n\t\t\t\tgl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);\n\t\t\t}\n";
p.pixel_shader_pixelate="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = vec2( floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2 );\n\t\t\t\tvec4 color = texture2D(u_texture, coord);\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n";p.pixel_shader_lowpalette="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tgl_FragColor = floor(color * u_value1) / u_value1;\n\t\t\t}\n";
p.pixel_shader_noise="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_noise;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\tuniform vec2 u_rand;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tvec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);\n\t\t\t\tgl_FragColor = vec4( color.xyz + noise * u_value1, color.a );\n\t\t\t}\n";
p.pixel_shader_gamma="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_value1;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tfloat gamma = 1.0 / u_value1;\n\t\t\t\tgl_FragColor = vec4( pow( color.xyz, vec3(gamma) ), color.a );\n\t\t\t}\n";g.registerNodeType("fx/generic",p);r.LGraphFXGeneric=p;var q=function(){this.addInput("Tex.","Texture");this.addInput("intensity","number");this.addOutput("Texture",
"Texture");this.properties={intensity:1,invert:!1,precision:LGraphTexture.DEFAULT};q._shader||(q._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,q.pixel_shader))};q.title="Vigneting";q.desc="Vigneting";q.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};q.prototype.onExecute=function(){var e=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH)this.setOutputData(0,e);else if(e){this._tex=LGraphTexture.getTargetTexture(e,this._tex,this.properties.precision);
var f=this.properties.intensity;this.isInputConnected(1)&&(f=this.getInputData(1),this.properties.intensity=f);gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var g=Mesh.getScreenQuad(),n=q._shader,d=this.properties.invert;this._tex.drawTo(function(){e.bind(0);n.uniforms({u_texture:0,u_intensity:f,u_isize:[1/e.width,1/e.height],u_invert:d?1:0}).draw(g)});this.setOutputData(0,this._tex)}};q.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_intensity;\n\t\t\tuniform int u_invert;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tfloat luminance = 1.0 - length( v_coord - vec2(0.5) ) * 1.414;\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tif(u_invert == 1)\n\t\t\t\t\tluminance = 1.0 - luminance;\n\t\t\t\tluminance = mix(1.0, luminance, u_intensity);\n\t\t\t   gl_FragColor = vec4( luminance * color.xyz, color.a);\n\t\t\t}\n\t\t\t";
g.registerNodeType("fx/vigneting",q);r.LGraphFXVigneting=q}})(this);
(function(r){function g(d){this.cmd=this.channel=0;d?this.setup(d):this.data=[0,0,0]}function f(d,a){navigator.requestMIDIAccess?(this.on_ready=d,this.state={note:[],cc:[]},navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))):(this.error="not suppoorted",a?a("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags"))}function e(){this.addOutput("on_midi",n.EVENT);this.addOutput("out","midi");this.properties={port:0};this._current_midi_event=
this._last_midi_event=null;var d=this;new f(function(a){d._midi=a;if(d._waiting)d.onStart();d._waiting=!1})}function p(){this.addInput("send",n.EVENT);this.properties={port:0};var d=this;new f(function(a){d._midi=a})}function q(){this.addInput("on_midi",n.EVENT);this._str="";this.size=[200,40]}function s(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};this.addInput("in",n.EVENT);this.addOutput("on_midi",n.EVENT)}function u(){this.properties={channel:0,cmd:"CC",value1:1,value2:1};this.addInput("send",
n.EVENT);this.addInput("assign",n.EVENT);this.addOutput("on_midi",n.EVENT)}function l(){this.properties={cc:1,value:0};this.addOutput("value","number")}var n=r.LiteGraph;g.prototype.setup=function(d){this.data=d;this.status=d=d[0];var a=d&240;this.cmd=240<=d?d:a;this.cmd==g.NOTEON&&0==this.velocity&&(this.cmd=g.NOTEOFF);this.cmd_str=g.commands[this.cmd]||"";if(a>=g.NOTEON||a<=g.NOTEOFF)this.channel=d&15};Object.defineProperty(g.prototype,"velocity",{get:function(){return this.cmd==g.NOTEON?this.data[2]:
-1},set:function(d){this.data[2]=d},enumerable:!0});g.notes="A A# B C C# D D# E F F# G G#".split(" ");g.prototype.getPitch=function(){return 440*Math.pow(2,(this.data[1]-69)/12)};g.computePitch=function(d){return 440*Math.pow(2,(d-69)/12)};g.prototype.getCC=function(){return this.data[1]};g.prototype.getCCValue=function(){return this.data[2]};g.prototype.getPitchBend=function(){return this.data[1]+(this.data[2]<<7)-8192};g.computePitchBend=function(d,a){return d+(a<<7)-8192};g.prototype.setCommandFromString=
function(d){this.cmd=g.computeCommandFromString(d)};g.computeCommandFromString=function(d){if(!d)return 0;if(d&&d.constructor===Number)return d;d=d.toUpperCase();switch(d){case "NOTE ON":case "NOTEON":return g.NOTEON;case "NOTE OFF":case "NOTEOFF":return g.NOTEON;case "KEY PRESSURE":case "KEYPRESSURE":return g.KEYPRESSURE;case "CONTROLLER CHANGE":case "CONTROLLERCHANGE":case "CC":return g.CONTROLLERCHANGE;case "PROGRAM CHANGE":case "PROGRAMCHANGE":case "PC":return g.PROGRAMCHANGE;case "CHANNEL PRESSURE":case "CHANNELPRESSURE":return g.CHANNELPRESSURE;
case "PITCH BEND":case "PITCHBEND":return g.PITCHBEND;case "TIME TICK":case "TIMETICK":return g.TIMETICK;default:return Number(d)}};g.toNoteString=function(d){var a;a=(d-21)%12;0>a&&(a=12+a);return g.notes[a]+Math.floor((d-24)/12+1)};g.prototype.toString=function(){var d=""+this.channel+". ";switch(this.cmd){case g.NOTEON:d+="NOTEON "+g.toNoteString(this.data[1]);break;case g.NOTEOFF:d+="NOTEOFF "+g.toNoteString(this.data[1]);break;case g.CONTROLLERCHANGE:d+="CC "+this.data[1]+" "+this.data[2];break;
case g.PROGRAMCHANGE:d+="PC "+this.data[1];break;case g.PITCHBEND:d+="PITCHBEND "+this.getPitchBend();break;case g.KEYPRESSURE:d+="KEYPRESS "+this.data[1]}return d};g.prototype.toHexString=function(){for(var d="",a=0;a<this.data.length;a++)d+=this.data[a].toString(16)+" "};g.NOTEOFF=128;g.NOTEON=144;g.KEYPRESSURE=160;g.CONTROLLERCHANGE=176;g.PROGRAMCHANGE=192;g.CHANNELPRESSURE=208;g.PITCHBEND=224;g.TIMETICK=248;g.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",
208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"};f.input=null;f.MIDIEvent=g;f.prototype.onMIDISuccess=function(d){console.log("MIDI ready!");console.log(d);this.midi=d;this.updatePorts();if(this.on_ready)this.on_ready(this)};f.prototype.updatePorts=function(){var d=this.midi;this.input_ports=d.inputs;for(var a=0,b=this.input_ports.values(),c=b.next();c&&
!1===c.done;)c=c.value,console.log("Input port [type:'"+c.type+"'] id:'"+c.id+"' manufacturer:'"+c.manufacturer+"' name:'"+c.name+"' version:'"+c.version+"'"),a++,c=b.next();this.num_input_ports=a;a=0;this.output_ports=d.outputs;b=this.output_ports.values();for(c=b.next();c&&!1===c.done;)c=c.value,console.log("Output port [type:'"+c.type+"'] id:'"+c.id+"' manufacturer:'"+c.manufacturer+"' name:'"+c.name+"' version:'"+c.version+"'"),a++,c=b.next();this.num_output_ports=a};f.prototype.onMIDIFailure=
function(d){console.error("Failed to get MIDI access - "+d)};f.prototype.openInputPort=function(d,a){var b=this.input_ports.get("input-"+d);if(!b)return!1;f.input=this;var c=this;b.onmidimessage=function(b){var d=new g(b.data);c.updateState(d);a&&a(b.data,d);if(f.on_message)f.on_message(b.data,d)};console.log("port open: ",b);return!0};f.parseMsg=function(d){};f.prototype.updateState=function(d){switch(d.cmd){case g.NOTEON:this.state.note[d.value1|0]=d.value2;break;case g.NOTEOFF:this.state.note[d.value1|
0]=0;break;case g.CONTROLLERCHANGE:this.state.cc[d.getCC()]=d.getCCValue()}};f.prototype.sendMIDI=function(d,a){if(a){var b=this.output_ports.get("output-"+d);b&&(f.output=this,a.constructor===g?b.send(a.data):b.send(a))}};e.MIDIInterface=f;e.title="MIDI Input";e.desc="Reads MIDI from a input port";e.prototype.getPropertyInfo=function(d){if(this._midi&&"port"==d){d={};for(var a=0;a<this._midi.input_ports.size;++a){var b=this._midi.input_ports.get("input-"+a);d[a]=a+".- "+b.name+" version:"+b.version}return{type:"enum",
values:d}}};e.prototype.onStart=function(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0};e.prototype.onMIDIEvent=function(d,a){this._last_midi_event=a;this.trigger("on_midi",a);a.cmd==g.NOTEON?this.trigger("on_noteon",a):a.cmd==g.NOTEOFF?this.trigger("on_noteoff",a):a.cmd==g.CONTROLLERCHANGE?this.trigger("on_cc",a):a.cmd==g.PROGRAMCHANGE?this.trigger("on_pc",a):a.cmd==g.PITCHBEND&&this.trigger("on_pitchbend",a)};e.prototype.onExecute=function(){if(this.outputs)for(var d=
this._last_midi_event,a=0;a<this.outputs.length;++a){var b=null;switch(this.outputs[a].name){case "midi":b=this._midi;break;case "last_midi":b=d;break;default:continue}this.setOutputData(a,b)}};e.prototype.onGetOutputs=function(){return[["last_midi","midi"],["on_midi",n.EVENT],["on_noteon",n.EVENT],["on_noteoff",n.EVENT],["on_cc",n.EVENT],["on_pc",n.EVENT],["on_pitchbend",n.EVENT]]};n.registerNodeType("midi/input",e);p.MIDIInterface=f;p.title="MIDI Output";p.desc="Sends MIDI to output channel";p.prototype.getPropertyInfo=
function(d){if(this._midi&&"port"==d){d={};for(var a=0;a<this._midi.output_ports.size;++a){var b=this._midi.output_ports.get(a);d[a]=a+".- "+b.name+" version:"+b.version}return{type:"enum",values:d}}};p.prototype.onAction=function(d,a){console.log(a);this._midi&&("send"==d&&this._midi.sendMIDI(this.port,a),this.trigger("midi",a))};p.prototype.onGetInputs=function(){return[["send",n.ACTION]]};p.prototype.onGetOutputs=function(){return[["on_midi",n.EVENT]]};n.registerNodeType("midi/output",p);q.title=
"MIDI Show";q.desc="Shows MIDI in the graph";q.prototype.onAction=function(d,a){a&&(this._str=a.constructor===g?a.toString():"???")};q.prototype.onDrawForeground=function(d){this._str&&(d.font="30px Arial",d.fillText(this._str,10,0.8*this.size[1]))};q.prototype.onGetInputs=function(){return[["in",n.ACTION]]};q.prototype.onGetOutputs=function(){return[["on_midi",n.EVENT]]};n.registerNodeType("midi/show",q);s.title="MIDI Filter";s.desc="Filters MIDI messages";s.prototype.onAction=function(d,a){!a||
a.constructor!==g||-1!=this.properties.channel&&a.channel!=this.properties.channel||-1!=this.properties.cmd&&a.cmd!=this.properties.cmd||-1!=this.properties.min_value&&a.data[1]<this.properties.min_value||-1!=this.properties.max_value&&a.data[1]>this.properties.max_value||this.trigger("on_midi",a)};n.registerNodeType("midi/filter",s);u.title="MIDIEvent";u.desc="Create a MIDI Event";u.prototype.onAction=function(d,a){"assign"==d?(this.properties.channel=a.channel,this.properties.cmd=a.cmd,this.properties.value1=
a.data[1],this.properties.value2=a.data[2]):(a=new g,a.channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?a.setCommandFromString(this.properties.cmd):a.cmd=this.properties.cmd,a.data[0]=a.cmd|a.channel,a.data[1]=Number(this.properties.value1),a.data[2]=Number(this.properties.value2),this.trigger("on_midi",a))};u.prototype.onExecute=function(){var d=this.properties;if(this.outputs)for(var a=0;a<this.outputs.length;++a){var b=null;switch(this.outputs[a].name){case "midi":b=
new g;b.setup([d.cmd,d.value1,d.value2]);b.channel=d.channel;break;case "command":b=d.cmd;break;case "cc":b=d.value1;break;case "cc_value":b=d.value2;break;case "note":b=d.cmd==g.NOTEON||d.cmd==g.NOTEOFF?d.value1:null;break;case "velocity":b=d.cmd==g.NOTEON?d.value2:null;break;case "pitch":b=d.cmd==g.NOTEON?g.computePitch(d.value1):null;break;case "pitchbend":b=d.cmd==g.PITCHBEND?g.computePitchBend(d.value1,d.value2):null;break;default:continue}null!==b&&this.setOutputData(a,b)}};u.prototype.onPropertyChanged=
function(d,a){"cmd"==d&&(this.properties.cmd=g.computeCommandFromString(a))};u.prototype.onGetOutputs=function(){return[["midi","midi"],["on_midi",n.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["pitchbend","number"]]};n.registerNodeType("midi/event",u);l.title="MIDICC";l.desc="gets a Controller Change";l.prototype.onExecute=function(){f.input&&(this.properties.value=f.input.state.cc[this.properties.cc]);this.setOutputData(0,
this.properties.value)};n.registerNodeType("midi/cc",l)})(this);
(function(r){function g(){this.properties={src:"",gain:0.5,loop:!0,autoplay:!0,playbackRate:1};this._loading_audio=!1;this._audiobuffer=null;this._audionodes=[];this._last_sourcenode=null;this.addOutput("out","audio");this.addInput("gain","number");this.audionode=t.getAudioContext().createGain();this.audionode.graphnode=this;this.audionode.gain.value=this.properties.gain;this.properties.src&&this.loadSound(this.properties.src)}function f(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,
smoothingTimeConstant:0.5};this.audionode=t.getAudioContext().createAnalyser();this.audionode.graphnode=this;this.audionode.fftSize=this.properties.fftSize;this.audionode.minDecibels=this.properties.minDecibels;this.audionode.maxDecibels=this.properties.maxDecibels;this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant;this.addInput("in","audio");this.addOutput("freqs","array");this.addOutput("samples","array");this._time_bin=this._freq_bin=null}function e(){this.properties={gain:1};
this.audionode=t.getAudioContext().createGain();this.addInput("in","audio");this.addInput("gain","number");this.addOutput("out","audio")}function p(){this.properties={impulse_src:"",normalize:!0};this.audionode=t.getAudioContext().createConvolver();this.addInput("in","audio");this.addOutput("out","audio")}function q(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:0.25};this.audionode=t.getAudioContext().createDynamicsCompressor();this.addInput("in","audio");this.addOutput("out",
"audio")}function s(){this.properties={};this.audionode=t.getAudioContext().createWaveShaper();this.addInput("in","audio");this.addInput("shape","waveshape");this.addOutput("out","audio")}function u(){this.properties={gain1:0.5,gain2:0.5};this.audionode=t.getAudioContext().createGain();this.audionode1=t.getAudioContext().createGain();this.audionode1.gain.value=this.properties.gain1;this.audionode2=t.getAudioContext().createGain();this.audionode2.gain.value=this.properties.gain2;this.audionode1.connect(this.audionode);
this.audionode2.connect(this.audionode);this.addInput("in1","audio");this.addInput("in1 gain","number");this.addInput("in2","audio");this.addInput("in2 gain","number");this.addOutput("out","audio")}function l(){this.properties={delayTime:0.5};this.audionode=t.getAudioContext().createDelay(10);this.audionode.delayTime.value=this.properties.delayTime;this.addInput("in","audio");this.addInput("time","number");this.addOutput("out","audio")}function n(){this.properties={frequency:350,detune:0,Q:1};this.addProperty("type",
"lowpass","enum",{values:"lowpass highpass bandpass lowshelf highshelf peaking notch allpass".split(" ")});this.audionode=t.getAudioContext().createBiquadFilter();this.addInput("in","audio");this.addOutput("out","audio")}function d(){this.properties={frequency:440,detune:0,type:"sine"};this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]});this.audionode=t.getAudioContext().createOscillator();this.addOutput("out","audio")}function a(){this.properties={continuous:!0,
mark:-1};this.addInput("data","array");this.addInput("mark","number");this.size=[300,200];this._last_buffer=null}function b(){this.properties={band:440,amplitude:1};this.addInput("freqs","array");this.addOutput("signal","number")}function c(){if(!c.default_code){var a=c.default_function.toString(),b=a.indexOf("{")+1,d=a.lastIndexOf("}");c.default_code=a.substr(b,d-b)}this.properties={code:c.default_code};a=t.getAudioContext();a.createScriptProcessor?this.audionode=a.createScriptProcessor(4096,1,1):
(console.warn("ScriptProcessorNode deprecated"),this.audionode=a.createGain());this.processCode();c._bypass_function||(c._bypass_function=this.audionode.onaudioprocess);this.addInput("in","audio");this.addOutput("out","audio")}function m(){this.audionode=t.getAudioContext().destination;this.addInput("in","audio")}var k=r.LiteGraph,t={};r.LGAudio=t;t.getAudioContext=function(){if(!this._audio_context){window.AudioContext=window.AudioContext||window.webkitAudioContext;if(!window.AudioContext)return console.error("AudioContext not supported by browser"),
null;this._audio_context=new AudioContext;this._audio_context.onmessage=function(a){console.log("msg",a)};this._audio_context.onended=function(a){console.log("ended",a)};this._audio_context.oncomplete=function(a){console.log("complete",a)}}return this._audio_context};t.connect=function(a,b){try{a.connect(b)}catch(c){console.warn("LGraphAudio:",c)}};t.disconnect=function(a,b){try{a.disconnect(b)}catch(c){console.warn("LGraphAudio:",c)}};t.changeAllAudiosConnections=function(a,b){if(a.inputs)for(var c=
0;c<a.inputs.length;++c){var d=a.graph.links[a.inputs[c].link];if(d){var e=a.graph.getNodeById(d.origin_id),f=null,f=e.getAudioNodeInOutputSlot?e.getAudioNodeInOutputSlot(d.origin_slot):e.audionode,d=null,d=a.getAudioNodeInInputSlot?a.getAudioNodeInInputSlot(c):a.audionode;b?t.connect(f,d):t.disconnect(f,d)}}if(a.outputs)for(c=0;c<a.outputs.length;++c)for(var e=a.outputs[c],g=0;g<e.links.length;++g)if(d=a.graph.links[e.links[g]]){var f=a.getAudioNodeInOutputSlot?a.getAudioNodeInOutputSlot(c):a.audionode,
k=a.graph.getNodeById(d.target_id),d=k.getAudioNodeInInputSlot?k.getAudioNodeInInputSlot(d.target_slot):k.audionode;b?t.connect(f,d):t.disconnect(f,d)}};t.onConnectionsChange=function(a,b,c,d){if(a==k.OUTPUT&&(a=null,d&&(a=this.graph.getNodeById(d.target_id)),a)){var e=null,e=this.getAudioNodeInOutputSlot?this.getAudioNodeInOutputSlot(b):this.audionode;b=null;b=a.getAudioNodeInInputSlot?a.getAudioNodeInInputSlot(d.target_slot):a.audionode;c?t.connect(e,b):t.disconnect(e,b)}};t.createAudioNodeWrapper=
function(a){var b=a.prototype.onPropertyChanged;a.prototype.onPropertyChanged=function(a,c){b&&b.call(this,a,c);this.audionode&&void 0!==this.audionode[a]&&(void 0!==this.audionode[a].value?this.audionode[a].value=c:this.audionode[a]=c)};a.prototype.onConnectionsChange=t.onConnectionsChange};t.cached_audios={};t.loadSound=function(a,b,c){function d(a){console.log("Audio loading sample error:",a);c&&c(a)}if(t.cached_audios[a]&&-1==a.indexOf("blob:"))b&&b(t.cached_audios[a]);else{t.onProcessAudioURL&&
(a=t.onProcessAudioURL(a));var e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";var f=t.getAudioContext();e.onload=function(){console.log("AudioSource loaded");f.decodeAudioData(e.response,function(c){console.log("AudioSource decoded");t.cached_audios[a]=c;b&&b(c)},d)};e.send();return e}};g["@src"]={widget:"resource"};g.supported_extensions=["wav","ogg","mp3"];g.prototype.onAdded=function(a){if(a.status===LGraph.STATUS_RUNNING)this.onStart()};g.prototype.onStart=function(){this._audiobuffer&&
this.properties.autoplay&&this.playBuffer(this._audiobuffer)};g.prototype.onStop=function(){this.stopAllSounds()};g.prototype.onPause=function(){this.pauseAllSounds()};g.prototype.onUnpause=function(){this.unpauseAllSounds()};g.prototype.onRemoved=function(){this.stopAllSounds();this._dropped_url&&URL.revokeObjectURL(this._url)};g.prototype.stopAllSounds=function(){for(var a=0;a<this._audionodes.length;++a)this._audionodes[a].started&&(this._audionodes[a].started=!1,this._audionodes[a].stop());this._audionodes.length=
0};g.prototype.pauseAllSounds=function(){t.getAudioContext().suspend()};g.prototype.unpauseAllSounds=function(){t.getAudioContext().resume()};g.prototype.onExecute=function(){if(this.inputs)for(var a=0;a<this.inputs.length;++a){var b=this.inputs[a];if(null!=b.link){var c=this.getInputData(a);if(void 0!==c)if("gain"==b.name)this.audionode.gain.value=c;else if("playbackRate"==b.name)for(this.properties.playbackRate=c,b=0;b<this._audionodes.length;++b)this._audionodes[b].playbackRate.value=c}}if(this.outputs)for(a=
0;a<this.outputs.length;++a)"buffer"==this.outputs[a].name&&this._audiobuffer&&this.setOutputData(a,this._audiobuffer)};g.prototype.onAction=function(a){this._audiobuffer&&("Play"==a?this.playBuffer(this._audiobuffer):"Stop"==a&&this.stopAllSounds())};g.prototype.onPropertyChanged=function(a,b){if("src"==a)this.loadSound(b);else if("gain"==a)this.audionode.gain.value=b;else if("playbackRate"==a)for(var c=0;c<this._audionodes.length;++c)this._audionodes[c].playbackRate.value=b};g.prototype.playBuffer=
function(a){var b=this,c=t.getAudioContext().createBufferSource();this._last_sourcenode=c;c.graphnode=this;c.buffer=a;c.loop=this.properties.loop;c.playbackRate.value=this.properties.playbackRate;this._audionodes.push(c);c.connect(this.audionode);this._audionodes.push(c);c.onended=function(){b.trigger("ended");var a=b._audionodes.indexOf(c);-1!=a&&b._audionodes.splice(a,1)};c.started||(c.started=!0,c.start());return c};g.prototype.loadSound=function(a){function b(a){this.boxcolor=k.NODE_DEFAULT_BOXCOLOR;
c._audiobuffer=a;c._loading_audio=!1;if(c.graph&&c.graph.status===LGraph.STATUS_RUNNING)c.onStart()}var c=this;this._request&&(this._request.abort(),this._request=null);this._audiobuffer=null;this._loading_audio=!1;a&&(this._request=t.loadSound(a,b),this._loading_audio=!0,this.boxcolor="#AA4")};g.prototype.onConnectionsChange=t.onConnectionsChange;g.prototype.onGetInputs=function(){return[["playbackRate","number"],["Play",k.ACTION],["Stop",k.ACTION]]};g.prototype.onGetOutputs=function(){return[["buffer",
"audiobuffer"],["ended",k.EVENT]]};g.prototype.onDropFile=function(a){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);a=URL.createObjectURL(a);this.properties.src=a;this.loadSound(a);this._dropped_url=a};g.title="Source";g.desc="Plays audio";k.registerNodeType("audio/source",g);f.prototype.onPropertyChanged=function(a,b){this.audionode[a]=b};f.prototype.onExecute=function(){if(this.isOutputConnected(0)){var a=this.audionode.frequencyBinCount;this._freq_bin&&this._freq_bin.length==a||(this._freq_bin=
new Uint8Array(a));this.audionode.getByteFrequencyData(this._freq_bin);this.setOutputData(0,this._freq_bin)}this.isOutputConnected(1)&&(a=this.audionode.frequencyBinCount,this._time_bin&&this._time_bin.length==a||(this._time_bin=new Uint8Array(a)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin));for(a=1;a<this.inputs.length;++a){var b=this.inputs[a];if(null!=b.link){var c=this.getInputData(a);void 0!==c&&(this.audionode[b.name].value=c)}}};f.prototype.onGetInputs=
function(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]};f.prototype.onGetOutputs=function(){return[["freqs","array"],["samples","array"]]};f.title="Analyser";f.desc="Audio Analyser";k.registerNodeType("audio/analyser",f);e.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var a=1;a<this.inputs.length;++a){var b=this.inputs[a],c=this.getInputData(a);void 0!==c&&(this.audionode[b.name].value=c)}};t.createAudioNodeWrapper(e);e.title=
"Gain";e.desc="Audio gain";k.registerNodeType("audio/gain",e);t.createAudioNodeWrapper(p);p.prototype.onRemove=function(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)};p.prototype.onPropertyChanged=function(a,b){"impulse_src"==a?this.loadImpulse(b):"normalize"==a&&(this.audionode.normalize=b)};p.prototype.onDropFile=function(a){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);this._dropped_url=URL.createObjectURL(a);this.properties.impulse_src=this._dropped_url;this.loadImpulse(this._dropped_url)};
p.prototype.loadImpulse=function(a){function b(a){c._impulse_buffer=a;c.audionode.buffer=a;console.log("Impulse signal set");c._loading_impulse=!1}var c=this;this._request&&(this._request.abort(),this._request=null);this._impulse_buffer=null;this._loading_impulse=!1;a&&(this._request=t.loadSound(a,b),this._loading_impulse=!0)};p.title="Convolver";p.desc="Convolves the signal (used for reverb)";k.registerNodeType("audio/convolver",p);t.createAudioNodeWrapper(q);q.prototype.onExecute=function(){if(this.inputs&&
this.inputs.length)for(var a=1;a<this.inputs.length;++a){var b=this.inputs[a];if(null!=b.link){var c=this.getInputData(a);void 0!==c&&(this.audionode[b.name].value=c)}}};q.prototype.onGetInputs=function(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]};q.title="DynamicsCompressor";q.desc="Dynamics Compressor";k.registerNodeType("audio/dynamicsCompressor",q);s.prototype.onExecute=function(){if(this.inputs&&this.inputs.length){var a=
this.getInputData(1);void 0!==a&&(this.audionode.curve=a)}};s.prototype.setWaveShape=function(a){this.audionode.curve=a};t.createAudioNodeWrapper(s);u.prototype.getAudioNodeInInputSlot=function(a){if(0==a)return this.audionode1;if(2==a)return this.audionode2};u.prototype.onPropertyChanged=function(a,b){"gain1"==a?this.audionode1.gain.value=b:"gain2"==a&&(this.audionode2.gain.value=b)};u.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var a=1;a<this.inputs.length;++a){var b=this.inputs[a];
null!=b.link&&"audio"!=b.type&&(b=this.getInputData(a),void 0!==b&&(1==a?this.audionode1.gain.value=b:3==a&&(this.audionode2.gain.value=b)))}};t.createAudioNodeWrapper(u);u.title="Mixer";u.desc="Audio mixer";k.registerNodeType("audio/mixer",u);t.createAudioNodeWrapper(l);l.prototype.onExecute=function(){var a=this.getInputData(1);void 0!==a&&(this.audionode.delayTime.value=a)};l.title="Delay";l.desc="Audio delay";k.registerNodeType("audio/delay",l);n.prototype.onExecute=function(){if(this.inputs&&
this.inputs.length)for(var a=1;a<this.inputs.length;++a){var b=this.inputs[a];if(null!=b.link){var c=this.getInputData(a);void 0!==c&&(this.audionode[b.name].value=c)}}};n.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["Q","number"]]};t.createAudioNodeWrapper(n);n.title="BiquadFilter";n.desc="Audio filter";k.registerNodeType("audio/biquadfilter",n);d.prototype.onStart=function(){this.audionode.started||(this.audionode.started=!0,this.audionode.start())};d.prototype.onStop=
function(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())};d.prototype.onPause=function(){this.onStop()};d.prototype.onUnpause=function(){this.onStart()};d.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var a=0;a<this.inputs.length;++a){var b=this.inputs[a];if(null!=b.link){var c=this.getInputData(a);void 0!==c&&(this.audionode[b.name].value=c)}}};d.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["type","string"]]};
t.createAudioNodeWrapper(d);d.title="Oscillator";d.desc="Oscillator";k.registerNodeType("audio/oscillator",d);a.prototype.onExecute=function(){this._last_buffer=this.getInputData(0);var a=this.getInputData(1);void 0!==a&&(this.properties.mark=a);this.setDirtyCanvas(!0,!1)};a.prototype.onDrawForeground=function(a){if(this._last_buffer){var b=this._last_buffer,c=b.length/this.size[0],d=this.size[1];a.fillStyle="black";a.fillRect(0,0,this.size[0],this.size[1]);a.strokeStyle="white";a.beginPath();var e=
0;if(this.properties.continuous){a.moveTo(e,d);for(var f=0;f<b.length;f+=c)a.lineTo(e,d-b[f|0]/255*d),e++}else for(f=0;f<b.length;f+=c)a.moveTo(e+0.5,d),a.lineTo(e+0.5,d-b[f|0]/255*d),e++;a.stroke();0<=this.properties.mark&&(b=t.getAudioContext().sampleRate/b.length,e=this.properties.mark/b*2/c,e>=this.size[0]&&(e=this.size[0]-1),a.strokeStyle="red",a.beginPath(),a.moveTo(e,d),a.lineTo(e,0),a.stroke())}};a.title="Visualization";a.desc="Audio Visualization";k.registerNodeType("audio/visualization",
a);b.prototype.onExecute=function(){if(this._freqs=this.getInputData(0)){var a=this.properties.band,b=this.getInputData(1);void 0!==b&&(a=b);b=t.getAudioContext().sampleRate/this._freqs.length;b=a/b*2;b>=this._freqs.length?b=this._freqs[this._freqs.length-1]:(a=b|0,b-=a,b=this._freqs[a]*(1-b)+this._freqs[a+1]*b);this.setOutputData(0,b/255*this.properties.amplitude)}};b.prototype.onGetInputs=function(){return[["band","number"]]};b.title="Signal";b.desc="extract the signal of some frequency";k.registerNodeType("audio/signal",
b);c.prototype.onAdded=function(a){a.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)};c["@code"]={widget:"code"};c.prototype.onStart=function(){this.audionode.onaudioprocess=this._callback};c.prototype.onStop=function(){this.audionode.onaudioprocess=c._bypass_function};c.prototype.onPause=function(){this.audionode.onaudioprocess=c._bypass_function};c.prototype.onUnpause=function(){this.audionode.onaudioprocess=this._callback};c.prototype.onExecute=function(){};c.prototype.onRemoved=
function(){this.audionode.onaudioprocess=c._bypass_function};c.prototype.processCode=function(){try{this._script=new new Function("properties",this.properties.code)(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(a){console.error("Error in onaudioprocess code",a),this._callback=c._bypass_function,this.audionode.onaudioprocess=this._callback}};c.prototype.onPropertyChanged=function(a,b){"code"==a&&(this.properties.code=b,this.processCode(),this.graph&&
this.graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))};c.default_function=function(){this.onaudioprocess=function(a){var b=a.inputBuffer;a=a.outputBuffer;for(var c=0;c<a.numberOfChannels;c++)for(var d=b.getChannelData(c),e=a.getChannelData(c),f=0;f<b.length;f++)e[f]=d[f]}};t.createAudioNodeWrapper(c);c.title="Script";c.desc="apply script to signal";k.registerNodeType("audio/script",c);m.title="Destination";m.desc="Audio output";k.registerNodeType("audio/destination",
m)})(this);
(function(r){function g(){this.size=[60,20];this.addInput("send",e.ACTION);this.addOutput("received",e.EVENT);this.addInput("in",0);this.addOutput("out",0);this.properties={url:"",room:"lgraph"};this._ws=null;this._last_data=[]}function f(){this.size=[60,20];this.addInput("send",e.ACTION);this.addOutput("received",e.EVENT);this.addInput("in",0);this.addOutput("out",0);this.properties={url:"tamats.com:55000",room:"lgraph",save_bandwidth:!0};this._server=null;this.createSocket();this._last_input_data=[];
this._last_output_data=[]}var e=r.LiteGraph;g.title="WebSocket";g.desc="Send data through a websocket";g.prototype.onPropertyChanged=function(e,f){"url"==e&&this.createSocket()};g.prototype.onExecute=function(){!this._ws&&this.properties.url&&this.createSocket();if(this._ws&&this._ws.readyState==WebSocket.OPEN){for(var e=this.properties.room,f=1;f<this.inputs.length;++f){var g=this.getInputData(f);if(null!=g){var r;try{r=JSON.stringify({type:0,room:e,channel:f,data:g})}catch(l){continue}this._ws.send(r)}}for(f=
1;f<this.outputs.length;++f)this.setOutputData(f,this._last_data[f])}};g.prototype.createSocket=function(){var e=this,f=this.properties.url;"ws"!=f.substr(0,2)&&(f="ws://"+f);this._ws=new WebSocket(f);this._ws.onopen=function(){console.log("ready");e.boxcolor="#8E8"};this._ws.onmessage=function(f){var g=JSON.parse(f.data);g.room&&g.room!=this.properties.room||(1==f.data.type?e.triggerSlot(0,g):e._last_data[f.data.channel||0]=g.data)};this._ws.onerror=function(f){console.log("couldnt connect to websocket");
e.boxcolor="#E88"};this._ws.onclose=function(f){console.log("connection closed");e.boxcolor="#000"}};g.prototype.send=function(e){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send(JSON.stringify({type:1,msg:e}))};g.prototype.onAction=function(e,f){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send({type:1,room:this.properties.room,action:e,data:f})};g.prototype.onGetInputs=function(){return[["in",0]]};g.prototype.onGetOutputs=function(){return[["out",0]]};e.registerNodeType("network/websocket",
g);f.title="SillyClient";f.desc="Connects to SillyServer to broadcast messages";f.prototype.onPropertyChanged=function(e,f){var g=this.properties.url+"/"+this.properties.room;this._server&&this._final_url!=g&&(this._server.connect(this.properties.url,this.properties.room),this._final_url=g)};f.prototype.onExecute=function(){if(this._server&&this._server.is_connected){for(var e=this.properties.save_bandwidth,f=1;f<this.inputs.length;++f){var g=this.getInputData(f);null==g||e&&this._last_input_data[f]==
g||(this._server.sendMessage({type:0,channel:f,data:g}),this._last_input_data[f]=g)}for(f=1;f<this.outputs.length;++f)this.setOutputData(f,this._last_output_data[f])}};f.prototype.createSocket=function(){var e=this;"undefined"==typeof SillyClient?(this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),this._error=!0):(this._server=new SillyClient,this._server.on_ready=function(){console.log("ready");e.boxcolor="#8E8"},this._server.on_message=function(f,g){var r=
null;try{r=JSON.parse(g)}catch(l){return}1==r.type?e.triggerSlot(0,r):e._last_output_data[r.channel||0]=r.data},this._server.on_error=function(f){console.log("couldnt connect to websocket");e.boxcolor="#E88"},this._server.on_close=function(f){console.log("connection closed");e.boxcolor="#000"},this.properties.url&&this.properties.room&&(this._server.connect(this.properties.url,this.properties.room),this._final_url=this.properties.url+"/"+this.properties.room))};f.prototype.send=function(e){this._server&&
this._server.is_connected&&this._server.sendMessage({type:1,data:e})};f.prototype.onAction=function(e,f){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,action:e,data:f})};f.prototype.onGetInputs=function(){return[["in",0]]};f.prototype.onGetOutputs=function(){return[["out",0]]};e.registerNodeType("network/sillyclient",f)})(this);
>>>>>>> heads/upstream/master
